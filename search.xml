<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>2025Lilctf(Reverse)</title>
    <url>/2025/08/15/2025Lilctf(Revese)/</url>
    <content><![CDATA[2025Lilctf(Reverse)1.ARM ASMå‘çŽ°æ˜¯apkï¼Œæ”¾åˆ°jadxçœ‹ä¸€ä¸‹ï¼Œå‘çŽ°ï¼š

ç„¶åŽidaæ‰“å¼€çœ‹åˆ°ï¼š

æ‰¾åˆ°è¿™ä¸‰ä¸ªå…³é”®å‡½æ•°ä»¥åŠï¼š

æŽ¨æµ‹æ˜¯å˜è¡¨å’Œç§»ä½çš„base64ï¼Œæ‰”ç»™aiåˆ†æžä¸€ä¸‹ï¼Œç”Ÿæˆè„šæœ¬ï¼š
import base64# è‡ªå®šä¹‰Base64è¡¨custom_b64_table = &quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ3456780129+/&quot;standard_b64_table = &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;# ç›®æ ‡å¯†æ–‡target_b64 = &quot;KRD2c1XRSJL9e0fqCIbiyJrHW1bu0ZnTYJvYw1DM2RzPK1XIQJnN2ZfRMY4So09S&quot;# è½¬æ¢åˆ°æ ‡å‡†Base64def to_standard_b64(s):    return s.translate(str.maketrans(custom_b64_table, standard_b64_table))# è§£ç Base64std_b64_str = to_standard_b64(target_b64)decoded = base64.b64decode(std_b64_str)data = list(decoded)  # è§£ç åŽçš„48å­—èŠ‚æ•°æ®# ç§»ä½é€†æ“ä½œï¼ˆæ¯3å­—èŠ‚ä¸€ç»„ï¼‰def reverse_shift(data):    result = []    for i in range(0, len(data), 3):        # ç¬¬1å­—èŠ‚ï¼šå¾ªçŽ¯å³ç§»3ä½ï¼ˆåŠ å¯†æ—¶å¾ªçŽ¯å·¦ç§»3ä½ï¼‰        b0 = data[i]        b0 = ((b0 &gt;&gt; 3) | (b0 &lt;&lt; 5)) &amp; 0xFF                # ç¬¬2å­—èŠ‚ï¼šå¾ªçŽ¯å·¦ç§»1ä½ï¼ˆåŠ å¯†æ—¶å¾ªçŽ¯å³ç§»1ä½ï¼‰        b1 = data[i+1]        b1 = ((b1 &lt;&lt; 1) | (b1 &gt;&gt; 7)) &amp; 0xFF                # ç¬¬3å­—èŠ‚ä¸å˜        b2 = data[i+2]        result.extend([b0, b1, b2])    return result# ç½®æ¢è¡¨tt0 = [0x0D, 0x0E, 0x0F, 0x0C, 0x0B, 0x0A, 0x09, 0x08,       0x06, 0x07, 0x05, 0x04, 0x02, 0x03, 0x01, 0x00]# æž„é€ é€†ç½®æ¢è¡¨inv_t = [0] * 16for i in range(16):    inv_t[t0[i]] = i# ä¸‰è½®å˜æ¢é€†æ“ä½œï¼ˆæ­£ç¡®å¯†é’¥ï¼‰def reverse_blocks(blocks):    # å—0ï¼šä½¿ç”¨å¯†é’¥ t0    block0 = [blocks[0][i] ^ t0[i] for i in range(16)]    block0 = [block0[inv_t[i]] for i in range(16)]        # å—1ï¼šä½¿ç”¨å¯†é’¥ t0    block1 = [blocks[1][i] ^ t0[i] for i in range(16)]    block1 = [block1[inv_t[i]] for i in range(16)]        # å—2ï¼šä½¿ç”¨å¯†é’¥ t0âŠ•1ï¼ˆå…³é”®ä¿®æ­£ï¼ï¼‰    key2 = [b ^ 0x01 for b in t0]    block2 = [blocks[2][i] ^ key2[i] for i in range(16)]    block2 = [block2[inv_t[i]] for i in range(16)]        return block0 + block1 + block2# æ­¥éª¤1: ç§»ä½é€†æ“ä½œdata = reverse_shift(data)# åˆ†å—ï¼ˆ16å­—èŠ‚/å—ï¼‰blocks = [    data[0:16],   # å—0: 0-15å­—èŠ‚    data[16:32],  # å—1: 16-31å­—èŠ‚    data[32:48]   # å—2: 32-47å­—èŠ‚]# æ­¥éª¤2: ä¸‰è½®é€†æ“ä½œï¼ˆä½¿ç”¨æ­£ç¡®å¯†é’¥ï¼‰original_data = reverse_blocks(blocks)# è½¬æ¢ä¸ºå­—ç¬¦ä¸²flag = &#x27;&#x27;.join(chr(b) for b in original_data)print(&quot;å®Œæ•´çš„Flag:&quot;, flag)print(&quot;Flagé•¿åº¦:&quot;, len(flag))

å®Œæ•´çš„Flag: LILCTF{ez_arm_asm_meow_meow_meowm_oe_wemwom_oe}wFlagé•¿åº¦: 48
æäº¤ä¸ä¸Šï¼ŒçŒœäº†ä¸€ä¸‹ï¼Œæœ€åŽè¯•äº†è¯•è¿™ä¸ª
LILCTF{ez_arm_asm_meow_meow_meow_meow_meow_meow}
æäº¤æˆåŠŸ
]]></content>
      <categories>
        <category>CTF</category>
        <category>Reverse</category>
      </categories>
      <tags>
        <tag>CTF</tag>
        <tag>Reverse</tag>
      </tags>
  </entry>
  <entry>
    <title>2025Lilctf(Crypto)</title>
    <url>/2025/08/15/2025Lilctf(Crypto)/</url>
    <content><![CDATA[2025Lilctf(Crypto)1.ez_mathåŽŸé¢˜ï¼š
from sage.all import *from Crypto.Util.number import *flag = b&#x27;LILCTF&#123;test_flag&#125;&#x27;[7:-1]lambda1 = bytes_to_long(flag[:len(flag)//2])lambda2 = bytes_to_long(flag[len(flag)//2:])p = getPrime(512)def mul(vector, c):    return [vector[0]*c, vector[1]*c]v1 = [getPrime(128), getPrime(128)]v2 = [getPrime(128), getPrime(128)]A = matrix(GF(p), [v1, v2])B = matrix(GF(p), [mul(v1,lambda1), mul(v2,lambda2)])C = A.inverse() * Bprint(f&#x27;p = &#123;p&#125;&#x27;)print(f&#x27;C = &#123;str(C).replace(&quot; &quot;, &quot;,&quot;).replace(&quot;\n&quot;, &quot;,&quot;).replace(&quot;[,&quot;, &quot;[&quot;)&#125;&#x27;)# p = 9620154777088870694266521670168986508003314866222315790126552504304846236696183733266828489404860276326158191906907396234236947215466295418632056113826161# C = [7062910478232783138765983170626687981202937184255408287607971780139482616525215270216675887321965798418829038273232695370210503086491228434856538620699645,7096268905956462643320137667780334763649635657732499491108171622164208662688609295607684620630301031789132814209784948222802930089030287484015336757787801],[7341430053606172329602911405905754386729224669425325419124733847060694853483825396200841609125574923525535532184467150746385826443392039086079562905059808,2557244298856087555500538499542298526800377681966907502518580724165363620170968463050152602083665991230143669519866828587671059318627542153367879596260872]

æ ¹æ®çŸ©é˜µæ±‚flagï¼Œè·Ÿmoeé‚£ä¸ªæœ‰ç‚¹åƒ

from sage.all import *from Crypto.Util.number import long_to_bytes# å·²çŸ¥çš„på’ŒCçŸ©é˜µå…ƒç´ p = 9620154777088870694266521670168986508003314866222315790126552504304846236696183733266828489404860276326158191906907396234236947215466295418632056113826161c11 = 7062910478232783138765983170626687981202937184255408287607971780139482616525215270216675887321965798418829038273232695370210503086491228434856538620699645c12 = 7096268905956462643320137667780334763649635657732499491108171622164208662688609295607684620630301031789132814209784948222802930089030287484015336757787801c21 = 7341430053606172329602911405905754386729224669425325419124733847060694853483825396200841609125574923525535532184467150746385826443392039086079562905059808c22 = 2557244298856087555500538499542298526800377681966907502518580724165363620170968463050152602083665991230143669519866828587671059318627542153367879596260872# åœ¨GF(p)åŸŸä¸Šè¿›è¡Œè®¡ç®—F = GF(p)c11 = F(c11)c12 = F(c12)c21 = F(c21)c22 = F(c22)# è®¡ç®—ç‰¹å¾æ–¹ç¨‹çš„ç³»æ•°sum_c = c11 + c22product_c = c11 * c22 - c12 * c21# è®¡ç®—åˆ¤åˆ«å¼å’Œå¹³æ–¹æ ¹D = sum_c^2 - 4 * product_csqrt_D = D.sqrt()# è®¡ç®—2çš„é€†å…ƒinv2 = F(2)^-1# æ±‚è§£ç‰¹å¾å€¼ï¼ˆÎ»â‚å’ŒÎ»â‚‚ï¼‰lambda1 = int((sum_c + sqrt_D) * inv2)lambda2 = int((sum_c - sqrt_D) * inv2)# è½¬æ¢ä¸ºå­—èŠ‚part1 = long_to_bytes(lambda1)part2 = long_to_bytes(lambda2)# ç”Ÿæˆå¯èƒ½çš„flagï¼ˆä¸¤ç§ç»„åˆï¼Œå› ä¸ºÎ»â‚å’ŒÎ»â‚‚å¯èƒ½é¡ºåºäº’æ¢ï¼‰flag1 = b&#x27;LILCTF&#123;&#x27; + part1 + part2 + b&#x27;&#125;&#x27;flag2 = b&#x27;LILCTF&#123;&#x27; + part2 + part1 + b&#x27;&#125;&#x27;print(&quot;å¯èƒ½çš„flag1:&quot;, flag1)print(&quot;å¯èƒ½çš„flag2:&quot;, flag2)

å¯èƒ½çš„flag1: bâ€™LILCTF{It_w4s_the_be5t_of_times_1t_wa5_the_w0rst_of_t1me5}â€™å¯èƒ½çš„flag2: bâ€™LILCTF{1t_wa5_the_w0rst_of_t1me5It_w4s_the_be5t_of_times_}â€™
2.linearåŽŸé¢˜ï¼š
import osimport randomimport signalsignal.alarm(10)flag = os.getenv(&quot;LILCTF_FLAG&quot;, &quot;LILCTF&#123;default&#125;&quot;)nrows = 16ncols = 32A = [[random.randint(1, 1919810) for _ in range(ncols)] for _ in range(nrows)]x = [random.randint(1, 114514) for _ in range(ncols)]b = [sum(A[i][j] * x[j] for j in range(ncols)) for i in range(nrows)]print(A)print(b)xx = list(map(int, input(&quot;Enter your solution: &quot;).strip().split()))if xx != x:    print(&quot;Oh, your linear algebra needs to be practiced.&quot;)else:    print(&quot;Bravo! Here is your flag:&quot;)    print(flag)

æ¯”è¾ƒç®€å•çš„ä¸€ä¸ªçº¿æ€§ä»£æ•°é¢˜ï¼Œä½†æ˜¯ä¸€èˆ¬æ±‚å‡ºæ¥çš„ç»“æžœå¥½åƒä¸å‡†ç¡®ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ ¼åŸºæ¥æ±‚è§£ï¼Œé—®é¢˜æ˜¯è¦æ±‚æ˜¯10sé™åˆ¶æ¯”è¾ƒéº»çƒ¦ï¼Œå› ä¸ºæˆ‘ä¸ä¼šåœ¨sagemathè¿žç«¯å£ï¼Œæ‰€ä»¥å°±ç”¨vscodeè¿žæŽ¥ç«¯å£ï¼Œä½¿ç”¨sagemathå‡ºxï¼Œè¿™æ ·çš„è¯å†å¤åˆ¶åˆ°äº¤äº’ç«¯å£å°±å¥½äº†
sagemathï¼š
# è¯»å–æ–‡æœ¬æ•°æ®with open(&quot;E:/edgeä¸‹è½½/CTF/2025LilCTF/Crypto/problem_data.txt&quot;, &quot;r&quot;, encoding=&quot;utf-8&quot;) as file:    data = file.read()# å‡è®¾æ•°æ®çš„æ ¼å¼æ˜¯ç±»ä¼¼äºŽJSONæˆ–Pythonåˆ—è¡¨çš„ç»“æž„# ä½ å¯ä»¥æ‰‹åŠ¨è§£æžæ–‡ä»¶å†…å®¹ï¼Œå‡è®¾æ•°æ®æ ¼å¼æ˜¯è¿™æ ·çš„ï¼š# A = [[...], [...], ...] å’Œ b = [...], ä½ å¯ä»¥ä½¿ç”¨eval()æˆ–json.loads()æ¥è§£æžimport ast# å‡è®¾ data ä¸­æœ‰ A å’Œ b çš„å®šä¹‰A = ast.literal_eval(data.split(&quot;A = &quot;)[1].split(&quot;b = &quot;)[0].strip())  # æå–å¹¶è§£æžAb = ast.literal_eval(data.split(&quot;b = &quot;)[1].strip())  # æå–å¹¶è§£æžb# ä¹‹åŽä½¿ç”¨è¿™äº›æ•°æ®è¿›è¡Œè®¡ç®—n = 32  # å˜é‡æ•°m = 16  # æ–¹ç¨‹æ•°W = 2**40  # æƒé‡# æž„é€ æ ¼åŸºçŸ©é˜µM = matrix(ZZ, n+1, n+m)for i in range(n):    M[i, i] = 1    for j in range(m):        M[i, n+j] = A[j][i] * W  # æ³¨æ„ï¼šAæ˜¯16è¡Œ32åˆ—ï¼Œæ‰€ä»¥A[j][i]æ˜¯ç¬¬jè¡Œç¬¬iåˆ—for j in range(m):    M[n, n+j] = b[j] * W# LLLçº¦ç®€ï¼ˆä½¿ç”¨æ›´å¿«å‚æ•°ï¼‰M_lll = M.LLL(delta=0.99, eta=0.51)# å¯»æ‰¾è§£solution = Nonefor i in range(n+1):    # æ£€æŸ¥åŽmä¸ªåˆ†é‡æ˜¯å¦å…¨ä¸º0    if all(M_lll[i, n+j] == 0 for j in range(m)):        x_sol = [abs(int(M_lll[i, j])) for j in range(n)]        # å°†è§£é™åˆ¶åœ¨[1,114514]èŒƒå›´å†…        x_sol = [max(1, min(x, 114514)) for x in x_sol]        solution = x_sol        break# å¦‚æžœLLLæœªæ‰¾åˆ°è§£ï¼Œä½¿ç”¨ä¼ªé€†ä½œä¸ºå¤‡é€‰if solution is None:    print(&quot;LLLæœªæ‰¾åˆ°è§£ï¼Œä½¿ç”¨ä¼ªé€†æ³•...&quot;)    A_np = matrix(RDF, A)    b_np = vector(RDF, b)    x_float = A_np.pseudoinverse() * b_np    solution = [int(round(num)) for num in x_float]    solution = [max(1, min(x, 114514)) for x in solution]# æ‰“å°è§£ï¼ˆå¤åˆ¶è¿™ä¸ªåˆ°client.pyï¼‰print(&quot;\n&quot; + &quot;=&quot;*80)print(&quot;è§£x (å¤åˆ¶è¿™ä¸ªåˆ°client.py):&quot;)print(&quot; &quot;.join(map(str, solution)))print(&quot;=&quot;*80)# éªŒè¯è§£ï¼ˆå¯é€‰ï¼‰b_calculated = [sum(A[i][j] * solution[j] for j in range(n)) for i in range(m)]if b_calculated == b:    print(&quot;éªŒè¯æˆåŠŸ: Ax = b&quot;)else:    print(&quot;éªŒè¯å¤±è´¥: Ax â‰  b&quot;)    print(f&quot;åŽŸå§‹b: &#123;b&#125;&quot;)    print(f&quot;è®¡ç®—b: &#123;b_calculated&#125;&quot;)

vscode
from pwn import *import timeimport osdef main():    # è¿žæŽ¥åˆ°æœåŠ¡å™¨    io = remote(&quot;challenge.xinshi.fun&quot;, 46755)        # æŽ¥æ”¶æ•°æ®ç›´åˆ°å‡ºçŽ°è¾“å…¥æç¤º    data = b&quot;&quot;    start_time = time.time()    while b&quot;Enter your solution:&quot; not in data:        chunk = io.recv(1024)        if not chunk:            break        data += chunk                # è¶…æ—¶æ£€æŸ¥        if time.time() - start_time &gt; 15:            print(&quot;Timeout waiting for data!&quot;)            io.close()            return        # æå–å¹¶ä¿å­˜çŸ©é˜µAå’Œå‘é‡b    A_start = data.find(b&quot;[[&quot;)    A_end = data.find(b&quot;]]&quot;) + 2    b_start = data.find(b&quot;[&quot;, A_end)    b_end = data.find(b&quot;]&quot;, b_start) + 1        A_str = data[A_start:A_end].decode()    b_str = data[b_start:b_end].decode()        # ä¿å­˜åˆ°æ–‡ä»¶    with open(&quot;problem_data.txt&quot;, &quot;w&quot;) as f:        f.write(f&quot;A = &#123;A_str&#125;\n&quot;)        f.write(f&quot;b = &#123;b_str&#125;\n&quot;)        print(&quot;é—®é¢˜æ•°æ®å·²ä¿å­˜åˆ° problem_data.txt&quot;)    print(&quot;è¯·ç«‹å³è¿è¡ŒSageMathè„šæœ¬è®¡ç®—è§£...&quot;)        # ç­‰å¾…ç”¨æˆ·ç²˜è´´è§£    print(&quot;\nè®¡ç®—å®ŒæˆåŽï¼Œå°†è§£xç²˜è´´åœ¨è¿™é‡Œï¼ˆç©ºæ ¼åˆ†éš”çš„32ä¸ªæ•´æ•°ï¼‰&quot;)    print(&quot;æ³¨æ„ï¼šæ‚¨æœ‰10ç§’æ—¶é—´å®Œæˆè®¡ç®—ï¼&quot;)    xx = input(&quot;&gt;&gt;&gt; &quot;).strip()        # æäº¤è§£    io.sendline(xx.encode())        # èŽ·å–ç»“æžœ    try:        result = io.recvall(timeout=5).decode()        print(&quot;\nServer response:&quot;)        print(result)    except:        print(&quot;\nTimeout waiting for server response&quot;)        io.close()if __name__ == &quot;__main__&quot;:    main()


flagï¼š     LILCTF{60b2bfea-b0f7-4aed-9c94-b2301afd828f}
3.mid_mathåŽŸé¢˜ï¼š
from sage.all import *from Crypto.Util.number import *from tqdm import tqdmfrom random import randintfrom Crypto.Cipher import AESfrom Crypto.Util.Padding import padflag = b&#x27;LILCTF&#123;test_flag&#125;&#x27;p = getPrime(64)P = GF(p)key = randint(2**62, p)def mul(vector, c):    return [vector[0]*c, vector[1]*c, vector[2]*c, vector[3]*c, vector[4]*c]v1 = [getPrime(64), getPrime(64), getPrime(64), getPrime(64), getPrime(64)]v2 = [getPrime(64), getPrime(64), getPrime(64), getPrime(64), getPrime(64)]v3 = [getPrime(64), getPrime(64), getPrime(64), getPrime(64), getPrime(64)]v4 = [getPrime(64), getPrime(64), getPrime(64), getPrime(64), getPrime(64)]v5 = [getPrime(64), getPrime(64), getPrime(64), getPrime(64), getPrime(64)]a, b, c, d, e = getPrime(64), getPrime(64), getPrime(64), getPrime(64),  0A = matrix(P, [v1, v2, v3, v4, v5])B = matrix(P, [mul(v1,a), mul(v2,b), mul(v3, c), mul(v4, d), mul(v5, e)])C = A.inverse() * BD = C**keykey = pad(long_to_bytes(key), 16)aes = AES.new(key,AES.MODE_ECB)msg = aes.encrypt(pad(flag, 64))print(f&quot;p = &#123;p&#125;&quot;)print(f&#x27;C = &#123;[i for i in C]&#125;&#x27;.replace(&#x27;(&#x27;, &#x27;[&#x27;).replace(&#x27;)&#x27;, &#x27;]&#x27;))print(f&#x27;D = &#123;[i for i in D]&#125;&#x27;.replace(&#x27;(&#x27;, &#x27;[&#x27;).replace(&#x27;)&#x27;, &#x27;]&#x27;))print(f&quot;msg = &#123;msg&#125;&quot;)#p = 14668080038311483271#C = [[11315841881544731102, 2283439871732792326, 6800685968958241983, 6426158106328779372, 9681186993951502212], [4729583429936371197, 9934441408437898498, 12454838789798706101, 1137624354220162514, 8961427323294527914], [12212265161975165517, 8264257544674837561, 10531819068765930248, 4088354401871232602, 14653951889442072670], [6045978019175462652, 11202714988272207073, 13562937263226951112, 6648446245634067896, 13902820281072641413], [1046075193917103481, 3617988773170202613, 3590111338369894405, 2646640112163975771, 5966864698750134707]]#D = [[1785348659555163021, 3612773974290420260, 8587341808081935796, 4393730037042586815, 10490463205723658044], [10457678631610076741, 1645527195687648140, 13013316081830726847, 12925223531522879912, 5478687620744215372], [9878636900393157276, 13274969755872629366, 3231582918568068174, 7045188483430589163, 5126509884591016427], [4914941908205759200, 7480989013464904670, 5860406622199128154, 8016615177615097542, 13266674393818320551], [3005316032591310201, 6624508725257625760, 7972954954270186094, 5331046349070112118, 6127026494304272395]]#msg = b&quot;\xcc]B:\xe8\xbc\x91\xe2\x93\xaa\x88\x17\xc4\xe5\x97\x87@\x0fd\xb5p\x81\x1e\x98,Z\xe1n`\xaf\xe0%:\xb7\x8aD\x03\xd2Wu5\xcd\xc4#m&#x27;\xa7\xa4\x80\x0b\xf7\xda8\x1b\x82k#\xc1gP\xbd/\xb5j&quot;



ç”±äºŽ D = C ** keyï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨çŸ©é˜µçš„ç‰¹å¾å€¼ï¼ˆeigenvaluesï¼‰æ¥æ¢å¤ keyï¼š

è®¡ç®— C å’Œ D çš„ç‰¹å¾å€¼ï¼š
C çš„ç‰¹å¾å€¼ eigC åŒ…å« 0 å’Œ 4 ä¸ªéžé›¶å€¼ã€‚
D çš„ç‰¹å¾å€¼ eigD åŒ…å« 0 å’Œ eigC çš„éžé›¶å€¼çš„ key æ¬¡å¹‚ã€‚


è¿‡æ»¤æŽ‰ 0ï¼Œå¾—åˆ°éžé›¶ç‰¹å¾å€¼ï¼š
L1 = [x for x in eigC if x != 0]
L2 = [x for x in eigD if x != 0]


é€šè¿‡ç¦»æ•£å¯¹æ•°æ¢å¤ keyï¼š
å¯¹ L1 å’Œ L2 ä¸­çš„æ¯ä¸€å¯¹ (x, y)ï¼Œè§£ y = x ** key mod pã€‚
ç”±äºŽ key çš„èŒƒå›´æ˜¯ [2^62, p]ï¼Œè§£å‡ºçš„ k å¿…é¡»æ»¡è¶³è¿™ä¸ªèŒƒå›´ã€‚


éªŒè¯ keyï¼š
æ£€æŸ¥æ˜¯å¦ &#123;x ** key for x in L1&#125; == set(L2)ã€‚


è§£å¯† msgï¼š
å°† key è½¬ä¸ºå­—èŠ‚ï¼Œå¡«å……åˆ°16å­—èŠ‚ï¼Œç”¨AES-ECBè§£å¯† msg



aiæ‹·æ‰“ä¸¤ä¸‹å°±æ¢­å‡ºæ¥äº†
from sage.all import *from Crypto.Util.number import *from Crypto.Cipher import AESfrom Crypto.Util.Padding import pad, unpad  # Import pad and unpad# Given datap = 14668080038311483271C_list = [    [11315841881544731102, 2283439871732792326, 6800685968958241983, 6426158106328779372, 9681186993951502212],    [4729583429936371197, 9934441408437898498, 12454838789798706101, 1137624354220162514, 8961427323294527914],    [12212265161975165517, 8264257544674837561, 10531819068765930248, 4088354401871232602, 14653951889442072670],    [6045978019175462652, 11202714988272207073, 13562937263226951112, 6648446245634067896, 13902820281072641413],    [1046075193917103481, 3617988773170202613, 3590111338369894405, 2646640112163975771, 5966864698750134707]]D_list = [    [1785348659555163021, 3612773974290420260, 8587341808081935796, 4393730037042586815, 10490463205723658044],    [10457678631610076741, 1645527195687648140, 13013316081830726847, 12925223531522879912, 5478687620744215372],    [9878636900393157276, 13274969755872629366, 3231582918568068174, 7045188483430589163, 5126509884591016427],    [4914941908205759200, 7480989013464904670, 5860406622199128154, 8016615177615097542, 13266674393818320551],    [3005316032591310201, 6624508725257625760, 7972954954270186094, 5331046349070112118, 6127026494304272395]]msg = b&quot;\xcc]B:\xe8\xbc\x91\xe2\x93\xaa\x88\x17\xc4\xe5\x97\x87@\x0fd\xb5p\x81\x1e\x98,Z\xe1n`\xaf\xe0%:\xb7\x8aD\x03\xd2Wu5\xcd\xc4#m&#x27;\xa7\xa4\x80\x0b\xf7\xda8\x1b\x82k#\xc1gP\xbd/\xb5j&quot;# Set up finite field and matricesF = GF(p)C = matrix(F, C_list)D = matrix(F, D_list)# Compute eigenvalueseigC = C.eigenvalues()eigD = D.eigenvalues()# Remove zero eigenvalues (one for each matrix)L1 = [x for x in eigC if x != F(0)]L2 = [x for x in eigD if x != F(0)]if len(L1) != 4 or len(L2) != 4:    print(&quot;Error: Expected 4 non-zero eigenvalues for both matrices.&quot;)    exit(1)# Find key by matching eigenvalues via discrete logarithmkey_candidate = Nonefor i in range(4):    x0 = L1[i]    for j in range(4):        y0 = L2[j]        try:            k0 = discrete_log(y0, x0)  # Solve y0 = x0^k0 mod p            candidates = []            # Check if k0 is in the valid range            if 2**62 &lt;= k0 &lt;= p:                candidates.append(k0)            # If k0 is too small, try k0 + order of x0            if k0 &lt; 2**62:                ord_val = x0.multiplicative_order()                k1 = k0 + ord_val                if 2**62 &lt;= k1 &lt;= p:                    candidates.append(k1)            # Verify candidate keys            for k_cand in candidates:                S = set(x**k_cand for x in L1)                if S == set(L2):                    key_candidate = k_cand                    print(f&quot;Found key: &#123;key_candidate&#125;&quot;)                    break            if key_candidate is not None:                break        except Exception as e:            continue    if key_candidate is not None:        breakif key_candidate is None:    print(&quot;Failed to find key.&quot;)    exit(1)# Decrypt the message using the recovered keykey_bytes = long_to_bytes(key_candidate)# Pad the key to 16 bytes for AESkey_padded = pad(key_bytes, 16)  # Now pad is importedaes = AES.new(key_padded, AES.MODE_ECB)flag_padded = aes.decrypt(msg)flag = unpad(flag_padded, 64)  # Original padding was 64 bytesprint(f&quot;Flag: &#123;flag.decode()&#125;&quot;)

 key: 5273966641785501202
flagï¼šLILCTF{Are_y0u_5till_4wake_que5t1on_m4ker!}
4.Space TravelåŽŸé¢˜ï¼š
from Crypto.Cipher import AESfrom hashlib import md5from params import vecsfrom os import urandomkey = int(&quot;&quot;.join([vecs[int.from_bytes(urandom(2)) &amp; 0xfff] for _ in range(50)]), 2)print(&quot;ðŸŽ :&quot;, [[nonce := int(urandom(50*2).hex(), 16), (bin(nonce &amp; key).count(&quot;1&quot;)) % 2] for _ in range(600)])print(&quot;ðŸš© :&quot;, AES.new(key=md5(str(key).encode()).digest(), nonce=b&quot;Tiffany&quot;, mode=AES.MODE_CTR).encrypt(open(&quot;flag.txt&quot;, &quot;rb&quot;).read()))

1.é¢˜é¢é€»è¾‘ï¼ˆæ¥è‡ª task.pyï¼‰

å…ˆä»Ž params.py é‡Œçš„ vecsï¼ˆ4096 ä¸ª 16 ä½äºŒè¿›åˆ¶ä¸²ï¼‰ä¸­ï¼Œç”¨ 12 ä½éšæœºç´¢å¼•å„å– 50 æ¬¡ï¼Œæ‹¼æˆ 50Ã—16 &#x3D; 800 ä½çš„äºŒè¿›åˆ¶ä¸²ï¼Œä½œä¸ºå¤§æ•´æ•° keyã€‚
æŽ¥ç€ç”Ÿæˆ 600 ç»„æ ·æœ¬ï¼šæ¯ç»„é‡Œæœ‰ä¸€ä¸ª 800 ä½éšæœºæ•° nonceï¼Œä»¥åŠä¸€ä¸ªæ¯”ç‰¹ parityï¼Œå®ƒç­‰äºŽ bin(nonce &amp; key) ä¸­ 1 çš„ä¸ªæ•°çš„å¥‡å¶ï¼ˆå³ (nonce Â· key) mod 2 çš„å†…ç§¯ï¼‰ã€‚
æœ€åŽç”¨ md5(str(key)) ä½œä¸º AES-CTR çš„ keyï¼Œnonce å›ºå®šä¸º &quot;Tiffany&quot;ï¼ŒåŠ å¯†å‡ºå¯†æ–‡ ðŸš©ã€‚

2.è§‚æµ‹ä¸Žå›°éš¾

600 ç»„æ ·æœ¬æä¾›äº† 600 æ¡çº¿æ€§æ–¹ç¨‹ï¼ˆGF(2) ä¸Šçš„å†…ç§¯ï¼‰ï¼Œä½†æœªçŸ¥é‡ key æœ‰ 800 ä¸ªæ¯”ç‰¹ï¼Œç›´æŽ¥è§£æœ‰ 200 ç»´è‡ªç”±åº¦ï¼Œä¸å”¯ä¸€ã€‚
å…³é”®æ˜¯ key çš„ç»“æž„ï¼šå®ƒæ˜¯ 50 ä¸ª 16 ä½å°å—çš„ä¸²è”ï¼Œæ¯å—éƒ½æ¥è‡ª vecsã€‚è€Œ vecs çš„ 4096 é¡¹ï¼Œå…¶å·®åˆ†é›†åˆï¼ˆå–ä»»æ„ä¸€ä¸ªåŸºå‡† v0ï¼Œçœ‹ vecs âŠ• v0 çš„è¡Œç©ºé—´ï¼‰ç»´åº¦æ˜¯ 12ã€‚è¿™æ„å‘³ç€ vecs å…¶å®žæ˜¯ä¸€ä¸ª 12 ç»´çº¿æ€§å­ç©ºé—´çš„ä»¿å°„é™ªé›†ï¼ˆcosetï¼‰ï¼Œå¤§å°æ­£å¥½ 2^12&#x3D;4096ã€‚
äºŽæ˜¯æ¯ä¸ª 16 ä½å°å—éƒ½å¯è¡¨ç¤ºä¸º v0 âŠ• (B * Î±)ï¼Œå…¶ä¸­ B æ˜¯ 12Ã—16 çš„åŸºçŸ©é˜µï¼ŒÎ± æ˜¯ 12 æ¯”ç‰¹åæ ‡ã€‚
50 ä¸ªå°å— â†’ ä¸€å…± 50Ã—12 &#x3D; 600 ä¸ªæœªçŸ¥æ¯”ç‰¹ã€‚
ä¸Ž 600 æ¡çº¿æ€§æ–¹ç¨‹æ­£å¥½åŒ¹é…ï¼ä»Žè€ŒæŠŠåŽŸæœ¬ 800 ç»´æœªçŸ¥ï¼Œé™æˆ 600 ç»´ï¼Œå¾—åˆ°å¯è§£çš„çº¿æ€§ç³»ç»Ÿã€‚



3.å»ºæ¨¡æ–¹å¼ï¼ˆå¯¹é½ bit é¡ºåºå¾ˆé‡è¦ï¼ï¼‰

æŠŠ vecs çš„ 16 ä½å­—ç¬¦ä¸²è§†ä½œ LSB-firstï¼ˆä¸Ž (nonce &amp; key) çš„ä½å¯¹é½ä¸€è‡´ï¼‰ï¼Œå¦åˆ™ä¼šè§£å‡ºé”™è¯¯çš„ keyã€‚
è®¾ç¬¬ t ä¸ªå°å—çš„æœªçŸ¥ 12 æ¯”ç‰¹ä¸º Î±_tã€‚å¯¹æ¯æ¡æ ·æœ¬æ–¹ç¨‹ï¼Œæœ‰
parity_i = âŠ•_t &lt;nonce_chunk_i_t, v0 âŠ• (B * Î±_t)&gt; ``         = âŠ•_t &lt;nonce_chunk_i_t, v0&gt; âŠ• âŠ•_t &lt;nonce_chunk_i_t, B * Î±_t&gt;
æŠŠå¸¸é‡é¡¹ âŠ•_t &lt;nonce_chunk_i_t, v0&gt; ç§»åˆ°å³è¾¹ï¼Œå‰©ä½™æ˜¯å…³äºŽæ‰€æœ‰ Î±_t çš„ 600Ã—600 çº¿æ€§æ–¹ç¨‹ç»„ï¼Œç›´æŽ¥åœ¨ GF(2) è§£ä¹‹å³å¯ã€‚
æ–¹ç¨‹ç»„ç§©é€šå¸¸æ˜¯ 599ï¼ˆæœ‰ 1 ç»´è‡ªç”±åº¦ï¼‰ï¼Œä½†è¿™ ä¸å½±å“ï¼šä»»æ„è§£å‡ºçš„ (Î±_t) éƒ½æ˜ å°„åˆ° v0 âŠ• B*Î±_tï¼Œè¿™ä¸ªé›†åˆåˆšå¥½å°±æ˜¯ vecs çš„é‚£ä¸ªä»¿å°„é™ªé›†ï¼Œä¸ä¼šè·‘å‡ºé›†åˆä¹‹å¤–ã€‚å¯¹é‚£ 1 ç»´è‡ªç”±åº¦ï¼Œæµ‹è¯•ä¸¤ç§å¯èƒ½éƒ½å¾ˆå¿«ï¼Œç›´æŽ¥çœ‹å“ªä¸€ä¸ªèƒ½æŠŠå¯†æ–‡æ­£ç¡®è§£å‡ºå¯è¯»æ˜Žæ–‡ï¼ˆä¸€èˆ¬æ˜¯æ ‡å‡† CTF flagï¼‰ã€‚

4.è§£å‡º key å¹¶è¿˜åŽŸæ˜Žæ–‡

ç”¨è§£å‡ºæ¥çš„ 50 ä¸ª 16 ä½å°å—æ‹¼æˆ 800 ä½ keyï¼ˆæ³¨æ„ä¿æŒ LSB-first ä¸Žæž„é€ ä¸€è‡´ï¼‰ã€‚
å– md5(str(key))ï¼ˆPython çš„ str(key) å³åè¿›åˆ¶ä¸²ï¼‰å½“ AES-CTR keyï¼Œnonce ç”¨ b&quot;Tiffany&quot;ï¼Œè§£å¯† ðŸš©ã€‚
èƒ½å¾—åˆ°æ¸…æ™°çš„ ASCII flagã€‚

import re, ast, numpy as np, hashlibfrom Crypto.Cipher import AES# ---- å·¥å…·ï¼šGF(2) çº¿æ€§ä»£æ•° ----def gf2_rref(M, rhs=None):    M = M.copy().astype(np.uint8)    if rhs is not None:        rhs = rhs.copy().astype(np.uint8)        M = np.concatenate([M, rhs.reshape(-1,1)], axis=1)    m, n_aug = M.shape    n = n_aug if rhs is None else n_aug - 1    row = 0    pivots = []    for col in range(n):        pivot = None        for r in range(row, m):            if M[r,col]:                pivot = r; break        if pivot is None:            continue        if pivot != row:            M[[row,pivot]] = M[[pivot,row]]        for r in range(m):            if r != row and M[r,col]:                M[r,:] ^= M[row,:]        pivots.append(col)        row += 1        if row == m: break    return M, pivotsdef int_to_bits_lsb(n, width):    return np.array([(n&gt;&gt;i) &amp; 1 for i in range(width)], dtype=np.uint8)def bits_to_int(bits_lsb):    v = 0    for i,b in enumerate(bits_lsb):        if b: v |= (1&lt;&lt;i)    return v# ---- è¯»å– vecsï¼ˆparams.pyï¼‰å¹¶è½¬ä¸º LSB-first ----with open(&#x27;params.py&#x27;,&#x27;r&#x27;,encoding=&#x27;utf-8&#x27;,errors=&#x27;ignore&#x27;) as f:    text = f.read()vecs_list = re.findall(r&quot;&#x27;([01]&#123;16&#125;)&#x27;&quot;, text)vecs = np.array([[int(b) for b in s[::-1]] for s in vecs_list], dtype=np.uint8)  # reverse to LSB-first# å–ä¸€ä¸ªåŸºå‘é‡ v0ï¼Œå¹¶æž„é€ å·®åˆ†é›†åˆçš„è¡Œç©ºé—´åŸº Bï¼ˆ12Ã—16ï¼‰v0 = vecs[0]diffs = (vecs ^ v0) % 2def gf2_basis_rows(M):    A = M.copy().astype(np.uint8)    m,n = A.shape    row=0    pivcols=[]    for col in range(n):        pivot=None        for r in range(row,m):            if A[r,col]:                pivot=r; break        if pivot is None: continue        if pivot!=row: A[[row,pivot]] = A[[pivot,row]]        for r in range(m):            if r!=row and A[r,col]:                A[r,:] ^= A[row,:]        pivcols.append(col); row+=1        if row==m: break    # æŠ½å–åŸºè¡Œ    basis_rows=[]    used=set()    for lead in pivcols:        for r in range(m):            if r in used: continue            if A[r,lead]==1 and all(A[r,c]==0 for c in range(lead)):                basis_rows.append(A[r].copy()); used.add(r); break    return np.array(basis_rows, dtype=np.uint8)B = gf2_basis_rows(diffs)   # 12 x 16# ---- è§£æžæ ·æœ¬å’Œå¯†æ–‡ï¼ˆoutput.txtï¼‰----with open(&#x27;output.txt&#x27;,&#x27;r&#x27;,encoding=&#x27;utf-8&#x27;,errors=&#x27;ignore&#x27;) as f:    data = f.read()gift_text = re.search(r&quot;ðŸŽ\s*:\s*(\[\[.*?\]\])&quot;, data, flags=re.S).group(1)cipher_text_literal = re.search(r&quot;ðŸš©\s*:\s*(b?[&#x27;\&quot;][^&#x27;\&quot;]+[&#x27;\&quot;])|ðŸš©\s*:\s*([0-9a-fA-Fx,\s\[\]]+)&quot;, data).group(1) \                      or re.search(r&quot;ðŸš©\s*:\s*(b?[&#x27;\&quot;][^&#x27;\&quot;]+[&#x27;\&quot;])|ðŸš©\s*:\s*([0-9a-fA-Fx,\s\[\]]+)&quot;, data).group(2)gift = ast.literal_eval(gift_text)cipher_literal = ast.literal_eval(cipher_text_literal)if isinstance(cipher_literal, bytes):    ct = cipher_literalelif isinstance(cipher_literal, list):    ct = bytes(cipher_literal)elif isinstance(cipher_literal, str):    ct = bytes.fromhex(cipher_literal)else:    raise RuntimeError(&quot;Unknown ciphertext!&quot;)# ---- å»ºç«‹ 600Ã—600 çº¿æ€§æ–¹ç¨‹ç»„ï¼ŒæœªçŸ¥ä¸º 50 ä¸ªå—çš„ 12 æ¯”ç‰¹åæ ‡ ----m = len(gift)T = 50k = B.shape[0]  # 12WIDTH = 16*TA2 = np.zeros((m, T*k), dtype=np.uint8)b2 = np.zeros(m, dtype=np.uint8)for i,(nonce, par) in enumerate(gift):    bits = int_to_bits_lsb(nonce, WIDTH)    const = 0    for t in range(T):        chunk = bits[16*t:16*(t+1)]        const ^= (np.dot(chunk, v0) % 2)        # å¯¹ Î±_tï¼ˆ12 ç»´ï¼‰ï¼Œå…¶ç³»æ•°å³ &lt;chunk, B_row&gt;ï¼Œç­‰ä»·äºŽ (B @ chunk)        A2[i, t*k:(t+1)*k] = (B @ chunk) % 2    b2[i] = (par ^ const) % 2# ---- è§£æ–¹ç¨‹ï¼ˆå¯èƒ½ç§© 599ï¼Œå°è¯•ä¸¤ä¸ªå€™é€‰ï¼‰----rref_A2, pivs = gf2_rref(A2, b2)nvar = A2.shape[1]x_alpha = np.zeros(nvar, dtype=np.uint8)row=0for col in range(nvar):    if row &lt; len(pivs) and pivs[row]==col:        x_alpha[col] = rref_A2[row,-1]; row+=1rrefA_only, pivs_only = gf2_rref(A2, None)null = np.zeros(nvar, dtype=np.uint8)if len(pivs_only) &lt; nvar:    fcol = [c for c in range(nvar) if c not in pivs_only][0]    null[fcol]=1    row=0    for col in range(nvar):        if row &lt; len(pivs_only) and pivs_only[row]==col:            s=0            for kcol in range(col+1, nvar):                if rrefA_only[row,kcol] and null[kcol]:                    s ^= 1            null[col]=s%2            row+=1def build_key_bits(alpha_concat):    blocks=[]    for t in range(T):        alpha_t = alpha_concat[t*k:(t+1)*k]        vec_t = (v0 ^ (alpha_t @ B) % 2) % 2  # LSB-first 16 bits        blocks.append(vec_t)    return np.concatenate(blocks)cands = [x_alpha, (x_alpha ^ null) % 2]for cand in cands:    key_bits = build_key_bits(cand)    key_int = bits_to_int(key_bits)    aes_key = hashlib.md5(str(key_int).encode()).digest()    cipher = AES.new(key=aes_key, nonce=b&quot;Tiffany&quot;, mode=AES.MODE_CTR)    pt = cipher.decrypt(ct)    try:        s = pt.decode(&#x27;utf-8&#x27;)        if &quot;&#123;&quot; in s and &quot;&#125;&quot; in s:            print(&quot;FLAG:&quot;, s)            break    except:        pass

flagï¼š LILCTF{Un1qUe_s0luti0n_1N_sUbSp4C3!}
5.baaaaaagåŽŸé¢˜ï¼š
from Crypto.Util.number import *import randomfrom Crypto.Cipher import AESimport hashlibfrom Crypto.Util.Padding import padfrom secret import flagp = random.getrandbits(72)assert len(bin(p)[2:]) == 72a = [getPrime(90) for _ in range(72)]b = 0t = pfor i in a:    temp = t % 2    b += temp * i    t = t &gt;&gt; 1key = hashlib.sha256(str(p).encode()).digest()cipher = AES.new(key, AES.MODE_ECB)flag = pad(flag,16)ciphertext = cipher.encrypt(flag)print(f&#x27;a = &#123;a&#125;&#x27;)print(f&#x27;b = &#123;b&#125;&#x27;)print(f&quot;ciphertext = &#123;ciphertext&#125;&quot;)&#x27;&#x27;&#x27;a = [965032030645819473226880279, 699680391768891665598556373, 1022177754214744901247677527, 680767714574395595448529297, 1051144590442830830160656147, 1168660688736302219798380151, 796387349856554292443995049, 740579849809188939723024937, 940772121362440582976978071, 787438752754751885229607747, 1057710371763143522769262019, 792170184324681833710987771, 912844392679297386754386581, 906787506373115208506221831, 1073356067972226734803331711, 1230248891920689478236428803, 713426848479513005774497331, 979527247256538239116435051, 979496765566798546828265437, 836939515442243300252499479, 1185281999050646451167583269, 673490198827213717568519179, 776378201435505605316348517, 809920773352200236442451667, 1032450692535471534282750757, 1116346000400545215913754039, 1147788846283552769049123803, 994439464049503065517009393, 825645323767262265006257537, 1076742721724413264636318241, 731782018659142904179016783, 656162889354758353371699131, 1045520414263498704019552571, 1213714972395170583781976983, 949950729999198576080781001, 1150032993579134750099465519, 975992662970919388672800773, 1129148699796142943831843099, 898871798141537568624106939, 997718314505250470787513281, 631543452089232890507925619, 831335899173370929279633943, 1186748765521175593031174791, 884252194903912680865071301, 1016020417916761281986717467, 896205582917201847609656147, 959440423632738884107086307, 993368100536690520995612807, 702602277993849887546504851, 1102807438605649402749034481, 629539427333081638691538089, 887663258680338594196147387, 1001965883259152684661493409, 1043811683483962480162133633, 938713759383186904819771339, 1023699641268310599371568653, 784025822858960757703945309, 986182634512707587971047731, 1064739425741411525721437119, 1209428051066908071290286953, 667510673843333963641751177, 642828919542760339851273551, 1086628537309368288204342599, 1084848944960506663668298859, 667827295200373631038775959, 752634137348312783761723507, 707994297795744761368888949, 747998982630688589828284363, 710184791175333909291593189, 651183930154725716807946709, 724836607223400074343868079, 1118993538091590299721647899]b = 34962396275078207988771864327ciphertext = b&#x27;Lo~G\xf46&gt;\xd609\x8e\x8e\xf5\xf83\xb5\xf0\x8f\x9f6&amp;\xea\x02\xfa\xb1_L\x85\x93\x93\xf7,`|\xc6\xbe\x05&amp;\x85\x8bC\xcd\xe6?TV4q&#x27;&#x27;&#x27;&#x27;

ä¸€ä¸ªèƒŒåŒ…å¯†ç ï¼Œè§£å‡ºpå°±èƒ½æ¢­å‡ºæ¥äº†ã€‚ä½†æ˜¯é—®é¢˜æ˜¯æ€Žä¹ˆè§£å‡ºpï¼š
æ®æˆ‘å·²çŸ¥çš„èƒŒåŒ…å¯†ç ï¼šbæ˜¯èƒŒåŒ…å®¹é‡ï¼Œaæ˜¯å°†è¦è£…è¿›èƒŒåŒ…çš„ç‰©å“ã€‚på¯ä»¥ç”±åè¿›åˆ¶è½¬åŒ–ä¸ºäºŒè¿›åˆ¶ï¼Œå…¶ä¸­æ»¡è¶³a[i],piã€‚piåªèƒ½ä¸º0æˆ–1,0ä»£è¡¨å¯¹åº”çš„a[i]æ²¡æœ‰è¢«è£…è¿›èƒŒåŒ…ï¼Œ1ä»£è¡¨å¯¹åº”çš„a[i]è¢«è£…è¿›èƒŒåŒ…ã€‚bä¼šè¢«aè£…æ»¡ã€‚
å¤§æ¦‚æ˜¯è¿™ä¸ªæ„æ€ï¼Œä½†æ˜¯åˆ—æ•°å­¦è¡¨è¾¾å¼å¾—å‡ºpçš„äºŒè¿›åˆ¶éœ€è¦çº¿æ€§ä»£æ•°çŸ¥è¯†ã€‚lllç®—æ³•å’Œbkzè§„çº¦
è¿™æ˜¯deepseekç»™å‡ºçš„è¯¦ç»†ï¼š
å¦‚ä½•è§£å‡º pï¼Ÿä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä½¿ç”¨æ ¼åŸºå½’çº¦ç®—æ³•ï¼ˆå¦‚ LLL æˆ– BKZï¼‰ã€‚æ ¼åŸºå½’çº¦å¯ä»¥å°†å­é›†å’Œé—®é¢˜è½¬åŒ–ä¸ºå¯»æ‰¾æ ¼ä¸­çš„çŸ­å‘é‡é—®é¢˜ã€‚å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š

æ ¼åŸºæž„é€ ï¼šæž„é€ ä¸€ä¸ª (n+1) x (n+1) çš„çŸ©é˜µï¼ˆn æ˜¯ a çš„é•¿åº¦ï¼‰ï¼Œå…¶ä¸­ï¼š

å‰ n è¡Œï¼šå¯¹è§’çº¿å…ƒç´ ä¸º 2ï¼Œæœ€åŽä¸€åˆ—ä¸º a[i]ã€‚
æœ€åŽä¸€è¡Œï¼šå‰ n ä¸ªå…ƒç´ ä¸º 1ï¼Œæœ€åŽä¸€ä¸ªå…ƒç´ ä¸º bã€‚

è¿™ç§æž„é€ ç¡®ä¿äº†è§£å‘é‡ (2*m_0 - 1, 2*m_1 - 1, ..., 2*m_&#123;n-1&#125; - 1, 0) åœ¨æ ¼ä¸­ï¼Œå…¶ä¸­ m_i æ˜¯ p çš„äºŒè¿›åˆ¶ä½ã€‚è½¬æ¢ v_i = 2*m_i - 1 å°†äºŒè¿›åˆ¶ä½æ˜ å°„åˆ° Â±1ï¼Œä½¿å¾—è§£å‘é‡æ›´çŸ­ä¸”æ›´æ˜“è¯†åˆ«ã€‚

æ ¼åŸºå½’çº¦ï¼šä½¿ç”¨ BKZ æˆ– LLL ç®—æ³•å¯¹æ ¼åŸºè¿›è¡Œå½’çº¦ã€‚BKZ é€šå¸¸æ›´å¼ºï¼ˆèƒ½æ‰¾åˆ°æ›´çŸ­çš„å‘é‡ï¼‰ï¼Œä½†è®¡ç®—æˆæœ¬æ›´é«˜ã€‚å¦‚æžœ BKZ å¤±è´¥ï¼Œå¯ä»¥å›žé€€åˆ° LLLã€‚

æœç´¢è§£å‘é‡ï¼šåœ¨å½’çº¦åŽçš„åŸºä¸­æœç´¢æ»¡è¶³æ¡ä»¶çš„å‘é‡ï¼š

å‰ n ä¸ªåæ ‡ä¸º Â±1ã€‚
æœ€åŽä¸€ä¸ªåæ ‡ä¸º 0ï¼ˆæˆ–æŽ¥è¿‘ 0ï¼Œå®¹é”™å¤„ç†ï¼‰ã€‚

å¦‚æžœæ‰¾åˆ°ï¼Œåˆ™ä»Žè§£å‘é‡æ¢å¤äºŒè¿›åˆ¶ä½ï¼šm_i = (v_i + 1) / 2ã€‚

æ¢å¤ pï¼šå°†äºŒè¿›åˆ¶ä½ç»„åˆæˆæ•´æ•° pï¼ˆæ³¨æ„ï¼šæœ€ä½Žä½å¯¹åº” m_0ï¼‰ã€‚


from sage.all import Matrix, ZZ# --------- å·²çŸ¥å‚æ•° ----------a = [965032030645819473226880279, 699680391768891665598556373, 1022177754214744901247677527, 680767714574395595448529297,     1051144590442830830160656147, 1168660688736302219798380151, 796387349856554292443995049, 740579849809188939723024937,     940772121362440582976978071, 787438752754751885229607747, 1057710371763143522769262019, 792170184324681833710987771,     912844392679297386754386581, 906787506373115208506221831, 1073356067972226734803331711, 1230248891920689478236428803,     713426848479513005774497331, 979527247256538239116435051, 979496765566798546828265437, 836939515442243300252499479,     1185281999050646451167583269, 673490198827213717568519179, 776378201435505605316348517, 809920773352200236442451667,     1032450692535471534282750757, 1116346000400545215913754039, 1147788846283552769049123803, 994439464049503065517009393,     825645323767262265006257537, 1076742721724413264636318241, 731782018659142904179016783, 656162889354758353371699131,     1045520414263498704019552571, 1213714972395170583781976983, 949950729999198576080781001, 1150032993579134750099465519,     975992662970919388672800773, 1129148699796142943831843099, 898871798141537568624106939, 997718314505250470787513281,     631543452089232890507925619, 831335899173370929279633943, 1186748765521175593031174791, 884252194903912680865071301,     1016020417916761281986717467, 896205582917201847609656147, 959440423632738884107086307, 993368100536690520995612807,     702602277993849887546504851, 1102807438605649402749034481, 629539427333081638691538089, 887663258680338594196147387,     1001965883259152684661493409, 1043811683483962480162133633, 938713759383186904819771339, 1023699641268310599371568653,     784025822858960757703945309, 986182634512707587971047731, 1064739425741411525721437119, 1209428051066908071290286953,     667510673843333963641751177, 642828919542760339851273551, 1086628537309368288204342599, 1084848944960506663668298859,     667827295200373631038775959, 752634137348312783761723507, 707994297795744761368888949, 747998982630688589828284363,     710184791175333909291593189, 651183930154725716807946709, 724836607223400074343868079, 1118993538091590299721647899]b = 34962396275078207988771864327ciphertext = b&#x27;Lo~G\xf46&gt;\xd609\x8e\x8e\xf5\xf83\xb5\xf0\x8f\x9f6&amp;\xea\x02\xfa\xb1_L\x85\x93\x93\xf7,`|\xc6\xbe\x05&amp;\x85\x8bC\xcd\xe6?TV4q&#x27;n = len(a)   # 72# --------- æž„é€ æ ¼åŸº ----------Ge = Matrix(ZZ, n+1, n+1)for i in range(n):    Ge[i, i] = 2    Ge[i, -1] = a[i]for i in range(n):    Ge[-1, i] = 1Ge[-1, -1] = b# --------- BKZ / LLL å½’çº¦ ----------print(&quot;Running BKZ...&quot;)try:    B = Ge.BKZ(block_size=28)except Exception as e:    print(&quot;BKZ å¤±è´¥ï¼Œé€€å›ž LLLï¼š&quot;, e)    B = Ge.LLL()print(&quot;Reduction done. Searching for solution vector...&quot;)found = Falsecandidate = None# æœç´¢è§£å‘é‡for row_idx in range(B.nrows()):    v = [int(B[row_idx, j]) for j in range(n+1)]    last = v[-1]    front = v[:-1]    if last == 0 and all(x in (-1, 1) for x in front):        candidate = front        found = True        print(f&quot;Found exact candidate in basis row &#123;row_idx&#125;&quot;)        breakif not found:    for row_idx in range(B.nrows()):        v = [int(B[row_idx, j]) for j in range(n+1)]        front = v[:-1]        last = v[-1]        if abs(last) &lt;= 1 and all(abs(x) in (0,1,2) for x in front):            possibly = []            ok = True            for x in front:                if x &gt;= 1:                    possibly.append(1)                elif x &lt;= -1:                    possibly.append(-1)                else:                    ok = False                    break            if ok:                candidate = possibly                found = True                print(f&quot;Found tolerant candidate in basis row &#123;row_idx&#125; (last=&#123;last&#125;)&quot;)                breakif not found:    print(&quot;æ²¡æœ‰åœ¨åŸºä¸­ç›´æŽ¥æ‰¾åˆ°æ»¡è¶³ (Â±1,...,0) å½¢å¼çš„å‘é‡ã€‚&quot;)    print(&quot;ä½ å¯ä»¥ï¼š\n - æé«˜ BKZ çš„ block_sizeï¼ˆæ›´å¼ºä½†æ›´æ…¢ï¼‰ï¼Œ\n - æˆ–å°è¯•æœç´¢åŸºå‘é‡çš„çŸ­çº¿æ€§ç»„åˆ / ä½¿ç”¨ fpylll çš„ shortest_vector.&quot;)    exit(1)# æ¢å¤ pm_bits = [(x + 1) // 2 for x in candidate]p_recovered = 0for i, bit in enumerate(m_bits):    p_recovered |= (bit &lt;&lt; i)print(&quot;Recovered p (decimal):&quot;, p_recovered)print(&quot;Recovered p (bin length):&quot;, len(bin(p_recovered)) - 2)

Running BKZâ€¦Reduction done. Searching for solution vectorâ€¦Found exact candidate in basis row 0Recovered p (decimal): 4208626653103825685156Recovered p (bin length): 72
from Crypto.Cipher import AESfrom Crypto.Util.Padding import unpadimport hashlibciphertext=b&#x27;Lo~G\xf46&gt;\xd609\x8e\x8e\xf5\xf83\xb5\xf0\x8f\x9f6&amp;\xea\x02\xfa\xb1_L\x85\x93\x93\xf7,`|\xc6\xbe\x05&amp;\x85\x8bC\xcd\xe6?TV4q&#x27;p_recovered=4208626653103825685156key = hashlib.sha256(str(p_recovered).encode()).digest()cipher = AES.new(key, AES.MODE_ECB)try:    plaintext = unpad(cipher.decrypt(ciphertext), 16)except ValueError:    plaintext = cipher.decrypt(ciphertext)    print(&quot;Warning: unpad failed; raw decrypted bytes shown.&quot;)print(&quot;Decrypted plaintext (bytes):&quot;, plaintext)try:    print(&quot;Decrypted plaintext (utf-8):&quot;, plaintext.decode())except Exception:    pass

Decrypted plaintext (bytes): bâ€™LILCTF{M4ybe_7he_brut3_f0rce_1s_be5t}â€™Decrypted plaintext (utf-8): LILCTF{M4ybe_7he_brut3_f0rce_1s_be5t}
]]></content>
      <categories>
        <category>CTF</category>
        <category>Crypto</category>
      </categories>
      <tags>
        <tag>CTF</tag>
        <tag>Crypto</tag>
      </tags>
  </entry>
  <entry>
    <title>2025moectf(Crypto)</title>
    <url>/2025/08/09/2025moectf(Crypto)/</url>
    <content><![CDATA[2025moectf(Crypto)1.moectf(Crypto)#!/usr/bin/env python3from Crypto.PublicKey import ElGamalfrom Crypto.Random import get_random_bytes, randomfrom Crypto.Util.number import *from random import *from secret import flagdef generate_elgamal_keypair(bits=512):p = getPrime(bits)for _ in range(1000):g = getRandomRange(2, 5)if pow(g, (p - 1) // 2, p) != 1:breakx = randrange(2, p - 1)æ³¨:æ­¤å¤„çš„secretæ¨¡å—å¯ä»¥ç†è§£ä¸ºå­˜å‚¨äº†æ˜Žæ–‡flagçš„pythonæ–‡ä»¶ï¼Œå±žäºŽæœªçŸ¥ä¿¡æ¯ï¼Œè€Œéžå…¬å¼€çš„å¯ç”¨æ¨¡å—ã€‚ä½ éœ€è¦å°è¯•ä»Žå¯†æ–‡åŽ»æ¢å¤åŽŸå§‹çš„flagï¼Œè€Œä¸æ˜¯åŽ»ä¸‹è½½secretæ¨¡å—ã€‚secretsåˆ™æ˜¯ä¸€ä¸ªç”¨äºŽç”Ÿæˆç®¡ç†å¯†ç çš„å®‰å…¨éšæœºæ•°çš„pythonæ ‡å‡†åº“ã€‚bytes_to_longå‡½æ•°ç”¨äºŽå°†flagç¼–ç ä¸ºæ•´æ•°ã€‚Hintï¼šä»€ä¹ˆæ˜¯ Elgamalè¿˜æ˜¯é™„ä¸ªé“¾æŽ¥å§Elgamaly = pow(g, x, p)return p, g, y, xkey=generate_elgamal_keypair(bits=512)p, g, y ,x= keyprint(&quot;=== å…¬é’¥ (p, g, y) ===&quot;)print(&quot;p =&quot;, p)print(&quot;g =&quot;, g)print(&quot;y =&quot;, y)print()k = randrange(1, p - 2)m = bytes_to_long(flag)c1 = pow(g, k, p)c2 = (m * pow(y, k, p)) % pprint(&quot;=== å¯†æ–‡ (c1, c2) ===&quot;)print(&quot;c1 =&quot;, c1)print(&quot;c2 =&quot;, c2)#ä¸å°å¿ƒæŠŠxè¾“å‡ºäº†()print(&quot;x =&quot;, x)&quot;&quot;&quot;=== å…¬é’¥ (p, g, y) ===p =11540963715962144951763578255357417528966715904849014985547597657698304891044841099894993117258279094910424033273299863589407477091830213468539451196239863g = 2y =8313424783366011287014623582773521595333285291380540689467073212212931648415580065207081449784135835711205324186662482526357834042013400765421925274271853=== å¯†æ–‡ (c1, c2) ===c1 =6652053553055645358275362259554856525976931841318251152940464543175108560132949610916012490837970851191204144757409335011811874896056430105292534244732863c2 =2314913568081526428247981719100952331444938852399031826635475971947484663418362533363591441216570597417789120470703548843342170567039399830377459228297983x =8010957078086554284020959664124784479610913596560035011951143269559761229114027738791440961864150225798049120582540951874956255115884539333966429021004214&quot;&quot;&quot;æ³¨:æ­¤å¤„çš„secretæ¨¡å—å¯ä»¥ç†è§£ä¸ºå­˜å‚¨äº†æ˜Žæ–‡flagçš„pythonæ–‡ä»¶ï¼Œå±žäºŽæœªçŸ¥ä¿¡æ¯ï¼Œè€Œéžå…¬å¼€çš„å¯ç”¨æ¨¡å—ã€‚ä½ éœ€è¦å°è¯•ä»Žå¯†æ–‡åŽ»æ¢å¤åŽŸå§‹çš„flagï¼Œè€Œä¸æ˜¯åŽ»ä¸‹è½½secretæ¨¡å—ã€‚secretsåˆ™æ˜¯ä¸€ä¸ªç”¨äºŽç”Ÿæˆç®¡ç†å¯†ç çš„å®‰å…¨éšæœºæ•°çš„pythonæ ‡å‡†åº“ã€‚bytes_to_longå‡½æ•°ç”¨äºŽå°†flagç¼–ç ä¸ºæ•´æ•°ã€‚

aiå¯ä»¥ä¸€æŠŠæ¢­ï¼Œæ˜Žä¸ªå†æ¥å†™è§£é¢˜è¿‡ç¨‹ï¼š

from Crypto.Util.number import long_to_bytes# ç»™å®šçš„å…¬é’¥å’Œç§é’¥p = 11540963715962144951763578255357417528966715904849014985547597657698304891044841099894993117258279094910424033273299863589407477091830213468539451196239863g = 2y = 8313424783366011287014623582773521595333285291380540689467073212212931648415580065207081449784135835711205324186662482526357834042013400765421925274271853c1 = 6652053553055645358275362259554856525976931841318251152940464543175108560132949610916012490837970851191204144757409335011811874896056430105292534244732863c2 = 2314913568081526428247981719100952331444938852399031826635475971947484663418362533363591441216570597417789120470703548843342170567039399830377459228297983x = 8010957078086554284020959664124784479610913596560035011951143269559761229114027738791440961864150225798049120582540951874956255115884539333966429021004214# è®¡ç®—å…±äº«å¯†é’¥ s = c1^x mod ps = pow(c1, x, p)# è®¡ç®— s çš„æ¨¡é€†å…ƒs_inv = pow(s, -1, p)# è§£å¯†æ¶ˆæ¯ m = c2 * s_inv mod pm = (c2 * s_inv) % p# å°†æ•´æ•°è½¬æ¢ä¸ºå­—èŠ‚ä¸²flag = long_to_bytes(m)print(&quot;è§£å¯†åŽçš„ flag:&quot;, flag.decode())

flag:   moectf{th1s_1s_y0ur_f1rst_ElG@m@l}
2.ez_DESåŽŸé¢˜ï¼š
from Crypto.Cipher import DESimport secretsimport stringflag = &#x27;moectf&#123;???&#125;&#x27;characters = string.ascii_letters + string.digits + string.punctuationkey = &#x27;ezdes&#x27;+&#x27;&#x27;.join(secrets.choice(characters) for _ in range(3))assert key[:5] == &#x27;ezdes&#x27;key = key.encode(&#x27;utf-8&#x27;)l = 8def encrypt(text, key):    cipher = DES.new(key, DES.MODE_ECB)    padded_text = text + (l - len(text) % l) * chr(len(text))    data = cipher.encrypt(padded_text.encode(&#x27;utf-8&#x27;))    return datac = encrypt(flag, key)print(&#x27;c =&#x27;, c)# c = b&#x27;\xe6\x8b0\xc8m\t?\x1d\xf6\x99sA&gt;\xce \rN\x83z\xa0\xdc&#123;\xbc\xb8X\xb2\xe2q\xa4&quot;\xfc\x07&#x27;

çˆ†ç ´ç§˜é’¥å°±å¥½ï¼Œaièƒ½ä¸€æŠŠæ¢­ï¼š
from Crypto.Cipher import DESimport stringfrom itertools import product# ç»™å®šçš„å¯†æ–‡c = b&#x27;\xe6\x8b0\xc8m\t?\x1d\xf6\x99sA&gt;\xce \rN\x83z\xa0\xdc&#123;\xbc\xb8X\xb2\xe2q\xa4&quot;\xfc\x07&#x27;# å¯èƒ½çš„å­—ç¬¦é›†characters = string.ascii_letters + string.digits + string.punctuationdef decrypt(ciphertext, key):    &quot;&quot;&quot;å°è¯•ä½¿ç”¨ç»™å®šçš„å¯†é’¥è§£å¯†ï¼Œä½¿ç”¨é¢˜ç›®ç‰¹å®šçš„å¡«å……æ–¹æ¡ˆ&quot;&quot;&quot;    try:        cipher = DES.new(key, DES.MODE_ECB)        data = cipher.decrypt(ciphertext)                # èŽ·å–åŽŸå§‹æ¶ˆæ¯é•¿åº¦ï¼ˆå¡«å……å­—ç¬¦çš„å€¼ï¼‰        msg_len = data[-1]                # è®¡ç®—å¡«å……é•¿åº¦        pad_len = 8 - (msg_len % 8)        if pad_len == 0:  # å¦‚æžœé•¿åº¦æ˜¯8çš„å€æ•°            pad_len = 8                # éªŒè¯å¡«å……æ˜¯å¦æ­£ç¡®        if all(byte == msg_len for byte in data[-pad_len:]):            # ç§»é™¤å¡«å……å¹¶è¿”å›žåŽŸå§‹æ¶ˆæ¯            return data[:-pad_len]    except:        pass    return Nonedef main():    &quot;&quot;&quot;ä¸»å‡½æ•°ï¼Œçˆ†ç ´å¯†é’¥å¹¶è§£å¯†&quot;&quot;&quot;    # ç”Ÿæˆæ‰€æœ‰å¯èƒ½çš„3å­—ç¬¦ç»„åˆ    total = len(characters) ** 3    count = 0        print(f&quot;å¼€å§‹çˆ†ç ´ &#123;total&#125; ç§å¯èƒ½çš„å¯†é’¥ç»„åˆ...&quot;)        # ä½¿ç”¨ç¬›å¡å°”ç§¯ç”Ÿæˆæ‰€æœ‰å¯èƒ½çš„3å­—ç¬¦åŽç¼€    for suffix in product(characters, repeat=3):        count += 1        if count % 100000 == 0:            print(f&quot;è¿›åº¦: &#123;count&#125;/&#123;total&#125; (&#123;count/total*100:.1f&#125;%)&quot;)                # æž„å»ºå®Œæ•´å¯†é’¥        key_str = &#x27;ezdes&#x27; + &#x27;&#x27;.join(suffix)        key = key_str.encode(&#x27;utf-8&#x27;)                # å°è¯•è§£å¯†        result = decrypt(c, key)                # å¦‚æžœè§£å¯†æˆåŠŸå¹¶ä¸”ç»“æžœåŒ…å« moectf æ ‡å¿—        if result and b&#x27;moectf&#123;&#x27; in result:            print(f&quot;\næ‰¾åˆ°æœ‰æ•ˆå¯†é’¥: &#123;key_str&#125;&quot;)            print(f&quot;è§£å¯†ç»“æžœ: &#123;result.decode()&#125;&quot;)            return        print(&quot;çˆ†ç ´å®Œæˆï¼Œæœªæ‰¾åˆ°æœ‰æ•ˆå¯†é’¥ã€‚å°è¯•æ£€æŸ¥å¡«å……é€»è¾‘æˆ–å¯†é’¥ç©ºé—´ã€‚&quot;)if __name__ == &quot;__main__&quot;:    main()

æ‰¾åˆ°æœ‰æ•ˆå¯†é’¥: ezdes8brè§£å¯†ç»“æžœ: moectf{_Ju5t envmEra+e.!}
3.baby_nextåŽŸé¢˜ï¼š
from Crypto.Util.number import *from gmpy2 import next_primefrom functools import reducefrom secret import flagassert len(flag) == 38assert flag[:7] == b&#x27;moectf&#123;&#x27;assert flag[-1:] == b&#x27;&#125;&#x27;def main():    p = getPrime(512)    q = int(reduce(lambda res, _: next_prime(res), range(114514), p))    n = p * q    e = 65537    m = bytes_to_long(flag)    c = pow(m, e, n)    print(f&#x27;&#123;n = &#125;&#x27;)    print(f&#x27;&#123;c = &#125;&#x27;)if __name__ == &#x27;__main__&#x27;:    main()&quot;&quot;&quot;n = 96742777571959902478849172116992100058097986518388851527052638944778038830381328778848540098201307724752598903628039482354215330671373992156290837979842156381411957754907190292238010742130674404082688791216045656050228686469536688900043735264177699512562466087275808541376525564145453954694429605944189276397c = 17445962474813629559693587749061112782648120738023354591681532173123918523200368390246892643206880043853188835375836941118739796280111891950421612990713883817902247767311707918305107969264361136058458670735307702064189010952773013588328843994478490621886896074511809007736368751211179727573924125553940385967&quot;&quot;&quot;

next_primeçš„åº”ç”¨ï¼Œä¹Ÿæ˜¯çˆ†ç ´ä¸€ä¸‹ï¼Œå› ä¸ºæ•°æ®é‡ä¸å¤§ï¼Œç»™ç‚¹æè¿°å°±èƒ½ä¸€æŠŠæ¢­äº†
from gmpy2 import isqrt, next_prime, mpzfrom Crypto.Util.number import long_to_bytesn = mpz(96742777571959902478849172116992100058097986518388851527052638944778038830381328778848540098201307724752598903628039482354215330671373992156290837979842156381411957754907190292238010742130674404082688791216045656050228686469536688900043735264177699512562466087275808541376525564145453954694429605944189276397)c = mpz(17445962474813629559693587749061112782648120738023354591681532173123918523200368390246892643206880043853188835375836941118739796280111891950421612990713883817902247767311707918305107969264361136058458670735307702064189010952773013588328843994478490621886896074511809007736368751211179727573924125553940385967)e = 65537def factor_n(n):    &quot;&quot;&quot;é«˜æ•ˆåˆ†è§£æŽ¥è¿‘çš„ç´ æ•°å› å­&quot;&quot;&quot;    a = isqrt(n)  # ç²¾ç¡®æ•´æ•°å¹³æ–¹æ ¹        # ä»Žå¹³æ–¹æ ¹å¼€å§‹å‘å‰æœç´¢ç´ æ•°ä½œä¸ºå€™é€‰p    p = next_prime(a - 10**7)  # ä»Žç¨ä½ŽäºŽå¹³æ–¹æ ¹çš„ä½ç½®å¼€å§‹        # å°è¯•på’ŒpåŽé¢çš„114514ä¸ªç´ æ•°ä½œä¸ºq    for _ in range(10000000):  # å®‰å…¨èŒƒå›´å†…æœç´¢        q = n // p                # æ£€æŸ¥æ˜¯å¦æ‰¾åˆ°æœ‰æ•ˆå› å­        if p * q == n:            return p, q                # ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªå€™é€‰p        p = next_prime(p)        return None, Nonep, q = factor_n(n)if p and q:    phi = (p-1)*(q-1)    d = pow(e, -1, phi)    m = pow(c, d, n)    flag = long_to_bytes(int(m))    print(&quot;Flag:&quot;, flag.decode())else:    print(&quot;æœªæ‰¾åˆ°å› å­&quot;)



flagï¼š  moectf{vv0W_p_m1nu5_q_i5_r34l1y_sm4lI}
4.ez_squareåŽŸé¢˜ï¼š
from Crypto.Util.number import *from secret import flagassert len(flag) == 35assert flag[:7] == b&#x27;moectf&#123;&#x27;assert flag[-1:] == b&#x27;&#125;&#x27;def main():    p = getPrime(512)    q = getPrime(512)    n = p * q    e = 65537    m = bytes_to_long(flag)    c = pow(m, e, n)    hint = pow(p + q, 2, n)    print(f&#x27;&#123;n = &#125;&#x27;)    print(f&#x27;&#123;c = &#125;&#x27;)    print(f&#x27;&#123;hint = &#125;&#x27;)if __name__ == &#x27;__main__&#x27;:    main()&quot;&quot;&quot;n = 83917281059209836833837824007690691544699901753577294450739161840987816051781770716778159151802639720854808886223999296102766845876403271538287419091422744267873129896312388567406645946985868002735024896571899580581985438021613509956651683237014111116217116870686535030557076307205101926450610365611263289149c = 69694813399964784535448926320621517155870332267827466101049186858004350675634768405333171732816667487889978017750378262941788713673371418944090831542155613846263236805141090585331932145339718055875857157018510852176248031272419248573911998354239587587157830782446559008393076144761176799690034691298870022190hint = 5491796378615699391870545352353909903258578093592392113819670099563278086635523482350754035015775218028095468852040957207028066409846581454987397954900268152836625448524886929236711403732984563866312512753483333102094024510204387673875968726154625598491190530093961973354413317757182213887911644502704780304&quot;&quot;&quot;

rsaåŠ å¯†å…¬å¼çš„è€ƒå¯Ÿï¼Œä¸éš¾ï¼Œä¹Ÿèƒ½ä¸€æŠŠæ¢­
import mathfrom Crypto.Util.number import long_to_bytes# å·²çŸ¥å‚æ•°n = 83917281059209836833837824007690691544699901753577294450739161840987816051781770716778159151802639720854808886223999296102766845876403271538287419091422744267873129896312388567406645946985868002735024896571899580581985438021613509956651683237014111116217116870686535030557076307205101926450610365611263289149c = 69694813399964784535448926320621517155870332267827466101049186858004350675634768405333171732816667487889978017750378262941788713673371418944090831542155613846263236805141090585331932145339718055875857157018510852176248031272419248573911998354239587587157830782446559008393076144761176799690034691298870022190hint = 5491796378615699391870545352353909903258578093592392113819670099563278086635523482350754035015775218028095468852040957207028066409846581454987397954900268152836625448524886929236711403732984563866312512753483333102094024510204387673875968726154625598491190530093961973354413317757182213887911644502704780304e = 65537# å…³é”®æŽ¨å¯¼ï¼š(p+q)Â² = (p-q)Â² + 4pqï¼Œè€Œhint = (p+q)Â² mod n = (p-q)Â² mod n# è®¡ç®—s = (p+q)Â² = 4n + hintï¼ˆå› ä¸ºhint = (p-q)Â²ä¸”å°äºŽnï¼‰s = 4 * n + hint# æ±‚sçš„å¹³æ–¹æ ¹å¾—åˆ°p+qs_sqrt = math.isqrt(s)assert s_sqrt * s_sqrt == s, &quot;sä¸æ˜¯å®Œå…¨å¹³æ–¹æ•°ï¼ŒæŽ¨å¯¼é”™è¯¯&quot;# æ±‚hintçš„å¹³æ–¹æ ¹å¾—åˆ°p-qd_sqrt = math.isqrt(hint)assert d_sqrt * d_sqrt == hint, &quot;hintä¸æ˜¯å®Œå…¨å¹³æ–¹æ•°ï¼ŒæŽ¨å¯¼é”™è¯¯&quot;# è®¡ç®—på’Œqp = (s_sqrt + d_sqrt) // 2q = (s_sqrt - d_sqrt) // 2# éªŒè¯p*qæ˜¯å¦ç­‰äºŽnassert p * q == n, &quot;åˆ†è§£nå¤±è´¥&quot;# è®¡ç®—æ¬§æ‹‰å‡½æ•°Ï†(n)phi = (p - 1) * (q - 1)# è®¡ç®—ç§é’¥dï¼ˆeçš„é€†å…ƒï¼‰d = pow(e, -1, phi)# è§£å¯†å¾—åˆ°æ˜Žæ–‡mm = pow(c, d, n)# è½¬æ¢ä¸ºflagflag = long_to_bytes(m)print(&quot;è§£å¯†å¾—åˆ°çš„flag:&quot;, flag.decode())



flagï¼š   moectf{Ma7hm4t1c5_is_@_k1nd_0f_a2t}
5.ezlegendreåŽŸé¢˜ï¼š
from Crypto.Util.number import getPrime, bytes_to_longfrom secret import flagp = 258669765135238783146000574794031096183a = 144901483389896508632771215712413815934def encrypt_flag(flag):    ciphertext = []    plaintext = &#x27;&#x27;.join([bin(i)[2:].zfill(8) for i in flag])    for b in plaintext:        e = getPrime(16)        d = randint(1,10)        n = pow(a+int(b)*d, e, p)        ciphertext.append(n)    return ciphertextprint(encrypt_flag(flag))

æ•°æ®éƒ½ç»™ä½ äº†ï¼Œç›´æŽ¥è¯»æ•°æ®å¾—å‡ºæœªçŸ¥æ•°å°±å¥½äº†
from Crypto.Util.number import isPrimefrom tqdm import tqdm# å·²çŸ¥å‚æ•°p = 258669765135238783146000574794031096183a = 144901483389896508632771215712413815934# å‡è®¾æˆ‘ä»¬æœ‰éƒ¨åˆ†å¯†æ–‡ciphertext = [102230607782303286066661803375943337852, 196795077203291879584123548614536291210, 41820965969318717978206410470942308653, 207485265608553973031638961376379316991, 126241934830164184030184483965965358511, 20250852993510047910828861636740192486, 103669039044817273633962139070912140023, 97337342479349334554052986501856387313, 159127719377115088432849153087501377529, 45764236700940832554086668329121194445, 35275004033464216369574866255836768148, 52905563179465420745275423120979831405, 17032180473319795641143474346227445013, 29477780450507011415073117531375947096, 55487351149573346854028771906741727601, 121576510894250531063152466107000055279, 69959515052241122548546701060784004682, 173839335744520746760315021378911211216, 28266103662329817802592951699263023295, 194965730205655016437216590690038884309, 208284966254343254016582889051763066574, 137680272193449000169293006333866420934, 250634504150859449051246497912830488025, 124228075953362483108097926850143387433, 232956176229023369857830577971626577196, 149441784891021006224395235471825205661, 118758326165875568431376314508740278934, 222296215466271835013184903421917936512, 49132466023594939909761224481560782731, 406286678537520849308828749751513339, 215122152883292859254246948661946520324, 81283590250399459209567683991648438199, 150395133067480380674905743031927410663, 5710878479977467762548400320726575491, 83627753774286426170934105100463456109, 164968224377869331545649899270867630850, 241057183685774160581265732812497247167, 109136287048010096863680430193408099828, 116313129605409961931811582899075031153, 202739016625709380026000805340243458300, 25408225921774957745573142542576755590, 151336258796933656160956289529558246702, 2947189044370494063643525166023973095, 228678413963736672394976193093568181979, 40627063032321835707220414670018641024, 55446789315226949622969082042881319148, 32219108726651509070669836923591948459, 134454924722414419191920784435633637634, 97952023967728640730045857104376826039, 20659076942504417479953787092276592682, 93281761173713729777326842152860901050, 133634773495582264000160065317239987936, 79976720152435218818731114555425458470, 234654694673289327542859971371886984118, 51332273108989067644245919615090753756, 134120280423303717489979349737802826605, 182001158305920226320085758522717203725, 98408798757865562737462169470346158516, 78200435603900368619334272308272773797, 232796357836930341547987600782979821555, 589106968861493082018132081244848952, 24186003230092331554886767628744415123, 236070626491251466741246103662922841423, 238699080882667864827094121849090696547, 141659873734297659078160283051728812410, 228977113517120063860252637394240795552, 236613527842969921794004708284265628300, 145522034982744654991661857596541755396, 249608374387044047328725156440984678776, 325110572051913836681821746093704556, 171492052199838424502681030556098576483, 156498865212994371079795360268866413702, 196747701509389071931992996873572785043, 70811811603137896158765356680364490781, 83672551582385607422240464086955462541, 117961603623637997457153763936550310698, 224448821395214505399297116719025174412, 4598815373009554321735225938200807251, 194892269604260726530091473301914449005, 127484628022155760909820605666827662175, 208706240846212140439291547368645656474, 14102286481104997303651684152195298336, 6129503335471304345451795609683770657, 103799668048593149396277157385628834185, 185813375481410513002496683918106238351, 233491689316882978147517340230794025796, 46274083097168831187719988888816378961, 119487551553664772614629936285345836934, 84340029922118279362389419277915602509, 88253743193124528032223101368846247085, 227895357640018330099501504941388167432, 92189947144174433744195727086236905626, 83114957902192791332190922428847199876, 173535754090441937731619031520699325122, 192309407933789484835602071782330798398, 255421921600128994923738650157598053776, 155535082468314012733563336837641958625, 49064798421022327310707074253263463055, 161216416471071644769301963857685054031, 252480348817188872515008985698620059851, 75854882798183185741756645038434215611, 256065006192683011190132982128640682537, 87507510173514424105732562474643251223, 163309795132131534875147566536485288212, 253583084320404985699510129361746869059, 253300112521651972637580307326576568313, 239027717080729650738678032571840680727, 117444657686971615526398894470673026034, 215470942802874046857958621181684551426, 58767098748728136687851735836323448020, 249357164697409977883764098879705065535, 174705348385893117518084017669958647345, 211108767177375215605155301209259781232, 57829566748907062397366819001461941421, 88265742700024922112974862134385921564, 80952107622167923709226013231566882261, 236078582132483864916117213281193714198, 193448482646563141692726575550417225891, 245972799166806058223048506073553726233, 10132977708896091601871557249244373666, 201785418152654519825849206312616081028, 15169816744048531212384271865884567710, 122545328290385950043826822277924297182, 202918646192255177261567701479991753600, 32696887488223731055835744711207261936, 88319352182963224921157305627381030375, 92381505322264045777004475690398861771, 189745654013352563126968415157143821842, 152254915005998949299817641843658795579, 198032433618991362619448347415342295581, 84073892809321676935569114878067118319, 82243805869584256211699602267760745768, 61994229948266781537191603999495995852, 253668765227759797787675352833142466255, 38865376724677211964966907748953557125, 134615436811268347303232550777225944929, 176932422465426107783498083830285780588, 207573742393618910694054452362826628208, 200033130835394442710748301293534928706, 127536063935293533700918451145963158658, 219125698281820710910675956971948816959, 179795893258398750139395156587561075767, 69649628109726874051635160004398498964, 241433717681314766463039563422535023524, 202664264135718511331695232476272832350, 205151096657425932591242432052912914182, 210305712465948130683966275157181140301, 196555690055906934925300527324955477733, 66817932643964538216259564711698986077, 95270796440975607179107356182889534333, 123226880424532374188134357659879826495, 53506495440223773538415807620524749240, 19253217887083870834249774316467647628, 165699356396365023442008488156823647206, 107809175498119862854792975070673056027, 250453989887421415931162217952559757164, 171492052199838424502681030556098576483, 133778166882550119563444625306816232463, 149009301604122447269581792013291889175, 9982418254629616281350713836647603294, 203486292122499140756846060502464655972, 157686696123400087437836943220926921848, 88338919773540412238116717043122711811, 113265824169274322024623493892867211478, 5549372099744960679418616304893848801, 12431828907518852062050349123660880165, 183957934738536914983862053251433028750, 42027289270308356303682029801998790750, 117406080036483925915502666019795783905, 154312255292300186042636734144948304054, 143706917273862261295046346995206133170, 50088136095338601440516112338120787526, 250634504150859449051246497912830488025, 8073010289877796888705519374892639903, 40049582814576788803483039836229025416, 227012342545923833983403067401561291645, 201776603581414625783054400184026088994, 55474945478884522762318445841998187357, 221515530211550293408010846844218019597, 172650752042211610909190315288155597255, 67046194931321172530462444254204111483, 207435868835185636819659137800256834557, 188063222224545200294767050268070647452, 58099349021260301211275261896736590564, 23598877596106927870697531042828774738, 58546308516383335224739442370238545000, 58125311541947998710088435169901475101, 238219925698115060748249043752036454438, 203910234934340893915761800653823457631, 190854889967769152565565000250829375099, 37573623890629846209257307181880876288, 226220240200270623843038279593586687278, 144246075981535671790438155977352345487, 14665770553338784222331493932533448756, 37992062606775322664977502677838074649, 47370175759976523832233910009306151684, 97047813247943880266351445874642842468, 237607444658797800072728280983357541134, 174853113478993738890584814806707459112, 17104608155861584438824639050715857607, 83639027011494777283064583268678718843, 237826165608708003941944469905843354705, 231707683915242052796886276983724691027, 146089830852925550139294146760718642221, 25604562707667550478623425477029052785, 108577663147976992047614498924706939204, 69040319834829375335287614995435269276, 169933229202934375632745753379104389929, 72693008284867494808267387710985847974, 158548279589965576940349068403862889270, 49458101234256610254825879149914255140, 24389558269688411084589654047215902968, 210567980379246548727819953025607019254, 110423375132252997825868399832298953831, 109589895677661968369424757992411668628, 66177577069199763925999718357846633613, 83602293803708828242273186265396676466, 172226271050176278536911356541786290551, 85799805809703976643034084477579915867, 179399990302447560847151603157937241688, 81687654752229170984692833277072534294, 160766441640281044008645821822296569868, 100306680611749750243920501921769642984, 42195187332833922597871030332905266026, 238918420772178508359295233180536910768, 221685929158944699801776621298532178665, 209349638787804999657456057184702655805, 183953393268431043006359511952782903516, 137364333131365794683132159746962959967, 15637689373906596015395350692459218048, 145956368418289159411911667337899986262, 197987711355277581048877821432652325207, 125421308989313724733467092345532539875, 90525081516582408488547894471421476595, 107405840115256692042814887586009104950, 71587500700172519801649824611045199280, 10155721246869986043302768283257682883, 100522792569358427133597834727509523742, 244473925018526409824670892423775482110, 50746138425761666610345252577572889037, 142188269919422432629363225167297071042, 8235113926890598897465093754260801947, 174540885017405784646782293055852044631, 171949847901434672429841435895697323702, 34391199559497599434575002007581170988, 7337868660819385932166025474594964373, 89608475952042154068811282935241824949, 162561097613906905390170334328135062933, 252566077272083954707900007055640560669, 4284637988579219107997224848114896904, 220026371387782427901244689037957398829, 86019060485320999498155965142619258089, 19304861731281576405798605142335886482, 123188238667151068575810494833929221938, 125089740978532716086813732154638565196, 252061524500088702951562270741214799294, 89528875472312768404823823905699760649, 63307407053590054220492282094909190524, 24389558269688411084589654047215902968, 43835777110183833958990705735152973942, 196543204310466258426232803779025620993, 225032412767857179129234169288824097261, 50292890880286260984317361296226049436, 64928956886509273090981701066528078331, 25408225921774957745573142542576755590, 235921667882292842303120860570747218086, 217132603855089441017750752624514343437, 11106129204256119599329380588789107048, 147501327490657927610543345089238991876, 158091159632919983870444592039392730373, 254215886971254771885657857148535673338, 129869106474614345624950211566868568809, 10425702332274469498479699675668087022, 136595953187315682777976356839442311764, 1607792140397737044118662059498732982, 23710000155612873207506044342091514799, 118571340370877720354330132780832828911, 194624784476702188629452374731837038856, 51332273108989067644245919615090753756, 240921043405288511960365826273938845156, 158670188709175825212687487436006138030, 133641825913283256858340618209700716053, 43054466484232130048301271684438593412, 20361972967806283315536154125012604660, 135700832615866572032111395529532615300, 160609169788639387827865051539103507016, 100576279475451993660766480883708996211, 215424685541583305069271024253690375127, 60018956375784961551937423504137141702, 107997941230633604720421526632224279451, 219482010609171816035007605036664317041, 22173526221024380740269311947729076493, 249746554302052221287371350978970766087, 93207359085331319264650563354951254906, 221421697282310997113867048083058096452, 61834092635779365101011109381392037516, 162215218701897689647766394615098617152, 141856131587452385513407955541400099703, 177910903795887762773545874929605680469, 228832704523723308335513552177377803295, 229427981969125094398744034150988525118, 217938760689082034514008764751385239765, 3238055163645731541423094980789895030, 42308449860804765793467328093112118974, 254764518926620089428032312378507653680, 215733901156118606036318409454786603209, 59640829345183339336712595595022506261, 33515071724475649656070325837411550208, 51175659069843551646353202764296812462, 211462959696081863041546889096760952490, 230559603938699838189391087728971115767, 85878911733601049548471257838175175563, 214134904074265214033878852207103328297, 160702405980652445507529591230654474171, 223755040649990285320102091954198427148, 166476753890268002826149533120107157745, 26283916639129998224675164834425763384, 232971495542024495583092055361321729894, 79741799146769724681649849525636816379, 228506526471280046809909301748098760369, 167502422063741368765891061653686283332, 26984184590668253713951516794937308166, 105952393031190074432183821281493254, 113823192955281698937767041115166174652, 93264047694114869263275726820602569731, 55481974783112950660682138071588408040, 108961894273530837550182447112767144669, 47975793549419083945738147934068241928, 204024371586357035343484206754422857590, 251859351272989525849999231358507018068, 75939709807860493804628805619699991501, 129031774446142139804436921156668129187, 110764318451937254261883856778359218969, 246404864722813298477426808193494673610, 153818236564405157581869620439634140065, 246125932167584353084676586883038397451]# é¢„è®¡ç®—16ä½ç´ æ•°primes_16bit = [i for i in range(2, 2**16) if isPrime(i)]def decrypt_bit(n):    for b in [0, 1]:  # å°è¯•0å’Œ1        for d in range(1, 11):  # å°è¯•dä»Ž1åˆ°10            for e in primes_16bit:  # å°è¯•æ‰€æœ‰16ä½ç´ æ•°                if pow(a + b*d, e, p) == n:                    return str(b)    return &#x27;?&#x27;  # æœªæ‰¾åˆ°# è§£å¯†æ‰€æœ‰ä½plain_bits = []for n in tqdm(ciphertext):    plain_bits.append(decrypt_bit(n))# å°†äºŒè¿›åˆ¶å­—ç¬¦ä¸²è½¬æ¢å›žå­—èŠ‚plaintext = &#x27;&#x27;.join(plain_bits)flag = bytes(int(plaintext[i:i+8], 2) for i in range(0, len(plaintext), 8))print(flag)

flagï¼šbâ€˜moectf{Y0u_h@v3_ju5t_s01v3d_7h1s_pr0b13m!}â€™
æ€»ç»“ï¼šä¸ºæ•°ä¸å¤šèƒ½akçš„å¯†ç ï¼ˆå¦‚æžœåŽç»­ä¸ä¸Šé¢˜çš„è¯ï¼‰ï¼Œåˆšå­¦ä¸¤ä¸‰ä¸ªæœˆçš„å¯†ç æ‰‹é€‚åˆåšï¼Œå¯ä»¥å¢žå¼ºä¸€ä¸‹ä¿¡å¿ƒä»¥åŠç»ƒä¸€ä¸‹åŸºæœ¬åŠŸ
æœ€åŽï¼Œæµ‹è¯•ä¸€ä¸‹å›¾ç‰‡ï¼š

å“¦ï¼ŒåŽç»­ä¼šç»§ç»­ä¸Šé¢˜
]]></content>
      <categories>
        <category>CTF</category>
        <category>Crypto</category>
      </categories>
      <tags>
        <tag>CTF</tag>
        <tag>Crypto</tag>
      </tags>
  </entry>
  <entry>
    <title>Javaé¢è¯•2</title>
    <url>/2025/09/26/Java%E9%9D%A2%E8%AF%952/</url>
    <content><![CDATA[Javaé¢è¯•2hré¢ï¼šé—®ä¸ªäººä¿¡æ¯ï¼Œæ²¡é—®æŠ€æœ¯é—®é¢˜
åŽç«¯é¢ï¼šè‡ªæˆ‘ä»‹ç»1ï¼Œaopæ˜¯ä»€ä¹ˆï¼Œé€šå¸¸æ€Žä¹ˆä½¿ç”¨
2ï¼Œiocï¼Œè¿™æ¬¡æ¯”ä¸Šæ¬¡å¼ºï¼Œä¸Šæ¬¡ç›´æŽ¥è¯´ä¸ä¼šï¼Œè¿™æ¬¡è¯´äº†æŽ§åˆ¶åè½¬ï¼Œä¾èµ–æ³¨å…¥ï¼Œç„¶åŽè¯´äº†ä¸ä¼š
3ï¼Œbeançš„ç”Ÿå‘½å‘¨æœŸï¼Œåªè¯´äº†å®¹å™¨åŒ–åˆå§‹åŒ–é”€æ¯ï¼Œç„¶åŽè¯´ä¸ä¼š
4ï¼Œsychorynatheenï¼ˆå¿˜äº†å’‹æ‹¼äº†ï¼‰ï¼Œé‚£ä¸ªä»€ä¹ˆé”ï¼Œé—®äº†æ˜¯ä¸æ˜¯å¯é‡å…¥é”ï¼Œä½¿ç”¨åœºæ™¯ã€‚è¿™ä¸ªä¹Ÿæ˜¯ä¸ä¼š
5ï¼Œé—®äº†é¡¹ç›®ä¸­åœ¨å“ªä½¿ç”¨æ•°æ®åº“ï¼Œæ€Žä¹ˆä½¿ç”¨æ•°æ®åº“çš„
6ï¼Œæ€Žä¹ˆå…³è”ä¸åŒè¡¨ï¼Œæ€Žä¹ˆä¿è¯å…³è”è¡¨çš„æ•°æ®ä¸€è‡´æ€§ï¼Œè¡¨çš„ç´¢å¼•æœ‰å“ªäº›ï¼Œä½ åœ¨é¡¹ç›®ä¸­ä¸»è¦ç”¨åˆ°äº†å“ªäº›ç´¢å¼•ï¼Œä½ åœ¨é¡¹ç›®ä¸­å†™çš„æœ€å¤æ‚çš„sqlè¯­å¥
7ï¼Œé—®äº†redisåœ¨é¡¹ç›®ä¸­ä½¿ç”¨
8ï¼Œé—®äº†rsa
ï¼Œï¼Œï¼Œé¡¹ç›®å’Œåœºæ™¯è¿˜é—®å…¶ä»–çš„äº†ï¼Œä½†æˆ‘å¿˜äº†
å‰ç«¯ï¼šå‰ç«¯é—®äº†gitå’ŒLinuxï¼Œå› ä¸ºæˆ‘è¯´ä¸ä¼šå†™å‰ç«¯ä»£ç ï¼Œåªçœ‹å¾—æ‡‚å†™è·¯ç”±å’ŒæŽ’æŸ¥bug1ï¼Œä½ æ€Žä¹ˆä½¿ç”¨gitçš„
2ï¼Œgitä½ é¡¹ç›®å†™å¥½äº†ä¸€éƒ¨åˆ†æ€Žä¹ˆå…³è”ä¸¤ä¸ªä»“åº“ï¼Œæˆ‘è¯´ï¼šå…ˆå…³è”ä¸€ä¸ªç„¶åŽè§£å¼€æƒé™å†å…³è”å¦ä¸€ä¸ªï¼Œä»–é—®æˆ‘å…·ä½“æ“ä½œæˆ‘è¯´æˆ‘æ²¡å®žè·µè¿‡
3ï¼Œä½ é¡¹ç›®å†™å¥½ä¸€éƒ¨åˆ†ï¼Œä¸æƒ³ä¸Šä¼ gitä¹Ÿä¸æäº¤åˆ°æœ¬åœ°ï¼Œä½ æ€Žä¹ˆæš‚å­˜é¡¹ç›®ï¼Œæˆ‘å¤§æ¦‚æ„æ€ï¼šä¿å­˜ä¸€ä¸‹ç„¶åŽå°±å¥½äº†ï¼Œä¸‹æ¬¡ç»§ç»­å†™ã€‚ä½†ï¼Œé¢ï¼Œé¢è¯•å®˜å¥½åƒæœ‰ç‚¹æ‡µé€¼ï¼Œç„¶åŽè¿½é—®ï¼Œæˆ‘è¯´æ‹¿ideaä¸¾ä¾‹ï¼Œcsä¿å­˜ä¸€ä¸‹ä¸‹æ¬¡ç»§ç»­å†™å°±å¥½äº†
4ï¼ŒLinuxä½ æ€Žä¹ˆä½¿ç”¨
5ï¼Œæ€Žä¹ˆç¼–è¾‘æ–‡ä»¶
å…¶ä»–çš„å¿˜äº†é¢è¯•å®˜éƒ½æŒºå‹å–„ï¼Œä¸èµ–
]]></content>
      <categories>
        <category>Java</category>
        <category>é¢è¯•</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>é¢è¯•</tag>
      </tags>
  </entry>
  <entry>
    <title>Javaé¢è¯•1</title>
    <url>/2025/09/26/Java%E9%9D%A2%E8%AF%951/</url>
    <content><![CDATA[Javaé¢è¯•1åŒ—äº¬æ˜‡è…¾è‡ªæˆ‘ä»‹ç»
1.aopä»‹ç»å’Œåœ¨é¡¹ç›®ä¸­å“ªé‡Œä½¿ç”¨äº†
æˆ‘ï¼šä»€ä¹ˆaopï¼Œæˆ‘åªçŸ¥é“é¢å‘åˆ‡é¢ç¼–ç¨‹ä»€ä¹ˆä»€ä¹ˆçš„ï¼Œé¡¹ç›®ä¸­æˆ‘ä¹Ÿä¸æ™“å¾—ç”¨æ²¡ç”¨ï¼ŒåªçŸ¥é“è¿™ä¸ªæ¦‚å¿µï¼Œå¥½åƒæ²¡æœ‰å…·ä½“ä½¿ç”¨ã€‚
ç­”æ¡ˆï¼š

AOPæ¦‚å¿µï¼š â€œAOPæ˜¯é¢å‘åˆ‡é¢ç¼–ç¨‹ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯å°†é‚£äº›éå¸ƒåœ¨ä¸šåŠ¡é€»è¾‘ä¸­å„å¤„çš„ã€é€šç”¨çš„åŠŸèƒ½ï¼ˆæ¯”å¦‚æ—¥å¿—è®°å½•ã€æƒé™æ£€æŸ¥ã€äº‹åŠ¡ç®¡ç†ï¼‰æŠ½å–å‡ºæ¥ï¼Œåšæˆç‹¬ç«‹çš„â€˜åˆ‡é¢â€™ï¼Œç„¶åŽé€šè¿‡é¢„ç¼–è¯‘æ–¹å¼æˆ–è¿è¡Œæ—¶åŠ¨æ€ä»£ç†çš„æ–¹å¼ï¼Œåœ¨ä¸ä¿®æ”¹åŽŸæœ‰ä¸šåŠ¡ä»£ç çš„æƒ…å†µä¸‹ï¼Œæ¨ªå‘åœ°ç»‡å…¥åˆ°ä¸šåŠ¡é€»è¾‘ä¸­ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯ä¸šåŠ¡æ¨¡å—æ›´åŠ çº¯å‡€ï¼Œåªå…³æ³¨æ ¸å¿ƒé€»è¾‘ï¼Œä»£ç å¤ç”¨æ€§æžé«˜ã€‚â€

é¡¹ç›®åº”ç”¨ï¼š ï¼ˆè¿™æ˜¯å…³é”®ï¼Œä¸€å®šè¦ç»“åˆé¡¹ç›®ï¼ï¼‰

ï¼ˆè®ºå›é¡¹ç›®ï¼‰ â€œåœ¨æˆ‘çš„æ ¡å›­è®ºå›é¡¹ç›®é‡Œï¼Œæˆ‘ä½¿ç”¨AOPå®žçŽ°äº†å…¨å±€çš„æ“ä½œæ—¥å¿—è®°å½•ã€‚æˆ‘è‡ªå®šä¹‰äº†ä¸€ä¸ª@Logæ³¨è§£ï¼Œåªè¦åœ¨Controllerçš„æ–¹æ³•ä¸ŠåŠ ä¸Šè¿™ä¸ªæ³¨è§£ï¼ŒAOPå°±ä¼šè‡ªåŠ¨æ‹¦æˆªè¿™ä¸ªæ–¹æ³•ï¼Œåœ¨æ–¹æ³•æ‰§è¡ŒåŽï¼Œå°†ç”¨æˆ·IDã€æ“ä½œå†…å®¹ã€IPåœ°å€ã€æ‰§è¡Œæ—¶é—´ç­‰è®°å½•åˆ°æ•°æ®åº“é‡Œã€‚è¿™æ ·å°±ä¸ç”¨åœ¨ä¸ç›¸å…³çš„ä¸šåŠ¡ä»£ç é‡Œåˆ°å¤„å†™log.info()äº†ã€‚â€
ï¼ˆé€šç”¨åœºæ™¯ï¼‰ â€œè¿˜æœ‰å°±æ˜¯ï¼ŒSpringçš„**å£°æ˜Žå¼äº‹åŠ¡ç®¡ç†@Transactional**æœ¬èº«å°±æ˜¯åŸºäºŽAOPå®žçŽ°çš„ã€‚åœ¨æˆ‘çš„é¡¹ç›®é‡Œï¼Œæ‰€æœ‰æ¶‰åŠæ•°æ®åº“å¤šæ­¥æ“ä½œçš„æ–¹æ³•ï¼Œæˆ‘éƒ½åŠ ä¸Šäº†è¿™ä¸ªæ³¨è§£æ¥ä¿è¯äº‹åŠ¡ã€‚â€
ï¼ˆCTFé¡¹ç›®ï¼‰ â€œåœ¨Gatewayç½‘å…³é‡Œï¼Œè™½ç„¶ç”¨çš„æ˜¯è¿‡æ»¤å™¨ï¼Œä½†æ€æƒ³å’ŒAOPæ˜¯ç›¸é€šçš„ï¼Œå®žçŽ°äº†ç»Ÿä¸€çš„é‰´æƒå’Œæ—¥å¿—ã€‚â€



2.æ€€ç–‘æˆ‘æ˜¯ä¸æ˜¯è®¡ç®—æœºä¸“ä¸šï¼Œé—®äº†è¯¾ç¨‹
è®¡ç½‘ï¼Œè®¡ç»„ï¼Œæ•°æ®åº“ï¼Œæ•°æ®ç»“æž„
3.é˜Ÿå’Œæ ˆåŒºåˆ«ï¼Œæ ˆèƒ½ä¸èƒ½å®žçŽ°é“¾è¡¨ï¼Œé“¾è¡¨å®žçŽ°æ ˆæ€Žä¹ˆå®žçŽ°
æˆ‘ï¼šåªå›žç­”äº†å…ˆå…¥å…ˆå‡ºå’Œå…ˆå…¥åŽå‡ºï¼Œå¿˜å®Œäº†ã€‚
ç­”æ¡ˆï¼š

åŒºåˆ«ï¼š â€œé˜Ÿåˆ—æ˜¯FIFOï¼Œå…ˆè¿›å…ˆå‡ºï¼Œå°±åƒé£Ÿå ‚æŽ’é˜Ÿã€‚æ ˆæ˜¯LIFOï¼ŒåŽè¿›å…ˆå‡ºï¼Œå°±åƒå ç›˜å­ï¼Œä½ åªèƒ½æ‹¿æœ€ä¸Šé¢é‚£ä¸ªã€‚â€

æ ˆèƒ½ä¸èƒ½å®žçŽ°é“¾è¡¨ï¼š â€œè¿™ä¸ªé—®é¢˜å¯èƒ½æœ‰ç‚¹æ­§ä¹‰ã€‚æˆ‘ç†è§£æ‚¨å¯èƒ½æ˜¯æƒ³é—®èƒ½å¦ç”¨é“¾è¡¨æ¥å®žçŽ°æ ˆï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œè€Œä¸”éžå¸¸åˆé€‚ï¼Œå› ä¸ºé“¾è¡¨åœ¨å¤´èŠ‚ç‚¹çš„æ’å…¥å’Œåˆ é™¤æ“ä½œéƒ½æ˜¯O(1)æ—¶é—´å¤æ‚åº¦çš„ï¼Œå®Œç¾Žå¥‘åˆæ ˆçš„æ“ä½œã€‚â€

é“¾è¡¨å®žçŽ°æ ˆæ€Žä¹ˆå®žçŽ°ï¼ˆå£è¿°æ€è·¯ï¼‰ï¼š

å®šä¹‰ä¸€ä¸ªé“¾è¡¨èŠ‚ç‚¹ç±»Nodeï¼ŒåŒ…å«dataå’ŒnextæŒ‡é’ˆã€‚
å®šä¹‰ä¸€ä¸ªæ ˆç±»LinkedListStackï¼Œå®ƒåªéœ€è¦ä¸€ä¸ªæˆå‘˜å˜é‡ï¼šæŒ‡å‘æ ˆé¡¶çš„èŠ‚ç‚¹topã€‚
å…¥æ ˆpush()ï¼šæ–°å»ºä¸€ä¸ªèŠ‚ç‚¹ï¼Œå°†è¯¥èŠ‚ç‚¹çš„nextæŒ‡å‘å½“å‰çš„topèŠ‚ç‚¹ï¼Œç„¶åŽå°†topæŒ‡é’ˆæŒ‡å‘è¿™ä¸ªæ–°èŠ‚ç‚¹ã€‚
å‡ºæ ˆpop()ï¼šå¦‚æžœtopä¸ä¸ºç©ºï¼Œå…ˆä¿å­˜topèŠ‚ç‚¹çš„å€¼ï¼Œç„¶åŽå°†topæŒ‡é’ˆæŒ‡å‘top.nextï¼Œæœ€åŽè¿”å›žä¿å­˜çš„å€¼ã€‚
æŸ¥çœ‹æ ˆé¡¶peek()ï¼šç›´æŽ¥è¿”å›žtop.dataå³å¯ã€‚



4.redisåœ¨é¡¹ç›®ä¸­çš„åº”ç”¨ï¼Œrediså¦‚ä½•å®žçŽ°æŽ’åï¼Œä¸ºä»€ä¹ˆä¸ç”¨list,ä¸ºä»€ä¹ˆä¸ç”¨mysqlï¼Œå¹¶å‘é‡æ˜Žæ˜Žä¸é«˜ä¸ºä»€ä¹ˆä¸ç”¨mysql
æˆ‘ï¼šå­˜éªŒè¯ç ï¼Œå¾—åˆ†æŽ’åå’Œç‚¹èµžæŽ’åéƒ½ç”¨äº†ï¼ŒæŽ’åç”¨çš„æ˜¯æœ‰åºé›†åˆï¼Œå› ä¸ºæœ‰åºé›†åˆçš„scoreå¾ˆå®¹æ˜“å®žçŽ°ç”±é«˜åˆ°ä½Žçš„æŽ’åï¼Œlistè¿˜è¦è‡ªå·±æŽ’åºä¸€ä¸‹ã€‚mysqlæ€§èƒ½ä½Žï¼Œæˆ‘çš„é¡¹ç›®å¹¶å‘é‡ä¸é«˜ä½†æ˜¯ä¸ºäº†è®©åŽæœŸä¸å†é‡æ–°å†™è¿™ä¸€å—ä»£ç å°±ç”¨äº†redisï¼Œå¹¶ä¸”ç”¨mysqlçš„è¯ä¹Ÿè¦å®žçŽ°è‡ªå·±æŽ’åºã€‚
ç­”æ¡ˆï¼š

ä¸ºä»€ä¹ˆä¸ç”¨Listï¼š â€œListæ˜¯çº¿æ€§ç»“æž„ï¼Œç¼ºä¹æŽ’åºèƒ½åŠ›ã€‚å¦‚æžœè¦å®žçŽ°æŽ’åï¼Œæ¯æ¬¡æœ‰åˆ†æ•°æ›´æ–°éƒ½éœ€è¦å¯¹æ•´ä¸ªListè¿›è¡ŒSORTæ“ä½œï¼Œæ—¶é—´å¤æ‚åº¦æ˜¯O(N log N)ï¼Œæ€§èƒ½éžå¸¸å·®ã€‚è€ŒSorted Setï¼ˆZSetï¼‰åº•å±‚æ˜¯è·³è¡¨ï¼ˆSkipListï¼‰ å’Œå“ˆå¸Œè¡¨ï¼Œæ’å…¥å’Œæ›´æ–°åˆ†æ•°çš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯O(log N)ï¼Œå¹¶ä¸”å…ƒç´ å¤©ç„¶å°±æ˜¯æœ‰åºçš„ã€‚â€
ä¸ºä»€ä¹ˆä¸ç”¨MySQLï¼š â€œè™½ç„¶é¡¹ç›®åˆæœŸå¹¶å‘é‡ä¸é«˜ï¼Œä½†æŽ’åæ˜¯ä¸€ä¸ªé«˜é¢‘è¯»å†™çš„åœºæ™¯ã€‚æ¯æ¬¡æäº¤å¾—åˆ†éƒ½è¦UPDATEåˆ†æ•°ç„¶åŽSELECT ... ORDER BY score DESCï¼Œè¿™ä¸ªORDER BYåœ¨æ•°æ®é‡å¤§æ—¶æ˜¯æ€§èƒ½ç“¶é¢ˆï¼ˆæ¶‰åŠæŽ’åºå’Œæ–‡ä»¶æŽ’åºï¼‰ã€‚MySQLçš„QPSè¿œä½ŽäºŽRedisã€‚ä½¿ç”¨Redisä½œä¸ºç¼“å­˜ï¼Œå°†è¿™éƒ¨åˆ†åŽ‹åŠ›ä»Žæ•°æ®åº“å‰¥ç¦»ï¼Œæ˜¯æ›´ç§‘å­¦çš„æž¶æž„è®¾è®¡ï¼Œä¹Ÿä¾¿äºŽæœªæ¥æ¨ªå‘æ‰©å±•ã€‚MySQLæ›´é€‚åˆä½œä¸ºâ€˜æœ€ç»ˆâ€™çš„æ•°æ®æŒä¹…åŒ–å­˜å‚¨ã€‚â€

5.rediså’Œmysqlçš„ä¸€è‡´æ€§ï¼Œä»–é‚£æœ‰ç‚¹ä¹±ï¼Œæ²¡è¿½é—®ï¼Œåº”è¯¥æ„Ÿè§‰æˆ‘gäº†ï¼Œæƒ³æ—©ç‚¹ç»“æŸ
æˆ‘ï¼šå»¶è¿ŸåŒåˆ ï¼Œå…ˆåˆ æ•°æ®åº“å†åˆ ç¼“å­˜

â€œæˆ‘ä»¬é‡‡ç”¨çš„æ˜¯ç¼“å­˜å¤±æ•ˆæ¨¡å¼ combined with å»¶è¿ŸåŒåˆ ç­–ç•¥ æ¥å°½å¯èƒ½ä¿è¯æœ€ç»ˆä¸€è‡´æ€§ã€‚â€
â€œå†™è¯·æ±‚çš„æµç¨‹æ˜¯ï¼šâ€
å…ˆæ·˜æ±°ï¼ˆåˆ é™¤ï¼‰Redisä¸­çš„ç¼“å­˜æ•°æ®ã€‚
å†æ›´æ–°MySQLæ•°æ®åº“ã€‚
ï¼ˆå»¶è¿ŸåŒåˆ ï¼‰å¼‚æ­¥ç­‰å¾…ä¸€å°æ®µæ—¶é—´ï¼ˆæ¯”å¦‚å‡ ç™¾æ¯«ç§’ï¼Œé€šè¿‡MQæˆ–å¼‚æ­¥çº¿ç¨‹ï¼‰ï¼Œå†æ¬¡æ·˜æ±°Redisç¼“å­˜ã€‚ è¿™ä¸ªæ­¥éª¤æ˜¯ä¸ºäº†æ¸…é™¤åœ¨â€˜æ›´æ–°MySQLâ€™å’Œâ€˜å†æ¬¡è¯»è¯·æ±‚â€™è¿™ä¸ªæ—¶é—´é—´éš™å†…ï¼Œå¯èƒ½è¢«è¯»è¯·æ±‚é‡æ–°åŠ è½½åˆ°Redisé‡Œçš„æ—§æ•°æ®ã€‚


â€œè¯»è¯·æ±‚çš„æµç¨‹æ˜¯ï¼šâ€
å…ˆè¯»Redisï¼Œå‘½ä¸­åˆ™è¿”å›žã€‚
æœªå‘½ä¸­åˆ™è¯»MySQLï¼Œç„¶åŽå°†æ•°æ®å†™å…¥Redisã€‚



6.æ€Žä¹ˆæŸ¥åˆ†æ•°å‰ä¸‰åå­¦ç”Ÿï¼Œè¯´top3å¸ƒæ‹‰å¸ƒæ‹‰çš„ï¼Œä½†æ˜¯ä»–è¯´topä¸æ˜¯æ‰€æœ‰çš„éƒ½æœ‰ï¼Œé‡æ–°è¯´ï¼Œæœ€åŽä¸ä¼š
æˆ‘ï¼šç”¨select top3 ä»€ä¹ˆä»€ä¹ˆçš„ï¼Œè¢«åé©³ä»–è¯´topä¸æ˜¯æ‰€æœ‰çš„éƒ½æœ‰ï¼Œç„¶åŽè¯´ä¸ä¼š
ç­”æ¡ˆï¼š

â€œå¦‚æžœå…è®¸å¹¶åˆ—æŽ’åï¼Œå¹¶ä¸”å¸Œæœ›çœ‹åˆ°æ‰€æœ‰å¹¶åˆ—å‰ä¸‰çš„å­¦ç”Ÿï¼Œå•çº¯çš„LIMIT 3æˆ–TOP 3æ˜¯ä¸è¡Œçš„ï¼Œå› ä¸ºå®ƒä»¬åªè¿”å›žå‰ä¸‰è¡Œã€‚â€

â€œæ ‡å‡†çš„åšæ³•æ˜¯ä½¿ç”¨çª—å£å‡½æ•°ã€‚è¿™é‡Œæœ‰ä¸¤ç§å¸¸ç”¨å‡½æ•°ï¼š

RANK()ï¼šå¦‚æžœæœ‰å¹¶åˆ—ç¬¬ä¸€ï¼Œé‚£ä¹ˆä¸‹ä¸€ä¸ªåæ¬¡æ˜¯ç¬¬ä¸‰ã€‚ä¾‹å¦‚ï¼š1, 1, 3, 4, 5â€¦
DENSE_RANK()ï¼šå¦‚æžœæœ‰å¹¶åˆ—ç¬¬ä¸€ï¼Œé‚£ä¹ˆä¸‹ä¸€ä¸ªåæ¬¡æ˜¯ç¬¬äºŒã€‚ä¾‹å¦‚ï¼š1, 1, 2, 3, 4â€¦


â€œä»¥DENSE_RANK()ä¸ºä¾‹ï¼ŒSQLå¯ä»¥è¿™æ ·å†™ï¼šâ€
sql
-- å‡è®¾è¡¨åæ˜¯ `students`ï¼Œ æœ‰å­—æ®µ `name` å’Œ `score`SELECT name, score, rankingFROM (  SELECT name, score, DENSE_RANK() OVER (ORDER BY score DESC) AS ranking  FROM students) AS tWHERE ranking &lt;= 3;

7.ä¸šåŠ¡æ¨¡å—æ€Žä¹ˆç›¸äº’è°ƒç”¨ï¼Œè®¤è¯æœåŠ¡ç”¨çš„ä»€ä¹ˆæž¶æž„ï¼Ÿ
æˆ‘ï¼šé€šè¿‡feignè°ƒç”¨urlå’Œgatewayç»Ÿä¸€è½¬å‘api
ç­”æ¡ˆï¼š

æœåŠ¡è°ƒç”¨ï¼š â€œå†…éƒ¨æœåŠ¡é—´çš„è°ƒç”¨ï¼Œæˆ‘ä»¬ä½¿ç”¨ Spring Cloud OpenFeign è¿›è¡Œå£°æ˜Žå¼RESTè°ƒç”¨ã€‚è¿™æ ·å°±åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·ï¼Œéžå¸¸ç®€æ´ã€‚åº•å±‚æ˜¯é€šè¿‡HTTPåè®®+Jsonæ ¼å¼è¿›è¡Œçš„é€šä¿¡ã€‚â€
è®¤è¯æž¶æž„ï¼š â€œæˆ‘ä»¬é‡‡ç”¨çš„æ˜¯ Token-Based Authentication æž¶æž„ï¼Œæ ¸å¿ƒæ˜¯ JWTã€‚ç”¨æˆ·ç™»å½•æˆåŠŸåŽï¼Œè®¤è¯ä¸­å¿ƒï¼ˆAuth Serviceï¼‰ä¼šç”Ÿæˆä¸€ä¸ªJWT Tokenè¿”å›žç»™å®¢æˆ·ç«¯ã€‚åŽç»­æ‰€æœ‰è¯·æ±‚ï¼Œå®¢æˆ·ç«¯éƒ½ä¼šåœ¨Headerä¸­æºå¸¦è¿™ä¸ªTokenã€‚â€
æµç¨‹ï¼š â€œAPI Gateway ä½œä¸ºç»Ÿä¸€å…¥å£ï¼Œä¼šæ ¡éªŒTokençš„ç­¾åå’Œæœ‰æ•ˆæœŸï¼ˆè¿™ä¸€æ­¥å¯ä»¥åšç®€å•çš„æœ¬åœ°æ ¡éªŒï¼‰ã€‚æ ¡éªŒé€šè¿‡åŽï¼ŒGatewayä¼šå°†è¯·æ±‚è½¬å‘åˆ°å¯¹åº”çš„ä¸šåŠ¡æœåŠ¡ã€‚ä¸šåŠ¡æœåŠ¡æœ¬èº«ä¸è´Ÿè´£æ ¡éªŒTokençš„åˆæ³•æ€§ï¼Œä½†ä¼šä»ŽTokenä¸­è§£æžå‡ºç”¨æˆ·ä¿¡æ¯ï¼ˆå¦‚userIdï¼‰æ¥è¿›è¡Œä¸šåŠ¡é€»è¾‘å¤„ç†ã€‚â€

8.ç™»å½•tokenæ€Žä¹ˆä¿è¯å®‰å…¨å’Œè®¤è¯ï¼Œè°ƒç”¨ä¸åŒæœåŠ¡tokenæ€Žä¹ˆæ ¡éªŒ
æˆ‘ï¼šæˆ‘åœ¨gatewayå†™äº†filterå’Œspringsecretaryç»Ÿä¸€æ‹¦æˆªå’Œæ ¡éªŒtokenï¼Œå†è½¬å‘åˆ°å„æœåŠ¡
ç­”æ¡ˆï¼š

å®‰å…¨ä¿è¯ï¼š
æ•°å­—ç­¾åï¼š JWTæœ€åŽä¸€éƒ¨åˆ†æ˜¯ç­¾åï¼Œç”±æœåŠ¡ç«¯ç”¨ç§é’¥ç”Ÿæˆã€‚ä»»ä½•å¯¹Headeræˆ–Payloadçš„ç¯¡æ”¹éƒ½ä¼šå¯¼è‡´ç­¾åéªŒè¯å¤±è´¥ã€‚
åŠ å¯†ç®—æ³•ï¼š ä½¿ç”¨å¼ºç®—æ³•å¦‚RS256ï¼ˆéžå¯¹ç§°åŠ å¯†ï¼‰ã€‚
æ•æ„Ÿä¿¡æ¯ï¼š ä¸åœ¨Payloadä¸­å­˜æ”¾æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚å¯†ç ï¼‰ã€‚
HTTPSï¼š ç½‘ç»œä¼ è¾“å…¨ç¨‹ä½¿ç”¨HTTPSï¼Œé˜²æ­¢Tokenè¢«çªƒå–ã€‚
çŸ­æœŸæœ‰æ•ˆï¼š è®¾ç½®è¾ƒçŸ­çš„Tokenè¿‡æœŸæ—¶é—´ï¼Œå¹¶é…å¥—åˆ·æ–°Tokenæœºåˆ¶ã€‚


æœåŠ¡é—´æ ¡éªŒï¼š â€œåœ¨æˆ‘ä»¬çš„æž¶æž„ä¸­ï¼Œä¸šåŠ¡æœåŠ¡æœ¬èº«ä¸éœ€è¦å†æ¬¡æ ¡éªŒTokençš„ç­¾åã€‚å› ä¸ºGatewayå·²ç»å®Œæˆäº†è¿™é¡¹æœ€è€—æ—¶çš„å®‰å…¨å·¥ä½œã€‚ä¸šåŠ¡æœåŠ¡åªéœ€è¦è§£æžTokenï¼Œå–å‡ºå…¶ä¸­çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆå¦‚userIdï¼‰å³å¯ã€‚æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªé€šç”¨çš„JWTè§£æžå·¥å…·ç±»æ¥å®žçŽ°è¿™ä¸€ç‚¹ï¼Œé¿å…æ¯ä¸ªæœåŠ¡éƒ½å†™é‡å¤ä»£ç ã€‚â€

9.ç®¡ç†ç«¯æŽ§åˆ¶æƒé™æ€Žä¹ˆå®žçŽ°
æˆ‘ï¼šæ²¡å†™ç®¡ç†ç«¯ä½†æˆ‘æƒ³è¿‡è¿™ä¸ªé—®é¢˜ï¼Œå½“æ—¶çš„æƒ³æ³•æ˜¯ç”¨ruoyiæ¥ç®¡ç†
ç­”æ¡ˆï¼š

â€œè™½ç„¶æˆ‘çš„é¡¹ç›®é‡Œæ²¡å®žçŽ°ï¼Œä½†æˆ‘æ€è€ƒè¿‡çš„æ–¹æ¡ˆæ˜¯åŸºäºŽ RBACï¼ˆåŸºäºŽè§’è‰²çš„è®¿é—®æŽ§åˆ¶ï¼‰ æ¨¡åž‹æ¥è®¾è®¡ã€‚â€
â€œæ•°æ®åº“å±‚é¢ä¼šæœ‰äº”å¼ æ ¸å¿ƒè¡¨ï¼šç”¨æˆ·è¡¨ã€è§’è‰²è¡¨ã€æƒé™è¡¨ï¼ˆæˆ–èœå•è¡¨ï¼‰ã€ç”¨æˆ·-è§’è‰²å…³è”è¡¨ã€è§’è‰²-æƒé™å…³è”è¡¨ã€‚â€
â€œåœ¨æƒé™æ ¡éªŒå±‚é¢ï¼Œæˆ‘ä¼šåœ¨Gatewayçš„å…¨å±€è¿‡æ»¤å™¨æˆ–æ¯ä¸ªä¸šåŠ¡çš„Controlleræ–¹æ³•ä¸Šï¼Œé€šè¿‡æ³¨è§£ï¼ˆå¦‚@PreAuthorize(&quot;hasAuthority(&#39;user:delete&#39;)&quot;)ï¼‰çš„æ–¹å¼è¿›è¡Œæ‹¦æˆªã€‚ç”¨æˆ·çš„æƒé™ä¿¡æ¯å¯ä»¥åœ¨ç™»å½•æ—¶ä¸€å¹¶åŠ è½½å¹¶æ”¾å…¥JWTï¼Œæˆ–è€…æ¯æ¬¡è¯·æ±‚æ—¶ä»ŽRedisä¸­æŸ¥è¯¢ã€‚â€

10.ä»€ä¹ˆæ¨¡å¼æ¥æž„å»ºæž¶æž„ï¼Ÿä¸ä¼šï¼Œä½†æ˜¯ä»–è¯´mvcä»€ä¹ˆä»€ä¹ˆçš„æ‰æƒ³èµ·æ¥ï¼Œç„¶åŽè¿½é—®è‡ªå·±åœ¨é¡¹ç›®å†™çš„ä¸œè¥¿ä»¥åŠdomainã€‚æ„Ÿè§‰åœ¨æ€€ç–‘æˆ‘é¡¹ç›®æ˜¯ä¸æ˜¯è‡ªå·±å†™çš„
æˆ‘ï¼šä¸çŸ¥é“ä»€ä¹ˆäº‹æ¨¡å¼å°±æ˜¯springbooté‚£ä¸€å¥—ï¼Œä½†æ˜¯ä»–è¯´mvcä»€ä¹ˆä»€ä¹ˆçš„æ‰æƒ³èµ·æ¥ï¼Œç„¶åŽè¿½é—®è‡ªå·±åœ¨é¡¹ç›®å†™çš„ä¸œè¥¿ä»¥åŠdomainï¼Œæˆ‘è¯´å°±æ˜¯å®žä½“ç±»åŠ dtoåŠ voè¿™ä¸€å¥—
ç­”æ¡ˆï¼š

â€œæ‚¨æŒ‡çš„æ˜¯ä»£ç åˆ†å±‚æž¶æž„å¯¹å—ï¼Ÿæˆ‘ä»¬é¡¹ç›®é‡‡ç”¨çš„æ˜¯ç»å…¸çš„ MVCåˆ†å±‚æž¶æž„ å¹¶ç»“åˆäº† DDDï¼ˆé¢†åŸŸé©±åŠ¨è®¾è®¡ï¼‰ çš„ä¸€äº›æ€æƒ³ã€‚â€
â€œå…·ä½“åˆ†å±‚æ˜¯ï¼š
Controllerå±‚ï¼šæŽ¥æ”¶è¯·æ±‚ï¼Œå‚æ•°æ ¡éªŒï¼Œè¿”å›žå“åº”ã€‚ä½¿ç”¨VOå¯¹è±¡ä¸Žå‰ç«¯äº¤äº’ã€‚
Serviceå±‚ï¼šæ ¸å¿ƒä¸šåŠ¡é€»è¾‘å±‚ã€‚æŽ¥å£å’Œå®žçŽ°åˆ†ç¦»ï¼Œä½¿ç”¨DTOå¯¹è±¡åœ¨å±‚é—´ä¼ è¾“ã€‚
Mapper&#x2F;Repositoryå±‚ï¼šè´Ÿè´£ä¸Žæ•°æ®åº“äº¤äº’ï¼Œæ“ä½œEntityå®žä½“å¯¹è±¡ã€‚
æ¨¡åž‹è½¬æ¢ï¼šæˆ‘ä»¬ä¼šä½¿ç”¨MapStructæˆ–Springçš„BeanUtilsåœ¨Entityã€DTOã€VOä¹‹é—´è¿›è¡Œè½¬æ¢ï¼Œé¿å…å°†æ•°æ®åº“å®žä½“ç›´æŽ¥æš´éœ²ç»™å‰ç«¯ã€‚â€


â€œè¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†è§£è€¦ï¼Œè®©å„å±‚èŒè´£å•ä¸€ï¼Œä¾¿äºŽç»´æŠ¤å’Œæµ‹è¯•ã€‚â€

11.å¾®æœåŠ¡é—®äº†äº†è§£ä¸äº†è§£nettyä»€ä¹ˆä»€ä¹ˆï¼Œå¦ä¸€ä¸ªå¾®æœåŠ¡ï¼Œæˆ‘è¯´æˆ‘ç”¨çš„cloudalibabaã€‚
æˆ‘ï¼šä¸äº†è§£ï¼Œæˆ‘ç”¨çš„cloudalibaba
ç­”æ¡ˆï¼š

â€œNettyæˆ‘çŸ¥é“ï¼Œå®ƒæ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„NIOç½‘ç»œç¼–ç¨‹æ¡†æž¶ï¼ŒåƒDubboã€RocketMQã€Elasticsearchè¿™äº›ä¸­é—´ä»¶çš„ç½‘ç»œé€šä¿¡å±‚åº•å±‚éƒ½ç”¨åˆ°äº†Nettyã€‚â€
â€œè™½ç„¶æˆ‘çŽ°åœ¨çš„é¡¹ç›®æ˜¯åŸºäºŽSpring Cloud Alibabaçš„HTTPåè®®ç”Ÿæ€æž„å»ºçš„ï¼Œæ²¡æœ‰ç›´æŽ¥ä½¿ç”¨Netty APIï¼Œä½†æˆ‘ç†è§£å®ƒçš„é‡è¦æ€§ã€‚å¦‚æžœæœªæ¥æœ‰æ›´é«˜æ€§èƒ½ã€éœ€è¦é•¿è¿žæŽ¥ï¼ˆå¦‚IMç³»ç»Ÿï¼‰çš„åœºæ™¯ï¼Œæˆ‘ä¼šä¼˜å…ˆè€ƒè™‘åŸºäºŽNettyçš„æŠ€æœ¯æ ˆï¼Œæ¯”å¦‚ç›´æŽ¥ä½¿ç”¨Dubboè¿›è¡ŒRPCè°ƒç”¨ã€‚â€

12.å¾®æœåŠ¡ä¸¤ä¸ªè¡¨ä¸åœ¨åŒä¸€ä¸ªï¼Œæ€Žä¹ˆå…³è”ï¼Ÿè¯´äº†å‡ ç§ï¼Œéƒ½è¢«å¦å†³äº†ï¼Œåº”è¯¥æ˜¯ä»–æ²¡å¬åˆ°ä»–æƒ³å¬çš„ï¼Œç„¶åŽæˆ‘å°±ä¸ä¼šäº†
æˆ‘ï¼šæˆ‘å†™çš„é¡¹ç›®éƒ½ç”¨çš„ä¸€ä¸ªåº“ï¼Œæ²¡æœ‰ä¸åŒå¾®æœåŠ¡ä¸åŒåº“ï¼Œä¸ä¼šæœ‰è¿™ä¸ªé—®é¢˜ã€‚ä¸æ»¡æ„åŽæŽ¥ç€å›žç­”ï¼šæ¯ä¸ªè°ƒç”¨æ–¹æ³•è°ƒç”¨å…¶ä»–æ–¹æ³•è¿”å›žçš„ç»“æžœæ¥å…³è”ï¼Œä»–è¯´ï¼šé‚£è¿™æ ·æ¯æ¬¡éƒ½éœ€è¦è°ƒç”¨å…¶ä»–æ–¹æ³•ï¼Œæ€§èƒ½ä¸å¥½ã€‚æŽ¥ç€å›žç­”ï¼šç”¨gatewayç»Ÿä¸€ç®¡ç†è°ƒç”¨ä¸Žè¿”å›žï¼Œä»–è¯´gatewayä¸æ˜¯å¿…é¡»çš„ï¼Œæ²¡æœ‰gatewayæ€Žä¹ˆåŠžã€‚ä¹‹åŽæˆ‘è¯´ä¸ä¼šã€‚
ç­”æ¡ˆï¼š

â€œåœ¨æ ‡å‡†çš„å¾®æœåŠ¡æž¶æž„ä¸‹ï¼Œæ•°æ®åº“æ˜¯éšæœåŠ¡æ‹†åˆ†çš„ï¼Œç¦æ­¢è·¨æœåŠ¡ç›´æŽ¥è¿žåº“æŸ¥è¯¢ã€‚å¯¹äºŽè¿™ç§éœ€è¦å…³è”æŸ¥è¯¢çš„åœºæ™¯ï¼Œå¸¸è§çš„è§£å†³æ–¹æ¡ˆæœ‰å‡ ç§ï¼š

APIèšåˆï¼ˆæœ€å¸¸ç”¨ï¼‰ï¼šåœ¨ä¸šåŠ¡ä»£ç å±‚è¿›è¡Œã€‚ç”±æœåŠ¡Aè°ƒç”¨æœåŠ¡Bçš„APIèŽ·å–æ‰€éœ€æ•°æ®ï¼Œç„¶åŽåœ¨å†…å­˜ä¸­è¿›è¡Œå…³è”å’Œç»„è£…ã€‚è¿™æ˜¯æœ€ç›´æŽ¥çš„æ–¹å¼ï¼Œä½†å¯èƒ½ä¼šå¢žåŠ ç½‘ç»œå¼€é”€ã€‚
æ•°æ®å†—ä½™ï¼šï¼ˆè¿™å¯èƒ½æ˜¯ä»–æœ€æƒ³å¬çš„ï¼‰ å°†æœåŠ¡Bçš„æŸäº›å­—æ®µï¼ˆå¦‚user_nameï¼‰å†—ä½™åˆ°æœåŠ¡Açš„æ•°æ®åº“ä¸­ã€‚é€šè¿‡MQç›‘å¬æœåŠ¡Bçš„æ•°æ®å˜æ›´äº‹ä»¶ï¼Œæ¥ä¿è¯å†—ä½™æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚è¿™æ˜¯ä¸€ç§â€˜ä»¥ç©ºé—´æ¢æ—¶é—´â€™çš„è®¾è®¡ï¼Œéžå¸¸é€‚åˆé«˜æ€§èƒ½æŸ¥è¯¢åœºæ™¯ã€‚
CQRSï¼ˆå‘½ä»¤æŸ¥è¯¢èŒè´£åˆ†ç¦»ï¼‰ï¼šæž„å»ºä¸€ä¸ªä¸“é—¨ç”¨äºŽæŸ¥è¯¢çš„è¯»æœåŠ¡ï¼Œå®ƒçš„æ•°æ®æ¥è‡ªå„ä¸ªå¾®æœåŠ¡ï¼Œé€šè¿‡ç›‘å¬é¢†åŸŸäº‹ä»¶ï¼Œå°†æ•°æ®åŒæ­¥åˆ°ä¸€ä¸ªåªè¯»æ•°æ®åº“ï¼ˆå¦‚Elasticsearchï¼‰ä¸­ï¼Œå½¢æˆå®½è¡¨ï¼Œä¸“é—¨åº”å¯¹å¤æ‚çš„è·¨æœåŠ¡æŸ¥è¯¢ã€‚â€



13.é—®äº†rsaåŠ å¯†å¯¹ç§°åŠ å¯†å’Œéžå¯¹ç§°åŠ å¯†ä»€ä¹ˆçš„ï¼Œå†è¯´å­˜å¯†ç ç”¨ä»€ä¹ˆåŠ å¯†æ¯”è¾ƒå¥½
è¿™ä¸ªç§’äº†ï¼Œå› ä¸ºæˆ‘æ‰“ctfå°±æ˜¯å¯†ç æ–¹å‘çš„ï¼Œæ²¡ä»€ä¹ˆå¥½è¯´çš„
14.æ•°æ®åº“ç´¢å¼•ï¼Œå“ªäº›æƒ…å†µä¼šå¯¼è‡´å¤±æ•ˆï¼Œè¿ç®—ç¬¦ä¼šä¸ä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆ
æˆ‘ï¼šå¸ƒæ‹‰å¸ƒæ‹‰ä¸æ‹‰ï¼Œç´¢å¼•å¤±æ•ˆçš„å…«è‚¡æ–‡èƒŒä¸ŠåŽ»äº†
ç­”æ¡ˆï¼š
15.ç„¶åŽé—®åŒ—äº¬èƒ½è¿‡åŽ»ä¸èƒ½ä¹‹ç±»çš„ï¼Œå¤§æ¦‚æ˜¯é—®æ–¹ä¾¿ä¸æ–¹ä¾¿
16.åé—®é—®é¢˜
æ€»ç»“ï¼Œå…«è‚¡åŸºæœ¬æ²¡ä¼šçš„ï¼ŒjavaåŸºç¡€ä¹Ÿå¥½å¤šä¸ä¼šï¼Œé¡¹ç›®ä¹Ÿæœ‰å¾ˆå¤šé—®é¢˜ï¼ŒåŸºæœ¬æ²¡å¸Œæœ›ã€‚
]]></content>
      <categories>
        <category>Java</category>
        <category>é¢è¯•</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>é¢è¯•</tag>
      </tags>
  </entry>
  <entry>
    <title>2025å¤©æœºå­¦å ‚</title>
    <url>/2025/08/11/2025%E5%A4%A9%E6%9C%BA%E5%AD%A6%E5%A0%82/</url>
    <content><![CDATA[2025å¤©æœºå­¦å ‚day01ï¼šåˆå§‹åŒ–é¡¹ç›®è™šæ‹Ÿæœºå¯†ç ï¼šroot      123321
192.168.150.101 git.tianji.com  tjxt  123321192.168.150.101 jenkins.tianji.com    root  123192.168.150.101 mq.tianji.com    tjxt  123321192.168.150.101 nacos.tianji.com      nacos   nacos192.168.150.101 xxljob.tianji.com192.168.150.101 es.tianji.com192.168.150.101 api.tianji.com192.168.150.101 www.tianji.com      jack  123   Rose  123456192.168.150.101 manage.tianji.com192.168.150.101 cpolar.tianji.com





ç‚¹å‡»initåˆå§‹åŒ–è™šæ‹Ÿæœºï¼š
åœ¨VMwareå¾—åˆ°ï¼š

ç„¶åŽåˆå§‹åŒ–ç½‘ç»œé…ç½®ï¼Œæ”¹æˆè¿™æ ·ï¼š

å¯åŠ¨è™šæ‹Ÿæœºï¼Œè™šæ‹Ÿæœºä¸­çš„çŽ¯å¢ƒä¼šè‡ªå¯åŠ¨ï¼Œæˆ‘ä»¬å¯ä»¥è®¿é—®ä¸€ä¸ªè¿›è¡Œæµ‹è¯•ï¼Œè®¿é—®æ˜¯è¦è®¿é—®æˆ‘ç”»çº¢æ¡†çš„urlï¼š192.168.150.101:8848

ç„¶åŽæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨switchhostæ¥ä»£ç†ï¼Œå…·ä½“å¯ä»¥çœ‹æˆ‘switchhostçš„æ–‡ç« 
nginxæ— æ³•å¯åŠ¨é—®é¢˜ï¼Œå°è¯•é‡å¯è¿›è¡Œè§£å†³ï¼šè§£å†³å¤±è´¥ï¼Œä½†æœ€åŽè€—æ—¶å››å°æ—¶å·¦å³è§£å†³äº†ï¼Œé—®é¢˜åœ¨äºŽnginxçš„confçš„è¯­æ³•é—®é¢˜ï¼Œå¤§æ¦‚æ”¹æˆè¿™æ ·å°±å¥½äº†ï¼š

ç„¶åŽå¤åˆ¶åˆå§‹åŒ–é¡¹ç›®åˆ°æœ¬åœ°ï¼š
http://192.168.150.101:10880/tjxt/tianji.git
git clone http://192.168.150.101:10880/tjxt/tianji.git -b lesson-init

ç„¶åŽæ‰“å¼€é¡¹ç›®åˆ·æ–°ä¸€ä¸‹mavenä¸‹ä¸‹ä¾èµ–å°±å¥½äº†
é‡åˆ°bugï¼š

è§£å†³äº†ä¸€ä¸‹åˆï¼Œåˆ°æœ€åŽè¿˜æ˜¯ä¾èµ–é—®é¢˜ï¼šæŠŠè¿™ä¸ªæ³¨é‡Šçš„# åˆ æŽ‰

æŸ¥æ‰¾bugï¼ŒRoseåˆ é™¤è®¢å•æ—¶æ˜¾ç¤ºä¸èƒ½åˆ é™¤ä»–äººè®¢å•
æƒ³è¿œç¨‹è°ƒè¯•ï¼Œæ”¹æˆè¿™æ ·ï¼š

ç„¶åŽå…³æŽ‰tj-tradeï¼Œå¯åŠ¨tj-trade-debug
å½“ç„¶ä¹Ÿå¯ä»¥ç›´æŽ¥æœ¬åœ°è°ƒè¯•ï¼Œä½†æ˜¯æ³¨æ„è°ƒè¯•å‰ç¼–è¾‘é…ç½®æ”¹ä¸ºlocal

å›žåˆ°bugé—®é¢˜ï¼Œå°†&#x3D;æ”¹æˆequalsæˆ–è€…&#x3D;&#x3D;å°±å¥½äº†
ç„¶åŽæŽ¨é€åˆ°æœ¬åœ°çš„gitå°±å¥½äº†
day02ï¼šæˆ‘çš„è¯¾è¡¨å¯¼å…¥domainå’Œenumsç„¶åŽä¸‹è½½mybatisplusæ’ä»¶ç„¶åŽè¿žæŽ¥ï¼š
jdbc:mysql:&#x2F;&#x2F;localhost:192.168.150.101:3306&#x2F;tj_learning?useSSL&#x3D;false&amp;serverTimezone&#x3D;UTC
ä½†æ˜¯é‡åˆ°é—®é¢˜ï¼š

è¿˜æ²¡è§£å†³ï¼Œå› ä¸ºæˆ‘æ•°æ®åº“èƒ½è¿žä¸Šä½†æ˜¯è¿™ä¸ªæ’ä»¶è¿žä¸ä¸Šï¼Œæ‰€ä»¥æš‚æ—¶æ²¡ç®¡è¿˜èƒ½ç»§ç»­å­¦ä¸‹åŽ»
ç„¶åŽå†™é‚£ä¸ªè¯¾ç¨‹å¼„åˆ°æˆ‘çš„è¯¾è¡¨çš„ä»£ç ï¼Œè¿™å°±ä¸å¤åˆ¶äº†ï¼Œæ¯”è¾ƒç®€å•
ç„¶åŽè¿›è¡Œæµ‹è¯•ï¼Œä»–ä¼šæ˜¾ç¤ºæŠ¥åå¤±è´¥ï¼Œå› ä¸ºæ•°æ®åº“æ•°æ®å¤ªè€äº†ï¼Œä½ è‡ªå·±æ”¹ä¸€ä¸‹æ—¶é—´å°±èƒ½æŠ¥åæˆåŠŸäº†
ç„¶åŽç¬¬äºŒä¸ªæ˜¯åˆ†é¡µæŸ¥è¯¢è¯¾è¡¨ï¼Œä¹Ÿæ˜¯ä¸éš¾ï¼Œä½†æ˜¯åˆ«å¿˜äº†åœ¨è¯·æ±‚å¤´ä¸­åŠ user-infoï¼Œè¦ä¸ç„¶ä¼šæŠ¥401
ç¬¬ä¸‰ä¸ªæŸ¥è¯¢æ­£åœ¨å­¦ä¹ çš„è¯¾ç¨‹ä¹Ÿæ˜¯ä¸€æ ·
è¯¾åŽä½œä¸šæˆ‘ç›´æŽ¥æ¬äº†
ä½†æ˜¯day02æœ‰ä¸ªé—®é¢˜ï¼Œæ²¡æœ‰è§£å†³ï¼š

ä½†æ˜¯åŽç«¯æŽ¥å£æ­£å¸¸ä½¿ç”¨ï¼Œæˆ‘å°±æ²¡ç®¡ä»–
day03å­¦ä¹ è®¡åˆ’å’Œè¿›åº¦å†™å®Œä»£ç åŽå‡ºçŽ°bugï¼š

ç„¶åŽå‘çŽ°æ˜¯serviceImplå¿˜åŠ serviceæ³¨è§£äº†ï¼ŒåŠ äº†å°±èƒ½è§£å†³äº†
é‡åˆ°äº†é—®é¢˜ï¼š

è¿™æ˜¯æ•°æ®åº“å»ºè¡¨çš„é—®é¢˜ï¼Œä½†æ„Ÿè§‰ä¿®æ”¹å¤ªéº»çƒ¦äº†ï¼Œæˆ‘ä¸æ”¹äº†ã€‚ä»£ç æœ¬èº«æ²¡é—®é¢˜
å¦å¤–è¿˜æ˜¯å‰ç«¯é—®é¢˜ï¼Œå¯¼è‡´æ•°æ®æ²¡å›žæ˜¾ä½†æ˜¯æŽ¥å£æµ‹è¯•æ²¡é—®é¢˜
day3åŸºæœ¬æ˜¯æ°´è¿‡åŽ»çš„
day04é«˜å¹¶å‘ä¼˜åŒ–u1s1é¢å¯¹é«˜å¹¶å‘ä½ ä¼šæ€Žä¹ˆåŠžï¼Ÿhmé£žä¹¦çš„ç­”æ¡ˆï¼š

è¦æˆ‘è¯´ï¼Œå£å¤´è¡¨è¾¾ä¸€ä¸‹å¤§æ¦‚å°±æ˜¯ï¼š
1.å­˜å…¥redisåŽç»­æ›´æ–°æ•°æ®åº“
2.æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ…¢æ…¢å¤„ç†
3.é™æµ
4.å¼‚æ­¥è¯·æ±‚ï¼Œå…ˆè¿”å›žä¸œè¥¿åŽè¿›è¡Œå¤„ç†  &#x2F;&#x2F;æ„Ÿè§‰å’Œ2é‡å¤äº†
ç„¶åŽå°±æ˜¯æ”¹é€ ä»£ç ï¼Œæ‡’å¾—çœ‹äº†ï¼Œå¤ªæ— èŠã€‚
day05é—®ç­”ç³»ç»Ÿ]]></content>
      <categories>
        <category>Java</category>
        <category>complete_item</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>complete_item</tag>
      </tags>
  </entry>
  <entry>
    <title>Javaå¸¸è§å…«è‚¡</title>
    <url>/2025/08/26/Java%E5%B8%B8%E8%A7%81%E5%85%AB%E8%82%A1/</url>
    <content><![CDATA[Javaå¸¸è§å…«è‚¡ä¸€ã€Java åŸºç¡€ (Java Basics)1. æŽ¥å£ (Interface) vs æŠ½è±¡ç±» (Abstract Class)é¢è¯•å®˜ï¼š è¯´ä¸€ä¸‹æŽ¥å£å’ŒæŠ½è±¡ç±»çš„åŒºåˆ«ã€‚
æˆ‘ï¼šå¥½çš„ï¼ŒæŽ¥å£å’ŒæŠ½è±¡ç±»ä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒåŒºåˆ«ï¼š

è®¾è®¡ç›®çš„ä¸åŒï¼šæŠ½è±¡ç±»æè¿°çš„æ˜¯ â€œis-aâ€ å…³ç³»ï¼Œå¼ºè°ƒç±»çš„æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Œæ¯”å¦‚ Manager æ˜¯ä¸€ä¸ª Employeeã€‚è€ŒæŽ¥å£æè¿°çš„æ˜¯ â€œhas-aâ€ æˆ– â€œcan-doâ€ å…³ç³»ï¼Œå¼ºè°ƒç±»å…·å¤‡ä»€ä¹ˆèƒ½åŠ›ï¼Œæ¯”å¦‚ Bird å¯ä»¥ Flyã€‚
æ–¹æ³•å®žçŽ°ï¼šæŠ½è±¡ç±»å¯ä»¥æœ‰æŠ½è±¡æ–¹æ³•ï¼Œä¹Ÿå¯ä»¥æœ‰å®žçŽ°äº†çš„å…·ä½“æ–¹æ³•ï¼Œç”¨äºŽä»£ç å¤ç”¨ã€‚åœ¨JDK 8ä¹‹å‰ï¼ŒæŽ¥å£åªèƒ½æœ‰æŠ½è±¡æ–¹æ³•ï¼›JDK 8ä¹‹åŽï¼ŒæŽ¥å£å¯ä»¥æ‹¥æœ‰é»˜è®¤æ–¹æ³•ï¼ˆdefaultï¼‰å’Œé™æ€æ–¹æ³•ï¼ˆstaticï¼‰ã€‚
æˆå‘˜å˜é‡ï¼šæŠ½è±¡ç±»ä¸­çš„å˜é‡å¯ä»¥æ˜¯æ™®é€šçš„ï¼Œä¹Ÿå¯ä»¥æ˜¯å¸¸é‡ã€‚è€ŒæŽ¥å£ä¸­å®šä¹‰çš„å˜é‡é»˜è®¤éƒ½æ˜¯ public static final çš„å¸¸é‡ã€‚
æž„é€ æ–¹æ³•ï¼šæŠ½è±¡ç±»æœ‰æž„é€ æ–¹æ³•ï¼Œè™½ç„¶ä¸èƒ½å®žä¾‹åŒ–è‡ªå·±ï¼Œä½†å¯ä»¥ä¾›å­ç±»åˆå§‹åŒ–æ—¶è°ƒç”¨ã€‚æŽ¥å£æ²¡æœ‰æž„é€ æ–¹æ³•ã€‚
ç»§æ‰¿æ€§ï¼šè¿™æ˜¯æœ€å…³é”®çš„å·®åˆ«ã€‚Javaæ˜¯å•ç»§æ‰¿ï¼Œä¸€ä¸ªç±»åªèƒ½ç»§æ‰¿ä¸€ä¸ªæŠ½è±¡ç±»ã€‚ä½†ä¸€ä¸ªç±»å¯ä»¥å®žçŽ°å¤šä¸ªæŽ¥å£ï¼Œä»Žè€ŒèŽ·å¾—å¤šç§èƒ½åŠ›ã€‚

é€‰ç”¨åœºæ™¯ï¼š

å¦‚æžœéœ€è¦å®šä¹‰ä¸€ç³»åˆ—å¯†åˆ‡ç›¸å…³å¯¹è±¡çš„å…±åŒæ¨¡æ¿å’Œè¡Œä¸ºï¼Œä¼˜å…ˆä½¿ç”¨æŠ½è±¡ç±»ã€‚
å¦‚æžœéœ€è¦å®šä¹‰ä¸€ç§èƒ½åŠ›æˆ–å¥‘çº¦ï¼Œè®©ä¸ç›¸å…³çš„ç±»éƒ½èƒ½æ‹¥æœ‰ï¼Œæˆ–è€…éœ€è¦å®žçŽ°å¤šé‡ç»§æ‰¿çš„æ•ˆæžœï¼Œå°±ä½¿ç”¨æŽ¥å£ã€‚


2. å•ä¾‹æ¨¡å¼ (Singleton Pattern) ä¸ŽåŒé‡æ£€æŸ¥é” (Double-Checked Locking)é¢è¯•å®˜ï¼š äº†è§£å•ä¾‹æ¨¡å¼å—ï¼Ÿå†™ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„å•ä¾‹ã€‚
æˆ‘ï¼šå•ä¾‹æ¨¡å¼çš„æ ¸å¿ƒæ˜¯ä¿è¯ä¸€ä¸ªç±»åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½åªæœ‰ä¸€ä¸ªå®žä¾‹ï¼Œå¹¶æä¾›ä¸€ä¸ªå…¨å±€è®¿é—®ç‚¹ã€‚
å®žçŽ°çº¿ç¨‹å®‰å…¨çš„å•ä¾‹æœ‰å¤šç§æ–¹å¼ï¼Œæ¯”å¦‚é¥¿æ±‰å¼ã€æ‡’æ±‰å¼åŠ é”ã€é™æ€å†…éƒ¨ç±»ç­‰ã€‚å…¶ä¸­ï¼ŒåŒé‡æ£€æŸ¥é”ï¼ˆDCLï¼‰ æ˜¯ä¸€ç§æ€§èƒ½å’Œçº¿ç¨‹å®‰å…¨å…¼é¡¾çš„æ‡’åŠ è½½æ–¹æ¡ˆã€‚
ï¼ˆå¦‚æžœè®©å†™ä»£ç ï¼Œæˆ‘ä¼šå†™å‡ºDCLçš„ä»£ç ã€‚ä½†æŒ‰æ‚¨è¦æ±‚ï¼Œè¿™é‡Œä¸åšä»£ç å±•ç¤ºï¼‰
å®ƒçš„æ ¸å¿ƒæ€è·¯æ˜¯ï¼š

å°†å®žä¾‹å¼•ç”¨ç”¨ volatile å…³é”®å­—ä¿®é¥°ã€‚
åœ¨ getInstance æ–¹æ³•ä¸­ï¼Œå…ˆè¿›è¡Œä¸€æ¬¡åˆ¤ç©ºï¼Œå¦‚æžœå®žä¾‹ä¸å­˜åœ¨ï¼Œå†è¿›å…¥åŒæ­¥ä»£ç å—ã€‚
è¿›å…¥åŒæ­¥å—åŽï¼Œå†è¿›è¡Œç¬¬äºŒæ¬¡åˆ¤ç©ºï¼Œæœ€åŽæ‰åˆ›å»ºå®žä¾‹ã€‚

é¢è¯•å®˜ï¼š ä¸ºä»€ä¹ˆè¿™é‡Œå¿…é¡»è¦ç”¨ volatile å…³é”®å­—ï¼Ÿ
æˆ‘ï¼švolatile åœ¨è¿™é‡Œä¸»è¦ä½œç”¨æ˜¯ç¦æ­¢æŒ‡ä»¤é‡æŽ’åºã€‚
instance = new Singleton() è¿™è¡Œä»£ç ä¸æ˜¯ä¸€ä¸ªåŽŸå­æ“ä½œï¼Œå®ƒåˆ†ä¸ºä¸‰æ­¥ï¼š1.åˆ†é…å†…å­˜ã€2.åˆå§‹åŒ–å¯¹è±¡ã€3.å°†å¼•ç”¨æŒ‡å‘å†…å­˜åœ°å€ã€‚JVMå¯èƒ½å¯¹æ­¥éª¤2å’Œ3è¿›è¡Œé‡æŽ’åºã€‚
å¦‚æžœæ²¡æœ‰ volatileï¼Œå¯èƒ½å‘ç”Ÿï¼šçº¿ç¨‹Aæ‰§è¡Œäº†1å’Œ3ï¼Œæ­¤æ—¶ instance ä¸ä¸ºnullï¼Œä½†å¯¹è±¡è¿˜æœªåˆå§‹åŒ–ï¼ˆæ­¥éª¤2æœªæ‰§è¡Œï¼‰ã€‚è¿™æ—¶çº¿ç¨‹Bè¿›æ¥åˆ¤æ–­ instance ä¸ä¸ºnullï¼Œå°±ç›´æŽ¥è¿”å›žäº†ä¸€ä¸ªåŠæˆå“å¯¹è±¡åŽ»ä½¿ç”¨ï¼Œä»Žè€Œå¯¼è‡´é”™è¯¯ã€‚
volatile é€šè¿‡å†…å­˜å±éšœç¦æ­¢äº†è¿™ç§é‡æŽ’åºï¼Œä¿è¯äº†å¯¹è±¡çš„åˆå§‹åŒ–å®Œæˆåœ¨å‰ï¼Œå¼•ç”¨èµ‹å€¼åœ¨åŽï¼Œä»Žè€Œè§£å†³äº†è¿™ä¸ªéšè”½çš„é—®é¢˜ã€‚
å…¶ä»–å®žçŽ°æ–¹å¼çš„å¯¹æ¯”ï¼š

é¥¿æ±‰å¼ï¼šæœ€ç®€å•ï¼Œçº¿ç¨‹å®‰å…¨ï¼Œä½†ä¸æ˜¯æ‡’åŠ è½½ï¼Œå¯èƒ½é€ æˆèµ„æºæµªè´¹ã€‚
åŒæ­¥æ–¹æ³•æ‡’æ±‰å¼ï¼šçº¿ç¨‹å®‰å…¨ï¼Œä½†é”ç²’åº¦å¤ªå¤§ï¼Œæ€§èƒ½å·®ã€‚
é™æ€å†…éƒ¨ç±»ï¼šæˆ‘ä¸ªäººè®¤ä¸ºæ˜¯æœ€ä¼˜é›…çš„å®žçŽ°ä¹‹ä¸€ã€‚å®ƒåˆ©ç”¨ç±»åŠ è½½æœºåˆ¶ä¿è¯äº†çº¿ç¨‹å®‰å…¨ï¼Œä¸”å®žçŽ°äº†æ‡’åŠ è½½ï¼Œæ— éœ€åŠ é”ï¼Œæ€§èƒ½é«˜ã€‚
æžšä¸¾ï¼šæœ€å®‰å…¨çš„æ–¹å¼ï¼Œä¸ä»…èƒ½é¿å…å¤šçº¿ç¨‹é—®é¢˜ï¼Œè¿˜èƒ½é˜²æ­¢åå°„å’Œååºåˆ—åŒ–ç ´åå•ä¾‹ã€‚

äºŒã€Java é›†åˆæ¡†æž¶ (Java Collections Framework)1. HashMap æ·±åº¦è§£æžé¢è¯•å®˜ï¼š èƒ½è¯¦ç»†è¯´è¯´ HashMap çš„å®žçŽ°åŽŸç†å—ï¼Ÿ
æˆ‘ï¼šå¥½çš„ã€‚HashMap çš„æ ¸å¿ƒå®žçŽ°æ˜¯â€œæ•°ç»„ + é“¾è¡¨ + çº¢é»‘æ ‘â€ã€‚

é¢è¯•å®˜ï¼š å…·ä½“è®²è®²å®ƒçš„æ•°æ®ç»“æž„ï¼Ÿ
æˆ‘ï¼š

æ•°æ®ç»“æž„ï¼š
åº•å±‚æ˜¯ä¸€ä¸ª Node&lt;K,V&gt;[] table æ•°ç»„ã€‚
æ•°ç»„çš„æ¯ä¸ªä½ç½®ç§°ä¸ºä¸€ä¸ªâ€œæ¡¶â€ï¼ˆbucketï¼‰ã€‚å­˜å…¥æ—¶ï¼Œæ ¹æ® key çš„ hash å€¼è®¡ç®—å‡ºæ•°ç»„ä¸‹æ ‡ã€‚
å¦‚æžœä¸åŒçš„ key è½åˆ°äº†åŒä¸€ä¸ªæ¡¶é‡Œï¼ˆå“ˆå¸Œå†²çªï¼‰ï¼Œå°±ç”¨é“¾è¡¨æ¥å­˜å‚¨ã€‚
å½“é“¾è¡¨é•¿åº¦è¶…è¿‡é˜ˆå€¼ï¼ˆé»˜è®¤ä¸º8ï¼‰ï¼Œå¹¶ä¸”æ•°ç»„æ€»é•¿åº¦è¾¾åˆ°ä¸€å®šè§„æ¨¡ï¼ˆé»˜è®¤ä¸º64ï¼‰æ—¶ï¼Œé“¾è¡¨ä¼šè½¬æ¢ä¸ºçº¢é»‘æ ‘ã€‚
å½“æ ‘èŠ‚ç‚¹æ•°å°äºŽé˜ˆå€¼ï¼ˆé»˜è®¤ä¸º6ï¼‰æ—¶ï¼Œçº¢é»‘æ ‘ä¼šé€€åŒ–æˆé“¾è¡¨ã€‚




é¢è¯•å®˜ï¼š ä¸ºä»€ä¹ˆè¦å¼•å…¥çº¢é»‘æ ‘ï¼Ÿ
æˆ‘ï¼š

å¼•å…¥çº¢é»‘æ ‘çš„åŽŸå› ï¼š

- è§£å†³æžç«¯æƒ…å†µä¸‹ï¼ˆä¾‹å¦‚å¤§é‡æ•°æ®å“ˆå¸Œå†²çªï¼‰ï¼Œé“¾è¡¨è¿‡é•¿å¯¼è‡´çš„æŸ¥è¯¢æ•ˆçŽ‡ä»Ž O(1) é€€åŒ–ä¸º O(n) çš„é—®é¢˜ã€‚- çº¢é»‘æ ‘æ˜¯ä¸€ç§è‡ªå¹³è¡¡çš„äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œèƒ½å°†æŸ¥è¯¢ã€æ’å…¥ã€åˆ é™¤çš„æ—¶é—´å¤æ‚åº¦æŽ§åˆ¶åœ¨ O(log n)ï¼Œä¿è¯äº†æ€§èƒ½ä¸‹é™ã€‚

é¢è¯•å®˜ï¼š HashMap ä»€ä¹ˆæ—¶å€™æ‰©å®¹ï¼Ÿæ€Žä¹ˆæ‰©ï¼Ÿ
æˆ‘ï¼š

æ‰©å®¹æœºåˆ¶ï¼ˆRehashingï¼‰ï¼š

- å½“å…ƒç´ æ•°é‡è¶…è¿‡ å®¹é‡ * è´Ÿè½½å› å­ï¼ˆé»˜è®¤0.75ï¼‰æ—¶ï¼Œæ•°ç»„ä¼šè¿›è¡Œæ‰©å®¹ï¼ˆé€šå¸¸æ‰©ä¸ºåŽŸæ¥çš„2å€ï¼‰ã€‚- æ‰©å®¹åŽï¼Œæ‰€æœ‰å…ƒç´ éœ€è¦é‡æ–°è®¡ç®—åœ¨æ–°æ•°ç»„ä¸­çš„ä½ç½®ï¼Œè¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒè€—æ—¶çš„æ“ä½œã€‚

é¢è¯•å®˜ï¼š ä¸ºä»€ä¹ˆ HashMap çš„é•¿åº¦æ€»æ˜¯2çš„å¹‚æ¬¡æ–¹ï¼Ÿ
æˆ‘ï¼š

é•¿åº¦ä¸ºä½•æ˜¯2çš„å¹‚æ¬¡æ–¹ï¼š

- ä¸ºäº†é«˜æ•ˆåœ°é€šè¿‡ (n - 1) &amp; hash è®¡ç®— key çš„ç´¢å¼•ä½ç½®ã€‚- &amp; æ“ä½œæ¯”å–æ¨¡è¿ç®— % æ•ˆçŽ‡é«˜å¾—å¤šã€‚å½“æ•°ç»„é•¿åº¦ n ä¸º 2 çš„å¹‚æ—¶ï¼Œ(n - 1) &amp; hash ç­‰ä»·äºŽ hash % nï¼Œä½†æ•ˆçŽ‡æ›´é«˜ï¼ŒåŒæ—¶èƒ½ä¿è¯è®¡ç®—ç»“æžœå‡åŒ€åˆ†å¸ƒã€‚

é¢è¯•å®˜ï¼š ä»Ž JDK7 åˆ° JDK8ï¼ŒHashMap åœ¨è§£å†³å†²çªæ—¶æœ‰ä»€ä¹ˆé‡è¦å˜åŒ–ï¼Ÿ
æˆ‘ï¼š

JDK7å¤´æ’æ³• -&gt; JDK8å°¾æ’æ³•ï¼š

- JDK7 ä½¿ç”¨å¤´æ’æ³•ï¼Œè®¤ä¸ºæ–°æ’å…¥çš„å…ƒç´ æ›´å¯èƒ½è¢«é©¬ä¸Šè®¿é—®ã€‚ä½†åœ¨å¤šçº¿ç¨‹æ‰©å®¹æ—¶ï¼Œå¤´æ’æ³•ä¼šæ”¹å˜é“¾è¡¨çš„é¡ºåºï¼Œå¯èƒ½å¯¼è‡´å½¢æˆçŽ¯å½¢é“¾è¡¨ï¼Œå¼•èµ·æ­»å¾ªçŽ¯å’Œæ•°æ®ä¸¢å¤±ã€‚- JDK8 æ”¹ä¸ºå°¾æ’æ³•ï¼Œæ‰©å®¹æ—¶é“¾è¡¨å…ƒç´ é¡ºåºä¸å˜ï¼Œè§£å†³äº†è¿™ä¸ªæ½œåœ¨é—®é¢˜ã€‚ï¼ˆä½†HashMapæœ¬èº«ä»éžçº¿ç¨‹å®‰å…¨ï¼Œåªæ˜¯è§£å†³äº†è¿™ä¸ªç‰¹å®šçš„æ­»å¾ªçŽ¯Bugï¼‰ã€‚

é¢è¯•å®˜ï¼š ä¸ºä»€ä¹ˆé€‰æ‹©è¿™ç§é“¾è¡¨å’Œçº¢é»‘æ ‘ç»“åˆçš„æ–¹å¼ï¼Ÿ
æˆ‘ï¼š

ä¸ºä½•é‡‡ç”¨é“¾è¡¨+çº¢é»‘æ ‘ï¼š

- è¿™æ˜¯ä¸€ç§åœ¨ç©ºé—´å’Œæ—¶é—´ä¸Šçš„æƒè¡¡ã€‚- é“¾è¡¨ç»“æž„ç®€å•ï¼Œå ç”¨å†…å­˜å°‘ï¼Œä½†åœ¨èŠ‚ç‚¹å¤šæ—¶æ€§èƒ½å·®ã€‚- çº¢é»‘æ ‘æ€§èƒ½å¥½ï¼Œä½†ç»“æž„å¤æ‚ï¼Œå ç”¨å†…å­˜æ›´å¤šã€‚- è¿™ç§è®¾è®¡ä¿è¯äº†åœ¨ç»å¤§å¤šæ•°å†²çªè¾ƒå°‘çš„æƒ…å†µä¸‹ä½¿ç”¨é«˜æ•ˆçš„é“¾è¡¨ï¼Œä»…åœ¨å°‘æ•°å†²çªä¸¥é‡æ—¶è½¬ä¸ºçº¢é»‘æ ‘ï¼Œä»¥ç©ºé—´æ¢æ—¶é—´ï¼Œè¾¾åˆ°æ•´ä½“æœ€ä¼˜ã€‚
2. ArrayList vs LinkedListé¢è¯•å®˜ï¼š å¯¹æ¯”ä¸€ä¸‹ ArrayList å’Œ LinkedListã€‚
æˆ‘ï¼šå¥½çš„ã€‚å®ƒä»¬æ ¸å¿ƒåŒºåˆ«åœ¨äºŽåº•å±‚æ•°æ®ç»“æž„å’Œç”±æ­¤å¸¦æ¥çš„æ€§èƒ½å·®å¼‚ã€‚

åº•å±‚ç»“æž„ï¼š
ArrayList åŸºäºŽåŠ¨æ€æ•°ç»„ã€‚å†…å­˜ä¸­æ˜¯è¿žç»­çš„å­˜å‚¨ç©ºé—´ã€‚
LinkedList åŸºäºŽåŒå‘é“¾è¡¨ã€‚å†…å­˜ä¸­æ˜¯é€šè¿‡èŠ‚ç‚¹æŒ‡é’ˆè¿žæŽ¥çš„ç¦»æ•£å­˜å‚¨ã€‚




é¢è¯•å®˜ï¼š å®ƒä»¬åœ¨æ“ä½œæ•ˆçŽ‡ä¸Šæœ‰ä»€ä¹ˆä¸åŒï¼Ÿ
æˆ‘ï¼š

æ“ä½œæ•ˆçŽ‡ï¼š

- éšæœºè®¿é—® (get&#x2F;set)ï¼šArrayList çš„å¤æ‚åº¦æ˜¯ O(1)ï¼Œå› ä¸ºå®ƒå¯ä»¥é€šè¿‡ä¸‹æ ‡ç›´æŽ¥è®¡ç®—å†…å­˜åœ°å€ã€‚LinkedList æ˜¯ O(n)ï¼Œéœ€è¦éåŽ†é“¾è¡¨ã€‚- å¤´éƒ¨æ’å…¥&#x2F;åˆ é™¤ï¼šArrayList æ˜¯ O(n)ï¼Œå› ä¸ºéœ€è¦ç§»åŠ¨åŽç»­æ‰€æœ‰å…ƒç´ ã€‚LinkedList æ˜¯ O(1)ï¼Œåªéœ€ä¿®æ”¹æŒ‡é’ˆã€‚- å°¾éƒ¨æ’å…¥&#x2F;åˆ é™¤ï¼šä¸¤è€…åœ¨å·²çŸ¥å°¾èŠ‚ç‚¹çš„æƒ…å†µä¸‹éƒ½æŽ¥è¿‘ O(1)ã€‚ArrayList åœ¨æ— éœ€æ‰©å®¹æ—¶æ˜¯ O(1)ï¼›LinkedList éœ€è¦å…ˆéåŽ†åˆ°å°¾éƒ¨ï¼ˆå¦‚æžœæ²¡æœ‰å°¾æŒ‡é’ˆè®°å½•ï¼‰æ˜¯ O(n)ï¼Œä½†é€šå¸¸å®žçŽ°ä¼šè®°å½•å°¾æŒ‡é’ˆï¼Œæ‰€ä»¥ä¹Ÿæ˜¯ O(1)ã€‚- ä¸­é—´æ’å…¥&#x2F;åˆ é™¤ï¼šArrayList å¹³å‡éœ€è¦ç§»åŠ¨ä¸€åŠå…ƒç´ ï¼Œæ˜¯ O(n)ã€‚LinkedList æŸ¥æ‰¾ä½ç½®æ˜¯ O(n)ï¼Œä½†æ’å…¥&#x2F;åˆ é™¤æ“ä½œæœ¬èº«æ˜¯ O(1)ã€‚

é¢è¯•å®˜ï¼š å®ƒä»¬çš„å†…å­˜å ç”¨æœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Ÿ
æˆ‘ï¼š

å†…å­˜å ç”¨ï¼š

- ArrayList åªåœ¨æ•°ç»„å°¾éƒ¨é¢„ç•™ç©ºé—´ï¼Œå†…å­˜åˆ©ç”¨çŽ‡é«˜ã€‚ä½†æ‰©å®¹æ—¶ä¼šé€ æˆä¸´æ—¶æµªè´¹ã€‚- LinkedList æ¯ä¸ªå…ƒç´ éƒ½éœ€è¦æ¶ˆè€—é¢å¤–ç©ºé—´å­˜æ”¾å‰åŽèŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œå†…å­˜å¼€é”€æ›´å¤§ã€‚

é¢è¯•å®˜ï¼š å®žé™…å¼€å‘ä¸­å¦‚ä½•é€‰æ‹©ï¼Ÿ
æˆ‘ï¼š

é€‚ç”¨åœºæ™¯ï¼š

- ä¼˜å…ˆé€‰æ‹© ArrayListã€‚å› ä¸ºå®ƒCPUç¼“å­˜å‹å¥½ï¼ˆå†…å­˜è¿žç»­ï¼‰ï¼Œç»¼åˆæ€§èƒ½åœ¨å¤§å¤šæ•°è¯»å¤šå†™å°‘çš„åœºæ™¯ä¸‹æ›´å¥½ã€‚- åªæœ‰åœ¨éœ€è¦é¢‘ç¹åœ¨åˆ—è¡¨å¤´éƒ¨æˆ–ä¸­é—´è¿›è¡Œæ’å…¥&#x2F;åˆ é™¤æ“ä½œæ—¶ï¼Œæ‰è€ƒè™‘ä½¿ç”¨ LinkedListã€‚
3. ConcurrentHashMap åŽŸç†ä¸Žæ¼”è¿›é¢è¯•å®˜ï¼š è®²ä¸€ä¸‹ ConcurrentHashMap çš„åŽŸç†ï¼Œä»¥åŠå®ƒåœ¨ JDK7 å’Œ JDK8 çš„å®žçŽ°æœ‰ä»€ä¹ˆä¸åŒã€‚
æˆ‘ï¼šå¥½çš„ã€‚ConcurrentHashMap æ˜¯ HashMap çš„çº¿ç¨‹å®‰å…¨ç‰ˆæœ¬ï¼Œå®ƒçš„å®žçŽ°åŽŸç†åœ¨ JDK7 å’Œ JDK8 æœ‰é‡å¤§å˜åŒ–ã€‚

é¢è¯•å®˜ï¼š å…ˆè¯´ä¸‹ JDK7 æ˜¯æ€Žä¹ˆå®žçŽ°çš„ï¼Ÿ
æˆ‘ï¼š

JDK7åˆ†æ®µé”å®žçŽ° (Segment Locking)ï¼š
å®ƒå†…éƒ¨æœ‰ä¸€ä¸ª Segment æ•°ç»„ï¼Œæ¯ä¸ª Segment æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ã€ç»§æ‰¿äº† ReentrantLock çš„ HashEntry[] æ•°ç»„ï¼ˆä¸€ä¸ªå°HashMapï¼‰ã€‚
â€œåˆ†æ®µé”â€ çš„æ€æƒ³æ˜¯ï¼šé”ä¸å†é’ˆå¯¹æ•´ä¸ªMapï¼Œè€Œæ˜¯åªé”ä½å…¶ä¸­ä¸€ä¸ª Segmentã€‚è¿™æ ·ï¼Œä¸åŒ Segment çš„è¯»å†™æ“ä½œå¯ä»¥å®Œå…¨å¹¶è¡Œï¼Œå¤§å¤§æå‡äº†å¹¶å‘åº¦ã€‚
é»˜è®¤æœ‰ 16 ä¸ª Segmentï¼Œæ‰€ä»¥ç†è®ºä¸Šæœ€å¤šå¯ä»¥æ”¯æŒ 16 ä¸ªçº¿ç¨‹åŒæ—¶å†™å…¥ã€‚




é¢è¯•å®˜ï¼š é‚£ JDK8 å‘¢ï¼Ÿä¸ºä»€ä¹ˆåˆæ”¹äº†ï¼Ÿ
æˆ‘ï¼š

JDK8 CAS + synchronized å®žçŽ°ï¼š

- JDK8 æŠ›å¼ƒäº† Segment åˆ†æ®µé”çš„æ¦‚å¿µï¼Œå®ƒçš„åº•å±‚æ•°æ®ç»“æž„å˜å¾—å’Œ HashMap ä¸€æ ·ï¼Œæ˜¯ Node[] æ•°ç»„ + é“¾è¡¨ + çº¢é»‘æ ‘ã€‚- å®žçŽ°çº¿ç¨‹å®‰å…¨çš„æ–¹å¼æ›´åŠ ç»†åŒ–ï¼š- CAS (æ— é”ç®—æ³•)ï¼šç”¨äºŽåˆå§‹åŒ–æ•°ç»„ã€å‘æ¡¶ä¸­æ’å…¥èŠ‚ç‚¹ï¼ˆå½“æ¡¶ä¸ºç©ºæ—¶ï¼‰ç­‰æ— ç«žäº‰åœºæ™¯ï¼Œæ€§èƒ½æžé«˜ã€‚- synchronized (åŒæ­¥é”)ï¼šå½“å‘ç”Ÿå“ˆå¸Œå†²çªï¼Œéœ€è¦æ“ä½œé“¾è¡¨æˆ–çº¢é»‘æ ‘æ—¶ï¼Œåˆ™åªé”ä½å½“å‰å‘ç”Ÿå†²çªçš„æ¡¶ï¼ˆé“¾è¡¨å¤´èŠ‚ç‚¹&#x2F;æ ‘æ ¹èŠ‚ç‚¹ï¼‰ã€‚é”çš„ç²’åº¦ä»Ž JDK7 çš„ä¸€ä¸ª Segmentï¼ˆç®¡ç€å¾ˆå¤šæ¡¶ï¼‰ç¼©å°åˆ°äº†ä¸€ä¸ªæ¡¶ï¼Œå¹¶å‘åº¦æ›´é«˜ã€‚- è¿™ç§è®¾è®¡ç»“åˆäº† CAS çš„é«˜æ€§èƒ½å’Œ synchronized çš„ç¨³å®šæ€§ï¼Œå¹¶ä¸”åœ¨é”ç²’åº¦ä¸Šåšåˆ°äº†æžè‡´ã€‚

é¢è¯•å®˜ï¼š ä»Ž JDK7 åˆ° JDK8 è¿™æ¬¡å‡çº§ä¸»è¦å¸¦æ¥äº†å“ªäº›å¥½å¤„ï¼Ÿ
æˆ‘ï¼š

JDK7 åˆ° JDK8 çš„å‡çº§ï¼š

- é”ç²’åº¦æ›´å°ï¼šä»Žé”ä¸€æ®µï¼ˆSegmentï¼‰åˆ°é”ä¸€æ¡¶ï¼ˆBucketï¼‰ï¼Œå¹¶å‘æ€§èƒ½å¾—åˆ°æžå¤§æå‡ã€‚- æ•°æ®ç»“æž„ä¼˜åŒ–ï¼šå¼•å…¥äº†çº¢é»‘æ ‘ï¼Œè§£å†³äº†é“¾è¡¨è¿‡é•¿æ—¶æŸ¥è¯¢æ…¢çš„é—®é¢˜ï¼Œä¿è¯äº†æœ€åæƒ…å†µä¸‹çš„æ€§èƒ½ã€‚- API å¢žå¼ºï¼šæä¾›äº†æ›´å¤šæ–¹ä¾¿çš„æµå¼ APIï¼ˆå¦‚ forEach, reduceï¼‰ã€‚- ä»£ç æ›´ç®€åŒ–ï¼šç§»é™¤äº†å¤æ‚çš„ Segment ç»“æž„ï¼Œåº•å±‚å®žçŽ°å˜å¾—æ›´ç®€æ´ã€æ›´ç»Ÿä¸€ï¼ˆå’Œ HashMap ç±»ä¼¼ï¼‰ï¼Œæ›´æ˜“äºŽç»´æŠ¤å’Œç†è§£ã€‚
ä¸‰ã€Java å¹¶å‘ç¼–ç¨‹ (Java Concurrency)1. ä¹è§‚é”ä¸Žæ‚²è§‚é”é¢è¯•å®˜ï¼š è¯´è¯´ä½ å¯¹ä¹è§‚é”å’Œæ‚²è§‚é”çš„ç†è§£ã€‚
æˆ‘ï¼šå¥½çš„ï¼Œè¿™æ˜¯ä¸¤ç§ä¸åŒçš„å¹¶å‘æŽ§åˆ¶ç­–ç•¥ã€‚

æ‚²è§‚é”ï¼š
æ€æƒ³ï¼šè®¤ä¸ºå¹¶å‘å†²çªæ˜¯å¤§æ¦‚çŽ‡äº‹ä»¶ï¼Œæ¯æ¬¡æ“ä½œæ•°æ®æ—¶ï¼Œéƒ½å‡å®šåˆ«äººä¼šä¿®æ”¹ï¼Œæ‰€ä»¥å…ˆåŠ é”å†æ“ä½œã€‚
å®žçŽ°ï¼šsynchronized å…³é”®å­—ã€ReentrantLock ç­‰ã€‚
ç±»æ¯”ï¼šå°±åƒâ€œå†™æ–‡æ¡£æ—¶å…ˆé”é—¨â€ï¼Œé˜²æ­¢åˆ«äººæ‰“æ‰°ã€‚


ä¹è§‚é”ï¼š
æ€æƒ³ï¼šè®¤ä¸ºå¹¶å‘å†²çªæ˜¯å°æ¦‚çŽ‡äº‹ä»¶ï¼Œæ¯æ¬¡æ“ä½œæ•°æ®æ—¶ï¼Œä¸ä¼šå…ˆåŠ é”ï¼Œè€Œæ˜¯åœ¨æ›´æ–°æ—¶åˆ¤æ–­æ­¤æœŸé—´æ•°æ®æ˜¯å¦è¢«ä»–äººä¿®æ”¹è¿‡ã€‚
å®žçŽ°ï¼šé€šå¸¸ä½¿ç”¨ CAS (Compare-And-Swap) ç®—æ³•æˆ–ç‰ˆæœ¬å·æœºåˆ¶ã€‚
ç±»æ¯”ï¼šå°±åƒâ€œå†™æ–‡æ¡£æ—¶ä¸é”é—¨â€ï¼Œæäº¤æ—¶æ‰æ£€æŸ¥æœ‰æ²¡æœ‰äººåŠ¨è¿‡åŽŸç¨¿ï¼Œæ²¡åŠ¨è¿‡å°±æäº¤ï¼ŒåŠ¨äº†å°±æ”¾å¼ƒæˆ–é‡è¯•ã€‚



é€‚ç”¨åœºæ™¯ï¼š

æ‚²è§‚é”ï¼šé€‚åˆå†™å¤šè¯»å°‘çš„åœºæ™¯ï¼Œå†²çªä¸¥é‡æ—¶æ€§èƒ½é«˜ã€‚
ä¹è§‚é”ï¼šé€‚åˆè¯»å¤šå†™å°‘çš„åœºæ™¯ï¼Œå†²çªå°‘æ—¶æ€§èƒ½è¿œé«˜äºŽæ‚²è§‚é”ï¼Œèƒ½å‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚

2. CAS åŽŸç†ä¸ŽåŽŸå­ç±»å®žçŽ°é¢è¯•å®˜ï¼š è®²ä¸€ä¸‹ CAS çš„åŽŸç†ã€‚
æˆ‘ï¼š

CASå®žçŽ°åŽŸç†ï¼š
CAS çš„å…¨ç§°æ˜¯ Compare-And-Swapï¼Œå³æ¯”è¾ƒå¹¶äº¤æ¢ã€‚å®ƒæ˜¯ä¸€ä¸ªCPUåŽŸå­æŒ‡ä»¤ï¼Œä¿è¯äº†æ“ä½œçš„åŽŸå­æ€§ã€‚
æ“ä½œåŒ…å«ä¸‰ä¸ªæ“ä½œæ•°ï¼šå†…å­˜åœ°å€ Vã€æ—§çš„é¢„æœŸå€¼ Aã€è¦æ›´æ–°çš„æ–°å€¼ Bã€‚
åŽŸç†ï¼šå½“ä¸”ä»…å½“å†…å­˜åœ°å€ V ä¸­çš„å½“å‰å€¼ç­‰äºŽé¢„æœŸå€¼ A æ—¶ï¼Œå¤„ç†å™¨æ‰ä¼šè‡ªåŠ¨å°†åœ°å€ V çš„å€¼æ›´æ–°ä¸ºæ–°å€¼ Bï¼Œå¦åˆ™ä»€ä¹ˆéƒ½ä¸åšã€‚æ•´ä¸ªæ“ä½œæ˜¯ä¸€ä¸ªåŽŸå­æ“ä½œã€‚




é¢è¯•å®˜ï¼š CAS æœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ï¼Ÿ
æˆ‘ï¼šä¼˜ç‚¹ï¼š

é«˜æ€§èƒ½ï¼šå®ƒæ˜¯ä¸€ç§æ— é”æ“ä½œï¼Œé¿å…äº†ä¼ ç»Ÿäº’æ–¥é”ï¼ˆå¦‚ synchronizedï¼‰å¸¦æ¥çš„çº¿ç¨‹é˜»å¡žã€ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€ï¼Œåœ¨ä½Žç«žäº‰çŽ¯å¢ƒä¸‹æ€§èƒ½å¾ˆé«˜ã€‚

ç¼ºç‚¹ï¼š

ABA é—®é¢˜ï¼šè¿™æ˜¯æœ€ç»å…¸çš„ç¼ºç‚¹ã€‚ä¸€ä¸ªçº¿ç¨‹è¯»å–å†…å­˜å€¼ä¸º Aï¼Œæ­¤æ—¶å¦ä¸€ä¸ªçº¿ç¨‹å°†å€¼æ”¹ä¸º Bï¼Œç„¶åŽåˆæ”¹å›ž Aã€‚ç­‰ç¬¬ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œ CAS æ—¶ï¼Œå‘çŽ°å€¼è¿˜æ˜¯ Aï¼ŒäºŽæ˜¯æ“ä½œæˆåŠŸï¼Œä½†å®ƒå¹¶ä¸çŸ¥é“è¿™ä¸ª A å·²ç»è¢«â€œä¸­é—´ä¿®æ”¹è¿‡â€äº†ã€‚
å¾ªçŽ¯æ—¶é—´é•¿å¼€é”€å¤§ï¼šå¦‚æžœ CAS æ“ä½œé•¿æ—¶é—´ä¸æˆåŠŸï¼ˆç«žäº‰æ¿€çƒˆï¼‰ï¼ŒCPU ä¼šä¸€ç›´è¿›è¡Œè‡ªæ—‹ï¼ˆå¾ªçŽ¯é‡è¯•ï¼‰ï¼Œæ¶ˆè€—èµ„æºã€‚
åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŽŸå­æ“ä½œï¼šå¯¹äºŽå¤šä¸ªå…±äº«å˜é‡ï¼ŒCAS æ— æ³•ä¿è¯åŽŸå­æ€§ï¼Œå¯èƒ½éœ€è¦åŠ é”ã€‚


é¢è¯•å®˜ï¼š é‚£æ€Žä¹ˆè§£å†³ ABA é—®é¢˜å‘¢ï¼Ÿ
æˆ‘ï¼š

å¯ä»¥é€šè¿‡ç»™æ•°æ®åŠ ä¸Šç‰ˆæœ¬å·ï¼ˆStampï¼‰ æˆ–æ—¶é—´æˆ³æ¥è§£å†³ã€‚
Java æä¾›äº† AtomicStampedReference ç±»ã€‚å®ƒä¸ä»…åœ¨æ¯”è¾ƒå€¼ï¼Œè¿˜ä¼šæ¯”è¾ƒä¸€ä¸ª int åž‹çš„ç‰ˆæœ¬å·æ ‡è®°ã€‚ä»»ä½•å¯¹å€¼çš„ä¿®æ”¹éƒ½ä¼šä½¿ç‰ˆæœ¬å·é€’å¢žï¼Œè¿™æ ·å³ä½¿å€¼ä»Ž A å˜å›ž Aï¼Œç‰ˆæœ¬å·ä¹Ÿå˜äº†ï¼ŒCAS å°±ä¼šå¤±è´¥ã€‚


é¢è¯•å®˜ï¼š åŽŸå­ç±»ï¼ˆæ¯”å¦‚ AtomicIntegerï¼‰æ˜¯å¦‚ä½•åˆ©ç”¨ CAS å®žçŽ°çš„ï¼Ÿ
æˆ‘ï¼š

åŽŸå­ç±»å®žçŽ°åŽŸç†ï¼š

- åŽŸå­ç±»ï¼ˆå¦‚ AtomicIntegerï¼‰å†…éƒ¨çš„æ ¸å¿ƒå­—æ®µï¼ˆå¦‚ valueï¼‰éƒ½ç”± volatile ä¿®é¥°ï¼Œä¿è¯äº†å¯è§æ€§ã€‚- å®ƒä»¬çš„æ‰€æœ‰åŽŸå­æ€§æ–¹æ³•ï¼ˆå¦‚ getAndIncrement()ï¼‰å†…éƒ¨éƒ½è°ƒç”¨äº† Unsafe ç±»çš„ CAS æ–¹æ³•ï¼ˆcompareAndSwapIntï¼‰ã€‚- ä»¥ i++ ä¸ºä¾‹ï¼ŒgetAndIncrement() çš„å®žçŽ°æ˜¯ä¸€ä¸ª CAS è‡ªæ—‹å¾ªçŽ¯ï¼šå…ˆèŽ·å–å½“å‰å€¼ï¼Œè®¡ç®—æ–°å€¼ï¼Œç„¶åŽç”¨ CAS å°è¯•æ›´æ–°ã€‚å¦‚æžœå¤±è´¥ï¼ˆå€¼å·²è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹ï¼‰ï¼Œå°±é‡æ–°èŽ·å–å½“å‰å€¼ï¼Œå†æ¬¡è®¡ç®—å’Œå°è¯•ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢ã€‚
3. synchronized ä¸Ž ReentrantLock è¯¦è§£é¢è¯•å®˜ï¼š å¯¹æ¯”ä¸€ä¸‹ synchronized å’Œ ReentrantLockã€‚
æˆ‘ï¼šå¥½çš„ï¼Œå®ƒä»¬çš„æ ¸å¿ƒåŒºåˆ«å¦‚ä¸‹ï¼š

æœ¬è´¨ä¸åŒï¼šsynchronized æ˜¯ Java å…³é”®å­—ï¼Œç”± JVM åº•å±‚å®žçŽ°ï¼›ReentrantLock æ˜¯ä¸€ä¸ª Java ç±»ï¼ŒåŸºäºŽ AQS å®žçŽ°ã€‚
é”çš„é‡Šæ”¾ï¼šsynchronized åœ¨ä»£ç å—æ‰§è¡Œå®Œæˆ–å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œç”± JVM è‡ªåŠ¨é‡Šæ”¾é”ï¼›ReentrantLock å¿…é¡»æ‰‹åŠ¨è°ƒç”¨ unlock() æ–¹æ³•é‡Šæ”¾é”ï¼Œé€šå¸¸åœ¨ finally å—ä¸­å®Œæˆï¼Œå¦åˆ™å®¹æ˜“é€ æˆæ­»é”ã€‚
åŠŸèƒ½ä¸°å¯Œæ€§ï¼šReentrantLock åŠŸèƒ½æ›´ä¸°å¯Œã€‚
å¯ä¸­æ–­ï¼šlockInterruptibly() å¯ä»¥å“åº”ä¸­æ–­ï¼Œåœ¨ç­‰å¾…é”çš„è¿‡ç¨‹ä¸­å¯ä»¥è¢«ä¸­æ–­ã€‚
å…¬å¹³é”ï¼šå¯ä»¥é€‰æ‹©åˆ›å»ºå…¬å¹³é”ï¼ˆå…ˆç­‰å¾…çš„çº¿ç¨‹å…ˆèŽ·å¾—é”ï¼‰ï¼Œsynchronized æ˜¯éžå…¬å¹³é”ã€‚
æ¡ä»¶é˜Ÿåˆ—ï¼šå¯ä»¥é€šè¿‡ Condition å®žçŽ°å¤šè·¯é€šçŸ¥ï¼Œæ›´ç²¾ç»†åœ°æŽ§åˆ¶çº¿ç¨‹çš„ç­‰å¾…ä¸Žå”¤é†’ã€‚


çµæ´»æ€§ï¼šsynchronized çš„åŠ é”å’Œé‡Šæ”¾é”æ˜¯å›ºåŒ–çš„ï¼›ReentrantLock å¯ä»¥åœ¨æ–¹æ³•å†…åŠ é”ï¼Œåœ¨å¦ä¸€æ–¹æ³•å†…è§£é”ï¼Œæ›´çµæ´»ã€‚
é”çš„å®žçŽ°æœºåˆ¶ï¼šsynchronized åœ¨ JDK6 åŽå¼•å…¥äº†é”å‡çº§æœºåˆ¶æ¥ä¼˜åŒ–æ€§èƒ½ï¼›ReentrantLock åˆ™é€šè¿‡ AQS å†…éƒ¨çš„ CAS è‡ªæ—‹æ¥å®žçŽ°ã€‚

é€‰ç”¨å»ºè®®ï¼š

é™¤éžéœ€è¦ ReentrantLock çš„é«˜çº§åŠŸèƒ½ï¼ˆå¦‚å¯ä¸­æ–­ã€å…¬å¹³é”ã€Conditionï¼‰ï¼Œå¦åˆ™ä¼˜å…ˆä½¿ç”¨ synchronizedï¼Œå› ä¸ºå®ƒçš„å†™æ³•æ›´ç®€æ´ï¼Œä¸”ç”± JVM ç»´æŠ¤å’Œä¼˜åŒ–ã€‚


é¢è¯•å®˜ï¼š è¯¦ç»†è¯´ä¸€ä¸‹ synchronized çš„é”å‡çº§æµç¨‹ã€‚
æˆ‘ï¼š

synchronized çš„é”å‡çº§æµç¨‹ï¼š

ä¸ºäº†åœ¨æ€§èƒ½å’Œå¼€é”€ä¹‹é—´å–å¾—å¹³è¡¡ï¼ŒJVM å°† synchronized çš„é”çŠ¶æ€åˆ†ä¸º4çº§ï¼Œå¹¶å¯ä»¥ä»Žä½Žåˆ°é«˜è¿›è¡Œå‡çº§ï¼Œä½†ä¸å¯é™çº§ã€‚
- **æ— é” (No Lock)**ï¼šå¯¹è±¡æœªä½œä¸ºåŒæ­¥é”ä½¿ç”¨ã€‚- **åå‘é” (Biased Locking)**ï¼š    - **ç›®çš„**ï¼šåœ¨**æ²¡æœ‰ç«žäº‰**çš„æƒ…å†µä¸‹ï¼Œæ¶ˆé™¤åŒæ­¥å¼€é”€ã€‚å‡è®¾é”æ€»æ˜¯ç”±åŒä¸€çº¿ç¨‹èŽ·å¾—ã€‚    - **æµç¨‹**ï¼šç¬¬ä¸€ä¸ªçº¿ç¨‹è®¿é—®åŒæ­¥å—æ—¶ï¼Œä¼šé€šè¿‡ CAS æ“ä½œå°†å¯¹è±¡å¤´ä¸­çš„ Mark Word é‡Œå­˜å‚¨çš„çº¿ç¨‹ ID æ”¹ä¸ºè‡ªå·±çš„ IDã€‚ä¹‹åŽè¯¥çº¿ç¨‹å†è¿›å…¥æ—¶ï¼Œåªéœ€æ£€æŸ¥çº¿ç¨‹ ID æ˜¯å¦åŒ¹é…ï¼ŒåŒ¹é…åˆ™æ— éœ€ä»»ä½•åŒæ­¥æ“ä½œã€‚- **è½»é‡çº§é” (Lightweight Lock)**ï¼š    - **è§¦å‘æ¡ä»¶**ï¼šå½“æœ‰**è½»å¾®ç«žäº‰**ï¼ˆç¬¬äºŒä¸ªçº¿ç¨‹æ¥å°è¯•èŽ·å–é”ï¼‰æ—¶ï¼Œåå‘é”ä¼šå‡çº§ä¸ºè½»é‡çº§é”ã€‚    - **æµç¨‹**ï¼šçº¿ç¨‹ä¼šåœ¨è‡ªå·±çš„æ ˆå¸§ä¸­åˆ›å»ºä¸€ä¸ªé”è®°å½•ï¼ˆLock Recordï¼‰ï¼Œç„¶åŽé€šè¿‡ **CAS** æ“ä½œå°è¯•å°†å¯¹è±¡å¤´çš„ Mark Word æ›´æ–°ä¸ºæŒ‡å‘è¯¥é”è®°å½•çš„æŒ‡é’ˆã€‚å¦‚æžœæˆåŠŸï¼Œå½“å‰çº¿ç¨‹å°±èŽ·å¾—äº†é”ã€‚å¦‚æžœå¤±è´¥ï¼Œä¼š**è‡ªæ—‹**é‡è¯•ä¸€å®šæ¬¡æ•°ã€‚- **é‡é‡çº§é” (Heavyweight Lock)**ï¼š    - **è§¦å‘æ¡ä»¶**ï¼š**è‡ªæ—‹å¤±è´¥**ï¼ˆç«žäº‰åŠ å‰§ï¼Œçº¿ç¨‹æ•°å¤šæˆ–ç­‰å¾…æ—¶é—´é•¿ï¼‰åŽï¼Œé”ä¼šå‡çº§ä¸ºé‡é‡çº§é”ã€‚    - **æµç¨‹**ï¼šæ­¤æ—¶ï¼ŒæœªèŽ·å¾—é”çš„çº¿ç¨‹ä¼š**è¢«æŒ‚èµ·**ï¼Œè¿›å…¥é˜»å¡žçŠ¶æ€ï¼Œç­‰å¾…æ“ä½œç³»ç»Ÿè°ƒåº¦ï¼Œéœ€è¦è¿›è¡Œç”¨æˆ·æ€åˆ°å†…æ ¸æ€çš„åˆ‡æ¢ï¼Œå¼€é”€æœ€å¤§ã€‚


é¢è¯•å®˜ï¼š ä»€ä¹ˆæ˜¯ synchronized çš„å¯é‡å…¥æ€§ï¼Ÿ
æˆ‘ï¼š

synchronized çš„å¯é‡å…¥æ€§ï¼š

- æ¦‚å¿µï¼šæŒ‡åŒä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œå®Œå¤–å±‚åŒæ­¥æ–¹æ³•&#x2F;å—åŽï¼Œå†æ¬¡è¿›å…¥å®ƒçš„å†…å±‚åŒæ­¥æ–¹æ³•&#x2F;å—æ—¶ï¼Œå¯ä»¥ç›´æŽ¥èŽ·å¾—é”è€Œä¸ä¼šè¢«è‡ªå·±é˜»å¡žã€‚- åŽŸç†ï¼šJVM ä¼šä¸ºæ¯ä¸ªé”å¯¹è±¡ç»´æŠ¤ä¸€ä¸ªè®¡æ•°å™¨å’Œä¸€ä¸ªæŒæœ‰è€…çº¿ç¨‹æ ‡è¯†ã€‚å½“çº¿ç¨‹ç¬¬ä¸€æ¬¡èŽ·å–é”æ—¶ï¼Œè®¡æ•°å™¨å˜ä¸º1ã€‚æ¯æ¬¡é‡å…¥ï¼Œè®¡æ•°å™¨å°±+1ã€‚é€€å‡ºåŒæ­¥å—ï¼Œè®¡æ•°å™¨å°±-1ã€‚ç›´åˆ°è®¡æ•°å™¨ä¸º0ï¼Œé”æ‰è¢«çœŸæ­£é‡Šæ”¾ã€‚- é‡è¦æ€§ï¼šå¯é‡å…¥æ€§é¿å…äº†çº¿ç¨‹æ­»é”è‡ªå·±ï¼Œæ˜¯è®¾è®¡åŒæ­¥ä»£ç çš„åŸºç¡€ã€‚
4. volatile å…³é”®å­—çš„ä½œç”¨ä¸ŽåŽŸç†é¢è¯•å®˜ï¼š è®²ä¸€ä¸‹ volatile å…³é”®å­—çš„ä½œç”¨å’ŒåŽŸç†ã€‚
æˆ‘ï¼šå¥½çš„ã€‚volatile æ˜¯ Java æä¾›çš„è½»é‡çº§åŒæ­¥æœºåˆ¶ï¼Œå®ƒä¸»è¦æœ‰ä¸¤å¤§æ ¸å¿ƒä½œç”¨ï¼šä¿è¯å†…å­˜å¯è§æ€§ å’Œ ç¦æ­¢æŒ‡ä»¤é‡æŽ’åºã€‚

é¢è¯•å®˜ï¼š å…ˆè§£é‡Šä¸€ä¸‹ä»€ä¹ˆæ˜¯å†…å­˜å¯è§æ€§ï¼Œvolatile æ˜¯å¦‚ä½•ä¿è¯çš„ï¼Ÿ
æˆ‘ï¼š

å†…å­˜å¯è§æ€§ (Memory Visibility)ï¼š
é—®é¢˜ï¼šæ ¹æ® Java å†…å­˜æ¨¡åž‹ (JMM)ï¼Œæ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼Œç”¨äºŽç¼“å­˜å…±äº«å˜é‡çš„å‰¯æœ¬ã€‚å½“ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†å…±äº«å˜é‡ï¼Œå¯èƒ½åªæ˜¯å…ˆä¿®æ”¹äº†è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼Œæœªèƒ½ç«‹å³å†™å›žä¸»å†…å­˜ï¼Œå¯¼è‡´å…¶ä»–çº¿ç¨‹è¯»å–åˆ°çš„ä»ç„¶æ˜¯æ—§çš„å‰¯æœ¬å€¼ã€‚
volatile çš„ä½œç”¨ï¼šå½“ä¸€ä¸ªå˜é‡è¢«å£°æ˜Žä¸º volatile åŽï¼š
ä»»ä½•çº¿ç¨‹ä¿®æ”¹è¿™ä¸ªå˜é‡ï¼Œéƒ½ä¼šç«‹å³å¼ºåˆ¶å°†æ–°å€¼åˆ·æ–°åˆ°ä¸»å†…å­˜ã€‚
ä»»ä½•çº¿ç¨‹è¯»å–è¿™ä¸ªå˜é‡ï¼Œéƒ½ä¼šå¼ºåˆ¶ä»Žä¸»å†…å­˜ä¸­é‡æ–°è¯»å–æœ€æ–°çš„å€¼ï¼Œä½¿å½“å‰å·¥ä½œå†…å­˜ä¸­çš„å‰¯æœ¬å¤±æ•ˆã€‚


åŽŸç†ï¼šåº•å±‚æ˜¯é€šè¿‡å†…å­˜å±éšœ (Memory Barrier) æ¥å®žçŽ°çš„ã€‚å†™æ“ä½œå‰åŽä¼šæ’å…¥å±éšœï¼Œå¼ºåˆ¶å°†ç¼“å­˜æ•°æ®åˆ·å›žä¸»å­˜ï¼›è¯»æ“ä½œå‰åŽä¹Ÿä¼šæ’å…¥å±éšœï¼Œå¼ºåˆ¶ä½¿æœ¬åœ°ç¼“å­˜å¤±æ•ˆï¼Œä»Žä¸»å­˜æ‹‰å–æ–°æ•°æ®ã€‚




é¢è¯•å®˜ï¼š é‚£ç¦æ­¢æŒ‡ä»¤é‡æŽ’åºå‘¢ï¼Ÿè¿™åˆæ˜¯ä»€ä¹ˆï¼Ÿ
æˆ‘ï¼š

ç¦æ­¢æŒ‡ä»¤é‡æŽ’åº (Prevention of Instruction Reordering)ï¼š

- é—®é¢˜ï¼šä¸ºäº†æå‡æ€§èƒ½ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¸¸å¸¸ä¼šå¯¹æŒ‡ä»¤è¿›è¡Œé‡æŽ’åºã€‚ä½†åœ¨å¤šçº¿ç¨‹çŽ¯å¢ƒä¸‹ï¼Œä¸æ°å½“çš„é‡æŽ’åºå¯èƒ½ä¼šå¯¼è‡´ç¨‹åºè¿è¡Œç»“æžœä¸Žé¢„æœŸä¸ç¬¦ã€‚ï¼ˆæœ€ç»å…¸çš„ä¾‹å­å°±æ˜¯åŒé‡æ£€æŸ¥é”å•ä¾‹æ¨¡å¼ä¸­ï¼Œinstance = new Singleton() è¿™è¡Œä»£ç å¯èƒ½è¢«é‡æŽ’åºï¼Œå¯¼è‡´å…¶ä»–çº¿ç¨‹æ‹¿åˆ°ä¸€ä¸ªæœªåˆå§‹åŒ–å®Œå…¨çš„å¯¹è±¡ï¼‰ã€‚- volatile çš„ä½œç”¨ï¼šé€šè¿‡æ·»åŠ å†…å­˜å±éšœï¼Œvolatile å…³é”®å­—ç¦æ­¢äº† JVM å’Œå¤„ç†å™¨å¯¹ä¿®é¥°äº† volatile çš„å˜é‡çš„è¯»å†™æ“ä½œä¸Žå…¶ä»–æŒ‡ä»¤è¿›è¡Œé‡æŽ’åºï¼Œä»Žè€Œä¿è¯äº†æ“ä½œçš„æœ‰åºæ€§ã€‚- åŽŸç†ï¼šå†…å­˜å±éšœå°±åƒä¸€ä¸ªâ€œæ …æ â€ï¼Œå‘Šè¯‰ç¼–è¯‘å™¨å’Œ CPUï¼Œå¿…é¡»åœ¨è¿™ä¸ªå±éšœä¹‹å‰çš„æ‰€æœ‰æ“ä½œéƒ½å®ŒæˆåŽï¼Œæ‰èƒ½æ‰§è¡Œå±éšœä¹‹åŽçš„æ“ä½œã€‚
æ€»ç»“ï¼švolatile çš„æ ¸å¿ƒæ˜¯é€šè¿‡å†…å­˜å±éšœè¿™ä¸€ CPU æŒ‡ä»¤æ¥å®žçŽ°å¯è§æ€§å’Œæœ‰åºæ€§ã€‚ä½†å®ƒä¸ä¿è¯åŽŸå­æ€§ï¼Œåƒ i++ è¿™ç§å¤åˆæ“ä½œä¾ç„¶éœ€è¦åŠ é”æˆ–ä½¿ç”¨åŽŸå­ç±»ã€‚
5. Java å†…å­˜æ¨¡åž‹ (JMM) ä¸Ž Happens-Beforeé¢è¯•å®˜ï¼š è°ˆè°ˆä½ å¯¹ Java å†…å­˜æ¨¡åž‹ (JMM) çš„ç†è§£ã€‚
æˆ‘ï¼šå¥½çš„ã€‚JMM æ˜¯ä¸€ä¸ªæŠ½è±¡çš„æ¦‚å¿µï¼Œå®ƒå®šä¹‰äº†ç¨‹åºä¸­å„ç§å˜é‡ï¼ˆçº¿ç¨‹å…±äº«å˜é‡ï¼‰çš„è®¿é—®è§„åˆ™ï¼Œä»¥åŠå¦‚ä½•åœ¨å†…å­˜ä¸­è¿›è¡Œè¯»å†™æ“ä½œçš„ç»†èŠ‚ã€‚å®ƒå±è”½äº†åº•å±‚ç¡¬ä»¶å†…å­˜ç»“æž„çš„å·®å¼‚ï¼Œæ—¨åœ¨è§£å†³å¤šçº¿ç¨‹ä¸‹çš„å¯è§æ€§ã€åŽŸå­æ€§å’Œæœ‰åºæ€§é—®é¢˜ã€‚

é¢è¯•å®˜ï¼š JMM æ˜¯å¦‚ä½•æŠ½è±¡å†…å­˜ç»“æž„çš„ï¼Ÿ
æˆ‘ï¼š

JMMæŠ½è±¡æ¨¡åž‹ï¼ˆä¸»å†…å­˜ã€å·¥ä½œå†…å­˜ï¼‰ï¼š

ä¸»å†…å­˜ (Main Memory)ï¼šå­˜å‚¨æ‰€æœ‰çš„å…±äº«å˜é‡ã€‚æ‰€æœ‰çº¿ç¨‹éƒ½èƒ½è®¿é—®ï¼Œä½†é€Ÿåº¦è¾ƒæ…¢ã€‚
å·¥ä½œå†…å­˜ (Working Memory)ï¼šæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼Œå¯ä»¥çœ‹ä½œæ˜¯CPUé«˜é€Ÿç¼“å­˜å’Œå¯„å­˜å™¨çš„æŠ½è±¡ã€‚å®ƒå­˜å‚¨äº†è¯¥çº¿ç¨‹ä½¿ç”¨åˆ°çš„å…±äº«å˜é‡çš„å‰¯æœ¬ã€‚
äº¤äº’åè®®ï¼šJMM è§„å®šäº†çº¿ç¨‹å¦‚ä½•ä¸Žä¸»å†…å­˜è¿›è¡Œäº¤äº’ï¼š
readï¼šä»Žä¸»å†…å­˜è¯»å–æ•°æ®åˆ°å·¥ä½œå†…å­˜ã€‚
loadï¼šå°† read å¾—åˆ°çš„å€¼æ”¾å…¥å·¥ä½œå†…å­˜çš„å˜é‡å‰¯æœ¬ä¸­ã€‚
useï¼šæ‰§è¡Œå¼•æ“Žä½¿ç”¨å·¥ä½œå†…å­˜ä¸­çš„å˜é‡å€¼ã€‚
assignï¼šæ‰§è¡Œå¼•æ“Žå°†æ–°å€¼èµ‹ç»™å·¥ä½œå†…å­˜ä¸­çš„å˜é‡ã€‚
storeï¼šå°†å·¥ä½œå†…å­˜ä¸­çš„å˜é‡å€¼ä¼ é€åˆ°ä¸»å†…å­˜ã€‚
writeï¼šå°† store ä¼ æ¥çš„å€¼å†™å…¥ä¸»å†…å­˜çš„å˜é‡ä¸­ã€‚



JMM é€šè¿‡è¿™8ç§åŽŸå­æ“ä½œï¼ˆè¿˜æœ‰ lock å’Œ unlockï¼‰æ¥æŽ§åˆ¶ä¸»å†…å­˜ä¸Žå·¥ä½œå†…å­˜ä¹‹é—´çš„åŒæ­¥ï¼Œä»Žè€Œå†³å®šä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡çš„å†™å…¥ä½•æ—¶å¯¹å¦ä¸€ä¸ªçº¿ç¨‹å¯è§ã€‚volatile çš„ç‰¹æ®Šè§„åˆ™å°±ä½“çŽ°åœ¨å®ƒå¼ºåˆ¶ read&#x2F;load&#x2F;use å’Œ assign&#x2F;store&#x2F;write å¿…é¡»è¿žç»­ã€æŒ‰é¡ºåºæ‰§è¡Œã€‚



é¢è¯•å®˜ï¼š ä»€ä¹ˆæ˜¯æŒ‡ä»¤é‡æŽ’åºï¼Ÿå®ƒä¸ºä»€ä¹ˆä¼šå¸¦æ¥é—®é¢˜ï¼Ÿ
æˆ‘ï¼š

æŒ‡ä»¤é‡æŽ’åºï¼š

- åŽŸå› ï¼šä¸ºäº†å……åˆ†å‘æŒ¥ CPU æ€§èƒ½ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¸¸å¸¸ä¼šåœ¨ä¸æ”¹å˜ç¨‹åºå•çº¿ç¨‹æ‰§è¡Œç»“æžœçš„å‰æä¸‹ï¼Œå¯¹æŒ‡ä»¤çš„æ‰§è¡Œé¡ºåºè¿›è¡Œé‡æ–°æŽ’åºä¼˜åŒ–ã€‚- é—®é¢˜ï¼šåœ¨å¤šçº¿ç¨‹çŽ¯å¢ƒä¸‹ï¼Œè¿™ç§é‡æŽ’åºå¯èƒ½ä¼šç ´åç¨‹åºçš„è¯­ä¹‰ï¼Œå¯¼è‡´çº¿ç¨‹æ‰§è¡Œç»“æžœå‡ºçŽ°ä¸å¯é¢„æµ‹çš„é”™è¯¯ã€‚ï¼ˆä¾‹å¦‚ï¼ŒåŒé‡æ£€æŸ¥é”å•ä¾‹æ¨¡å¼ä¸­ï¼Œç”±äºŽ new æ“ä½œçš„éžåŽŸå­æ€§å¯èƒ½è¢«é‡æŽ’åºï¼Œå¯¼è‡´å…¶ä»–çº¿ç¨‹æ‹¿åˆ°ä¸€ä¸ªæœªåˆå§‹åŒ–å®Œå…¨çš„å¯¹è±¡å¼•ç”¨ï¼‰ã€‚

é¢è¯•å®˜ï¼š JMM å¦‚ä½•è§£å†³å¯è§æ€§å’Œæœ‰åºæ€§é—®é¢˜ï¼Ÿä»€ä¹ˆæ˜¯ Happens-Before åŽŸåˆ™ï¼Ÿ
æˆ‘ï¼š

Happens-Before åŽŸåˆ™ï¼š

- è¿™æ˜¯ JMM æœ€æ ¸å¿ƒçš„æ¦‚å¿µã€‚å®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ç§å¯è§æ€§ä¿è¯è§„åˆ™ï¼Œç”¨äºŽæè¿°ä¸¤ä¸ªæ“ä½œä¹‹é—´çš„å†…å­˜å¯è§æ€§ã€‚å¦‚æžœæ“ä½œ A Happens-Before äºŽæ“ä½œ Bï¼Œé‚£ä¹ˆ A æ“ä½œæ‰€äº§ç”Ÿçš„æ‰€æœ‰å†…å­˜æ›´æ”¹ï¼ˆç»“æžœï¼‰å¯¹ B æ“ä½œéƒ½æ˜¯å¯è§çš„ã€‚- å®ƒæ˜¯ä¸€äº›è§„åˆ™çš„é›†åˆï¼Œæ— éœ€ä»»ä½•åŒæ­¥æ‰‹æ®µå°±å¤©ç„¶å…·æœ‰ Happens-Before å…³ç³»ï¼š

ç¨‹åºæ¬¡åºè§„åˆ™ï¼šåœ¨ä¸€ä¸ªçº¿ç¨‹å†…ï¼Œä¹¦å†™åœ¨å‰é¢çš„æ“ä½œ Happens-Before äºŽåŽé¢çš„æ“ä½œã€‚ï¼ˆæ³¨æ„ï¼šè¿™ä»…æŒ‡æ‰§è¡Œç»“æžœä¸Šçš„é¡ºåºï¼Œä¾ç„¶å¯èƒ½è¢«é‡æŽ’åºï¼Œä½†é‡æŽ’åºåŽçš„ç»“æžœå¿…é¡»ä¸ŽæŒ‰ä»£ç é¡ºåºæ‰§è¡Œçš„ç»“æžœä¸€è‡´ï¼‰ã€‚
ç›‘è§†å™¨é”è§„åˆ™ï¼šå¯¹ä¸€ä¸ªé”çš„ unlock æ“ä½œ Happens-Before äºŽåŽç»­å¯¹è¿™ä¸ªé”çš„ lock æ“ä½œã€‚
volatileå˜é‡è§„åˆ™ï¼šå¯¹ä¸€ä¸ª volatile å˜é‡çš„å†™æ“ä½œ Happens-Before äºŽåŽç»­å¯¹è¿™ä¸ªå˜é‡çš„è¯»æ“ä½œã€‚
çº¿ç¨‹å¯åŠ¨è§„åˆ™ï¼šThread å¯¹è±¡çš„ start() æ–¹æ³•è°ƒç”¨ Happens-Before äºŽæ­¤çº¿ç¨‹çš„ä»»ä½•åŠ¨ä½œã€‚
çº¿ç¨‹ç»ˆæ­¢è§„åˆ™ï¼šçº¿ç¨‹ä¸­çš„æ‰€æœ‰æ“ä½œéƒ½ Happens-Before äºŽå…¶ä»–çº¿ç¨‹æ£€æµ‹åˆ°è¯¥çº¿ç¨‹å·²ç»ç»ˆæ­¢ï¼ˆå¦‚ thread.join() è¿”å›žï¼‰ã€‚
ä¼ é€’æ€§ï¼šå¦‚æžœ A Happens-Before Bï¼Œä¸” B Happens-Before Cï¼Œé‚£ä¹ˆ A Happens-Before Cã€‚

**æ€»ç»“**ï¼šHappens-Before å…³ç³»å¹¶ä¸ä»£è¡¨å®žé™…æ‰§è¡Œçš„æ—¶é—´é¡ºåºï¼Œè€Œæ˜¯**å†…å­˜å¯è§æ€§çš„ä¿è¯**ã€‚å®ƒæ˜¯åˆ¤æ–­æ•°æ®æ˜¯å¦å­˜åœ¨ç«žäº‰ã€çº¿ç¨‹æ˜¯å¦å®‰å…¨çš„ä¸»è¦ä¾æ®ã€‚

6. AQS åŽŸç†æµ…æžé¢è¯•å®˜ï¼š è®²ä¸€ä¸‹ AQS çš„æ ¸å¿ƒåŽŸç†ã€‚
æˆ‘ï¼šå¥½çš„ã€‚AQS (AbstractQueuedSynchronizer) æ˜¯ JUC å¹¶å‘åŒ…çš„æ ¸å¿ƒåŸºç¡€ç»„ä»¶ï¼Œåƒ ReentrantLockã€CountDownLatch ç­‰å·¥å…·éƒ½æ˜¯åŸºäºŽå®ƒå®žçŽ°çš„ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯ â€œä¸€ä¸ªçŠ¶æ€ä½ï¼ˆstateï¼‰+ ä¸€ä¸ªFIFOçº¿ç¨‹ç­‰å¾…é˜Ÿåˆ—ï¼ˆCLHï¼‰â€ã€‚

é¢è¯•å®˜ï¼š å…·ä½“è¯´è¯´ state å’Œ CLH é˜Ÿåˆ—çš„ä½œç”¨ã€‚
æˆ‘ï¼š

AQSæ ¸å¿ƒæ€æƒ³ï¼ˆstateã€CLHé˜Ÿåˆ—ï¼‰ï¼š
çŠ¶æ€ (state)ï¼šè¿™æ˜¯ä¸€ä¸ªç”± volatile ä¿®é¥°çš„ int æˆå‘˜å˜é‡ï¼Œè¡¨ç¤ºå…±äº«èµ„æºçš„çŠ¶æ€ã€‚å…·ä½“å«ä¹‰ç”±å­ç±»å®šä¹‰ï¼Œä¾‹å¦‚ï¼š
åœ¨ ReentrantLock ä¸­ï¼Œstate=0 è¡¨ç¤ºé”æœªè¢«å ç”¨ï¼Œstate&gt;0 è¡¨ç¤ºé”è¢«å ç”¨ï¼Œä¸”æ•°å€¼è¡¨ç¤ºé‡å…¥æ¬¡æ•°ã€‚
åœ¨ Semaphore ä¸­ï¼Œstate è¡¨ç¤ºå‰©ä½™çš„è®¸å¯è¯æ•°é‡ã€‚


CLHé˜Ÿåˆ—ï¼šè¿™æ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„åŒå‘ FIFO é˜Ÿåˆ—ï¼Œç”¨äºŽç®¡ç†èŽ·å–èµ„æºå¤±è´¥çš„çº¿ç¨‹ã€‚å½“çº¿ç¨‹äº‰æŠ¢èµ„æºå¤±è´¥æ—¶ï¼ŒAQS ä¼šå°†å½“å‰çº¿ç¨‹åŠå…¶ç­‰å¾…çŠ¶æ€ç­‰ä¿¡æ¯æž„é€ æˆä¸€ä¸ªèŠ‚ç‚¹ï¼ˆNodeï¼‰å¹¶åŠ å…¥é˜Ÿå°¾ï¼Œç„¶åŽé˜»å¡žè¯¥çº¿ç¨‹ï¼ˆLockSupport.park()ï¼‰ã€‚é˜Ÿåˆ—å¤´èŠ‚ç‚¹è¡¨ç¤ºå½“å‰æ­£æŒæœ‰èµ„æºçš„çº¿ç¨‹ã€‚




é¢è¯•å®˜ï¼š AQS æ˜¯å¦‚ä½•åŸºäºŽè¿™ä¸ªæ ¸å¿ƒæ€æƒ³æ¥å®žçŽ°å…¬å¹³é”çš„ï¼Ÿ
æˆ‘ï¼š

å¦‚ä½•å®žçŽ°å…¬å¹³é”ï¼š

- å…¬å¹³é” çš„æ ¸å¿ƒåŽŸåˆ™æ˜¯ï¼šå…ˆæ¥åŽåˆ°ï¼Œå³ç­‰å¾…æ—¶é—´æœ€é•¿çš„çº¿ç¨‹ï¼ˆé˜Ÿåˆ—å¤´èŠ‚ç‚¹çš„åŽç»§èŠ‚ç‚¹ï¼‰ä¼˜å…ˆèŽ·å–èµ„æºã€‚- å®žçŽ°æœºåˆ¶ï¼šå½“ä¸€ä¸ªçº¿ç¨‹ï¼ˆThread-Aï¼‰å°è¯•é€šè¿‡ lock() æ–¹æ³•èŽ·å–é”æ—¶ï¼Œå®ƒçš„æ ¸å¿ƒé€»è¾‘æ˜¯ï¼š

æ£€æŸ¥ state æ˜¯å¦ä¸º 0ï¼ˆé”æ˜¯å¦ç©ºé—²ï¼‰ã€‚
åœ¨åˆ¤æ–­é”ç©ºé—²åŽï¼Œå…¬å¹³é”çš„å®žçŽ°ä¼šå…ˆè°ƒç”¨ hasQueuedPredecessors() æ–¹æ³•æ£€æŸ¥ç­‰å¾…é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰å…¶ä»–çº¿ç¨‹åœ¨æŽ’é˜Ÿã€‚

- å¦‚æžœé˜Ÿåˆ—ä¸ºç©ºï¼Œæˆ–è€…å½“å‰çº¿ç¨‹è‡ªå·±å°±æ˜¯é˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹ï¼ˆå³å°†è¢«å”¤é†’çš„ä¸‹ä¸€ä¸ªï¼‰ï¼Œé‚£ä¹ˆå®ƒæ‰æœ‰èµ„æ ¼åŽ»ç”¨ CAS ç«žäº‰é”ã€‚- å¦‚æžœå‘çŽ°é˜Ÿåˆ—ä¸­æœ‰å…¶ä»–çº¿ç¨‹åœ¨ç­‰å¾…ï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹ä¼šæ”¾å¼ƒç«žäº‰ï¼Œç›´æŽ¥å°†è‡ªå·±åŠ å…¥é˜Ÿåˆ—æœ«å°¾è¿›è¡Œç­‰å¾…ï¼Œè¿™å°±ä¿è¯äº†â€œå…ˆæ¥åŽåˆ°â€çš„å…¬å¹³æ€§ã€‚- ä¸Žéžå…¬å¹³é”çš„åŒºåˆ«ï¼šéžå…¬å¹³é”ï¼ˆReentrantLock çš„é»˜è®¤æ–¹å¼ï¼‰åœ¨å°è¯•èŽ·å–é”æ—¶ï¼Œä¸ç®¡é˜Ÿåˆ—é‡Œæœ‰æ²¡æœ‰çº¿ç¨‹åœ¨ç­‰ï¼Œéƒ½ä¼šç›´æŽ¥åŽ»ç”¨ CAS æŠ¢é”ã€‚æŠ¢å¤±è´¥äº†æ‰å…¥é˜Ÿã€‚è¿™æé«˜äº†åžåé‡ä½†å¯èƒ½å¯¼è‡´â€œæ’é˜Ÿâ€çŽ°è±¡ï¼Œé€ æˆçº¿ç¨‹é¥¥é¥¿ã€‚
å››ã€Java è™šæ‹Ÿæœº (JVM)1. JVM å†…å­˜åŒºåŸŸä¸Žåˆ†é…é¢è¯•å®˜ï¼š è¯´ä¸€ä¸‹ JVM çš„å†…å­˜åŒºåŸŸæ˜¯å¦‚ä½•åˆ’åˆ†çš„ã€‚
æˆ‘ï¼šå¥½çš„ã€‚JVM å†…å­˜åŒºåŸŸä¸»è¦åˆ†ä¸ºçº¿ç¨‹å…±äº«åŒºå’Œçº¿ç¨‹ç§æœ‰åŒºã€‚

é¢è¯•å®˜ï¼š çº¿ç¨‹å…±äº«åŒºåŒ…å«å“ªäº›ï¼Ÿå„è‡ªçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ
æˆ‘ï¼š

çº¿ç¨‹å…±äº«åŒºï¼š
å † (Heap)ï¼š
ä½œç”¨ï¼šè¿™æ˜¯æœ€å¤§çš„ä¸€å—å†…å­˜åŒºåŸŸï¼Œç”¨äºŽå­˜æ”¾å¯¹è±¡å®žä¾‹å’Œæ•°ç»„ã€‚GCï¼ˆåžƒåœ¾å›žæ”¶ï¼‰ä¸»è¦å‘ç”Ÿåœ¨è¿™é‡Œã€‚
ç»†åˆ†ï¼šä»Žåžƒåœ¾å›žæ”¶è§’åº¦ï¼Œå¯åˆ†ä¸ºæ–°ç”Ÿä»£ (Young Generation) å’Œè€å¹´ä»£ (Old Generation)ã€‚æ–°ç”Ÿä»£åˆåˆ†ä¸º Eden åŒºå’Œä¸¤ä¸ª SurvivoråŒº (S0&#x2F;S1)ã€‚


æ–¹æ³•åŒº (Method Area)ï¼š
ä½œç”¨ï¼šç”¨äºŽå­˜å‚¨å·²è¢«è™šæ‹ŸæœºåŠ è½½çš„ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ã€å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åŽçš„ä»£ç ç­‰æ•°æ®ã€‚
å®žçŽ°ï¼šåœ¨ JDK8 ä¹‹å‰ï¼Œå®ƒçš„å®žçŽ°æ˜¯â€œæ°¸ä¹…ä»£â€(PermGen)ã€‚åœ¨ JDK8 åŠä¹‹åŽï¼Œæ”¹ä¸ºäº†å…ƒç©ºé—´ (Metaspace)ï¼Œå¹¶ä½¿ç”¨æœ¬åœ°å†…å­˜ (Native Memory) æ¥å®žçŽ°ï¼Œå¤§å¤§é™ä½Žäº†OOMçš„é£Žé™©ã€‚






é¢è¯•å®˜ï¼š é‚£çº¿ç¨‹ç§æœ‰åŒºå‘¢ï¼Ÿ
æˆ‘ï¼š

çº¿ç¨‹ç§æœ‰åŒºï¼š

- è™šæ‹Ÿæœºæ ˆ (VM Stack)ï¼š- ä½œç”¨ï¼šæè¿°çš„æ˜¯ Java æ–¹æ³•æ‰§è¡Œçš„å†…å­˜æ¨¡åž‹ã€‚æ¯ä¸ªæ–¹æ³•åœ¨æ‰§è¡Œæ—¶éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ ˆå¸§ï¼Œç”¨äºŽå­˜å‚¨å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€åŠ¨æ€é“¾æŽ¥ã€æ–¹æ³•å‡ºå£ç­‰ä¿¡æ¯ã€‚æˆ‘ä»¬å¸¸è¯´çš„â€œæ ˆå†…å­˜â€å°±æ˜¯æŒ‡è¿™é‡Œã€‚- å¼‚å¸¸ï¼šå¦‚æžœçº¿ç¨‹è¯·æ±‚çš„æ ˆæ·±åº¦å¤§äºŽè™šæ‹Ÿæœºæ‰€å…è®¸çš„æ·±åº¦ï¼Œå°†æŠ›å‡º StackOverflowErrorï¼›å¦‚æžœæ ˆå¯ä»¥åŠ¨æ€æ‰©å±•ä½†æ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿå†…å­˜ï¼Œåˆ™æŠ›å‡º OutOfMemoryErrorã€‚- æœ¬åœ°æ–¹æ³•æ ˆ (Native Method Stack)ï¼š- ä½œç”¨ï¼šä¸Žè™šæ‹Ÿæœºæ ˆéžå¸¸ç›¸ä¼¼ï¼ŒåŒºåˆ«åœ¨äºŽå®ƒä¸ºè™šæ‹Ÿæœºä½¿ç”¨çš„ Native æ–¹æ³•æœåŠ¡ã€‚- ç¨‹åºè®¡æ•°å™¨ (Program Counter Register)ï¼š- ä½œç”¨ï¼šä¸€å—è¾ƒå°çš„å†…å­˜ç©ºé—´ï¼Œå¯ä»¥çœ‹ä½œæ˜¯å½“å‰çº¿ç¨‹æ‰€æ‰§è¡Œçš„å­—èŠ‚ç çš„è¡Œå·æŒ‡ç¤ºå™¨ã€‚å®ƒæ˜¯å”¯ä¸€ä¸€ä¸ªåœ¨ JVM è§„èŒƒä¸­æ²¡æœ‰è§„å®šä»»ä½• OutOfMemoryError æƒ…å†µçš„åŒºåŸŸã€‚

é¢è¯•å®˜ï¼š ä½ åˆšæ‰è¿˜æåˆ°äº†ç›´æŽ¥å†…å­˜ï¼Œå®ƒå±žäºŽ JVM å†…å­˜åŒºåŸŸå—ï¼Ÿ
æˆ‘ï¼š

ç›´æŽ¥å†…å­˜ (Direct Memory)ï¼š

- ä¸å±žäºŽ JVM è¿è¡Œæ—¶æ•°æ®åŒºï¼Œä¹Ÿä¸æ˜¯ JVM è§„èŒƒä¸­å®šä¹‰çš„å†…å­˜åŒºåŸŸã€‚- ä½œç”¨ï¼šå®ƒæ˜¯ç”± NIO çš„ DirectByteBuffer å¼•ç”¨çš„å†…å­˜åŒºåŸŸï¼Œé€šå¸¸ç›´æŽ¥åœ¨ç‰©ç†å†…å­˜ä¸Šåˆ†é…ï¼Œé¿å…äº†åœ¨ Java å †å’Œ Native å †ä¹‹é—´æ¥å›žå¤åˆ¶æ•°æ®ï¼Œä»Žè€Œèƒ½æ˜¾è‘—æé«˜æ€§èƒ½ã€‚- å½±å“ï¼šè™½ç„¶ä¸å— JVM å†…å­˜ç®¡ç†ï¼Œä½†å…¶å¤§å°ä¹Ÿä¼šå—åˆ°æœ¬æœºæ€»å†…å­˜çš„é™åˆ¶ã€‚å¦‚æžœå„ä¸ªå†…å­˜åŒºåŸŸçš„æ€»å’Œå¤§äºŽç‰©ç†å†…å­˜é™åˆ¶ï¼ŒåŠ¨æ€æ‰©å±•æ—¶å¯èƒ½å¯¼è‡´ OutOfMemoryErrorã€‚
2. åžƒåœ¾å›žæ”¶ç®—æ³•ä¸Žæ”¶é›†å™¨é¢è¯•å®˜ï¼š è®²ä¸€ä¸‹ JVM å¦‚ä½•ç¡®å®šä¸€ä¸ªå¯¹è±¡æ˜¯åžƒåœ¾ï¼Ÿä»¥åŠæœ‰å“ªäº›åžƒåœ¾å›žæ”¶ç®—æ³•ã€‚
æˆ‘ï¼šå¥½çš„ã€‚åžƒåœ¾å›žæ”¶ä¸»è¦åˆ†ä¸¤æ­¥ï¼šé¦–å…ˆç¡®å®šå¯¹è±¡æ˜¯å¦å­˜æ´»ï¼ˆæ˜¯åžƒåœ¾ï¼‰ï¼Œç„¶åŽè¿›è¡Œå›žæ”¶ã€‚

é¢è¯•å®˜ï¼š å…ˆè¯´ä¸‹å¦‚ä½•ç¡®å®šåžƒåœ¾ã€‚
æˆ‘ï¼š

ç¡®å®šåžƒåœ¾çš„ç®—æ³•ï¼š
å¼•ç”¨è®¡æ•°æ³•ï¼š
åŽŸç†ï¼šç»™å¯¹è±¡ä¸­æ·»åŠ ä¸€ä¸ªå¼•ç”¨è®¡æ•°å™¨ï¼Œæ¯å½“æœ‰ä¸€ä¸ªåœ°æ–¹å¼•ç”¨å®ƒï¼Œè®¡æ•°å™¨å°±åŠ 1ï¼›å½“å¼•ç”¨å¤±æ•ˆæ—¶ï¼Œè®¡æ•°å™¨å°±å‡1ã€‚ä»»ä½•æ—¶åˆ»è®¡æ•°å™¨ä¸º0çš„å¯¹è±¡å°±æ˜¯ä¸å¯èƒ½å†è¢«ä½¿ç”¨çš„ã€‚
ç¼ºç‚¹ï¼šå®ƒæ— æ³•è§£å†³å¯¹è±¡ä¹‹é—´å¾ªçŽ¯å¼•ç”¨çš„é—®é¢˜ï¼ˆå³Aå¼•ç”¨Bï¼ŒBä¹Ÿå¼•ç”¨Aï¼Œä½†å†æ— ç¬¬ä¸‰æ–¹å¼•ç”¨å®ƒä»¬ä¿©ï¼‰ï¼Œä»Žè€Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚å› æ­¤ï¼Œä¸»æµçš„ Java è™šæ‹Ÿæœºéƒ½æ²¡æœ‰é€‰ç”¨å¼•ç”¨è®¡æ•°æ³•ã€‚


å¯è¾¾æ€§åˆ†æžç®—æ³•ï¼š
åŽŸç†ï¼šè¿™æ˜¯ JVM é‡‡ç”¨çš„ç®—æ³•ã€‚é€šè¿‡ä¸€ç³»åˆ—ç§°ä¸º â€œGC Rootsâ€ çš„æ ¹å¯¹è±¡ä½œä¸ºèµ·å§‹èŠ‚ç‚¹é›†ï¼Œä»Žè¿™äº›èŠ‚ç‚¹å¼€å§‹ï¼Œæ ¹æ®å¼•ç”¨å…³ç³»å‘ä¸‹æœç´¢ï¼Œæœç´¢è¿‡ç¨‹æ‰€èµ°è¿‡çš„è·¯å¾„ç§°ä¸ºâ€œå¼•ç”¨é“¾â€ã€‚å¦‚æžœæŸä¸ªå¯¹è±¡åˆ° GC Roots é—´æ²¡æœ‰ä»»ä½•å¼•ç”¨é“¾ç›¸è¿žï¼ˆå³ä»Ž GC Roots åˆ°è¿™ä¸ªå¯¹è±¡ä¸å¯è¾¾ï¼‰ï¼Œåˆ™è¯æ˜Žæ­¤å¯¹è±¡æ˜¯ä¸å¯èƒ½å†è¢«ä½¿ç”¨çš„ã€‚
å“ªäº›å¯¹è±¡å¯ä»¥ä½œä¸º GC Rootsï¼š
è™šæ‹Ÿæœºæ ˆï¼ˆæ ˆå¸§ä¸­çš„å±€éƒ¨å˜é‡è¡¨ï¼‰ä¸­å¼•ç”¨çš„å¯¹è±¡ã€‚
æœ¬åœ°æ–¹æ³•æ ˆä¸­ JNIï¼ˆå³ Native æ–¹æ³•ï¼‰å¼•ç”¨çš„å¯¹è±¡ã€‚
æ–¹æ³•åŒºä¸­ç±»é™æ€å±žæ€§å¼•ç”¨çš„å¯¹è±¡ã€‚
æ–¹æ³•åŒºä¸­å¸¸é‡å¼•ç”¨çš„å¯¹è±¡ã€‚
Java è™šæ‹Ÿæœºå†…éƒ¨çš„å¼•ç”¨ï¼ˆå¦‚åŸºæœ¬ç±»åž‹å¯¹åº”çš„ Class å¯¹è±¡ï¼Œå¸¸é©»çš„å¼‚å¸¸å¯¹è±¡ç­‰ï¼‰ã€‚
è¢«åŒæ­¥é”ï¼ˆsynchronizedï¼‰æŒæœ‰çš„å¯¹è±¡ã€‚








é¢è¯•å®˜ï¼š ç¡®å®šäº†åžƒåœ¾ä¹‹åŽï¼Œæœ‰å“ªäº›å›žæ”¶ç®—æ³•ï¼Ÿ
æˆ‘ï¼š

å›žæ”¶åžƒåœ¾çš„ç®—æ³•ï¼š

- æ ‡è®°-æ¸…é™¤ç®—æ³•ï¼š- è¿‡ç¨‹ï¼šåˆ†ä¸ºâ€œæ ‡è®°â€å’Œâ€œæ¸…é™¤â€ä¸¤ä¸ªé˜¶æ®µï¼šé¦–å…ˆæ ‡è®°å‡ºæ‰€æœ‰éœ€è¦å›žæ”¶çš„å¯¹è±¡ï¼Œåœ¨æ ‡è®°å®ŒæˆåŽï¼Œç»Ÿä¸€å›žæ”¶æŽ‰æ‰€æœ‰è¢«æ ‡è®°çš„å¯¹è±¡ã€‚- ç¼ºç‚¹ï¼šæ•ˆçŽ‡ä¸é«˜ï¼Œä¸”ä¼šäº§ç”Ÿå¤§é‡ä¸è¿žç»­çš„å†…å­˜ç¢Žç‰‡ï¼Œå¯¼è‡´ä»¥åŽéœ€è¦åˆ†é…è¾ƒå¤§å¯¹è±¡æ—¶æ— æ³•æ‰¾åˆ°è¶³å¤Ÿçš„è¿žç»­å†…å­˜è€Œä¸å¾—ä¸æå‰è§¦å‘å¦ä¸€æ¬¡ GCã€‚
- **å¤åˆ¶ç®—æ³•**ï¼š    - **è¿‡ç¨‹**ï¼šå°†å¯ç”¨å†…å­˜æŒ‰å®¹é‡åˆ†ä¸ºå¤§å°ç›¸ç­‰çš„ä¸¤å—ï¼Œæ¯æ¬¡åªä½¿ç”¨å…¶ä¸­ä¸€å—ã€‚å½“è¿™ä¸€å—çš„å†…å­˜ç”¨å®Œäº†ï¼Œå°±å°†è¿˜å­˜æ´»ç€çš„å¯¹è±¡**å¤åˆ¶**åˆ°å¦å¤–ä¸€å—ä¸Šé¢ï¼Œç„¶åŽå†æŠŠå·²ä½¿ç”¨è¿‡çš„å†…å­˜ç©ºé—´ä¸€æ¬¡æ¸…ç†æŽ‰ã€‚    - **ä¼˜ç‚¹**ï¼šå®žçŽ°ç®€å•ï¼Œè¿è¡Œé«˜æ•ˆï¼Œä¸”æ²¡æœ‰å†…å­˜ç¢Žç‰‡ã€‚    - **ç¼ºç‚¹**ï¼š**å†…å­˜ä»£ä»·å¤ªé«˜**ï¼Œå¯ç”¨å†…å­˜ç¼©å°ä¸ºäº†åŽŸæ¥çš„ä¸€åŠã€‚    - **åº”ç”¨**ï¼šæ˜¯**æ–°ç”Ÿä»£**åžƒåœ¾å›žæ”¶çš„ä¸»è¦ç®—æ³•ã€‚å•†ä¸šè™šæ‹Ÿæœºéƒ½é‡‡ç”¨è¿™ç§ç®—æ³•æ¥å›žæ”¶æ–°ç”Ÿä»£ï¼Œä½†å¹¶ä¸æ˜¯æŒ‰1:1çš„æ¯”ä¾‹åˆ’åˆ†ï¼Œè€Œæ˜¯å°†å†…å­˜åˆ†ä¸ºä¸€å—è¾ƒå¤§çš„ Eden ç©ºé—´å’Œä¸¤å—è¾ƒå°çš„ Survivor ç©ºé—´ï¼Œæ¯æ¬¡ä½¿ç”¨ Eden å’Œå…¶ä¸­ä¸€å— Survivorã€‚- **æ ‡è®°-æ•´ç†ç®—æ³•**ï¼š    - **è¿‡ç¨‹**ï¼šæ ‡è®°è¿‡ç¨‹ä¸Žâ€œæ ‡è®°-æ¸…é™¤â€ç®—æ³•ä¸€æ ·ï¼Œä½†åŽç»­æ­¥éª¤ä¸æ˜¯ç›´æŽ¥å¯¹å¯å›žæ”¶å¯¹è±¡è¿›è¡Œæ¸…ç†ï¼Œè€Œæ˜¯è®©æ‰€æœ‰å­˜æ´»çš„å¯¹è±¡éƒ½å‘å†…å­˜ç©ºé—´çš„ä¸€ç«¯ç§»åŠ¨ï¼Œç„¶åŽç›´æŽ¥æ¸…ç†æŽ‰è¾¹ç•Œä»¥å¤–çš„å†…å­˜ã€‚    - **ä¼˜ç‚¹**ï¼šé¿å…äº†å†…å­˜ç¢Žç‰‡ï¼Œä¹Ÿé¿å…äº†å¤åˆ¶ç®—æ³•çš„ç©ºé—´æµªè´¹ã€‚    - **ç¼ºç‚¹**ï¼šç§»åŠ¨å­˜æ´»å¯¹è±¡å¹¶æ›´æ–°æ‰€æœ‰å¼•ç”¨åœ°å€æ˜¯ä¸€é¡¹è´Ÿé‡æ“ä½œï¼Œéœ€è¦æš‚åœç”¨æˆ·çº¿ç¨‹ï¼ˆStop The Worldï¼‰ã€‚    - **åº”ç”¨**ï¼šä¸»è¦ç”¨äºŽ**è€å¹´ä»£**çš„åžƒåœ¾å›žæ”¶ã€‚- **åˆ†ä»£æ”¶é›†ç®—æ³•**ï¼š    - **æœ¬è´¨**ï¼šè¿™ä¸æ˜¯ä¸€ç§å…·ä½“çš„ç®—æ³•ï¼Œè€Œæ˜¯ä¸€ç§**ç†è®º**ã€‚å½“å‰å•†ä¸šè™šæ‹Ÿæœºçš„åžƒåœ¾æ”¶é›†å™¨éƒ½é‡‡ç”¨å®ƒã€‚    - **æ€æƒ³**ï¼šæ ¹æ®å¯¹è±¡å­˜æ´»å‘¨æœŸçš„ä¸åŒï¼Œå°† Java å †åˆ’åˆ†ä¸º**æ–°ç”Ÿä»£**å’Œ**è€å¹´ä»£**ï¼Œç„¶åŽæ ¹æ®å„ä¸ªå¹´ä»£çš„ç‰¹ç‚¹é‡‡ç”¨æœ€é€‚å½“çš„æ”¶é›†ç®—æ³•ã€‚        - åœ¨**æ–°ç”Ÿä»£**ä¸­ï¼Œæ¯æ¬¡åžƒåœ¾æ”¶é›†æ—¶éƒ½æœ‰å¤§æ‰¹å¯¹è±¡æ­»åŽ»ï¼Œåªæœ‰å°‘é‡å­˜æ´»ï¼Œé‚£å°±é€‰ç”¨**å¤åˆ¶ç®—æ³•**ï¼Œåªéœ€è¦ä»˜å‡ºå°‘é‡å­˜æ´»å¯¹è±¡çš„å¤åˆ¶æˆæœ¬å°±å¯ä»¥å®Œæˆæ”¶é›†ã€‚        - åœ¨**è€å¹´ä»£**ä¸­ï¼Œå› ä¸ºå¯¹è±¡å­˜æ´»çŽ‡é«˜ã€æ²¡æœ‰é¢å¤–ç©ºé—´å¯¹å®ƒè¿›è¡Œåˆ†é…æ‹…ä¿ï¼Œå°±å¿…é¡»ä½¿ç”¨**æ ‡è®°-æ¸…é™¤**æˆ–**æ ‡è®°-æ•´ç†**ç®—æ³•æ¥è¿›è¡Œå›žæ”¶ã€‚

3. æ€§èƒ½è°ƒä¼˜ã€OOMä¸Žå†…å­˜æ³„æ¼é¢è¯•å®˜ï¼š è°ˆè°ˆJVMè°ƒä¼˜çš„ç›®æ ‡å’Œå¸¸ç”¨å‚æ•°ã€‚
æˆ‘ï¼šå¥½çš„ã€‚JVMè°ƒä¼˜çš„æ ¸å¿ƒç›®æ ‡æ˜¯åœ¨åžåé‡ã€å»¶è¿Ÿå’Œå†…å­˜å ç”¨ä¸‰è€…é—´æ‰¾åˆ°æœ€ä½³å¹³è¡¡ã€‚

JVMè°ƒä¼˜ç›®æ ‡ï¼š
ä½Žå»¶è¿Ÿï¼šå‡å°‘ GCåœé¡¿æ—¶é—´ï¼ˆStop-The-Worldï¼‰ï¼Œæé«˜åº”ç”¨å“åº”é€Ÿåº¦ï¼Œé€‚åˆWebç­‰äº¤äº’å¼åº”ç”¨ã€‚
é«˜åžåé‡ï¼šå‡å°‘GCæ€»è€—æ—¶ï¼Œå¢žå¤§åº”ç”¨è¿è¡Œæ—¶é—´å æ¯”ï¼Œé€‚åˆåŽå°è®¡ç®—åž‹ä»»åŠ¡ã€‚
å‡å°‘å†…å­˜å ç”¨ï¼šåœ¨æ»¡è¶³éœ€æ±‚çš„å‰æä¸‹ï¼ŒæŽ§åˆ¶å †å†…å­˜å¤§å°ã€‚


å¸¸ç”¨å‚æ•°ï¼š
-Xms å’Œ -Xmxï¼šè®¾ç½®å †çš„åˆå§‹å¤§å°(-Xms)å’Œæœ€å¤§å¤§å°(-Xmx)ï¼Œé€šå¸¸è®¾ä¸ºç›¸åŒå€¼ä»¥é¿å…æ‰©å®¹å¸¦æ¥çš„æ€§èƒ½æŠ–åŠ¨ã€‚
-Xmnï¼šè®¾ç½®æ–°ç”Ÿä»£å¤§å°ã€‚æ•´ä¸ªJVMå †å¤§å° &#x3D; æ–°ç”Ÿä»£ + è€å¹´ä»£ã€‚
-XX:SurvivorRatioï¼šè®¾ç½®EdenåŒºä¸Žä¸€ä¸ªSurvivoråŒºçš„æ¯”ä¾‹ï¼ˆé»˜è®¤ä¸º8ï¼Œå³Eden:S0:S1&#x3D;8:1:1ï¼‰ã€‚
-XX:+UseG1GCï¼šæŒ‡å®šä½¿ç”¨G1åžƒåœ¾æ”¶é›†å™¨ã€‚
-XX:+PrintGC &#x2F; -XX:+PrintGCDetailsï¼šæ‰“å°GCæ—¥å¿—ï¼Œç”¨äºŽæŽ’æŸ¥ã€‚
-XX:MetaspaceSize å’Œ -XX:MaxMetaspaceSizeï¼šè®¾ç½®å…ƒç©ºé—´åˆå§‹å¤§å°å’Œæœ€å¤§å¤§å°ã€‚




é¢è¯•å®˜ï¼š ä»€ä¹ˆæ˜¯é€ƒé€¸åˆ†æžï¼Ÿæ ˆä¸Šåˆ†é…åˆæ˜¯ä»€ä¹ˆï¼Ÿ
æˆ‘ï¼š

é€ƒé€¸åˆ†æžï¼šæ˜¯JITç¼–è¯‘å™¨çš„ä¸€ç§é«˜çº§ä¼˜åŒ–æŠ€æœ¯ã€‚å®ƒé€šè¿‡åˆ†æžå¯¹è±¡çš„ä½œç”¨åŸŸï¼Œåˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦ä¼šè¢«å¤–éƒ¨æ–¹æ³•æˆ–å¤–éƒ¨çº¿ç¨‹æ‰€å¼•ç”¨ã€‚
æ–¹æ³•é€ƒé€¸ï¼šå¯¹è±¡è¢«ä½œä¸ºå‚æ•°ä¼ é€’ç»™å…¶ä»–æ–¹æ³•ã€‚
çº¿ç¨‹é€ƒé€¸ï¼šå¯¹è±¡è¢«èµ‹å€¼ç»™å…¶ä»–çº¿ç¨‹å¯è®¿é—®çš„å®žä¾‹å˜é‡ã€‚


æ ˆä¸Šåˆ†é…ï¼š
å¦‚æžœé€ƒé€¸åˆ†æžè¯æ˜Žä¸€ä¸ªå¯¹è±¡ä¸ä¼šé€ƒé€¸å‡ºæ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡å°±å¯ä»¥åœ¨æ ˆä¸Šåˆ†é…å†…å­˜ï¼Œè€Œä¸æ˜¯åœ¨å †ä¸Šã€‚
å¥½å¤„ï¼šå¯¹è±¡éšæ–¹æ³•æ ˆå¸§å‡ºæ ˆè€Œè‡ªåŠ¨é”€æ¯ï¼Œæ— éœ€åžƒåœ¾å›žæ”¶å™¨ä»‹å…¥ï¼Œæžå¤§å‡è½»äº†GCåŽ‹åŠ›ï¼Œæå‡äº†æ€§èƒ½ã€‚




é¢è¯•å®˜ï¼š å¸¸è§çš„OutOfMemoryErroræœ‰å“ªäº›ï¼Ÿå¦‚ä½•æŽ’æŸ¥ï¼Ÿ
æˆ‘ï¼š

OutOfMemoryErroré¿å…ä¸ŽæŽ’æŸ¥ï¼š

OOMé”™è¯¯æœ‰å¤šç§ç±»åž‹ï¼Œæ¯ç§åŽŸå› ä¸åŒï¼š- Java heap spaceï¼šå †å†…å­˜æº¢å‡ºã€‚æœ€å¸¸è§ï¼ŒåŽŸå› æ˜¯å¯¹è±¡å¤ªå¤šæˆ–å­˜åœ¨å†…å­˜æ³„æ¼ï¼Œå †ç©ºé—´ä¸è¶³ã€‚- æŽ’æŸ¥ï¼šä½¿ç”¨-XX:+HeapDumpOnOutOfMemoryErrorå‚æ•°åœ¨OOMæ—¶è‡ªåŠ¨ç”Ÿæˆå †è½¬å‚¨æ–‡ä»¶ï¼Œç„¶åŽç”¨MATã€JProfilerç­‰å·¥å…·åˆ†æžï¼Œæ‰¾åˆ°æ˜¯å“ªäº›å¯¹è±¡å ç”¨äº†å¤§é‡å†…å­˜ä»¥åŠå®ƒä»¬çš„GC Rootså¼•ç”¨é“¾ã€‚- Metaspace &#x2F; PermGen spaceï¼šå…ƒç©ºé—´ï¼ˆæ–¹æ³•åŒºï¼‰æº¢å‡ºã€‚åŽŸå› æ˜¯åŠ è½½çš„ç±»è¿‡å¤šï¼Œå¦‚å¤§é‡åŠ¨æ€ä»£ç†ã€åå°„ã€‚- GC overhead limit exceededï¼šGC overhead limit exceededï¼šGCå›žæ”¶æ•ˆçŽ‡è¿‡ä½Žå¯¼è‡´çš„æº¢å‡ºã€‚é»˜è®¤å¦‚æžœè¶…è¿‡98%çš„æ—¶é—´éƒ½åœ¨åšGCå¹¶ä¸”å›žæ”¶ä¸åˆ°2%çš„å †ç©ºé—´ï¼Œå°±ä¼šæŠ›å‡ºæ­¤é”™è¯¯ã€‚æœ¬è´¨æ˜¯å †å†…å­˜å¤ªå°æˆ–å†…å­˜æ³„æ¼ã€‚- Unable to create new native threadï¼šæ— æ³•åˆ›å»ºæœ¬åœ°çº¿ç¨‹ã€‚åŽŸå› æ˜¯åˆ›å»ºçš„çº¿ç¨‹æ•°è¶…è¿‡ç³»ç»Ÿé™åˆ¶ï¼ˆå¦‚Linuxçš„ulimitï¼‰æˆ–å†…å­˜ä¸è¶³ã€‚

é¢è¯•å®˜ï¼š ä»€ä¹ˆæ˜¯å†…å­˜æ³„æ¼ï¼Ÿä¸¾å‡ ä¸ªå¸¸è§ä¾‹å­ã€‚
æˆ‘ï¼š

å†…å­˜æ³„æ¼æ¦‚å¿µä¸Žå¸¸è§æ¡ˆä¾‹ï¼š

- æ¦‚å¿µï¼šæŒ‡ç¨‹åºä¸­å·²åŠ¨æ€åˆ†é…çš„å †å†…å­˜ç”±äºŽæŸç§åŽŸå› æœªèƒ½è¢«é‡Šæ”¾æˆ–æ— æ³•è¢«é‡Šæ”¾ï¼Œé€ æˆç³»ç»Ÿå†…å­˜çš„æµªè´¹ï¼Œæœ€ç»ˆå¯èƒ½å¯¼è‡´OOMã€‚- å®ƒä¸Žå†…å­˜æº¢å‡ºçš„å…³ç³»ï¼šå†…å­˜æ³„æ¼æ˜¯åŽŸå› ï¼Œå†…å­˜æº¢å‡ºæ˜¯ç»“æžœã€‚æŒç»­çš„æ³„æ¼æœ€ç»ˆä¼šå¯¼è‡´æº¢å‡ºã€‚
**å¸¸è§æ¡ˆä¾‹**ï¼š- **ç¼“å­˜æ³„æ¼**ï¼šä½¿ç”¨äº†æ— å¤§å°é™åˆ¶çš„ç¼“å­˜ï¼ˆå¦‚`HashMap`ä½œä¸ºç¼“å­˜ï¼‰ï¼Œå¯¹è±¡åªæ”¾å…¥ä¸å–å‡ºã€‚åº”ä½¿ç”¨`WeakHashMap`æˆ–ç±»ä¼¼Guava Cacheçš„ã€å…·æœ‰LRUæ·˜æ±°æœºåˆ¶çš„ç¼“å­˜ã€‚- **ç›‘å¬å™¨æœªç§»é™¤**ï¼šå‘å…¨å±€é›†åˆï¼ˆå¦‚ä¸€ä¸ªé™æ€Listï¼‰æ³¨å†Œäº†ç›‘å¬å™¨ï¼Œä½†åœ¨å¯¹è±¡ä¸ç”¨åŽæ²¡æœ‰å–æ¶ˆæ³¨å†Œï¼Œå¯¼è‡´é›†åˆä¸€ç›´æŒæœ‰å¯¹è±¡çš„å¼•ç”¨ï¼Œæ— æ³•è¢«å›žæ”¶ã€‚- **æ•°æ®åº“è¿žæŽ¥ã€æ–‡ä»¶æµæœªå…³é—­**ï¼šè¿™äº›èµ„æºä¸ä»…å ç”¨å†…å­˜ï¼Œè¿˜å ç”¨ç³»ç»Ÿå¥æŸ„ã€‚- **å†…éƒ¨ç±»æŒæœ‰å¤–éƒ¨ç±»å¼•ç”¨**ï¼šéžé™æ€å†…éƒ¨ç±»ä¼šéšå¼æŒæœ‰å¤–éƒ¨ç±»çš„å¼•ç”¨ã€‚å¦‚æžœè¿™ä¸ªå†…éƒ¨ç±»çš„å®žä¾‹è¢«ä¸€ä¸ªé•¿ç”Ÿå‘½å‘¨æœŸå¯¹è±¡å¼•ç”¨ï¼Œå°±ä¼šå¯¼è‡´å¤–éƒ¨ç±»ä¹Ÿæ— æ³•è¢«å›žæ”¶ã€‚



äº”ã€Java å¤šçº¿ç¨‹ (Java Multithreading)1. çº¿ç¨‹æ± æ ¸å¿ƒåŽŸç†ä¸Žå‚æ•°é…ç½®é¢è¯•å®˜ï¼š è¯´ä¸€ä¸‹çº¿ç¨‹æ± çš„7ä¸ªæ ¸å¿ƒå‚æ•°ã€‚
æˆ‘ï¼šå¥½çš„ã€‚é€šè¿‡ ThreadPoolExecutor çš„æž„é€ å‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°7ä¸ªæ ¸å¿ƒå‚æ•°ï¼š

corePoolSizeï¼šæ ¸å¿ƒçº¿ç¨‹æ•°ã€‚çº¿ç¨‹æ± ç»´æŠ¤çš„æœ€å°çº¿ç¨‹æ•°é‡ï¼Œå³ä½¿å®ƒä»¬å¤„äºŽç©ºé—²çŠ¶æ€ï¼Œä¹Ÿä¸ä¼šè¢«å›žæ”¶ï¼ˆé™¤éžè®¾ç½®äº† allowCoreThreadTimeOutï¼‰ã€‚
maximumPoolSizeï¼šæœ€å¤§çº¿ç¨‹æ•°ã€‚çº¿ç¨‹æ± å…è®¸åˆ›å»ºçš„æœ€å¤§çº¿ç¨‹æ•°é‡ã€‚
keepAliveTimeï¼šç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´ã€‚å½“çº¿ç¨‹æ•°è¶…è¿‡ corePoolSize æ—¶ï¼Œå¤šä½™çš„ç©ºé—²çº¿ç¨‹åœ¨ç»ˆæ­¢å‰ç­‰å¾…æ–°ä»»åŠ¡çš„æœ€é•¿æ—¶é—´ã€‚
unitï¼škeepAliveTime å‚æ•°çš„æ—¶é—´å•ä½ã€‚
workQueueï¼šä»»åŠ¡é˜Ÿåˆ—ã€‚ç”¨äºŽä¿å­˜ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡çš„é˜»å¡žé˜Ÿåˆ—ï¼ˆå¦‚ ArrayBlockingQueue, LinkedBlockingQueueï¼‰ã€‚
threadFactoryï¼šçº¿ç¨‹å·¥åŽ‚ã€‚ç”¨äºŽåˆ›å»ºæ–°çº¿ç¨‹ï¼Œå¯ä»¥è®¾ç½®çº¿ç¨‹åã€ä¼˜å…ˆçº§ç­‰ï¼Œä¾¿äºŽæŽ’æŸ¥é—®é¢˜ã€‚
handlerï¼šæ‹’ç»ç­–ç•¥ã€‚å½“çº¿ç¨‹æ± å’Œé˜Ÿåˆ—éƒ½å·²æ»¡æ—¶ï¼Œç”¨äºŽå¤„ç†æ–°æäº¤ä»»åŠ¡çš„ç­–ç•¥ï¼ˆå¦‚æŠ›å‡ºå¼‚å¸¸ã€ç›´æŽ¥ä¸¢å¼ƒç­‰ï¼‰ã€‚


é¢è¯•å®˜ï¼š æè¿°ä¸€ä¸‹ä»»åŠ¡æäº¤åˆ°çº¿ç¨‹æ± åŽçš„æ‰§è¡Œæµç¨‹ã€‚
æˆ‘ï¼š

ä»»åŠ¡æäº¤æµç¨‹ï¼š

å½“ä¸€ä¸ªæ–°ä»»åŠ¡è¢«æäº¤ (execute()) æ—¶ï¼Œæµç¨‹å¦‚ä¸‹ï¼š

é¦–å…ˆï¼Œåˆ¤æ–­å½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°æ˜¯å¦å°äºŽ corePoolSizeã€‚å¦‚æžœæ˜¯ï¼Œåˆ™åˆ›å»ºæ–°çš„æ ¸å¿ƒçº¿ç¨‹æ¥æ‰§è¡Œè¯¥ä»»åŠ¡ï¼ˆå³ä½¿æœ‰å…¶ä»–ç©ºé—²çº¿ç¨‹ï¼‰ã€‚
å¦‚æžœå½“å‰çº¿ç¨‹æ•°å·²è¾¾åˆ° corePoolSizeï¼Œåˆ™å°è¯•å°†ä»»åŠ¡æ”¾å…¥å·¥ä½œé˜Ÿåˆ— (workQueue) ç­‰å¾…ã€‚
å¦‚æžœé˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™åˆ¤æ–­å½“å‰çº¿ç¨‹æ•°æ˜¯å¦å°äºŽ maximumPoolSizeã€‚å¦‚æžœæ˜¯ï¼Œåˆ™åˆ›å»ºæ–°çš„éžæ ¸å¿ƒçº¿ç¨‹æ¥æ‰§è¡Œè¯¥ä»»åŠ¡ã€‚
å¦‚æžœçº¿ç¨‹æ•°ä¹Ÿå·²è¾¾åˆ° maximumPoolSizeï¼Œå¹¶ä¸”é˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™è§¦å‘æ‹’ç»ç­–ç•¥ (handler)ã€‚

**ç®€å•è®°æ³•**ï¼š**å…ˆæ ¸å¿ƒ -&gt; å†å…¥é˜Ÿ -&gt; åŽæ‰©å®¹ -&gt; æœ€åŽæ‹’ç»**ã€‚


é¢è¯•å®˜ï¼š åœ¨å®žé™…é¡¹ç›®ä¸­ï¼Œå¦‚ä½•è®¾ç½®æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Ÿ
æˆ‘ï¼š

æ ¸å¿ƒå‚æ•°è®¡ç®—ï¼š

è¿™æ˜¯ä¸€ä¸ªç»éªŒå€¼ï¼Œéœ€è¦æ ¹æ®ä»»åŠ¡ç±»åž‹æ˜¯ CPUå¯†é›†åž‹ è¿˜æ˜¯ IOå¯†é›†åž‹ æ¥è°ƒæ•´ã€‚
- **CPUå¯†é›†åž‹**ï¼š    - **ç‰¹ç‚¹**ï¼šä»»åŠ¡ä¸»è¦æ¶ˆè€—CPUèµ„æºï¼Œéœ€è¦è¿›è¡Œå¤§é‡è®¡ç®—ï¼ˆä¾‹å¦‚ï¼Œè®¡ç®—åœ†å‘¨çŽ‡ã€è§†é¢‘ç¼–ç ï¼‰ã€‚    - **è®¾ç½®**ï¼šçº¿ç¨‹æ•°ä¸å®œè¿‡å¤šï¼Œé€šå¸¸è®¾ç½®ä¸º **`CPUæ ¸å¿ƒæ•° + 1`**ã€‚è®¾ç½®è¿‡å¤šä¼šå¯¼è‡´å¤§é‡çš„çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œåè€Œé™ä½Žæ€§èƒ½ã€‚- **IOå¯†é›†åž‹**ï¼š    - **ç‰¹ç‚¹**ï¼šä»»åŠ¡å¤§éƒ¨åˆ†æ—¶é—´åœ¨ç­‰å¾…IOæ“ä½œï¼ˆå¦‚æ•°æ®åº“æŸ¥è¯¢ã€ç½‘ç»œè¯·æ±‚ã€æ–‡ä»¶è¯»å†™ï¼‰ï¼ŒCPUç©ºé—²ã€‚    - **è®¾ç½®**ï¼šçº¿ç¨‹æ•°å¯ä»¥è®¾ç½®å¾—å¤šä¸€äº›ï¼Œä»¥å……åˆ†åˆ©ç”¨CPUèµ„æºã€‚é€šå¸¸å¯ä»¥è®¾ç½®ä¸º **`2 * CPUæ ¸å¿ƒæ•°`**ï¼Œæˆ–è€…æ›´é«˜ã€‚æ›´ç²¾ç¡®çš„ä¼°ç®—å…¬å¼æ˜¯ï¼š**`çº¿ç¨‹æ•° = CPUæ ¸å¿ƒæ•° * (1 + å¹³å‡ç­‰å¾…æ—¶é—´ / å¹³å‡è®¡ç®—æ—¶é—´)`**ã€‚**æ³¨æ„**ï¼šè¿™åªæ˜¯ä¸€ä¸ªç†è®ºä¸Šçš„èµ·å§‹å€¼ï¼Œ**å®žé™…ç”Ÿäº§ä¸­éœ€è¦é€šè¿‡åŽ‹æµ‹æ¥æ‰¾åˆ°æœ€é€‚åˆè‡ªå·±åº”ç”¨çš„å‚æ•°**ã€‚



å…­ã€æ•°æ®åº“ (Database)1. MySQL1.1 äº‹åŠ¡ä¸Ž ACID å±žæ€§
é¢è¯•å®˜ï¼š ä½ å…ˆè¯´è¯´ MySQL çš„äº‹åŠ¡å’Œå®ƒçš„ ACID å±žæ€§å§ã€‚
æˆ‘ï¼š
å¥½çš„ã€‚äº‹åŠ¡æ˜¯æ•°æ®åº“æ“ä½œçš„åŸºæœ¬å•å…ƒï¼Œå®ƒæ˜¯ä¸€ä¸ªä¸å¯åˆ†å‰²çš„å·¥ä½œåºåˆ—ï¼Œè¦ä¹ˆå…¨éƒ¨æ‰§è¡ŒæˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œå¤±è´¥ï¼Œèƒ½ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§å’Œå®Œæ•´æ€§ã€‚
äº‹åŠ¡çš„ ACID å±žæ€§æ˜¯å…¶æ ¸å¿ƒç‰¹æ€§ï¼Œå…·ä½“æŒ‡ï¼š

åŽŸå­æ€§ï¼ˆAtomicityï¼‰ï¼šäº‹åŠ¡ä¸­çš„æ‰€æœ‰æ“ä½œè¦ä¹ˆå…¨éƒ¨å®Œæˆï¼Œè¦ä¹ˆå…¨éƒ¨ä¸å®Œæˆï¼Œä¸ä¼šå­˜åœ¨éƒ¨åˆ†æ‰§è¡Œçš„æƒ…å†µã€‚æ¯”å¦‚è½¬è´¦æ—¶ï¼Œâ€œä»Ž A è´¦æˆ·æ‰£é’±â€ å’Œ â€œç»™ B è´¦æˆ·åŠ é’±â€ è¿™ä¸¤ä¸ªæ“ä½œè¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å¤±è´¥ï¼Œä¸ä¼šå‡ºçŽ° A æ‰£äº†é’±ä½† B æ²¡æ”¶åˆ°çš„æƒ…å†µã€‚

ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ï¼šäº‹åŠ¡æ‰§è¡Œå‰åŽï¼Œæ•°æ®åº“çš„å®Œæ•´æ€§çº¦æŸä¸ä¼šè¢«ç ´åã€‚ä¾‹å¦‚ï¼Œå‡è®¾è¡¨ä¸­æœ‰ â€œæ€»é‡‘é¢ &#x3D; A è´¦æˆ·é‡‘é¢ + B è´¦æˆ·é‡‘é¢â€ çš„çº¦æŸï¼Œè½¬è´¦äº‹åŠ¡æ‰§è¡ŒåŽï¼Œè¿™ä¸ªç­‰å¼ä¾ç„¶æˆç«‹ã€‚

éš”ç¦»æ€§ï¼ˆIsolationï¼‰ï¼šå¤šä¸ªäº‹åŠ¡å¹¶å‘æ‰§è¡Œæ—¶ï¼Œä¸€ä¸ªäº‹åŠ¡çš„æ‰§è¡Œä¸åº”è¢«å…¶ä»–äº‹åŠ¡å¹²æ‰°ï¼Œæ¯ä¸ªäº‹åŠ¡éƒ½åƒåœ¨ç‹¬ç«‹æ‰§è¡Œä¸€æ ·ã€‚é¿å…å› å¹¶å‘æ“ä½œå¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚

æŒä¹…æ€§ï¼ˆDurabilityï¼‰ï¼šä¸€æ—¦äº‹åŠ¡æäº¤æˆåŠŸï¼Œå®ƒå¯¹æ•°æ®åº“ä¸­æ•°æ®çš„ä¿®æ”¹å°±æ˜¯æ°¸ä¹…æ€§çš„ï¼Œå³ä½¿ä¹‹åŽå‘ç”Ÿæ•°æ®åº“å´©æºƒç­‰æ•…éšœï¼Œä¿®æ”¹çš„æ•°æ®ä¹Ÿä¸ä¼šä¸¢å¤±ã€‚


1.2 äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸Ž MVCC æœºåˆ¶
é¢è¯•å®˜ï¼š é‚£äº‹åŠ¡çš„éš”ç¦»çº§åˆ«æœ‰å“ªäº›ï¼ŸMySQL çš„é»˜è®¤éš”ç¦»çº§åˆ«æ˜¯ä»€ä¹ˆï¼ŸMVCC æœºåˆ¶ä½ äº†è§£å—ï¼Ÿ
æˆ‘ï¼š
äº‹åŠ¡éš”ç¦»çº§åˆ«æ˜¯ä¸ºäº†åº”å¯¹å¹¶å‘äº‹åŠ¡å¯èƒ½å‡ºçŽ°çš„é—®é¢˜ï¼ˆå¦‚è„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯»ï¼‰è€Œè®¾å®šçš„ï¼Œä¸»è¦æœ‰ 4 ç§ï¼š

è¯»æœªæäº¤ï¼ˆRead Uncommittedï¼‰ï¼šæœ€ä½Žçš„éš”ç¦»çº§åˆ«ã€‚ä¸€ä¸ªäº‹åŠ¡å¯ä»¥è¯»å–åˆ°å¦ä¸€ä¸ªæœªæäº¤äº‹åŠ¡ä¿®æ”¹çš„æ•°æ®ï¼Œå¯èƒ½å¯¼è‡´è„è¯»ï¼ˆè¯»å–åˆ°æœªæäº¤çš„æ— æ•ˆæ•°æ®ï¼‰ã€‚

è¯»å·²æäº¤ï¼ˆRead Committedï¼‰ï¼šä¸€ä¸ªäº‹åŠ¡åªèƒ½è¯»å–åˆ°å¦ä¸€ä¸ªå·²æäº¤äº‹åŠ¡ä¿®æ”¹çš„æ•°æ®ï¼Œè§£å†³äº†è„è¯»é—®é¢˜ï¼Œä½†å¯èƒ½å‡ºçŽ°ä¸å¯é‡å¤è¯»ï¼ˆåŒä¸€äº‹åŠ¡ä¸­å¤šæ¬¡è¯»å–åŒä¸€æ•°æ®ï¼Œç»“æžœå› å…¶ä»–äº‹åŠ¡æäº¤çš„ä¿®æ”¹è€Œä¸åŒï¼‰ã€‚

å¯é‡å¤è¯»ï¼ˆRepeatable Readï¼‰ï¼šMySQL çš„é»˜è®¤éš”ç¦»çº§åˆ«ã€‚ä¿è¯åŒä¸€äº‹åŠ¡ä¸­å¤šæ¬¡è¯»å–åŒä¸€æ•°æ®æ—¶ï¼Œç»“æžœä¸€è‡´ï¼Œè§£å†³äº†ä¸å¯é‡å¤è¯»é—®é¢˜ï¼Œä½†åœ¨é»˜è®¤æƒ…å†µä¸‹å¯èƒ½å‡ºçŽ°å¹»è¯»ï¼ˆåŒä¸€äº‹åŠ¡ä¸­ï¼ŒæŒ‰åŒä¸€æ¡ä»¶å¤šæ¬¡æŸ¥è¯¢ï¼Œç»“æžœé›†è¡Œæ•°å› å…¶ä»–äº‹åŠ¡çš„æ’å…¥ &#x2F; åˆ é™¤è€Œå˜åŒ–ï¼‰ã€‚

ä¸²è¡ŒåŒ–ï¼ˆSerializableï¼‰ï¼šæœ€é«˜çš„éš”ç¦»çº§åˆ«ã€‚äº‹åŠ¡ä¸²è¡Œæ‰§è¡Œï¼Œå®Œå…¨é¿å…äº†å¹¶å‘é—®é¢˜ï¼Œä½†æ€§èƒ½æžä½Žï¼Œé€šå¸¸åªåœ¨æ•°æ®ä¸€è‡´æ€§è¦æ±‚æžé«˜ä¸”å¹¶å‘é‡ä½Žçš„åœºæ™¯ä½¿ç”¨ã€‚


MVCCï¼ˆMulti-Version Concurrency Controlï¼Œå¤šç‰ˆæœ¬å¹¶å‘æŽ§åˆ¶ï¼‰æ˜¯ MySQL å®žçŽ°è¯»å·²æäº¤å’Œå¯é‡å¤è¯»éš”ç¦»çº§åˆ«çš„æ ¸å¿ƒæœºåˆ¶ï¼Œå®ƒé€šè¿‡ä¸ºæ•°æ®ä¿å­˜å¤šä¸ªç‰ˆæœ¬ï¼Œè®©è¯»å†™æ“ä½œä¸ç›¸äº’é˜»å¡žï¼Œæå‡å¹¶å‘æ€§èƒ½ã€‚å…¶å®žçŽ°åŽŸç†ä¸»è¦æ¶‰åŠç‰ˆæœ¬é“¾å’ŒReadViewï¼š

ç‰ˆæœ¬é“¾ï¼šæ¯è¡Œæ•°æ®åœ¨è¢«ä¿®æ”¹æ—¶ï¼Œä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„ç‰ˆæœ¬ï¼Œæ—§ç‰ˆæœ¬ä¸ä¼šè¢«ç«‹å³åˆ é™¤ï¼Œè€Œæ˜¯ä¿ç•™ä¸‹æ¥å¹¶é€šè¿‡éšè—åˆ—ï¼ˆå¦‚DB_TRX_IDè®°å½•ä¿®æ”¹äº‹åŠ¡ IDã€DB_ROLL_PTRæŒ‡å‘æ—§ç‰ˆæœ¬æ•°æ®ï¼‰å½¢æˆé“¾è¡¨ï¼Œå³ç‰ˆæœ¬é“¾ã€‚

ReadViewï¼šäº‹åŠ¡åœ¨è¿›è¡Œå¿«ç…§è¯»ï¼ˆæ™®é€š SELECT æ“ä½œï¼‰æ—¶ï¼Œä¼šç”Ÿæˆä¸€ä¸ª ReadViewï¼Œå®ƒåŒ…å«å½“å‰æ´»è·ƒäº‹åŠ¡çš„ ID åˆ—è¡¨ç­‰ä¿¡æ¯ã€‚é€šè¿‡æ¯”è¾ƒæ•°æ®ç‰ˆæœ¬çš„DB_TRX_IDä¸Ž ReadView ä¸­çš„ä¿¡æ¯ï¼Œæ¥åˆ¤æ–­è¯¥ç‰ˆæœ¬æ•°æ®æ˜¯å¦å¯è§ï¼šè‹¥æ•°æ®ç‰ˆæœ¬çš„äº‹åŠ¡ ID ä¸åœ¨æ´»è·ƒåˆ—è¡¨ä¸­ä¸”å°äºŽ ReadView ä¸­çš„æœ€å¤§äº‹åŠ¡ ID ç­‰ï¼ˆä¸åŒéš”ç¦»çº§åˆ«ä¸‹åˆ¤æ–­é€»è¾‘æœ‰å·®å¼‚ï¼‰ï¼Œåˆ™æ•°æ®å¯è§ã€‚


è¯»å·²æäº¤éš”ç¦»çº§åˆ«ä¸‹ï¼Œæ¯æ¬¡æ‰§è¡Œ SELECT éƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„ ReadViewï¼Œæ‰€ä»¥èƒ½çœ‹åˆ°å…¶ä»–äº‹åŠ¡å·²æäº¤çš„ä¿®æ”¹ï¼›å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œä»…åœ¨ç¬¬ä¸€æ¬¡ SELECT æ—¶ç”Ÿæˆ ReadViewï¼Œä¹‹åŽå¤ç”¨è¯¥ ReadViewï¼Œå› æ­¤èƒ½ä¿è¯åŒä¸€äº‹åŠ¡ä¸­å¤šæ¬¡è¯»å–ç»“æžœä¸€è‡´ã€‚
é¢è¯•å®˜ï¼š é‚£å¯é‡å¤è¯»çº§åˆ«ä¸‹æ˜¯æ€Žä¹ˆè§£å†³å¹»è¯»çš„å‘¢ï¼Ÿ
æˆ‘ï¼š
MySQL çš„å¯é‡å¤è¯»çº§åˆ«é€šè¿‡ â€œMVCC å¿«ç…§è¯» + Next-Key Lock å½“å‰è¯»â€ çš„ç»„åˆæ¥è§£å†³å¹»è¯»é—®é¢˜ï¼š

MVCC å¿«ç…§è¯»ï¼šå¯¹äºŽæ™®é€šçš„ SELECT æŸ¥è¯¢ï¼ˆå¿«ç…§è¯»ï¼‰ï¼Œç”±äºŽå¤ç”¨ç¬¬ä¸€æ¬¡ç”Ÿæˆçš„ ReadViewï¼Œå³ä½¿å…¶ä»–äº‹åŠ¡æ’å…¥äº†æ–°æ•°æ®ï¼Œæ–°æ•°æ®çš„äº‹åŠ¡ ID åœ¨å½“å‰ ReadView ä¸­å¯èƒ½è¢«åˆ¤å®šä¸ºä¸å¯è§ï¼Œå› æ­¤ä¸ä¼šè¯»å–åˆ°æ–°æ’å…¥çš„æ•°æ®ï¼Œé¿å…äº†å¿«ç…§è¯»åœºæ™¯ä¸‹çš„å¹»è¯»ã€‚

Next-Key Lock å½“å‰è¯»ï¼šå¯¹äºŽåŠ é”çš„æŸ¥è¯¢ï¼ˆå¦‚SELECT â€¦ FOR UPDATEã€UPDATEã€DELETEç­‰å½“å‰è¯»æ“ä½œï¼‰ï¼ŒMySQL ä¼šä½¿ç”¨ Next-Key Lockã€‚å®ƒæ˜¯è¡Œé”å’Œé—´éš™é”çš„ç»„åˆï¼Œä¸ä»…ä¼šé”å®šç¬¦åˆæ¡ä»¶çš„è¡Œï¼Œè¿˜ä¼šé”å®šè¿™äº›è¡Œæ‰€åœ¨é—´éš™ï¼ˆå³ä¸å­˜åœ¨çš„ã€å¯èƒ½è¢«æ’å…¥æ•°æ®çš„åŒºé—´ï¼‰ï¼Œé˜²æ­¢å…¶ä»–äº‹åŠ¡åœ¨é—´éš™ä¸­æ’å…¥æ–°æ•°æ®ï¼Œä»Žè€Œé¿å…äº†å½“å‰è¯»åœºæ™¯ä¸‹çš„å¹»è¯»ã€‚


1.3 é”æœºåˆ¶ï¼šé—´éš™é”ä¸Žä¸´é”®é”
é¢è¯•å®˜ï¼š èŠå®Œéš”ç¦»çº§åˆ«ï¼Œå†è¯´è¯´ MySQL çš„é”æœºåˆ¶å§ï¼Œç‰¹åˆ«æ˜¯é—´éš™é”å’Œä¸´é”®é”ã€‚
æˆ‘ï¼š
MySQL çš„é”æœºåˆ¶æŒ‰ç²’åº¦å¯åˆ†ä¸ºè¡¨é”ã€è¡Œé”ç­‰ï¼Œè¡Œé”æ˜¯å¹¶å‘æŽ§åˆ¶çš„å…³é”®ï¼Œè€Œé—´éš™é”å’Œä¸´é”®é”æ˜¯è¡Œé”çš„æ‰©å±•ï¼š

é—´éš™é”ï¼ˆGap Lockï¼‰ï¼šé”å®šçš„æ˜¯ä¸€ä¸ªåŒºé—´ï¼Œè€Œä¸æ˜¯å…·ä½“çš„è¡Œã€‚å½“äº‹åŠ¡å¯¹æŸæ¡è®°å½•åŠ é”æ—¶ï¼Œè‹¥è¯¥è®°å½•æ‰€åœ¨ç´¢å¼•åŒºé—´å­˜åœ¨æœªä½¿ç”¨çš„é—´éš™ï¼Œä¼šå¯¹è¿™äº›é—´éš™åŠ é”ã€‚ä¾‹å¦‚ï¼Œè¡¨ä¸­æœ‰ id ä¸º 1ã€3ã€5 çš„è®°å½•ï¼Œå¯¹ id&#x3D;3 çš„è®°å½•åŠ é”æ—¶ï¼Œå¯èƒ½ä¼šé”å®š (1,3)ã€(3,5) è¿™æ ·çš„é—´éš™ï¼Œé˜²æ­¢å…¶ä»–äº‹åŠ¡åœ¨è¿™äº›é—´éš™ä¸­æ’å…¥ id&#x3D;2ã€4 çš„è®°å½•ï¼Œä¸»è¦ç”¨äºŽè§£å†³å¹»è¯»ã€‚

ä¸´é”®é”ï¼ˆNext-Key Lockï¼‰ï¼šæ˜¯è¡Œé”å’Œé—´éš™é”çš„ç»“åˆï¼Œé”å®šçš„æ˜¯ â€œè®°å½• + é—´éš™â€ã€‚å®ƒä¼šé”å®šå½“å‰è®°å½•ä»¥åŠè¯¥è®°å½•å‰é¢çš„é—´éš™ã€‚æ¯”å¦‚ä¸Šè¿° id&#x3D;3 çš„ä¾‹å­ï¼Œä¸´é”®é”ä¼šé”å®š (1,3] è¿™ä¸ªåŒºé—´ï¼ˆåŒ…å« 3 è¿™æ¡è®°å½•å’Œ 1 åˆ° 3 ä¹‹é—´çš„é—´éš™ï¼‰ã€‚åœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼ŒMySQL é»˜è®¤ä½¿ç”¨ä¸´é”®é”è¿›è¡Œå½“å‰è¯»æ“ä½œï¼Œå½“æŸ¥è¯¢æ¡ä»¶æ˜¯å”¯ä¸€ç´¢å¼•ä¸”ç²¾ç¡®åŒ¹é…æ—¶ï¼Œä¸´é”®é”ä¼šé™çº§ä¸ºè¡Œé”ã€‚


1.4 ç´¢å¼•ä¸Žä¼˜åŒ–ï¼šå›žè¡¨æŸ¥è¯¢ä¸Žè¦†ç›–ç´¢å¼•
é¢è¯•å®˜ï¼š ç´¢å¼•ç›¸å…³çš„ï¼Œå›žè¡¨æŸ¥è¯¢å’Œè¦†ç›–ç´¢å¼•ä½ æ¸…æ¥šå—ï¼Ÿ
æˆ‘ï¼š
è¿™ä¸¤ä¸ªæ¦‚å¿µå’Œç´¢å¼•çš„ç»“æž„å¯†åˆ‡ç›¸å…³ï¼ŒMySQL ä¸­æœ€å¸¸ç”¨çš„ç´¢å¼•æ˜¯ B + æ ‘ç´¢å¼•ï¼š

å›žè¡¨æŸ¥è¯¢ï¼šB + æ ‘ç´¢å¼•åˆ†ä¸ºèšç°‡ç´¢å¼•å’Œéžèšç°‡ç´¢å¼•ï¼ˆäºŒçº§ç´¢å¼•ï¼‰ã€‚èšç°‡ç´¢å¼•çš„å¶å­èŠ‚ç‚¹å­˜å‚¨çš„æ˜¯å®Œæ•´çš„è¡Œæ•°æ®ï¼Œè€Œéžèšç°‡ç´¢å¼•çš„å¶å­èŠ‚ç‚¹å­˜å‚¨çš„æ˜¯è¡Œæ•°æ®çš„ä¸»é”®å€¼ã€‚å½“ä½¿ç”¨éžèšç°‡ç´¢å¼•æŸ¥è¯¢æ•°æ®æ—¶ï¼Œè‹¥æŸ¥è¯¢çš„å­—æ®µä¸åœ¨éžèšç°‡ç´¢å¼•ä¸­ï¼Œéœ€è¦å…ˆé€šè¿‡éžèšç°‡ç´¢å¼•æ‰¾åˆ°ä¸»é”®å€¼ï¼Œå†åˆ°èšç°‡ç´¢å¼•ä¸­æ ¹æ®ä¸»é”®å€¼æŸ¥æ‰¾å®Œæ•´çš„è¡Œæ•°æ®ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±å«å›žè¡¨æŸ¥è¯¢ã€‚å›žè¡¨ä¼šå¢žåŠ  IO æ“ä½œï¼Œå½±å“æŸ¥è¯¢æ•ˆçŽ‡ã€‚

è¦†ç›–ç´¢å¼•ï¼šè‹¥æŸ¥è¯¢çš„æ‰€æœ‰å­—æ®µéƒ½åŒ…å«åœ¨éžèšç°‡ç´¢å¼•ä¸­ï¼ˆå³éžèšç°‡ç´¢å¼•çš„å¶å­èŠ‚ç‚¹å·²åŒ…å«æŸ¥è¯¢æ‰€éœ€çš„å…¨éƒ¨æ•°æ®ï¼‰ï¼Œåˆ™ä¸éœ€è¦å›žè¡¨ï¼Œç›´æŽ¥é€šè¿‡éžèšç°‡ç´¢å¼•å°±èƒ½èŽ·å–åˆ°æ•°æ®ï¼Œè¿™ç§ç´¢å¼•å°±æ˜¯è¦†ç›–ç´¢å¼•ã€‚ä¾‹å¦‚ï¼Œè¡¨æœ‰ç´¢å¼•idx_name(name)ï¼Œæ‰§è¡ŒSELECT name, age FROM table WHERE name&#x3D;â€™xxxâ€™ï¼Œè‹¥ageä¹Ÿåœ¨idx_nameç´¢å¼•ä¸­ï¼ˆå¦‚è”åˆç´¢å¼•idx_name_age(name, age)ï¼‰ï¼Œåˆ™è¯¥ç´¢å¼•å°±æ˜¯è¦†ç›–ç´¢å¼•ï¼Œèƒ½é¿å…å›žè¡¨ï¼Œæå‡æŸ¥è¯¢æ•ˆçŽ‡ã€‚


1.5 æ€§èƒ½åˆ†æžï¼šEXPLAIN ä¸Žç´¢å¼•å¤±æ•ˆ
é¢è¯•å®˜ï¼š é‚£æ€Žä¹ˆåˆ†æž SQL æ€§èƒ½ï¼Ÿç´¢å¼•ä¸ºä»€ä¹ˆä¼šå¤±æ•ˆå‘¢ï¼Ÿ
æˆ‘ï¼š
åˆ†æž MySQL SQL æ€§èƒ½æœ€å¸¸ç”¨çš„å·¥å…·æ˜¯EXPLAINå‘½ä»¤ï¼Œåœ¨ SQL è¯­å¥å‰åŠ ä¸ŠEXPLAINï¼Œæ‰§è¡ŒåŽä¼šå¾—åˆ°æŸ¥è¯¢è®¡åˆ’ï¼Œé€šè¿‡æŸ¥çœ‹å„åˆ—ï¼ˆå¦‚typeã€keyã€rowsã€extraç­‰ï¼‰çš„ä¿¡æ¯ï¼Œèƒ½åˆ¤æ–­ç´¢å¼•æ˜¯å¦è¢«ä½¿ç”¨ã€æŸ¥è¯¢æ•ˆçŽ‡å¦‚ä½•ï¼š

typeï¼šè¡¨ç¤ºè®¿é—®ç±»åž‹ï¼Œä»Žå¥½åˆ°å·®æœ‰systemã€constã€eq_refã€refã€rangeã€indexã€ALLç­‰ï¼ŒrangeåŠä»¥ä¸Šé€šå¸¸è¡¨ç¤ºä½¿ç”¨äº†ç´¢å¼•ï¼ŒALLæ˜¯å…¨è¡¨æ‰«æï¼Œæ•ˆçŽ‡ä½Žã€‚

keyï¼šæ˜¾ç¤ºå®žé™…ä½¿ç”¨çš„ç´¢å¼•ï¼Œè‹¥ä¸ºNULLåˆ™æœªä½¿ç”¨ç´¢å¼•ã€‚

rowsï¼šé¢„ä¼°éœ€è¦æ‰«æçš„è¡Œæ•°ï¼Œè¡Œæ•°è¶Šå°‘è¶Šå¥½ã€‚

extraï¼šåŒ…å«é¢å¤–ä¿¡æ¯ï¼Œå¦‚Using indexè¡¨ç¤ºä½¿ç”¨äº†è¦†ç›–ç´¢å¼•ï¼ŒUsing filesortè¡¨ç¤ºéœ€è¦é¢å¤–æŽ’åºï¼ˆæ•ˆçŽ‡ä½Žï¼‰ï¼ŒUsing temporaryè¡¨ç¤ºä½¿ç”¨äº†ä¸´æ—¶è¡¨ï¼ˆæ•ˆçŽ‡ä½Žï¼‰ç­‰ã€‚


ç´¢å¼•å¤±æ•ˆçš„åŽŸå› æœ‰å¾ˆå¤šï¼Œå¸¸è§çš„æœ‰ï¼š

ç´¢å¼•åˆ—ä¸Šä½¿ç”¨äº†å‡½æ•°æˆ–è¡¨è¾¾å¼ï¼Œå¦‚WHERE SUBSTR(name, 1, 1)&#x3D;â€™aâ€™ï¼Œä¼šå¯¼è‡´ç´¢å¼•æ— æ³•è¢«ä½¿ç”¨ã€‚

ç´¢å¼•åˆ—è¿›è¡Œäº†éšå¼ç±»åž‹è½¬æ¢ï¼Œå¦‚ç´¢å¼•åˆ—æ˜¯varcharç±»åž‹ï¼ŒæŸ¥è¯¢æ—¶ç”¨WHERE id&#x3D;123ï¼ˆ123 æ˜¯æ•°å­—ï¼‰ï¼ŒMySQL ä¼šè¿›è¡Œç±»åž‹è½¬æ¢ï¼Œå¯¼è‡´ç´¢å¼•å¤±æ•ˆã€‚

ä½¿ç”¨NOT INã€!&#x3D;ã€&lt;&gt;ç­‰å¦å®šæ“ä½œç¬¦ï¼Œå¯èƒ½å¯¼è‡´ç´¢å¼•å¤±æ•ˆï¼ˆè§†æƒ…å†µè€Œå®šï¼Œéƒ¨åˆ†åœºæ™¯ä¸‹å¯èƒ½ä½¿ç”¨ç´¢å¼•ï¼‰ã€‚

LIKEæŸ¥è¯¢ä»¥%å¼€å¤´ï¼Œå¦‚WHERE name LIKE â€˜%abcâ€™ï¼Œæ— æ³•ä½¿ç”¨ç´¢å¼•çš„å‰ç¼€åŒ¹é…ï¼Œå¯¼è‡´ç´¢å¼•å¤±æ•ˆã€‚

è”åˆç´¢å¼•æœªéµå¾ª â€œæœ€å·¦å‰ç¼€åŽŸåˆ™â€ï¼Œå³æŸ¥è¯¢æ¡ä»¶ä¸åŒ…å«è”åˆç´¢å¼•çš„ç¬¬ä¸€ä¸ªåˆ—ï¼Œå¦‚è”åˆç´¢å¼•(a,b,c)ï¼ŒæŸ¥è¯¢WHERE b&#x3D;1 AND c&#x3D;2ï¼Œä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆã€‚

è¡¨ä¸­æ•°æ®é‡æžå°‘ï¼ŒMySQL è®¤ä¸ºå…¨è¡¨æ‰«ææ¯”ä½¿ç”¨ç´¢å¼•æ›´é«˜æ•ˆï¼Œä¼šæ”¾å¼ƒä½¿ç”¨ç´¢å¼•ã€‚


1.6 æ—¥å¿—ç³»ç»Ÿï¼šä¸‰å¤§æ—¥å¿—è§£æžï¼ˆundo logã€redo logã€binlogï¼‰
é¢è¯•å®˜ï¼š æœ€åŽè¯´è¯´ MySQL çš„ä¸‰å¤§æ—¥å¿—å§ï¼Œundo logã€redo logã€binlogã€‚
æˆ‘ï¼š
MySQL çš„ä¸‰å¤§æ—¥å¿—åœ¨æ•°æ®ä¸€è‡´æ€§ã€äº‹åŠ¡æ¢å¤ã€ä¸»ä»Žå¤åˆ¶ç­‰æ–¹é¢èµ·ç€å…³é”®ä½œç”¨ï¼š

undo logï¼ˆå›žæ»šæ—¥å¿—ï¼‰ï¼š

ä½œç”¨ï¼šç”¨äºŽäº‹åŠ¡å›žæ»šå’Œ MVCCã€‚å½“äº‹åŠ¡ä¿®æ”¹æ•°æ®æ—¶ï¼Œä¼šå…ˆå°†æ•°æ®çš„æ—§ç‰ˆæœ¬è®°å½•åˆ° undo log ä¸­ã€‚è‹¥äº‹åŠ¡éœ€è¦å›žæ»šï¼ˆå¦‚æ‰§è¡ŒROLLBACKï¼‰ï¼Œå¯ä»¥é€šè¿‡ undo log æ¢å¤æ•°æ®åˆ°ä¿®æ”¹å‰çš„çŠ¶æ€ï¼›åŒæ—¶ï¼Œundo log ä¹Ÿæ˜¯ MVCC ä¸­ç‰ˆæœ¬é“¾çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œä¾›å¿«ç…§è¯»æ—¶èŽ·å–æ—§ç‰ˆæœ¬æ•°æ®ã€‚

ç‰¹ç‚¹ï¼šæ˜¯é€»è¾‘æ—¥å¿—ï¼Œè®°å½•çš„æ˜¯ â€œåšäº†ä»€ä¹ˆæ“ä½œå¯ä»¥æ¢å¤æ•°æ®â€ï¼Œä¸”ä¼šéšç€äº‹åŠ¡çš„æäº¤æˆ–å›žæ»šè¢«æ¸…ç†ã€‚

redo logï¼ˆé‡åšæ—¥å¿—ï¼‰ï¼š

ä½œç”¨ï¼šä¿è¯äº‹åŠ¡çš„æŒä¹…æ€§ã€‚äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¯¹æ•°æ®çš„ä¿®æ”¹ä¼šå…ˆå†™å…¥å†…å­˜çš„ç¼“å†²æ± ï¼ŒåŒæ—¶å°†ä¿®æ”¹æ“ä½œè®°å½•åˆ° redo logï¼ˆå…ˆå†™ redo log bufferï¼Œå†åˆ·åˆ°ç£ç›˜ï¼‰ã€‚è‹¥æ•°æ®åº“å‘ç”Ÿå´©æºƒï¼Œé‡å¯åŽå¯ä»¥é€šè¿‡ redo log é‡æ–°æ‰§è¡Œå·²æäº¤çš„äº‹åŠ¡æ“ä½œï¼Œæ¢å¤æ•°æ®ï¼Œé¿å…å› å†…å­˜æ•°æ®ä¸¢å¤±å¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´ã€‚

ç‰¹ç‚¹ï¼šæ˜¯ç‰©ç†æ—¥å¿—ï¼Œè®°å½•çš„æ˜¯ â€œæŸä¸ªæ•°æ®é¡µåšäº†ä»€ä¹ˆä¿®æ”¹â€ï¼Œé‡‡ç”¨å¾ªçŽ¯å†™çš„æ–¹å¼ï¼Œæœ‰å›ºå®šå¤§å°ã€‚

binlogï¼ˆäºŒè¿›åˆ¶æ—¥å¿—ï¼‰ï¼š

ä½œç”¨ï¼šç”¨äºŽä¸»ä»Žå¤åˆ¶å’Œæ•°æ®å¤‡ä»½æ¢å¤ã€‚å®ƒè®°å½•äº†æ‰€æœ‰å¯¹æ•°æ®åº“çš„ä¿®æ”¹æ“ä½œï¼ˆå¦‚INSERTã€UPDATEã€DELETEç­‰ï¼‰ï¼Œä¸è®°å½•æŸ¥è¯¢æ“ä½œã€‚ä¸»åº“å°† binlog å‘é€ç»™ä»Žåº“ï¼Œä»Žåº“é€šè¿‡æ‰§è¡Œ binlog ä¸­çš„æ“ä½œå®žçŽ°ä¸»ä»Žæ•°æ®åŒæ­¥ï¼›åŒæ—¶ï¼Œè‹¥æ•°æ®åº“å‘ç”Ÿæ•…éšœï¼Œå¯é€šè¿‡ binlog ç»“åˆå¤‡ä»½æ¢å¤åˆ°æŒ‡å®šæ—¶é—´ç‚¹çš„æ•°æ®ã€‚

ç‰¹ç‚¹ï¼šæ˜¯é€»è¾‘æ—¥å¿—ï¼Œè®°å½•çš„æ˜¯æ“ä½œçš„é€»è¾‘ï¼ˆå¦‚ â€œæ’å…¥ä¸€æ¡ id&#x3D;1 çš„è®°å½•â€ï¼‰ï¼Œé‡‡ç”¨è¿½åŠ å†™çš„æ–¹å¼ï¼Œä¸ä¼šè¦†ç›–æ—§æ—¥å¿—ï¼Œå¯é€šè¿‡expire_logs_daysç­‰å‚æ•°è®¾ç½®è‡ªåŠ¨æ¸…ç†ç­–ç•¥ã€‚


ä¸‰è€…çš„é…åˆï¼šäº‹åŠ¡æ‰§è¡Œæ—¶ï¼Œå…ˆå†™ undo logï¼Œå†ä¿®æ”¹ç¼“å†²æ± æ•°æ®ï¼ŒåŒæ—¶å†™ redo logï¼ˆprepare é˜¶æ®µï¼‰ï¼Œäº‹åŠ¡æäº¤æ—¶ï¼Œå†™ binlogï¼Œæœ€åŽå°† redo log æ ‡è®°ä¸ºæäº¤ï¼ˆcommit é˜¶æ®µï¼‰ï¼Œç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§å’ŒæŒä¹…æ€§ã€‚
2. Redis2.1 æ ¸å¿ƒæ•°æ®ç±»åž‹ä¸Žåº”ç”¨åœºæ™¯ï¼ˆString, Hash, List, Set, ZSet ç­‰ï¼‰
é¢è¯•å®˜ï¼š è¯´è¯´ Redis çš„æ ¸å¿ƒæ•°æ®ç±»åž‹æœ‰å“ªäº›ï¼Œå„è‡ªçš„åº”ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ
æˆ‘ï¼š
Redis çš„æ ¸å¿ƒæ•°æ®ç±»åž‹æ˜¯å…¶åŸºç¡€ï¼Œå¸¸è§çš„æœ‰ Stringã€Hashã€Listã€Setã€ZSet è¿™äº”ç§ï¼Œæ¯ç§éƒ½æœ‰ç‹¬ç‰¹çš„ç»“æž„å’Œé€‚ç”¨åœºæ™¯ï¼š

Stringï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼š

ç»“æž„ï¼šæœ€åŸºç¡€çš„æ•°æ®ç±»åž‹ï¼Œåº•å±‚å¯å­˜å‚¨å­—ç¬¦ä¸²ã€æ•´æ•°æˆ–æµ®ç‚¹æ•°ï¼Œæœ€å¤§èƒ½å­˜å‚¨ 512MBã€‚

åº”ç”¨åœºæ™¯ï¼šç¼“å­˜ç®€å•æ•°æ®ï¼ˆå¦‚ç”¨æˆ·ä¿¡æ¯ JSON ä¸²ï¼‰ã€è®¡æ•°å™¨ï¼ˆç”¨INCR&#x2F;DECRå®žçŽ°ç‚¹èµžæ•°ã€è®¿é—®é‡ç»Ÿè®¡ï¼‰ã€åˆ†å¸ƒå¼é”ï¼ˆé€šè¿‡SETNXå‘½ä»¤ï¼‰ã€Session å…±äº«ç­‰ã€‚

Hashï¼ˆå“ˆå¸Œï¼‰ï¼š

ç»“æž„ï¼šé”®å€¼å¯¹çš„é›†åˆï¼Œç±»ä¼¼ Java ä¸­çš„ HashMapï¼Œé€‚åˆå­˜å‚¨å¯¹è±¡ç±»æ•°æ®ï¼Œæ¯ä¸ª Hash å¯åŒ…å«æœ€å¤š 2^32-1 ä¸ªå­—æ®µã€‚

åº”ç”¨åœºæ™¯ï¼šå­˜å‚¨ç”¨æˆ·ä¿¡æ¯ï¼ˆå¦‚user:100ä¸º keyï¼Œnameâ€œageâ€ ç­‰ä¸ºå­—æ®µï¼‰ã€å•†å“å±žæ€§å­˜å‚¨ç­‰ï¼Œèƒ½åªä¿®æ”¹å¯¹è±¡çš„æŸä¸ªå­—æ®µï¼ŒèŠ‚çœå†…å­˜å’Œå¸¦å®½ã€‚

Listï¼ˆåˆ—è¡¨ï¼‰ï¼š

ç»“æž„ï¼šæœ‰åºçš„å­—ç¬¦ä¸²åˆ—è¡¨ï¼Œåº•å±‚æ˜¯åŒå‘é“¾è¡¨ï¼Œæ”¯æŒä»Žä¸¤ç«¯æ’å…¥ &#x2F; åˆ é™¤å…ƒç´ ï¼ŒæŒ‰ç´¢å¼•è®¿é—®ã€‚

åº”ç”¨åœºæ™¯ï¼šæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆç”¨LPUSHç”Ÿäº§æ¶ˆæ¯ã€RPOPæ¶ˆè´¹æ¶ˆæ¯ï¼‰ã€æœ€æ–°æ¶ˆæ¯å±•ç¤ºï¼ˆå¦‚æœ‹å‹åœˆç‚¹èµžåˆ—è¡¨ï¼‰ã€æŽ’è¡Œæ¦œå‰ N æ¡æ•°æ®ç­‰ã€‚

Setï¼ˆé›†åˆï¼‰ï¼š

ç»“æž„ï¼šæ— åºä¸”ä¸é‡å¤çš„å­—ç¬¦ä¸²é›†åˆï¼Œæ”¯æŒäº¤é›†ã€å¹¶é›†ã€å·®é›†ç­‰è¿ç®—ã€‚

åº”ç”¨åœºæ™¯ï¼šå¥½å‹å…³ç³»ï¼ˆå¦‚å…±åŒå¥½å‹ç”¨äº¤é›†SINTERï¼‰ã€æ ‡ç­¾å­˜å‚¨ï¼ˆå¦‚ç”¨æˆ·å…´è¶£æ ‡ç­¾ï¼‰ã€åŽ»é‡æ“ä½œï¼ˆå¦‚ UV ç»Ÿè®¡ï¼‰ç­‰ã€‚

ZSetï¼ˆæœ‰åºé›†åˆï¼‰ï¼š

ç»“æž„ï¼šåœ¨ Set åŸºç¡€ä¸Šç»™æ¯ä¸ªå…ƒç´ å…³è”ä¸€ä¸ªåˆ†æ•°ï¼ˆscoreï¼‰ï¼ŒæŒ‰åˆ†æ•°æŽ’åºï¼Œå…ƒç´ å”¯ä¸€ä½†åˆ†æ•°å¯é‡å¤ã€‚

åº”ç”¨åœºæ™¯ï¼šæŽ’è¡Œæ¦œï¼ˆå¦‚æ¸¸æˆç§¯åˆ†æŽ’åç”¨ZREVRANGEï¼‰ã€å¸¦æƒé‡çš„æ¶ˆæ¯é˜Ÿåˆ—ã€èŒƒå›´æŸ¥è¯¢ï¼ˆå¦‚æŸ¥è¯¢åˆ†æ•°åœ¨ 80-100 çš„ç”¨æˆ·ï¼‰ç­‰ã€‚


2.2 ç¼“å­˜é—®é¢˜ï¼šç©¿é€ã€å‡»ç©¿ã€é›ªå´©åŠè§£å†³æ–¹æ¡ˆ
é¢è¯•å®˜ï¼š Redis ä½œä¸ºç¼“å­˜æ—¶ï¼Œå¸¸è§çš„ç¼“å­˜ç©¿é€ã€å‡»ç©¿ã€é›ªå´©é—®é¢˜æ€Žä¹ˆè§£å†³ï¼Ÿ
æˆ‘ï¼š
è¿™ä¸‰ç±»é—®é¢˜éƒ½æ˜¯ç¼“å­˜ä½¿ç”¨ä¸­å¯èƒ½é‡åˆ°çš„å¹¶å‘æˆ–æ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼Œå…·ä½“åŠè§£å†³æ–¹æ¡ˆå¦‚ä¸‹ï¼š

ç¼“å­˜ç©¿é€ï¼š

é—®é¢˜ï¼šæŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®ï¼ˆå¦‚ç”¨æˆ·æŸ¥ id&#x3D;-1 çš„ç”¨æˆ·ï¼‰ï¼Œç¼“å­˜å’Œæ•°æ®åº“éƒ½æ— ç»“æžœï¼Œè¯·æ±‚ç›´æŽ¥æ‰“å‘æ•°æ®åº“ï¼Œå¤§é‡æ­¤ç±»è¯·æ±‚ä¼šåŽ‹åž®æ•°æ®åº“ã€‚

è§£å†³æ–¹æ¡ˆï¼šâ‘  ç©ºå€¼ç¼“å­˜ï¼Œå¯¹ä¸å­˜åœ¨çš„ key ç¼“å­˜ç©ºå€¼ï¼ˆè®¾è¾ƒçŸ­è¿‡æœŸæ—¶é—´ï¼Œé¿å…å ç”¨å†…å­˜ï¼‰ï¼›â‘¡ å¸ƒéš†è¿‡æ»¤å™¨ï¼Œåœ¨ç¼“å­˜å‰åŠ å¸ƒéš†è¿‡æ»¤å™¨ï¼Œå…ˆåˆ¤æ–­ key æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨ç›´æŽ¥è¿”å›žï¼Œè¿‡æ»¤æ— æ•ˆè¯·æ±‚ï¼›â‘¢ æŽ¥å£å±‚æ ¡éªŒï¼Œå¯¹éžæ³•å‚æ•°ï¼ˆå¦‚ id ä¸ºè´Ÿï¼‰ç›´æŽ¥æ‹¦æˆªã€‚

ç¼“å­˜å‡»ç©¿ï¼š

é—®é¢˜ï¼šä¸€ä¸ªçƒ­ç‚¹ key çªç„¶è¿‡æœŸï¼Œæ­¤æ—¶å¤§é‡å¹¶å‘è¯·æ±‚åŒæ—¶è®¿é—®è¯¥ keyï¼Œç¼“å­˜æœªå‘½ä¸­ï¼Œéƒ½åŽ»æŸ¥æ•°æ®åº“ï¼Œå¯¼è‡´æ•°æ®åº“çž¬é—´åŽ‹åŠ›éª¤å¢žã€‚

è§£å†³æ–¹æ¡ˆï¼šâ‘  çƒ­ç‚¹ key æ°¸ä¸è¿‡æœŸï¼Œåœ¨ä¸šåŠ¡å±‚ä¸è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œæ‰‹åŠ¨æ›´æ–°ï¼›â‘¡ äº’æ–¥é”ï¼Œç¼“å­˜æœªå‘½ä¸­æ—¶ï¼Œç”¨åˆ†å¸ƒå¼é”ï¼ˆå¦‚ Redis çš„SETNXï¼‰ä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹åŽ»æŸ¥æ•°æ®åº“ï¼Œå…¶ä»–çº¿ç¨‹ç­‰å¾…é‡è¯•ï¼›â‘¢ é¢„çƒ­ç¼“å­˜ï¼Œåœ¨é«˜å³°å‰ä¸»åŠ¨åŠ è½½çƒ­ç‚¹æ•°æ®åˆ°ç¼“å­˜å¹¶è®¾åˆç†è¿‡æœŸæ—¶é—´ã€‚

ç¼“å­˜é›ªå´©ï¼š

é—®é¢˜ï¼šå¤§é‡ç¼“å­˜ key åœ¨åŒä¸€æ—¶é—´è¿‡æœŸï¼Œæˆ– Redis é›†ç¾¤å®•æœºï¼Œå¯¼è‡´å¤§é‡è¯·æ±‚ç©¿é€åˆ°æ•°æ®åº“ï¼Œæ•°æ®åº“å› åŽ‹åŠ›è¿‡å¤§å´©æºƒã€‚

è§£å†³æ–¹æ¡ˆï¼šâ‘  è¿‡æœŸæ—¶é—´éšæœºåŒ–ï¼Œç»™ key çš„è¿‡æœŸæ—¶é—´åŠ éšæœºå€¼ï¼ˆå¦‚ 10Â±2 ç§’ï¼‰ï¼Œé¿å…åŒæ—¶è¿‡æœŸï¼›â‘¡ å¤šçº§ç¼“å­˜ï¼Œç”¨æœ¬åœ°ç¼“å­˜ï¼ˆå¦‚ Caffeineï¼‰+ Redis ç¼“å­˜ï¼Œå‡å°‘ Redis åŽ‹åŠ›ï¼›â‘¢ Redis é›†ç¾¤é«˜å¯ç”¨ï¼Œéƒ¨ç½²ä¸»ä»Ž + å“¨å…µæˆ– Redis Clusterï¼Œé¿å…å•ç‚¹æ•…éšœï¼›â‘£ é™æµé™çº§ï¼Œåœ¨æ•°æ®åº“å‰åŠ é™æµç»„ä»¶ï¼ˆå¦‚ Sentinelï¼‰ï¼Œè¶…è¿‡é˜ˆå€¼åˆ™é™çº§è¿”å›žé»˜è®¤æ•°æ®ã€‚


2.3 æ•°æ®ä¸€è‡´æ€§é—®é¢˜ä¸Žè§£å†³æ–¹æ¡ˆï¼ˆCache-Aside ç­–ç•¥ã€å»¶è¿ŸåŒåˆ ã€ç›‘å¬ binlogï¼‰
é¢è¯•å®˜ï¼š Redis å’Œæ•°æ®åº“å¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿæœ‰å“ªäº›å¸¸ç”¨æ–¹æ¡ˆï¼Ÿ
æˆ‘ï¼š
ç¼“å­˜ä¸Žæ•°æ®åº“çš„æ•°æ®ä¸€è‡´æ€§æŒ‡ä¸¤è€…æ•°æ®ä¿æŒåŒæ­¥ï¼Œå¸¸ç”¨æ–¹æ¡ˆéœ€æ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰æ‹©ï¼š

Cache-Aside ç­–ç•¥ï¼ˆæ—è·¯ç¼“å­˜ï¼‰ï¼š

æµç¨‹ï¼šè¯»æ“ä½œæ—¶ï¼Œå…ˆæŸ¥ç¼“å­˜ï¼Œå‘½ä¸­ç›´æŽ¥è¿”å›žï¼›æœªå‘½ä¸­æŸ¥æ•°æ®åº“ï¼Œå†æŠŠæ•°æ®å†™å…¥ç¼“å­˜ã€‚å†™æ“ä½œæ—¶ï¼Œå…ˆæ›´æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜ï¼ˆè€Œéžæ›´æ–°ç¼“å­˜ï¼Œé¿å…å¤šæ¬¡å†™ç¼“å­˜æµªè´¹èµ„æºï¼‰ã€‚

é€‚ç”¨åœºæ™¯ï¼šå¤§å¤šæ•°æ™®é€šä¸šåŠ¡åœºæ™¯ï¼Œç®€å•æ˜“å®žçŽ°ï¼Œä½†å¯èƒ½å› åˆ é™¤ç¼“å­˜å¤±è´¥å¯¼è‡´ä¸ä¸€è‡´ï¼ˆå¯é…åˆé‡è¯•æœºåˆ¶ï¼‰ã€‚

å»¶è¿ŸåŒåˆ ï¼š

æµç¨‹ï¼šå†™æ“ä½œæ—¶ï¼Œâ‘  å…ˆåˆ é™¤ç¼“å­˜ï¼›â‘¡ å†æ›´æ–°æ•°æ®åº“ï¼›â‘¢ è¿‡ä¸€æ®µæ—¶é—´ï¼ˆå¦‚ 500msï¼‰å†æ¬¡åˆ é™¤ç¼“å­˜ã€‚

ä½œç”¨ï¼šè§£å†³ â€œæ›´æ–°æ•°æ®åº“æ—¶ï¼Œå…¶ä»–çº¿ç¨‹å¯èƒ½å·²ä»Žæ—§æ•°æ®åº“è¯»æ•°æ®å†™å…¥ç¼“å­˜â€ çš„é—®é¢˜ï¼Œç¬¬äºŒæ¬¡åˆ é™¤å¯æ¸…é™¤å¯èƒ½çš„æ—§ç¼“å­˜ã€‚

é€‚ç”¨åœºæ™¯ï¼šå¹¶å‘è¾ƒé«˜ï¼Œå¯¹ä¸€è‡´æ€§è¦æ±‚ç¨é«˜çš„åœºæ™¯ï¼Œéœ€åˆç†è®¾ç½®å»¶è¿Ÿæ—¶é—´ï¼ˆæ ¹æ®ä¸šåŠ¡è€—æ—¶è°ƒæ•´ï¼‰ã€‚

ç›‘å¬ binlog åŒæ­¥ï¼š

æµç¨‹ï¼šå€ŸåŠ©æ•°æ®åº“çš„ binlogï¼ˆå¦‚ MySQL çš„ binlogï¼‰ï¼Œé€šè¿‡ä¸­é—´ä»¶ï¼ˆå¦‚ Canalï¼‰ç›‘å¬ binlog å˜åŒ–ï¼Œè§£æžåŽå¼‚æ­¥æ›´æ–°æˆ–åˆ é™¤ Redis ç¼“å­˜ã€‚

ä¼˜åŠ¿ï¼šè§£è€¦ä¸šåŠ¡ä»£ç ï¼Œå¯é æ€§é«˜ï¼Œé€‚åˆå¤æ‚çš„æ›´æ–°åœºæ™¯ã€‚

æ³¨æ„ï¼šå¼‚æ­¥æ›´æ–°æœ‰å»¶è¿Ÿï¼Œéœ€æŽ¥å—çŸ­æš‚çš„ä¸ä¸€è‡´ï¼Œä¸”éœ€ä¿è¯ä¸­é—´ä»¶çš„é«˜å¯ç”¨ã€‚


2.4 é«˜æ€§èƒ½åŽŸç†ï¼šI&#x2F;O å¤šè·¯å¤ç”¨æ¨¡åž‹ï¼ˆReactor æ¨¡å¼ã€epollï¼‰
é¢è¯•å®˜ï¼š Redis ä¸ºä»€ä¹ˆæ€§èƒ½é«˜ï¼ŸI&#x2F;O å¤šè·¯å¤ç”¨æ¨¡åž‹æ˜¯æ€Žä¹ˆå›žäº‹ï¼Ÿ
æˆ‘ï¼š
Redis é«˜æ€§èƒ½çš„åŽŸå› åŒ…æ‹¬åŸºäºŽå†…å­˜ã€å•çº¿ç¨‹ï¼ˆé¿å…çº¿ç¨‹åˆ‡æ¢å¼€é”€ï¼‰ç­‰ï¼Œå…¶ä¸­ I&#x2F;O å¤šè·¯å¤ç”¨æ¨¡åž‹æ˜¯å…³é”®ï¼š

I&#x2F;O å¤šè·¯å¤ç”¨ï¼šå…è®¸å•ä¸ªçº¿ç¨‹åŒæ—¶ç›‘å¬å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆSocketï¼‰ï¼Œå½“æŸä¸ªæè¿°ç¬¦å°±ç»ªï¼ˆå¦‚å¯è¯»ã€å¯å†™ï¼‰æ—¶ï¼Œé€šçŸ¥åº”ç”¨ç¨‹åºå¤„ç†ã€‚Redis ç”¨å®ƒè§£å†³äº†å•çº¿ç¨‹ä¸‹å¤„ç†å¤šå®¢æˆ·ç«¯è¿žæŽ¥çš„é—®é¢˜ï¼Œé¿å…äº†é˜»å¡žç­‰å¾…ã€‚

Reactor æ¨¡å¼ï¼šRedis çš„ I&#x2F;O æ¨¡åž‹åŸºäºŽ Reactor æ¨¡å¼å®žçŽ°ï¼Œæ ¸å¿ƒæ˜¯ â€œäº‹ä»¶é©±åŠ¨â€ï¼šâ‘  ä¸»çº¿ç¨‹è´Ÿè´£ç›‘å¬ Socketï¼Œå°†å°±ç»ªçš„äº‹ä»¶ï¼ˆå¦‚è¿žæŽ¥ã€è¯»å†™ï¼‰æ”¾å…¥äº‹ä»¶é˜Ÿåˆ—ï¼›â‘¡ å·¥ä½œçº¿ç¨‹ï¼ˆRedis å•çº¿ç¨‹ä¸‹ä¸»çº¿ç¨‹å³å·¥ä½œçº¿ç¨‹ï¼‰ä»Žé˜Ÿåˆ—å–äº‹ä»¶å¹¶å¤„ç†ï¼ˆå¦‚è§£æžå‘½ä»¤ã€æ‰§è¡Œæ“ä½œï¼‰ã€‚

epollï¼šRedis åœ¨ Linux ä¸‹é‡‡ç”¨ epoll ä½œä¸º I&#x2F;O å¤šè·¯å¤ç”¨çš„å®žçŽ°ï¼ˆä¸åŒç³»ç»Ÿæœ‰å·®å¼‚ï¼Œå¦‚ FreeBSD ç”¨ kqueueï¼‰ï¼Œç›¸æ¯” select&#x2F;poll æ›´é«˜æ•ˆï¼šâ‘  select&#x2F;poll éœ€è½®è¯¢æ‰€æœ‰æè¿°ç¬¦ï¼Œepoll é€šè¿‡å›žè°ƒé€šçŸ¥å°±ç»ªæè¿°ç¬¦ï¼Œæ— è½®è¯¢å¼€é”€ï¼›â‘¡ select æ”¯æŒçš„æè¿°ç¬¦æ•°é‡æœ‰é™ï¼ˆé»˜è®¤ 1024ï¼‰ï¼Œepoll æ— æ­¤é™åˆ¶ï¼›â‘¢ epoll èƒ½ç²¾å‡†èŽ·å–å°±ç»ªæè¿°ç¬¦ï¼Œå‡å°‘æ— æ•ˆæ“ä½œã€‚


æ­£æ˜¯ I&#x2F;O å¤šè·¯å¤ç”¨è®© Redis å•çº¿ç¨‹ä¹Ÿèƒ½é«˜æ•ˆå¤„ç†æ•°ä¸‡å¹¶å‘è¿žæŽ¥ã€‚
2.5 å®žæˆ˜åº”ç”¨ï¼šç™»å½•æœºåˆ¶ä¸Žé˜²æŠ–èŠ‚æµå®žçŽ°
é¢è¯•å®˜ï¼š Redis åœ¨å®žæˆ˜ä¸­æœ‰å“ªäº›å…¸åž‹åº”ç”¨ï¼Ÿæ¯”å¦‚ç™»å½•å’Œé˜²æŠ–èŠ‚æµæ€Žä¹ˆç”¨å®ƒå®žçŽ°ï¼Ÿ
æˆ‘ï¼š
Redis åœ¨ä¸šåŠ¡ä¸­æœ‰å¾ˆå¤šå®žç”¨åœºæ™¯ï¼Œç™»å½•æœºåˆ¶å’Œé˜²æŠ–èŠ‚æµæ˜¯å¸¸è§æ¡ˆä¾‹ï¼š

ç™»å½•æœºåˆ¶å®žçŽ°ï¼š

æµç¨‹ï¼šç”¨æˆ·ç™»å½•æˆåŠŸåŽï¼Œç”Ÿæˆå”¯ä¸€ tokenï¼ˆå¦‚ UUIDï¼‰ï¼Œä»¥token:xxxä¸º keyï¼Œç”¨æˆ·ä¿¡æ¯ä¸º value å­˜å…¥ Redisï¼ˆè®¾è¿‡æœŸæ—¶é—´ï¼Œå¦‚ 2 å°æ—¶ï¼‰ï¼›å®¢æˆ·ç«¯åŽç»­è¯·æ±‚æºå¸¦ tokenï¼ŒæœåŠ¡ç«¯æŸ¥ Redis éªŒè¯ token æ˜¯å¦æœ‰æ•ˆï¼Œæœ‰æ•ˆåˆ™å…è®¸è®¿é—®ã€‚

æ‰©å±•ï¼šå¯ç»“åˆ Redis çš„EXPIREç»­æœŸï¼ˆå¦‚ç”¨æˆ·æ“ä½œæ—¶åˆ·æ–°è¿‡æœŸæ—¶é—´ï¼‰ï¼Œæˆ–ç”¨DELå®žçŽ°ç™»å‡ºï¼›è¿˜èƒ½é€šè¿‡SETNXé˜²æ­¢åŒä¸€è´¦å·å¤šè®¾å¤‡ç™»å½•ï¼ˆç™»å½•æ—¶å…ˆåˆ æ—§ tokenï¼Œå†å­˜æ–° tokenï¼‰ã€‚

é˜²æŠ–èŠ‚æµå®žçŽ°ï¼š

é˜²æŠ–ï¼ˆé¿å…é‡å¤è§¦å‘ï¼‰ï¼šå¦‚æŒ‰é’®ç‚¹å‡»ï¼Œç”¨ Redis è®°å½•è§¦å‘æ—¶é—´ï¼Œè§„å®š â€œn ç§’å†…å†æ¬¡è§¦å‘åˆ™é‡ç½®æ—¶é—´â€ã€‚ä¾‹ï¼šç”¨SET key timestamp NX PX n*1000ï¼Œè‹¥ key ä¸å­˜åœ¨åˆ™è®¾ç½®ï¼ˆè§¦å‘æ“ä½œï¼‰ï¼Œå­˜åœ¨åˆ™ä¸å¤„ç†ã€‚

èŠ‚æµï¼ˆæŽ§åˆ¶è§¦å‘é¢‘çŽ‡ï¼‰ï¼šå¦‚æŽ¥å£é™æµï¼Œè§„å®š â€œn ç§’å†…æœ€å¤šè§¦å‘ m æ¬¡â€ã€‚ä¾‹ï¼šç”¨INCR keyè®¡æ•°ï¼ŒEXPIRE key nè®¾è¿‡æœŸæ—¶é—´ï¼Œè‹¥è®¡æ•°â‰¤m åˆ™å…è®¸ï¼Œå¦åˆ™æ‹’ç»ã€‚


2.6 é«˜å¯ç”¨ä¸ŽæŒä¹…åŒ–ï¼šä¸»ä»ŽåŒæ­¥ä¸Ž AOF&#x2F;RDB
é¢è¯•å®˜ï¼š Redis å¦‚ä½•ä¿è¯é«˜å¯ç”¨ï¼ŸæŒä¹…åŒ–æœºåˆ¶ AOF å’Œ RDB æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ
æˆ‘ï¼š
é«˜å¯ç”¨æ¶‰åŠä¸»ä»Žã€æŒä¹…åŒ–ç­‰ï¼Œç¡®ä¿ Redis ä¸ä¸¢å¤±æ•°æ®ä¸”æŒç»­å¯ç”¨ï¼š

ä¸»ä»ŽåŒæ­¥ï¼š

ä½œç”¨ï¼šå®žçŽ°æ•°æ®å¤‡ä»½å’Œè¯»å†™åˆ†ç¦»ã€‚ä¸»åº“è´Ÿè´£å†™æ“ä½œï¼Œä»Žåº“é€šè¿‡å¤åˆ¶ä¸»åº“æ•°æ®å®žçŽ°å¤‡ä»½ï¼ŒåŒæ—¶å¯åˆ†æ‹…è¯»è¯·æ±‚ã€‚

æµç¨‹ï¼šâ‘  ä»Žåº“è¿žæŽ¥ä¸»åº“ï¼Œå‘é€SYNCå‘½ä»¤ï¼›â‘¡ ä¸»åº“ç”Ÿæˆ RDB æ–‡ä»¶å¹¶å‘é€ç»™ä»Žåº“ï¼Œä»Žåº“åŠ è½½ RDB åŒæ­¥å…¨é‡æ•°æ®ï¼›â‘¢ ä¹‹åŽä¸»åº“å°†å†™å‘½ä»¤å¼‚æ­¥å‘é€ç»™ä»Žåº“ï¼Œä»Žåº“æ‰§è¡Œå‘½ä»¤ä¿æŒå¢žé‡åŒæ­¥ã€‚

é«˜å¯ç”¨ï¼šé…åˆå“¨å…µï¼ˆSentinelï¼‰ï¼Œå“¨å…µç›‘æŽ§ä¸»ä»ŽèŠ‚ç‚¹ï¼Œä¸»åº“æ•…éšœæ—¶è‡ªåŠ¨å°†ä»Žåº“åˆ‡æ¢ä¸ºä¸»åº“ï¼Œå®žçŽ°æ•…éšœè½¬ç§»ã€‚

æŒä¹…åŒ–æœºåˆ¶ï¼š

RDBï¼šåœ¨æŒ‡å®šæ—¶é—´é—´éš”ç”Ÿæˆæ•°æ®é›†çš„å¿«ç…§ï¼ˆå¦‚save 60 1000è¡¨ç¤º 60 ç§’å†… 1000 æ¬¡ä¿®æ”¹åˆ™è§¦å‘ï¼‰ï¼Œå°†æ•°æ®å†™å…¥äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆdump.rdbï¼‰ã€‚

ä¼˜åŠ¿ï¼šæ–‡ä»¶å°ï¼Œæ¢å¤é€Ÿåº¦å¿«ï¼›é€‚åˆå…¨é‡å¤‡ä»½ã€‚

åŠ£åŠ¿ï¼šå¿«ç…§é—´éš”å†…æ•°æ®å¯èƒ½ä¸¢å¤±ï¼ˆå¦‚å®•æœºï¼‰ï¼›ç”Ÿæˆå¿«ç…§æ—¶å¯èƒ½é˜»å¡žä¸»çº¿ç¨‹ï¼ˆç”¨bgsaveå¯å¼‚æ­¥ï¼Œä½†æœ‰èµ„æºå¼€é”€ï¼‰ã€‚

AOFï¼šè®°å½•æ‰€æœ‰å†™å‘½ä»¤ï¼ˆå¦‚SETã€HSETï¼‰ï¼Œè¿½åŠ åˆ°æ—¥å¿—æ–‡ä»¶ï¼ˆappendonly.aofï¼‰ï¼Œæ¢å¤æ—¶é‡æ–°æ‰§è¡Œå‘½ä»¤ã€‚

ä¼˜åŠ¿ï¼šæ•°æ®å®‰å…¨æ€§é«˜ï¼ˆå¯è®¾appendfsync alwayså®žæ—¶å†™å…¥ï¼‰ï¼›æ—¥å¿—å¯è¯»æ‡‚ï¼Œä¾¿äºŽæŽ’æŸ¥é—®é¢˜ã€‚

åŠ£åŠ¿ï¼šæ–‡ä»¶å¤§ï¼Œæ¢å¤æ…¢ï¼›å†™å‘½ä»¤è¿½åŠ å¯èƒ½å½±å“æ€§èƒ½ã€‚

å®žé™…é€‰æ‹©ï¼šé€šå¸¸æ··åˆä½¿ç”¨ AOF+RDBï¼ŒRDB ç”¨äºŽå¿«é€Ÿæ¢å¤ï¼ŒAOF å¼¥è¡¥ RDB çš„æ•°æ®ä¸¢å¤±é£Žé™©ã€‚


2.7 ç”Ÿäº§ä¼˜åŒ–ï¼šå¤§ Key ä¸Žçƒ­ Key å¤„ç†
é¢è¯•å®˜ï¼š ç”Ÿäº§çŽ¯å¢ƒä¸­ï¼ŒRedis çš„å¤§ Key å’Œçƒ­ Key æ€Žä¹ˆå¤„ç†ï¼Ÿ
æˆ‘ï¼š
å¤§ Key å’Œçƒ­ Key ä¼šå½±å“ Redis æ€§èƒ½ï¼ˆå¦‚å¤§ Key å¯¼è‡´é˜»å¡žï¼Œçƒ­ Key å¯¼è‡´èŠ‚ç‚¹è¿‡è½½ï¼‰ï¼Œéœ€é’ˆå¯¹æ€§ä¼˜åŒ–ï¼š

å¤§ Key å¤„ç†ï¼š

è¯†åˆ«ï¼šç”¨redis-cli â€“bigkeyså‘½ä»¤æ‰«æå¤§ Keyï¼ˆå¦‚ String&gt;100MBï¼ŒHash&#x2F;List å…ƒç´ è¿‡å¤šï¼‰ã€‚

æ‹†åˆ†ï¼šâ‘  String å¤§ Key æ‹†åˆ†ä¸ºå¤šä¸ªå° Keyï¼ˆå¦‚user:infoæ‹†ä¸ºuser:info:nameã€user:info:ageï¼‰ï¼›â‘¡ Hash&#x2F;List å¤§ Key æŒ‰èŒƒå›´æ‹†åˆ†ï¼ˆå¦‚ Hash æŒ‰å­—æ®µé¦–å­—æ¯æ‹†åˆ†ï¼ŒList æŒ‰ç´¢å¼•åˆ†æ®µï¼‰ã€‚

åˆ é™¤ï¼šå¤§ Key ç›´æŽ¥DELä¼šé˜»å¡žçº¿ç¨‹ï¼Œç”¨UNLINKï¼ˆå¼‚æ­¥åˆ é™¤ï¼‰æˆ–é€æ­¥åˆ é™¤ï¼ˆå¦‚ List ç”¨LPOPåˆ†æ‰¹åˆ ï¼‰ã€‚

çƒ­ Key å¤„ç†ï¼š

è¯†åˆ«ï¼šé€šè¿‡ç›‘æŽ§å·¥å…·ï¼ˆå¦‚ Redis Insightï¼‰ç»Ÿè®¡è®¿é—®é¢‘çŽ‡é«˜çš„ Keyï¼Œæˆ–æ ¹æ®ä¸šåŠ¡åˆ¤æ–­ï¼ˆå¦‚ç§’æ€å•†å“ IDï¼‰ã€‚

åˆ†æ•£å­˜å‚¨ï¼šâ‘  ç»™çƒ­ Key åŠ å‰ç¼€ &#x2F; åŽç¼€ï¼ˆå¦‚key:1ã€key:2ï¼‰ï¼Œåˆ†æ•£åˆ°ä¸åŒ Redis èŠ‚ç‚¹ï¼›â‘¡ ç”¨æœ¬åœ°ç¼“å­˜ï¼ˆå¦‚åº”ç”¨å†…å­˜ï¼‰åˆ†æ‹…éƒ¨åˆ†è¯·æ±‚ï¼Œå‡å°‘ Redis è®¿é—®ã€‚

ä¼˜åŒ–ç¼“å­˜ï¼šçƒ­ Key è®¾æ°¸ä¸è¿‡æœŸï¼Œæˆ–ç”¨ä¸»ä»Žå¤åˆ¶ï¼ˆä»Žåº“åˆ†æ‹…è¯»è¯·æ±‚ï¼‰ï¼Œé¿å…å•èŠ‚ç‚¹åŽ‹åŠ›è¿‡å¤§ã€‚


ä¸ƒã€å¼€å‘æ¡†æž¶ (Development Framework)SpringBoot 1. æ ¸å¿ƒæ€æƒ³ï¼šIoC (æŽ§åˆ¶åè½¬) ä¸Ž DI (ä¾èµ–æ³¨å…¥)
é¢è¯•å®˜ï¼š è¯·è¯´è¯´ SpringBoot çš„æ ¸å¿ƒæ€æƒ³ IoC å’Œ DI åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Œå®ƒä»¬ä¹‹é—´æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ
æˆ‘ï¼š
IoCï¼ˆInversion of Controlï¼ŒæŽ§åˆ¶åè½¬ï¼‰æ˜¯ Spring æ¡†æž¶çš„æ ¸å¿ƒæ€æƒ³ï¼Œå®ƒé¢ è¦†äº†ä¼ ç»Ÿç¨‹åºä¸­å¯¹è±¡åˆ›å»ºå’Œä¾èµ–ç®¡ç†çš„æ–¹å¼ï¼šä¼ ç»Ÿæ–¹å¼ä¸­ï¼Œå¯¹è±¡ç”±å¼€å‘è€…ä¸»åŠ¨é€šè¿‡newå…³é”®å­—åˆ›å»ºï¼Œä¾èµ–å…³ç³»ä¹Ÿç”±å¼€å‘è€…æ‰‹åŠ¨ç»´æŠ¤ï¼›è€Œåœ¨ IoC æ€æƒ³ä¸‹ï¼Œå¯¹è±¡çš„åˆ›å»ºæƒã€ç”Ÿå‘½å‘¨æœŸç®¡ç†ä»¥åŠä¾èµ–å…³ç³»çš„ç»„è£…éƒ½äº¤ç»™äº† Spring å®¹å™¨ï¼Œå¼€å‘è€…åªéœ€å®šä¹‰å¯¹è±¡çš„éœ€æ±‚ï¼Œç”±å®¹å™¨ â€œåå‘â€ å°†æ‰€éœ€å¯¹è±¡æ³¨å…¥ï¼Œå®žçŽ°äº† â€œæŽ§åˆ¶æƒä»Žå¼€å‘è€…åˆ°å®¹å™¨çš„è½¬ç§»â€ã€‚
DIï¼ˆDependency Injectionï¼Œä¾èµ–æ³¨å…¥ï¼‰æ˜¯ IoC çš„å…·ä½“å®žçŽ°æ–¹å¼ã€‚å½“ä¸€ä¸ªå¯¹è±¡éœ€è¦ä¾èµ–å¦ä¸€ä¸ªå¯¹è±¡æ—¶ï¼ŒSpring å®¹å™¨ä¼šä¸»åŠ¨å°†è¢«ä¾èµ–çš„å¯¹è±¡ â€œæ³¨å…¥â€ åˆ°ä¾èµ–å¯¹è±¡ä¸­ï¼Œæ— éœ€å¼€å‘è€…æ‰‹åŠ¨è®¾ç½®ã€‚æ¯”å¦‚åœ¨ Service å±‚ä¸­éœ€è¦ Dao å±‚å¯¹è±¡ï¼Œåªéœ€ç”¨@Autowiredæ³¨è§£æ ‡è®°ï¼ŒSpring å°±ä¼šè‡ªåŠ¨å°† Dao å®žä¾‹æ³¨å…¥åˆ° Service ä¸­ã€‚
ç®€å•æ¥è¯´ï¼ŒIoC æ˜¯è®¾è®¡æ€æƒ³ï¼ŒDI æ˜¯å®žçŽ°è¯¥æ€æƒ³çš„æ‰‹æ®µï¼ŒäºŒè€…ç›¸è¾…ç›¸æˆï¼Œå…±åŒé™ä½Žäº†ç»„ä»¶é—´çš„è€¦åˆåº¦ï¼Œè®©ä»£ç æ›´æ˜“ç»´æŠ¤å’Œæ‰©å±•ã€‚
2. è¿›é˜¶ç‰¹æ€§ï¼šå¾ªçŽ¯ä¾èµ–è§£å†³æœºåˆ¶ï¼ˆä¸‰çº§ç¼“å­˜ï¼‰
é¢è¯•å®˜ï¼š SpringBoot æ˜¯å¦‚ä½•è§£å†³ Bean ä¹‹é—´çš„å¾ªçŽ¯ä¾èµ–é—®é¢˜çš„ï¼Ÿä¸‰çº§ç¼“å­˜åœ¨è¿™é‡Œèµ·åˆ°äº†ä»€ä¹ˆä½œç”¨ï¼Ÿ
æˆ‘ï¼š
å¾ªçŽ¯ä¾èµ–æŒ‡çš„æ˜¯ä¸¤ä¸ªæˆ–å¤šä¸ª Bean ä¹‹é—´äº’ç›¸ä¾èµ–ï¼Œæ¯”å¦‚ A ä¾èµ– Bï¼ŒB åˆä¾èµ– Aã€‚Spring é€šè¿‡ä¸‰çº§ç¼“å­˜æœºåˆ¶æ¥è§£å†³å•ä¾‹ Bean çš„å¾ªçŽ¯ä¾èµ–é—®é¢˜ï¼Œæ ¸å¿ƒæ˜¯æå‰æš´éœ²æœªåˆå§‹åŒ–å®Œæˆçš„ Bean å®žä¾‹ã€‚
ä¸‰çº§ç¼“å­˜å…·ä½“æŒ‡ Spring å®¹å™¨ä¸­çš„ä¸‰ä¸ª Map ç»“æž„ï¼š

ä¸€çº§ç¼“å­˜ï¼ˆsingletonObjectsï¼‰ï¼šå­˜å‚¨å·²å®Œå…¨åˆå§‹åŒ–å®Œæˆçš„å•ä¾‹ Beanï¼Œæ˜¯æœ€ç»ˆä¾›å¤–éƒ¨ä½¿ç”¨çš„ Bean å®žä¾‹ã€‚

äºŒçº§ç¼“å­˜ï¼ˆearlySingletonObjectsï¼‰ï¼šå­˜å‚¨æå‰æš´éœ²çš„ã€å·²å®Œæˆå®žä¾‹åŒ–ä½†æœªå®Œæˆå±žæ€§æ³¨å…¥å’Œåˆå§‹åŒ–çš„ Bean å®žä¾‹ï¼ˆåŠæˆå“ Beanï¼‰ã€‚

ä¸‰çº§ç¼“å­˜ï¼ˆsingletonFactoriesï¼‰ï¼šå­˜å‚¨ Bean çš„å·¥åŽ‚å¯¹è±¡ï¼ˆObjectFactoryï¼‰ï¼Œè¯¥å·¥åŽ‚å¯ä»¥ç”Ÿæˆ Bean çš„æ—©æœŸä»£ç†å¯¹è±¡æˆ–åŽŸå§‹å®žä¾‹ã€‚


è§£å†³å¾ªçŽ¯ä¾èµ–çš„æµç¨‹ä»¥ A å’Œ B å¾ªçŽ¯ä¾èµ–ä¸ºä¾‹ï¼š

å®¹å™¨åˆ›å»º A æ—¶ï¼Œå…ˆå®žä¾‹åŒ– Aï¼ˆå®Œæˆæž„é€ æ–¹æ³•è°ƒç”¨ï¼‰ï¼Œç„¶åŽå°† A çš„å·¥åŽ‚å¯¹è±¡æ”¾å…¥ä¸‰çº§ç¼“å­˜ã€‚

A éœ€è¦æ³¨å…¥ Bï¼Œå®¹å™¨å¼€å§‹åˆ›å»º Bï¼ŒåŒæ ·å…ˆå®žä¾‹åŒ– Bï¼Œå°† B çš„å·¥åŽ‚å¯¹è±¡æ”¾å…¥ä¸‰çº§ç¼“å­˜ã€‚

B éœ€è¦æ³¨å…¥ Aï¼Œå®¹å™¨å…ˆæŸ¥ä¸€çº§ç¼“å­˜ï¼ˆæ—  Aï¼‰ï¼Œå†æŸ¥äºŒçº§ç¼“å­˜ï¼ˆæ—  Aï¼‰ï¼Œæœ€åŽæŸ¥ä¸‰çº§ç¼“å­˜ï¼Œé€šè¿‡ A çš„å·¥åŽ‚å¯¹è±¡èŽ·å– A çš„æ—©æœŸå®žä¾‹ï¼Œå°† A ä»Žä¸‰çº§ç¼“å­˜ç§»åˆ°äºŒçº§ç¼“å­˜ï¼Œç„¶åŽå°† A æ³¨å…¥åˆ° B ä¸­ã€‚

B å®Œæˆå±žæ€§æ³¨å…¥å’Œåˆå§‹åŒ–ï¼Œæˆä¸ºå®Œæ•´ Beanï¼Œæ”¾å…¥ä¸€çº§ç¼“å­˜ï¼Œä¹‹åŽå°† B æ³¨å…¥åˆ° A ä¸­ã€‚

A å®Œæˆå±žæ€§æ³¨å…¥å’Œåˆå§‹åŒ–ï¼Œæ”¾å…¥ä¸€çº§ç¼“å­˜ï¼Œå¾ªçŽ¯ä¾èµ–è§£å†³ã€‚


ä¸‰çº§ç¼“å­˜çš„å…³é”®ä½œç”¨æ˜¯åº”å¯¹ Bean è¢« AOP ä»£ç†çš„åœºæ™¯ï¼šè‹¥ Bean éœ€è¦ç”Ÿæˆä»£ç†å¯¹è±¡ï¼Œå·¥åŽ‚å¯¹è±¡ä¼šæå‰ç”Ÿæˆä»£ç†å®žä¾‹å¹¶æš´éœ²ï¼Œé¿å…æ³¨å…¥åŽŸå§‹å®žä¾‹å¯¼è‡´çš„ä»£ç†å¤±æ•ˆé—®é¢˜ï¼ŒäºŒçº§ç¼“å­˜åˆ™ç”¨äºŽå¿«é€ŸèŽ·å–æå‰æš´éœ²çš„å®žä¾‹ï¼Œå‡å°‘å·¥åŽ‚å¯¹è±¡çš„é‡å¤æ‰§è¡Œã€‚ä¸è¿‡ä¸‰çº§ç¼“å­˜ä»…èƒ½è§£å†³å•ä¾‹ Bean çš„å¾ªçŽ¯ä¾èµ–ï¼ŒåŽŸåž‹ Beanï¼ˆprototypeï¼‰çš„å¾ªçŽ¯ä¾èµ–æ— æ³•è§£å†³ï¼Œä¼šç›´æŽ¥æŠ›å‡ºå¼‚å¸¸ã€‚
3. é¢å‘åˆ‡é¢ç¼–ç¨‹ï¼šAOP å®žçŽ°åŽŸç†ï¼ˆJDK åŠ¨æ€ä»£ç† vs CGLIBï¼‰
é¢è¯•å®˜ï¼š SpringBoot çš„ AOP æ˜¯å¦‚ä½•å®žçŽ°çš„ï¼ŸJDK åŠ¨æ€ä»£ç†å’Œ CGLIB ä»£ç†æœ‰ä»€ä¹ˆåŒºåˆ«ï¼ŒSpring ä¼šå¦‚ä½•é€‰æ‹©ï¼Ÿ
æˆ‘ï¼š
AOPï¼ˆAspect-Oriented Programmingï¼Œé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰é€šè¿‡å°†æ—¥å¿—ã€äº‹åŠ¡ã€æƒé™æŽ§åˆ¶ç­‰é€šç”¨åŠŸèƒ½æŠ½å–ä¸º â€œåˆ‡é¢â€ï¼Œåœ¨ä¸ä¿®æ”¹ä¸šåŠ¡ä»£ç çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡ â€œç»‡å…¥â€ æœºåˆ¶å°†åˆ‡é¢ä¸Žä¸šåŠ¡é€»è¾‘ç»“åˆï¼Œå®žçŽ°ä»£ç å¤ç”¨ã€‚Spring AOP çš„åº•å±‚é€šè¿‡åŠ¨æ€ä»£ç†æŠ€æœ¯å®žçŽ°ï¼Œä¸»è¦æœ‰ JDK åŠ¨æ€ä»£ç†å’Œ CGLIB ä»£ç†ä¸¤ç§æ–¹å¼ã€‚
äºŒè€…çš„åŒºåˆ«ä¸»è¦ä½“çŽ°åœ¨å®žçŽ°æ–¹å¼å’Œé€‚ç”¨åœºæ™¯ä¸Šï¼š

JDK åŠ¨æ€ä»£ç†ï¼š

åŸºäºŽ Java åå°„æœºåˆ¶å®žçŽ°ï¼Œè¦æ±‚è¢«ä»£ç†çš„ç±»å¿…é¡»å®žçŽ°æŽ¥å£ï¼Œä»£ç†å¯¹è±¡æ˜¯æŽ¥å£çš„å®žçŽ°ç±»ã€‚

åŽŸç†æ˜¯é€šè¿‡Proxyç±»ç”Ÿæˆä»£ç†å®žä¾‹ï¼Œä»£ç†å®žä¾‹åœ¨è°ƒç”¨æ–¹æ³•æ—¶ï¼Œä¼šå›žè°ƒInvocationHandlerä¸­çš„invokeæ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­æ‰§è¡Œåˆ‡é¢é€»è¾‘å’Œç›®æ ‡æ–¹æ³•ã€‚

ä¼˜åŠ¿ï¼šJDK åŽŸç”Ÿæ”¯æŒï¼Œæ— éœ€ä¾èµ–ç¬¬ä¸‰æ–¹åº“ï¼Œæ•ˆçŽ‡è¾ƒé«˜ï¼ˆåœ¨ä»£ç†é€»è¾‘ç®€å•æ—¶ï¼‰ã€‚

å±€é™ï¼šåªèƒ½ä»£ç†å®žçŽ°äº†æŽ¥å£çš„ç±»ï¼Œæ— æ³•ä»£ç†æ— æŽ¥å£çš„ç±»ã€‚

CGLIB ä»£ç†ï¼š

åŸºäºŽå­—èŠ‚ç ç”ŸæˆæŠ€æœ¯å®žçŽ°ï¼Œé€šè¿‡ç»§æ‰¿è¢«ä»£ç†ç±»ç”Ÿæˆå­ç±»ä½œä¸ºä»£ç†å¯¹è±¡ï¼Œæ— éœ€è¢«ä»£ç†ç±»å®žçŽ°æŽ¥å£ã€‚

åŽŸç†æ˜¯é€šè¿‡ ASM æ¡†æž¶ä¿®æ”¹å­—èŠ‚ç ï¼Œåœ¨å­ç±»ä¸­é‡å†™çˆ¶ç±»çš„æ–¹æ³•ï¼Œåœ¨é‡å†™æ–¹æ³•ä¸­åµŒå…¥åˆ‡é¢é€»è¾‘å’Œç›®æ ‡æ–¹æ³•è°ƒç”¨ã€‚

ä¼˜åŠ¿ï¼šå¯ä»£ç†æ— æŽ¥å£çš„ç±»ï¼Œé€‚ç”¨èŒƒå›´æ›´å¹¿ã€‚

å±€é™ï¼šè‹¥è¢«ä»£ç†ç±»è¢«finalä¿®é¥°ï¼ˆæ— æ³•ç»§æ‰¿ï¼‰ï¼Œåˆ™æ— æ³•ç”Ÿæˆä»£ç†å¯¹è±¡ï¼›ç”±äºŽæ˜¯ç»§æ‰¿å®žçŽ°ï¼Œçˆ¶ç±»çš„finalæ–¹æ³•æ— æ³•è¢«é‡å†™ï¼Œä¹Ÿå°±æ— æ³•è¢«å¢žå¼ºã€‚


Spring å¯¹ä»£ç†æ–¹å¼çš„é€‰æ‹©é€»è¾‘ï¼š

è‹¥è¢«ä»£ç†çš„ç±»å®žçŽ°äº†æŽ¥å£ï¼Œé»˜è®¤ä½¿ç”¨ JDK åŠ¨æ€ä»£ç†ã€‚

è‹¥è¢«ä»£ç†çš„ç±»æœªå®žçŽ°æŽ¥å£ï¼Œé»˜è®¤ä½¿ç”¨ CGLIB ä»£ç†ã€‚

å¯é€šè¿‡é…ç½®spring.aop.proxy-target-class&#x3D;trueå¼ºåˆ¶ä½¿ç”¨ CGLIB ä»£ç†ï¼ˆSpringBoot 2.x åŽè¯¥é…ç½®é»˜è®¤å€¼ä¸º trueï¼‰ã€‚


4. äº‹åŠ¡ç®¡ç†ï¼š@Transactional æ³¨è§£å¤±æ•ˆåœºæ™¯åˆ†æž
é¢è¯•å®˜ï¼š åœ¨ SpringBoot ä¸­ä½¿ç”¨@Transactionalæ³¨è§£æ—¶ï¼Œå“ªäº›æƒ…å†µä¼šå¯¼è‡´äº‹åŠ¡å¤±æ•ˆï¼Ÿ
æˆ‘ï¼š
@Transactionalæ³¨è§£é€šè¿‡ AOP å®žçŽ°äº‹åŠ¡ç®¡ç†ï¼Œä½†åœ¨ä¸€äº›åœºæ™¯ä¸‹ä¼šå› ä¸ç¬¦åˆ AOP ä»£ç†æœºåˆ¶æˆ–æ³¨è§£ç”Ÿæ•ˆæ¡ä»¶è€Œå¤±æ•ˆï¼Œå¸¸è§åœºæ™¯æœ‰ï¼š

éžå…¬å…±æ–¹æ³•ä¸Šä½¿ç”¨æ³¨è§£ï¼š@Transactionalé»˜è®¤åªå¯¹å…¬å…±ï¼ˆpublicï¼‰æ–¹æ³•ç”Ÿæ•ˆï¼Œè‹¥åœ¨ privateã€protected æˆ– default ä¿®é¥°çš„æ–¹æ³•ä¸Šä½¿ç”¨ï¼ŒSpring ä¸ä¼šç”Ÿæˆäº‹åŠ¡ä»£ç†ï¼Œæ³¨è§£å¤±æ•ˆã€‚

è‡ªèº«æ–¹æ³•è°ƒç”¨ï¼ˆå†…éƒ¨è°ƒç”¨ï¼‰ï¼šåœ¨åŒä¸€ä¸ªç±»ä¸­ï¼Œä¸€ä¸ªæ— äº‹åŠ¡çš„æ–¹æ³•è°ƒç”¨å¦ä¸€ä¸ªæœ‰@Transactionalæ³¨è§£çš„æ–¹æ³•ï¼Œç”±äºŽå†…éƒ¨è°ƒç”¨ä¸ä¼šç»è¿‡ä»£ç†å¯¹è±¡ï¼Œäº‹åŠ¡åˆ‡é¢æ— æ³•ç”Ÿæ•ˆã€‚ä¾‹å¦‚ï¼š


TypeScriptå–æ¶ˆè‡ªåŠ¨æ¢è¡Œå¤åˆ¶
public class Service {
â€‹    public void methodA() {
â€‹        methodB(); &#x2F;&#x2F; å†…éƒ¨è°ƒç”¨ï¼ŒmethodBçš„äº‹åŠ¡å¤±æ•ˆ
â€‹    }
â€‹    @Transactional
â€‹    public void methodB() {
â€‹        &#x2F;&#x2F; ä¸šåŠ¡é€»è¾‘
â€‹    }
}

å¼‚å¸¸è¢«æ•èŽ·æœªæŠ›å‡ºï¼šäº‹åŠ¡é»˜è®¤åœ¨é‡åˆ°æœªæ•èŽ·çš„ RuntimeException æˆ– Error æ—¶å›žæ»šï¼Œè‹¥æ–¹æ³•å†…éƒ¨æ•èŽ·äº†å¼‚å¸¸ä¸”æœªé‡æ–°æŠ›å‡ºï¼Œäº‹åŠ¡ç®¡ç†å™¨æ— æ³•æ„ŸçŸ¥å¼‚å¸¸ï¼Œä¼šè®¤ä¸ºäº‹åŠ¡æ‰§è¡ŒæˆåŠŸï¼Œå¯¼è‡´ä¸å›žæ»šã€‚

é”™è¯¯çš„å¼‚å¸¸ç±»åž‹ï¼šè‹¥æ³¨è§£æŒ‡å®šäº†rollbackForå±žæ€§ï¼ˆå¦‚@Transactional(rollbackFor &#x3D; IOException.class)ï¼‰ï¼Œä½†å®žé™…æŠ›å‡ºçš„å¼‚å¸¸ä¸æ˜¯è¯¥ç±»åž‹ä¸”æœªè¢«rollbackForåŒ…å«ï¼Œäº‹åŠ¡ä¸ä¼šå›žæ»šï¼›è‹¥æœªæŒ‡å®šrollbackForï¼Œchecked å¼‚å¸¸ï¼ˆå¦‚ IOExceptionï¼‰é»˜è®¤ä¸ä¼šè§¦å‘å›žæ»šã€‚

Bean æœªè¢« Spring ç®¡ç†ï¼šè‹¥ç±»æœªé€šè¿‡@Serviceã€@Componentç­‰æ³¨è§£äº¤ç»™ Spring å®¹å™¨ç®¡ç†ï¼Œ@Transactionalæ³¨è§£æ— æ³•è¢«è§£æžï¼Œè‡ªç„¶å¤±æ•ˆã€‚

äº‹åŠ¡ä¼ æ’­æœºåˆ¶è®¾ç½®ä¸å½“ï¼šè‹¥ä¼ æ’­æœºåˆ¶è®¾ç½®ä¸ºPROPAGATION_NOT_SUPPORTEDï¼ˆä¸æ”¯æŒäº‹åŠ¡ï¼‰ã€PROPAGATION_NEVERï¼ˆç¦æ­¢äº‹åŠ¡ï¼‰ç­‰ï¼Œä¼šå¯¼è‡´å½“å‰æ–¹æ³•ä¸ä½¿ç”¨äº‹åŠ¡ï¼›æˆ–PROPAGATION_REQUIRES_NEWç­‰åœ¨ç‰¹å®šåœºæ™¯ä¸‹å› äº‹åŠ¡åµŒå¥—é€»è¾‘å¯¼è‡´é¢„æœŸå¤–çš„ç»“æžœã€‚


5. è®¾è®¡æ¨¡å¼åº”ç”¨ï¼ˆå·¥åŽ‚ã€å•ä¾‹ã€ä»£ç†ã€æ¨¡æ¿æ–¹æ³•ç­‰ï¼‰
é¢è¯•å®˜ï¼š SpringBoot ä¸­åº”ç”¨äº†å“ªäº›å¸¸è§çš„è®¾è®¡æ¨¡å¼ï¼Ÿèƒ½ä¸¾ä¾‹è¯´æ˜Žå—ï¼Ÿ
æˆ‘ï¼š
SpringBoot åŸºäºŽ Spring æ¡†æž¶ï¼Œå†…éƒ¨å¤§é‡åº”ç”¨äº†è®¾è®¡æ¨¡å¼ï¼Œä»¥ä¸‹æ˜¯å‡ ç§å…¸åž‹æ¨¡å¼çš„åº”ç”¨ï¼š

å·¥åŽ‚æ¨¡å¼ï¼šSpring çš„ Bean åˆ›å»ºè¿‡ç¨‹ä¸»è¦ä¾èµ–å·¥åŽ‚æ¨¡å¼ã€‚BeanFactoryæ˜¯ Bean å·¥åŽ‚çš„æ ¸å¿ƒæŽ¥å£ï¼Œè´Ÿè´£åˆ›å»ºå’Œç®¡ç† Beanï¼›DefaultListableBeanFactoryç­‰å®žçŽ°ç±»é€šè¿‡è¯»å–é…ç½®ï¼ˆå¦‚æ³¨è§£ã€XMLï¼‰ï¼Œæ ¹æ® Bean çš„å®šä¹‰ä¿¡æ¯ç”Ÿæˆ Bean å®žä¾‹ï¼Œå¼€å‘è€…æ— éœ€å…³å¿ƒ Bean çš„åˆ›å»ºç»†èŠ‚ï¼Œåªéœ€é€šè¿‡å·¥åŽ‚èŽ·å–ã€‚

å•ä¾‹æ¨¡å¼ï¼šSpring å®¹å™¨ä¸­çš„ Bean é»˜è®¤æ˜¯å•ä¾‹çš„ï¼ˆscope ä¸º singletonï¼‰ï¼Œé€šè¿‡ä¸€çº§ç¼“å­˜ï¼ˆsingletonObjectsï¼‰ä¿è¯ä¸€ä¸ª Bean åœ¨å®¹å™¨ä¸­åªæœ‰ä¸€ä¸ªå®žä¾‹ã€‚å®¹å™¨å¯åŠ¨æ—¶åˆ›å»º Bean å¹¶ç¼“å­˜ï¼ŒåŽç»­å¤šæ¬¡èŽ·å–çš„éƒ½æ˜¯åŒä¸€ä¸ªå®žä¾‹ï¼Œå‡å°‘äº†å¯¹è±¡åˆ›å»ºçš„å¼€é”€ã€‚

ä»£ç†æ¨¡å¼ï¼šå¦‚ AOP çš„å®žçŽ°ä¸­ï¼ŒJDK åŠ¨æ€ä»£ç†å’Œ CGLIB ä»£ç†éƒ½æ˜¯ä»£ç†æ¨¡å¼çš„åº”ç”¨ã€‚ä»£ç†å¯¹è±¡åœ¨ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•å‰åŽåµŒå…¥åˆ‡é¢é€»è¾‘ï¼ˆå¦‚äº‹åŠ¡ã€æ—¥å¿—ï¼‰ï¼Œæ—¢æ‰©å±•äº†åŠŸèƒ½ï¼Œåˆä¸ä¿®æ”¹ç›®æ ‡å¯¹è±¡çš„ä»£ç ï¼Œç¬¦åˆ â€œå¼€é—­åŽŸåˆ™â€ã€‚

æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼šåœ¨æ•°æ®è®¿é—®å±‚ï¼ˆå¦‚ JdbcTemplateã€RedisTemplateï¼‰ä¸­å¤§é‡ä½¿ç”¨ã€‚æ¨¡æ¿ç±»å®šä¹‰äº†æ“ä½œçš„æ•´ä½“æµç¨‹ï¼ˆå¦‚æ•°æ®åº“è¿žæŽ¥ã€æ‰§è¡Œ SQLã€å…³é—­è¿žæŽ¥ï¼‰ï¼Œå°†å¯å˜çš„æ­¥éª¤ï¼ˆå¦‚ SQL è¯­å¥ã€ç»“æžœé›†å¤„ç†ï¼‰æŠ½è±¡ä¸ºæŠ½è±¡æ–¹æ³•æˆ–é€šè¿‡å›žè°ƒæŽ¥å£è®©ç”¨æˆ·å®žçŽ°ï¼Œé¿å…äº†é‡å¤ä»£ç ï¼ŒåŒæ—¶ä¿è¯æµç¨‹çš„ä¸€è‡´æ€§ã€‚

è§‚å¯Ÿè€…æ¨¡å¼ï¼šSpring çš„äº‹ä»¶é©±åŠ¨æ¨¡åž‹åŸºäºŽè§‚å¯Ÿè€…æ¨¡å¼ã€‚ApplicationEventæ˜¯äº‹ä»¶æºï¼ŒApplicationListeneræ˜¯è§‚å¯Ÿè€…ï¼Œå½“äº‹ä»¶å‘å¸ƒï¼ˆå¦‚ContextRefreshedEventè¡¨ç¤ºå®¹å™¨åˆ·æ–°å®Œæˆï¼‰æ—¶ï¼Œæ‰€æœ‰ç›‘å¬è¯¥äº‹ä»¶çš„ Listener ä¼šè¢«è§¦å‘æ‰§è¡Œï¼Œå¸¸ç”¨äºŽä¸šåŠ¡è§£è€¦ï¼ˆå¦‚è®¢å•åˆ›å»ºåŽå‘é€é€šçŸ¥ï¼‰ã€‚


è¿™äº›è®¾è®¡æ¨¡å¼çš„åº”ç”¨è®© SpringBoot çš„æž¶æž„æ›´çµæ´»ã€å¯æ‰©å±•ï¼Œä¹Ÿæ˜¯å…¶èƒ½å¿«é€Ÿé›†æˆå„ç±»ç»„ä»¶çš„é‡è¦åŽŸå› ã€‚
]]></content>
      <categories>
        <category>Java</category>
        <category>ä¸ºäº†å®žä¹ è¯´æ˜¯</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>ä¸ºäº†å®žä¹ è¯´æ˜¯</tag>
      </tags>
  </entry>
  <entry>
    <title>Javaé¢è¯•3</title>
    <url>/2025/10/21/Java%E9%9D%A2%E8%AF%953/</url>
    <content><![CDATA[Javaé¢è¯•31. MyBatis çš„ä½œç”¨æ ‡å‡†ç­”æ¡ˆï¼šMyBatis æ˜¯ä¸€ä¸ªä¼˜ç§€çš„æŒä¹…å±‚æ¡†æž¶ï¼Œå®ƒæ”¯æŒè‡ªå®šä¹‰ SQLã€å­˜å‚¨è¿‡ç¨‹ä»¥åŠé«˜çº§æ˜ å°„ã€‚å®ƒçš„ä¸»è¦ä½œç”¨æ˜¯ç®€åŒ– JDBC çš„å¼€å‘ï¼Œè§£å†³åŽŸç”Ÿ JDBC ä»£ç çš„ç¹çå’Œé‡å¤å·¥ä½œé—®é¢˜ã€‚
æ ¸å¿ƒä½œç”¨åŒ…æ‹¬ï¼š

è§£è€¦ SQL ä¸Žç¨‹åºä»£ç ï¼šå°† SQL è¯­å¥ä»Ž Java ä»£ç ä¸­å‰¥ç¦»å‡ºæ¥ï¼Œé…ç½®åœ¨ XML æ–‡ä»¶æˆ–æ³¨è§£ä¸­ï¼Œä½¿å¾—ä»£ç æ›´æ¸…æ™°ã€æ›´æ˜“äºŽç»´æŠ¤ã€‚
è‡ªåŠ¨å®Œæˆ ORMï¼ˆå¯¹è±¡å…³ç³»æ˜ å°„ï¼‰ï¼šæ‰§è¡Œ SQL åŽï¼ŒMyBatis å¯ä»¥è‡ªåŠ¨å°†æŸ¥è¯¢ç»“æžœé›†å°è£…æˆ Java å¯¹è±¡ï¼ˆPOJOï¼‰ï¼Œæˆ–å°† Java å¯¹è±¡å‚æ•°è‡ªåŠ¨æ˜ å°„åˆ° SQL ä¸­ã€‚
æä¾›å¼ºå¤§çš„åŠ¨æ€ SQL åŠŸèƒ½ï¼šå¯ä»¥é€šè¿‡ XML æ ‡ç­¾ï¼ˆå¦‚ &lt;if&gt;, &lt;foreach&gt;, &lt;where&gt;ï¼‰çµæ´»åœ°æ‹¼æŽ¥å¤æ‚çš„ SQL è¯­å¥ï¼Œé¿å…äº†åœ¨ Java ä»£ç ä¸­æ‹¼æŽ¥å­—ç¬¦ä¸²çš„éº»çƒ¦å’Œæ½œåœ¨çš„å®‰å…¨é£Žé™©ï¼ˆå¦‚ SQL æ³¨å…¥ï¼‰ã€‚
ç®€åŒ–æ•°æ®åº“è¿žæŽ¥å’Œäº‹åŠ¡ç®¡ç†ï¼šå¯ä»¥ä¸Ž Spring ç­‰æ¡†æž¶æ— ç¼é›†æˆï¼Œç”±è¿™äº›æ¡†æž¶æ¥ç®¡ç†æ•°æ®æºå’Œäº‹åŠ¡ã€‚

ä½ å›žç­”çš„åˆ†æžï¼šä½ å¯èƒ½åªå›žç­”äº†â€œæŒä¹…å±‚æ¡†æž¶â€ï¼Œä½†æ²¡æœ‰å±•å¼€è¯´æ˜Žå®ƒå…·ä½“è§£å†³äº†ä»€ä¹ˆé—®é¢˜å’Œå¸¦æ¥äº†ä»€ä¹ˆå¥½å¤„ã€‚é¢è¯•å®˜æƒ³å¬åˆ°çš„æ˜¯ä½ å¯¹æ¡†æž¶ä»·å€¼çš„ç†è§£ã€‚

2. è¡¨ä¹‹é—´æ€Žä¹ˆè¿žæŽ¥æŸ¥è¯¢æ ‡å‡†ç­”æ¡ˆï¼šè¡¨ä¹‹é—´çš„è¿žæŽ¥æŸ¥è¯¢ä¸»è¦é€šè¿‡ SQL çš„ JOIN å…³é”®å­—æ¥å®žçŽ°ï¼Œè€Œä¸æ˜¯é€šè¿‡å¤–é”®ã€‚å¤–é”®æ˜¯ä¸€ç§æ•°æ®åº“å±‚é¢çš„çº¦æŸï¼Œç”¨äºŽä¿è¯æ•°æ®çš„å‚ç…§å®Œæ•´æ€§ï¼Œå®ƒå®šä¹‰äº†è¡¨ä¹‹é—´çš„å…³ç³»ï¼Œä½†ä¸ç›´æŽ¥ç”¨äºŽæŸ¥è¯¢ã€‚
å¸¸è§çš„è¿žæŽ¥æŸ¥è¯¢æœ‰ï¼š

å†…è¿žæŽ¥ï¼ˆINNER JOINï¼‰ï¼šè¿”å›žä¸¤ä¸ªè¡¨ä¸­è¿žæŽ¥å­—æ®µåŒ¹é…çš„è®°å½•ã€‚
sql
SELECT * FROM è®¢å•è¡¨ o INNER JOIN ç”¨æˆ·è¡¨ u ON o.user_id = u.id;



å·¦å¤–è¿žæŽ¥ï¼ˆLEFT JOINï¼‰ï¼šè¿”å›žå·¦è¡¨çš„æ‰€æœ‰è®°å½•ï¼Œä»¥åŠå³è¡¨ä¸­è¿žæŽ¥å­—æ®µåŒ¹é…çš„è®°å½•ã€‚å¦‚æžœå³è¡¨æ²¡æœ‰åŒ¹é…ï¼Œåˆ™è¿”å›ž NULLã€‚
sql
SELECT * FROM ç”¨æˆ·è¡¨ u LEFT JOIN è®¢å•è¡¨ o ON u.id = o.user_id;



å³å¤–è¿žæŽ¥ï¼ˆRIGHT JOINï¼‰ï¼šä¸Žå·¦è¿žæŽ¥ç›¸åï¼Œè¿”å›žå³è¡¨çš„æ‰€æœ‰è®°å½•å’Œå·¦è¡¨ä¸­åŒ¹é…çš„è®°å½•ã€‚

å…¨å¤–è¿žæŽ¥ï¼ˆFULL JOINï¼‰ï¼šè¿”å›žå·¦å³ä¸¤è¡¨çš„æ‰€æœ‰è®°å½•ã€‚


ä½ å›žç­”çš„åˆ†æžï¼šä½ å›žç­”â€œå¤–é”®â€æ˜¯ä¸å‡†ç¡®çš„ã€‚è¿™æ˜¯ä¸€ä¸ªå¸¸è§çš„æ¦‚å¿µæ··æ·†ã€‚é¢è¯•å®˜å¬åˆ°è¿™ä¸ªå›žç­”ï¼Œå¯èƒ½ä¼šè®¤ä¸ºä½ ä¸å¤ªç†Ÿæ‚‰ SQL æŸ¥è¯¢æœ¬èº«ã€‚ä¸€å®šè¦æ˜Žç¡®ï¼šå¤–é”®æ˜¯çº¦æŸï¼ŒJOIN æ˜¯æŸ¥è¯¢æ“ä½œã€‚

3. SQL çš„å‡½æ•°æ€Žä¹ˆæ‰§è¡Œæ ‡å‡†ç­”æ¡ˆï¼šSQL å‡½æ•°æ˜¯åœ¨æ•°æ®åº“æœåŠ¡å™¨ç«¯æ‰§è¡Œçš„ã€‚æˆ‘ä»¬åœ¨ SQL è¯­å¥ä¸­ç›´æŽ¥è°ƒç”¨å‡½æ•°ï¼Œæ•°æ®åº“å¼•æ“Žä¼šè´Ÿè´£è§£æžå’Œæ‰§è¡Œè¿™äº›å‡½æ•°ã€‚
å…·ä½“æ–¹å¼ï¼š

åœ¨ SQL è¯­å¥ä¸­ç›´æŽ¥è°ƒç”¨ï¼šå°†å‡½æ•°ä½œä¸º SQL çš„ä¸€éƒ¨åˆ†å†™å…¥ã€‚

æ—¥æœŸå‡½æ•°ï¼šSELECT NOW(); â€“ èŽ·å–æ•°æ®åº“å½“å‰æ—¶é—´
èšåˆå‡½æ•°ï¼šSELECT COUNT(*) FROM table_name;
å­—ç¬¦ä¸²å‡½æ•°ï¼šSELECT CONCAT(first_name, &#39; &#39;, last_name) AS full_name FROM users;


åœ¨ MyBatis ä¸­ï¼Œæˆ‘ä»¬å°±æ˜¯åœ¨ XML æ˜ å°„æ–‡ä»¶æˆ–æ³¨è§£çš„ SQL é‡Œç›´æŽ¥ä½¿ç”¨è¿™äº›å‡½æ•°ã€‚
xml
&lt;select id=&quot;getCurrentTime&quot; resultType=&quot;string&quot;&gt;    SELECT NOW()&lt;/select&gt;

ä½ å›žç­”çš„åˆ†æžï¼šä½ çš„å›žç­”â€œåœ¨æ–¹æ³•ä¸­å¯¹å†™å…¥å‚æ•°èµ‹å€¼ç„¶åŽå†æ‰§è¡Œsqlâ€æè¿°çš„æ˜¯è®¾ç½®æ™®é€šå‚æ•°çš„è¿‡ç¨‹ï¼Œå¹¶æ²¡æœ‰æ¶‰åŠåˆ° SQL å‡½æ•°ã€‚é¢è¯•å®˜æç¤ºçš„â€œå®žæ—¶æ—¶é—´â€ï¼ˆNOW()ï¼‰å°±æ˜¯ä¸€ä¸ªå…¸åž‹çš„åœ¨æ•°æ®åº“ç«¯æ‰§è¡Œçš„å‡½æ•°ã€‚ä½ éœ€è¦åŒºåˆ†æ¸…æ¥šï¼šç®€å•å‚æ•°ç”±åº”ç”¨ç¨‹åºä¼ å…¥ï¼Œè€Œå‡½æ•°ç”±æ•°æ®åº“è®¡ç®—ã€‚

4. æ¨¡ç³ŠæŸ¥è¯¢æ€Žä¹ˆå®žçŽ°çš„æ ‡å‡†ç­”æ¡ˆï¼šæ¨¡ç³ŠæŸ¥è¯¢æ˜¯ä½¿ç”¨ SQL çš„ LIKE å…³é”®å­—é…åˆé€šé…ç¬¦ %ï¼ˆä»£è¡¨ä»»æ„å¤šä¸ªå­—ç¬¦ï¼‰å’Œ _ï¼ˆä»£è¡¨ä¸€ä¸ªå­—ç¬¦ï¼‰æ¥å®žçŽ°çš„ã€‚
å…·ä½“å®žçŽ°ï¼ˆä»¥ MyBatis ä¸ºä¾‹ï¼‰ï¼šæŸ¥è¯¢å€¼åº”è¯¥ä½œä¸ºå‚æ•°ä¼ é€’ç»™ SQL è¯­å¥ï¼Œå¹¶åœ¨å‚æ•°å€¼çš„ä¸¤ç«¯åŠ ä¸Š %ã€‚

æ–¹å¼ä¸€ï¼šåœ¨ Java ä»£ç ä¸­æ‹¼æŽ¥å¥½ %ï¼ˆä¸æŽ¨èï¼Œæ˜“å¼•å‘ SQL æ³¨å…¥ï¼‰
java
String name = &quot;%&quot; + userInput + &quot;%&quot;;



æ–¹å¼äºŒï¼šåœ¨ MyBatis XML ä¸­ä½¿ç”¨ #&#123;&#125; å¹¶æ‹¼æŽ¥ %ï¼ˆæŽ¨èï¼‰
xml
&lt;select id=&quot;findUserByName&quot; resultType=&quot;User&quot;&gt;    SELECT * FROM users WHERE name LIKE CONCAT(&#x27;%&#x27;, #&#123;name&#125;, &#x27;%&#x27;)&lt;/select&gt;



æ–¹å¼ä¸‰ï¼šåœ¨ MyBatis XML ä¸­ä½¿ç”¨ bind æ ‡ç­¾ï¼ˆæŽ¨èï¼‰
xml
&lt;select id=&quot;findUserByName&quot; resultType=&quot;User&quot;&gt;    &lt;bind name=&quot;pattern&quot; value=&quot;&#x27;%&#x27; + name + &#x27;%&#x27;&quot; /&gt;    SELECT * FROM users WHERE name LIKE #&#123;pattern&#125;&lt;/select&gt;

ä½ å›žç­”çš„åˆ†æžï¼šä½ åªç­”å‡ºäº†â€œ%è¿žæŽ¥â€ï¼Œè¿™æ˜¯æ­£ç¡®çš„ï¼Œä½†ä¸å¤Ÿå®Œæ•´ã€‚é¢è¯•å®˜è¿½é—®â€œå…·ä½“æ€Žä¹ˆå®žçŽ°ï¼ŒæŸ¥è¯¢å€¼è¦åœ¨å“ªâ€æ˜¯åœ¨è€ƒå¯Ÿä½ å¦‚ä½•åœ¨ MyBatis æ¡†æž¶ä¸­å®‰å…¨ã€æ­£ç¡®åœ°ä¼ é€’è¿™ä¸ªå¸¦ % çš„å‚æ•°ã€‚ä½ éœ€è¦è¯´æ˜Žå‚æ•°æ¥è‡ªå“ªé‡Œï¼Œä»¥åŠå¦‚ä½•ç»„ç»‡ã€‚

5. åˆ†é¡µæŸ¥è¯¢æ€Žä¹ˆå®žçŽ°çš„æ ‡å‡†ç­”æ¡ˆï¼šåˆ†é¡µæŸ¥è¯¢çš„å®žçŽ°ä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼š

æ•°æ®åº“åŽŸç”Ÿåˆ†é¡µï¼ˆæŽ¨èï¼Œæ•ˆçŽ‡é«˜ï¼‰ï¼šç¼–å†™å¸¦æœ‰åˆ†é¡µå…³é”®å­—çš„ SQL è¯­å¥ã€‚

MySQLï¼šä½¿ç”¨ LIMIT
sql
SELECT * FROM table_name LIMIT #&#123;offset&#125;, #&#123;pageSize&#125;



ï¼ˆoffset = (pageNum - 1) * pageSizeï¼‰

Oracleï¼šä½¿ç”¨ ROWNUM æˆ– ROW_NUMBER()

PostgreSQLï¼šä½¿ç”¨ LIMIT OFFSET



ä½¿ç”¨åˆ†é¡µæ’ä»¶ï¼ˆæœ€æ–¹ä¾¿ï¼‰ï¼šåœ¨ MyBatis ä¸­ï¼Œå¯ä»¥ä½¿ç”¨åƒ PageHelper è¿™æ ·çš„ç¬¬ä¸‰æ–¹åˆ†é¡µæ’ä»¶ã€‚ä½ åªéœ€è¦åœ¨æŸ¥è¯¢æ–¹æ³•å‰è®¾ç½®åˆ†é¡µå‚æ•°ï¼Œæ’ä»¶ä¼šè‡ªåŠ¨æ‹¦æˆªä¸‹ä¸€ä¸ªæŸ¥è¯¢è¯­å¥ï¼Œå¹¶ä¸ºå…¶åŠ ä¸Šæ•°æ®åº“å¯¹åº”çš„åˆ†é¡µè¯­å¥ã€‚
java
// ä½¿ç”¨ PageHelperPageHelper.startPage(1, 10); // æŸ¥è¯¢ç¬¬1é¡µï¼Œæ¯é¡µ10æ¡List&lt;User&gt; userList = userMapper.selectAll();// userList å°±æ˜¯ä¸€ä¸ªåˆ†é¡µåŽçš„åˆ—è¡¨ï¼ŒPageHelper è¿˜ä¼šæä¾›ä¸€ä¸ª PageInfo å¯¹è±¡åŒ…å«æ€»è®°å½•æ•°ç­‰åˆ†é¡µä¿¡æ¯

ä½ å›žç­”çš„åˆ†æžï¼šè¿™ä¸ªé—®é¢˜å¾ˆå¸¸è§ã€‚å¦‚æžœä½ åªå›žç­”äº†é€»è¾‘åˆ†é¡µï¼ˆåœ¨å†…å­˜ä¸­åˆ†é¡µï¼‰ï¼Œæˆ–è€…è¯´ä¸æ¸…æ¥š LIMIT å…³é”®å­—ï¼Œå°±ä¼šæš´éœ²ç»éªŒä¸è¶³ã€‚ä¸€å®šè¦æŽŒæ¡ä¸€ç§æ•°æ®åº“çš„åŽŸç”Ÿåˆ†é¡µå†™æ³•ï¼Œå¹¶äº†è§£ä¸»æµçš„åˆ†é¡µæ’ä»¶ã€‚

6. Bean çš„ç”Ÿå‘½å‘¨æœŸæ ‡å‡†ç­”æ¡ˆï¼ˆä»¥ Spring Bean ä¸ºä¾‹ï¼‰ï¼šBean çš„ç”Ÿå‘½å‘¨æœŸæŒ‡çš„æ˜¯ä¸€ä¸ª Bean ä»Žåˆ›å»ºåˆ°é”€æ¯çš„æ•´ä¸ªè¿‡ç¨‹ã€‚ä¸»è¦é˜¶æ®µå¦‚ä¸‹ï¼š

å®žä¾‹åŒ–ï¼šSpring å®¹å™¨é€šè¿‡åå°„è°ƒç”¨æž„é€ å‡½æ•°åˆ›å»º Bean çš„å®žä¾‹ã€‚
å±žæ€§èµ‹å€¼ï¼ˆä¾èµ–æ³¨å…¥ï¼‰ï¼šå®¹å™¨å°† Bean çš„ä¾èµ–é¡¹ï¼ˆå…¶ä»– Bean æˆ–é…ç½®å€¼ï¼‰æ³¨å…¥åˆ° Bean çš„å±žæ€§ä¸­ã€‚
BeanPostProcessor çš„å‰ç½®å¤„ç†ï¼šè°ƒç”¨ postProcessBeforeInitialization æ–¹æ³•ã€‚
åˆå§‹åŒ–ï¼š
å¦‚æžœ Bean å®žçŽ°äº† InitializingBean æŽ¥å£ï¼Œåˆ™è°ƒç”¨å…¶ afterPropertiesSet() æ–¹æ³•ã€‚
å¦‚æžœ Bean é…ç½®äº† init-method æ–¹æ³•ï¼Œåˆ™è°ƒç”¨æ­¤è‡ªå®šä¹‰çš„åˆå§‹åŒ–æ–¹æ³•ã€‚


BeanPostProcessor çš„åŽç½®å¤„ç†ï¼šè°ƒç”¨ postProcessAfterInitialization æ–¹æ³•ï¼ˆAOP ä»£ç†é€šå¸¸åœ¨æ­¤å¤„ç”Ÿæˆï¼‰ã€‚
ä½¿ç”¨ä¸­ï¼šæ­¤æ—¶ Bean å·²å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥è¢«åº”ç”¨ç¨‹åºä½¿ç”¨ã€‚
é”€æ¯ï¼š
å½“å®¹å™¨å…³é—­æ—¶ï¼Œå¦‚æžœ Bean å®žçŽ°äº† DisposableBean æŽ¥å£ï¼Œåˆ™è°ƒç”¨å…¶ destroy() æ–¹æ³•ã€‚
å¦‚æžœ Bean é…ç½®äº† destroy-method æ–¹æ³•ï¼Œåˆ™è°ƒç”¨æ­¤è‡ªå®šä¹‰çš„é”€æ¯æ–¹æ³•ã€‚



ä½ å›žç­”çš„åˆ†æžï¼šè¿™æ˜¯ä¸€ä¸ªè€ƒå¯Ÿ Spring æ¡†æž¶ç†è§£æ·±åº¦çš„ç»å…¸é—®é¢˜ã€‚å¦‚æžœä½ åªèƒ½è¯´å‡ºä¸€ä¸¤ä¸ªé˜¶æ®µï¼ˆå¦‚â€œåˆ›å»ºã€åˆå§‹åŒ–ã€é”€æ¯â€ï¼‰ï¼Œå°±æ˜¾å¾—æ¯”è¾ƒè‚¤æµ…ã€‚å¦‚æžœèƒ½æµåˆ©åœ°è¯´å‡ºä¸Šè¿° 5-7 ä¸ªæ ¸å¿ƒé˜¶æ®µï¼Œå¹¶æåŠ BeanPostProcessor è¿™æ ·çš„æ‰©å±•ç‚¹ï¼Œä¼šç»™é¢è¯•å®˜ç•™ä¸‹å¾ˆå¥½çš„å°è±¡ã€‚
æ€»ç»“ä¸Žå»ºè®®
æ¦‚å¿µæ¸…æ™°ï¼šåŒºåˆ†å¼€â€œå¤–é”®â€ï¼ˆçº¦æŸï¼‰å’Œâ€œè¿žæŽ¥æŸ¥è¯¢â€ï¼ˆæ“ä½œï¼‰è¿™ç±»æ˜“æ··æ·†çš„æ¦‚å¿µã€‚
ç†è§£åŽŸç†ï¼šä¸è¦åªè®°åè¯ï¼Œè¦ç†è§£èƒŒåŽçš„åŽŸç†ã€‚æ¯”å¦‚ SQL å‡½æ•°åœ¨å“ªæ‰§è¡Œï¼Œå…³ç³»åˆ°åº”ç”¨ç¨‹åºå’Œæ•°æ®åº“çš„èŒè´£åˆ’åˆ†ã€‚
æ¡†æž¶ç†Ÿç»ƒåº¦ï¼šå¯¹äºŽ MyBatis&#x2F;Spring è¿™ç±»å¿…é—®æ¡†æž¶ï¼Œä¸ä»…è¦ä¼šç”¨ï¼Œè¿˜è¦äº†è§£å…¶æ ¸å¿ƒæœºåˆ¶å’Œæœ€ä½³å®žè·µï¼ˆå¦‚åˆ†é¡µã€åŠ¨æ€SQLã€ç”Ÿå‘½å‘¨æœŸï¼‰ã€‚
å¤šåŠ¨æ‰‹ï¼šæŠŠè¿™äº›é—®é¢˜çš„ç­”æ¡ˆè‡ªå·±å†™ä»£ç éªŒè¯ä¸€éï¼Œå°è±¡ä¼šæ›´æ·±åˆ»ã€‚

è¿™æ¬¡é¢è¯•è™½ç„¶æŒ‚äº†ï¼Œä½†æš´éœ²å‡ºçš„é—®é¢˜éžå¸¸å…¸åž‹ï¼Œæ­£å¥½ä¸ºä½ æŒ‡æ˜Žäº†ä¸‹ä¸€æ­¥å­¦ä¹ çš„æ–¹å‘ã€‚åŠ æ²¹ï¼
]]></content>
      <categories>
        <category>Java</category>
        <category>é¢è¯•</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>é¢è¯•</tag>
      </tags>
  </entry>
  <entry>
    <title>SwitchHostsä¸‹è½½å®‰è£…ä½¿ç”¨</title>
    <url>/2025/08/11/SwitchHosts%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[SwitchHostsä¸‹è½½å®‰è£…ä½¿ç”¨githubç›´æŽ¥æœç„¶åŽä¸‹è½½

ç„¶åŽç›´æŽ¥ä¿®æ”¹

æ³¨æ„ï¼Œè¦å…³ä»£ç†å¹¶ä¸”é‡å¯æµè§ˆå™¨ï¼ï¼ï¼
]]></content>
      <categories>
        <category>Java</category>
        <category>util</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>util</tag>
      </tags>
  </entry>
  <entry>
    <title></title>
    <url>/2025/09/22/%E7%AE%97%E6%B3%95%E5%88%B7%E9%A2%98/</url>
    <content><![CDATA[ç®—æ³•åˆ·é¢˜å¿ƒå¾—ä½“ä¼šä¸Žç»å…¸åˆ·é¢˜226. ç¿»è½¬äºŒå‰æ ‘ç®€å•
ç»™ä½ ä¸€æ£µäºŒå‰æ ‘çš„æ ¹èŠ‚ç‚¹ root ï¼Œç¿»è½¬è¿™æ£µäºŒå‰æ ‘ï¼Œå¹¶è¿”å›žå…¶æ ¹èŠ‚ç‚¹ã€‚
ç¤ºä¾‹ 1ï¼š

è¾“å…¥ï¼šroot = [4,2,7,1,3,6,9]è¾“å‡ºï¼š[4,7,2,9,6,3,1]

ç¤ºä¾‹ 2ï¼š

è¾“å…¥ï¼šroot = [2,1,3]è¾“å‡ºï¼š[2,3,1]

ç¤ºä¾‹ 3ï¼š
è¾“å…¥ï¼šroot = []è¾“å‡ºï¼š[]





é¢˜è§£ï¼š
é€’å½’æ·±åº¦ä¼˜å…ˆæœç´¢ï¼ˆDFSï¼‰
public TreeNode invertTree(TreeNode root) &#123;    if (root == null) return null;        TreeNode left = invertTree(root.left);    TreeNode right = invertTree(root.right);        root.left = right;    root.right = left;        return root;&#125;

è¿­ä»£ï¼ˆBFSï¼‰- ä½¿ç”¨é˜Ÿåˆ—
public TreeNode invertTree(TreeNode root) &#123;    if (root == null) return null;        Queue&lt;TreeNode&gt; queue = new LinkedList&lt;&gt;();    queue.offer(root);        while (!queue.isEmpty()) &#123;        TreeNode node = queue.poll();                // äº¤æ¢å·¦å³å­èŠ‚ç‚¹        TreeNode temp = node.left;        node.left = node.right;        node.right = temp;                if (node.left != null) queue.offer(node.left);        if (node.right != null) queue.offer(node.right);    &#125;        return root;&#125;

è¿­ä»£ï¼ˆDFSï¼‰- ä½¿ç”¨æ ˆ
public TreeNode invertTree(TreeNode root) &#123;    if (root == null) return null;        Stack&lt;TreeNode&gt; stack = new Stack&lt;&gt;();    stack.push(root);        while (!stack.isEmpty()) &#123;        TreeNode node = stack.pop();                // äº¤æ¢å·¦å³å­èŠ‚ç‚¹        TreeNode temp = node.left;        node.left = node.right;        node.right = temp;                if (node.left != null) stack.push(node.left);        if (node.right != null) stack.push(node.right);    &#125;        return root;&#125;





221. æœ€å¤§æ­£æ–¹å½¢åœ¨ä¸€ä¸ªç”± &#39;0&#39; å’Œ &#39;1&#39; ç»„æˆçš„äºŒç»´çŸ©é˜µå†…ï¼Œæ‰¾åˆ°åªåŒ…å« &#39;1&#39; çš„æœ€å¤§æ­£æ–¹å½¢ï¼Œå¹¶è¿”å›žå…¶é¢ç§¯ã€‚
ç¤ºä¾‹ 1ï¼š

è¾“å…¥ï¼šmatrix = [[&quot;1&quot;,&quot;0&quot;,&quot;1&quot;,&quot;0&quot;,&quot;0&quot;],[&quot;1&quot;,&quot;0&quot;,&quot;1&quot;,&quot;1&quot;,&quot;1&quot;],[&quot;1&quot;,&quot;1&quot;,&quot;1&quot;,&quot;1&quot;,&quot;1&quot;],[&quot;1&quot;,&quot;0&quot;,&quot;0&quot;,&quot;1&quot;,&quot;0&quot;]]è¾“å‡ºï¼š4

ç¤ºä¾‹ 2ï¼š

è¾“å…¥ï¼šmatrix = [[&quot;0&quot;,&quot;1&quot;],[&quot;1&quot;,&quot;0&quot;]]è¾“å‡ºï¼š1

ç¤ºä¾‹ 3ï¼š
è¾“å…¥ï¼šmatrix = [[&quot;0&quot;]]è¾“å‡ºï¼š0



åŠ¨æ€è§„åˆ’
é¢˜è§£ï¼š
public int maximalSquare(char[][] matrix) &#123;    if (matrix == null || matrix.length == 0) return 0;        int rows = matrix.length, cols = matrix[0].length;    int maxSide = 0;        // dp[i][j] è¡¨ç¤ºä»¥(i,j)ä¸ºå³ä¸‹è§’çš„æœ€å¤§æ­£æ–¹å½¢è¾¹é•¿    int[][] dp = new int[rows][cols];        for (int i = 0; i &lt; rows; i++) &#123;        for (int j = 0; j &lt; cols; j++) &#123;            if (matrix[i][j] == &#x27;1&#x27;) &#123;                if (i == 0 || j == 0) &#123;                    // ç¬¬ä¸€è¡Œæˆ–ç¬¬ä¸€åˆ—ï¼Œæœ€å¤§è¾¹é•¿åªèƒ½æ˜¯1                    dp[i][j] = 1;                &#125; else &#123;                    // å…³é”®å…¬å¼ï¼šå–å·¦ã€ä¸Šã€å·¦ä¸Šä¸‰ä¸ªæ–¹å‘çš„æœ€å°å€¼ + 1                    dp[i][j] = Math.min(Math.min(dp[i-1][j], dp[i][j-1]), dp[i-1][j-1]) + 1;                &#125;                maxSide = Math.max(maxSide, dp[i][j]);            &#125;        &#125;    &#125;        return maxSide * maxSide;&#125;

çˆ†ç ´ï¼š
public int maximalSquare(char[][] matrix) &#123;    if (matrix == null || matrix.length == 0) return 0;        int maxSide = 0;    int rows = matrix.length, cols = matrix[0].length;        for (int i = 0; i &lt; rows; i++) &#123;        for (int j = 0; j &lt; cols; j++) &#123;            if (matrix[i][j] == &#x27;1&#x27;) &#123;                maxSide = Math.max(maxSide, 1); // è‡³å°‘æ˜¯1x1çš„æ­£æ–¹å½¢                                // å°è¯•æ‰©å±•æ­£æ–¹å½¢                int currentMaxSide = Math.min(rows - i, cols - j);                for (int k = 1; k &lt; currentMaxSide; k++) &#123;                    if (isSquare(matrix, i, j, k)) &#123;                        maxSide = Math.max(maxSide, k + 1);                    &#125; else &#123;                        break;                    &#125;                &#125;            &#125;        &#125;    &#125;        return maxSide * maxSide; // è¿”å›žé¢ç§¯&#125;// æ£€æŸ¥ä»Ž(i,j)å¼€å§‹ï¼Œè¾¹é•¿ä¸ºside+1çš„æ­£æ–¹å½¢æ˜¯å¦å…¨æ˜¯&#x27;1&#x27;private boolean isSquare(char[][] matrix, int i, int j, int side) &#123;    // æ£€æŸ¥æ–°å¢žçš„è¡Œå’Œåˆ—    for (int k = 0; k &lt;= side; k++) &#123;        if (matrix[i + side][j + k] != &#x27;1&#x27;) return false;        if (matrix[i + k][j + side] != &#x27;1&#x27;) return false;    &#125;    return true;&#125;



215. æ•°ç»„ä¸­çš„ç¬¬Kä¸ªæœ€å¤§å…ƒç´ ç»™å®šæ•´æ•°æ•°ç»„ nums å’Œæ•´æ•° kï¼Œè¯·è¿”å›žæ•°ç»„ä¸­ç¬¬ **k** ä¸ªæœ€å¤§çš„å…ƒç´ ã€‚
è¯·æ³¨æ„ï¼Œä½ éœ€è¦æ‰¾çš„æ˜¯æ•°ç»„æŽ’åºåŽçš„ç¬¬ k ä¸ªæœ€å¤§çš„å…ƒç´ ï¼Œè€Œä¸æ˜¯ç¬¬ k ä¸ªä¸åŒçš„å…ƒç´ ã€‚
ä½ å¿…é¡»è®¾è®¡å¹¶å®žçŽ°æ—¶é—´å¤æ‚åº¦ä¸º O(n) çš„ç®—æ³•è§£å†³æ­¤é—®é¢˜ã€‚
ç¤ºä¾‹ 1:
è¾“å…¥: [3,2,1,5,6,4], k = 2è¾“å‡º: 5

ç¤ºä¾‹ 2:
è¾“å…¥: [3,2,3,1,2,4,5,5,6], k = 4è¾“å‡º: 4



é¢˜è§£ï¼š
é€‰æ‹©æŽ’åºï¼Œä½†æ˜¯è¿™ä¸ªè¶…æ—¶äº†ï¼š
class Solution &#123;    public int findKthLargest(int[] nums, int k) &#123;        for(int i = 0;i &lt; k;i++)&#123;            int maxIndex = i;            // æ‰¾åˆ°[i+1...R]ä¸Šæœ€å¤§å…ƒç´ çš„ç´¢å¼•            for(int j = i+1;j &lt; nums.length;j++)                if(nums[j] &gt; nums[maxIndex])                    maxIndex = j;            // å°†è¯¥å…ƒç´ æ”¾åˆ°iä½ç½®            if(maxIndex != i)&#123;                int temp = nums[i];                nums[i] = nums[maxIndex];                nums[maxIndex] = temp;            &#125;        &#125;        return nums[k-1];    &#125;&#125;

è°ƒåº“ï¼š
import java.util.Arrays;class Solution &#123;    public int findKthLargest(int[] nums, int k) &#123;        if (nums == null || nums.length == 0) &#123;            return 0;        &#125;                // å¯¹æ•°ç»„è¿›è¡ŒæŽ’åºï¼ˆå‡åºï¼‰        Arrays.sort(nums);                // ç¬¬kå¤§çš„å…ƒç´ åœ¨æŽ’åºåŽçš„ä½ç½®æ˜¯ nums.length - k        return nums[nums.length - k];    &#125;&#125;

]]></content>
  </entry>
  <entry>
    <title>ä¸ºäº†å®žä¹ è¯´æ˜¯</title>
    <url>/2025/09/16/%E4%B8%BA%E4%BA%86%E5%AE%9E%E4%B9%A0%E8%AF%B4%E6%98%AF/</url>
    <content><![CDATA[ä¸ºäº†å®žä¹ è¯´æ˜¯MySQL1. äº‹åŠ¡ï¼ˆTransactionï¼‰åè¯ä¸Žå®šä¹‰
äº‹åŠ¡ï¼šæ•°æ®åº“æ“ä½œçš„æœ€å°å·¥ä½œå•å…ƒï¼Œä¸€ä¸ªäº‹åŠ¡å†…çš„æ‰€æœ‰æ“ä½œä½œä¸ºä¸€ä¸ªæ•´ä½“ï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚
ACID ç‰¹æ€§ï¼š
åŽŸå­æ€§ (Atomicity)ï¼šäº‹åŠ¡æ˜¯ä¸€ä¸ªä¸å¯åˆ†å‰²çš„æ•´ä½“ï¼Œè¦ä¹ˆå…¨éƒ¨æäº¤ï¼Œè¦ä¹ˆå…¨éƒ¨å›žæ»šã€‚
ä¸€è‡´æ€§ (Consistency)ï¼šäº‹åŠ¡æ‰§è¡Œå‰åŽï¼Œæ•°æ®åº“å¿…é¡»ä»Žä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€å˜æ¢åˆ°å¦ä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€ï¼ˆæ•°æ®å®Œæ•´æ€§çº¦æŸä¸è¢«ç ´åï¼‰ã€‚
éš”ç¦»æ€§ (Isolation)ï¼šå¹¶å‘äº‹åŠ¡ä¹‹é—´ç›¸äº’éš”ç¦»ï¼Œä¸€ä¸ªäº‹åŠ¡çš„æ‰§è¡Œä¸åº”å½±å“å…¶ä»–äº‹åŠ¡ã€‚
æŒä¹…æ€§ (Durability)ï¼šäº‹åŠ¡ä¸€æ—¦æäº¤ï¼Œå…¶å¯¹æ•°æ®çš„ä¿®æ”¹å°±æ˜¯æ°¸ä¹…æ€§çš„ï¼Œå³ä½¿ç³»ç»Ÿæ•…éšœä¹Ÿä¸ä¼šä¸¢å¤±ã€‚



é¢è¯•æ·±å…¥è¿½é—®ä¸Žè§£ç­”Qï¼šACIDç‰¹æ€§åˆ†åˆ«é ä»€ä¹ˆä¿è¯ï¼Ÿ

A (åŽŸå­æ€§) å’Œ D (æŒä¹…æ€§)ï¼šä¸»è¦é  Redo Log å’Œ Undo Logã€‚
Undo Logï¼šç”¨äºŽå›žæ»šå’ŒMVCCã€‚äº‹åŠ¡ä¿®æ”¹æ•°æ®å‰ï¼Œä¼šå…ˆè®°å½•ä¿®æ”¹å‰çš„æ•°æ®åˆ°Undo Logã€‚å¦‚æžœäº‹åŠ¡éœ€è¦å›žæ»šï¼Œå°±å¯ä»¥åˆ©ç”¨Undo Logå°†æ•°æ®æ¢å¤åˆ°ä¹‹å‰çš„çŠ¶æ€ã€‚ä¿è¯äº†åŽŸå­æ€§ã€‚
Redo Logï¼šç”¨äºŽå´©æºƒæ¢å¤ã€‚äº‹åŠ¡æäº¤æ—¶ï¼Œä¼šå…ˆå†™Redo Logï¼ˆé¡ºåºå†™ï¼Œé€Ÿåº¦å¿«ï¼‰ï¼Œè®°å½•æ•°æ®é¡µçš„ç‰©ç†ä¿®æ”¹ã€‚å³ä½¿ä¿®æ”¹çš„æ•°æ®é¡µè¿˜æ²¡æœ‰åˆ·ç›˜ï¼ŒMySQLå®•æœºé‡å¯åŽä¹Ÿèƒ½æ ¹æ®Redo Logé‡åšï¼Œå°†æ•°æ®æ¢å¤åˆ°æäº¤çŠ¶æ€ã€‚ä¿è¯äº†æŒä¹…æ€§ã€‚


I (éš”ç¦»æ€§)ï¼šé  é”æœºåˆ¶ å’Œ MVCC æ¥ä¿è¯ã€‚
C (ä¸€è‡´æ€§)ï¼šæ˜¯æœ€ç»ˆç›®æ ‡ï¼Œç”±åŽŸå­æ€§ã€éš”ç¦»æ€§ã€æŒä¹…æ€§å…±åŒæ¥ä¿è¯ã€‚

Qï¼šè°ˆè°ˆå››å¤§éš”ç¦»çº§åˆ«åŠå…¶è§£å†³çš„é—®é¢˜ï¼Ÿ

è¯»æœªæäº¤ (Read Uncommitted)ï¼šä¸€ä¸ªäº‹åŠ¡èƒ½è¯»åˆ°å¦ä¸€ä¸ªäº‹åŠ¡æœªæäº¤çš„ä¿®æ”¹ã€‚é—®é¢˜ï¼šè„è¯»ã€‚
è¯»å·²æäº¤ (Read Committed, RC)ï¼šä¸€ä¸ªäº‹åŠ¡åªèƒ½è¯»åˆ°å¦ä¸€ä¸ªäº‹åŠ¡å·²æäº¤çš„ä¿®æ”¹ã€‚è§£å†³ï¼šè„è¯»ã€‚é—®é¢˜ï¼šä¸å¯é‡å¤è¯»ï¼ˆåŒä¸€äº‹åŠ¡å†…ä¸¤æ¬¡ç›¸åŒçš„æŸ¥è¯¢å¯èƒ½å¾—åˆ°ä¸åŒç»“æžœï¼‰ã€‚
å¯é‡å¤è¯» (Repeatable Read, RR)ï¼šMySQLçš„é»˜è®¤çº§åˆ«ã€‚ä¸€ä¸ªäº‹åŠ¡å†…å¤šæ¬¡è¯»å–åŒä¸€æ•°æ®ï¼Œç»“æžœæ˜¯ä¸€è‡´çš„ã€‚è§£å†³ï¼šè„è¯»ã€ä¸å¯é‡å¤è¯»ã€‚é—®é¢˜ï¼šå¹»è¯»ï¼ˆåŒä¸€äº‹åŠ¡å†…ä¸¤æ¬¡èŒƒå›´æŸ¥è¯¢ï¼Œç»“æžœé›†æ•°é‡ä¸ä¸€è‡´ï¼‰ã€‚
ä¸²è¡ŒåŒ– (Serializable)ï¼šæœ€é«˜éš”ç¦»çº§åˆ«ï¼Œæ‰€æœ‰äº‹åŠ¡ä¸²è¡Œæ‰§è¡Œã€‚è§£å†³ï¼šæ‰€æœ‰å¹¶å‘é—®é¢˜ã€‚é—®é¢˜ï¼šæ€§èƒ½æžä½Žã€‚

Qï¼šMySQLçš„RRçº§åˆ«çœŸçš„è§£å†³äº†å¹»è¯»å—ï¼Ÿ

ç­”æ¡ˆï¼šéƒ¨åˆ†è§£å†³ï¼Œä½†å¹¶éžå®Œå…¨å…ç–«ã€‚
å¦‚ä½•è§£å†³ï¼š
å¿«ç…§è¯»ï¼ˆæ™®é€šSELECT ...ï¼‰ï¼šé€šè¿‡MVCCè§£å†³ã€‚äº‹åŠ¡é¦–æ¬¡è¯»æ—¶ä¼šå»ºç«‹ä¸€è‡´æ€§è§†å›¾ï¼ˆReadViewï¼‰ï¼ŒåŽç»­è¯»éƒ½åŸºäºŽè¿™ä¸ªè§†å›¾ï¼Œçœ‹ä¸åˆ°å…¶ä»–äº‹åŠ¡æ–°æäº¤çš„æ•°æ®ï¼Œå› æ­¤ä¸ä¼šå¹»è¯»ã€‚
å½“å‰è¯»ï¼ˆSELECT ... FOR UPDATE, UPDATE, DELETEï¼‰ï¼šé€šè¿‡**Next-Key Lockï¼ˆä¸´é”®é”ï¼‰**è§£å†³ã€‚å½“å‰è¯»ä¸ä»…ä¼šé”ä½æ‰«æåˆ°çš„ç´¢å¼•è®°å½•ï¼Œè¿˜ä¼šé”ä½è¿™äº›è®°å½•ä¹‹é—´çš„â€œé—´éš™â€ï¼ˆGapï¼‰ï¼Œé˜²æ­¢å…¶ä»–äº‹åŠ¡åœ¨é—´éš™ä¸­æ’å…¥æ–°æ•°æ®ï¼Œä»Žè€Œé¿å…äº†å¹»è¯»ã€‚


æœªå®Œå…¨è§£å†³çš„æƒ…å†µï¼šå¦‚æžœä¸€ä¸ªäº‹åŠ¡å…ˆè¿›è¡Œå¿«ç…§è¯»ï¼Œç„¶åŽè‡ªå·±åˆæ‰§è¡Œäº†å½“å‰å†™æ“ä½œï¼ˆå¦‚UPDATEï¼‰ï¼Œè¿™ä¸ªå†™æ“ä½œæ˜¯èƒ½â€œçœ‹åˆ°â€å…¶ä»–äº‹åŠ¡æœ€æ–°æäº¤çš„æ•°æ®çš„ï¼Œå¯èƒ½ä¼šç ´åè¯¥äº‹åŠ¡è‡ªèº«çš„ä¸€è‡´æ€§è§†å›¾ï¼Œäº§ç”Ÿä¸€ç§ç‰¹æ®Šçš„å¹»è¯»ã€‚


2. é”ï¼ˆLockingï¼‰åè¯ä¸Žå®šä¹‰
å…±äº«é” (S Lock)ï¼šåˆç§°è¯»é”ã€‚äº‹åŠ¡è¯»æ•°æ®æ—¶åŠ å…±äº«é”ï¼Œå…è®¸å…¶ä»–äº‹åŠ¡è¯»ï¼Œä½†ä¸å…è®¸å†™ã€‚
æŽ’ä»–é” (X Lock)ï¼šåˆç§°å†™é”ã€‚äº‹åŠ¡å†™æ•°æ®æ—¶åŠ æŽ’ä»–é”ï¼Œä¸å…è®¸å…¶ä»–äº‹åŠ¡è¯»å’Œå†™ã€‚
è¡Œé”ï¼šé”ä½ä¸€è¡Œæ•°æ®ã€‚InnoDBæ”¯æŒã€‚
è¡¨é”ï¼šé”ä½æ•´å¼ è¡¨ã€‚MyISAMå¼•æ“Žçš„ä¸»è¦é”æœºåˆ¶ã€‚
æ„å‘é”ï¼šè¡¨çº§é”ã€‚ISï¼ˆæ„å‘å…±äº«é”ï¼‰å’ŒIXï¼ˆæ„å‘æŽ’ä»–é”ï¼‰ã€‚ç”¨äºŽå¿«é€Ÿåˆ¤æ–­è¡¨ä¸­æ˜¯å¦æœ‰è¡Œè¢«ä¸Šé”ï¼Œé¿å…é€è¡Œæ£€æŸ¥ã€‚

é¢è¯•æ·±å…¥è¿½é—®ä¸Žè§£ç­”Qï¼šInnoDBçš„è¡Œé”æ˜¯æ€Žä¹ˆå®žçŽ°çš„ï¼Ÿ

ç­”æ¡ˆï¼šInnoDBçš„è¡Œé”æ˜¯åŸºäºŽç´¢å¼•å®žçŽ°çš„ï¼
åŽŸç†ï¼šå¦‚æžœä¸€æ¡SQLè¯­å¥èµ°ç´¢å¼•ï¼Œå®ƒåªä¼šé”ä½æ»¡è¶³æ¡ä»¶çš„ç´¢å¼•é¡¹å’Œå¯¹åº”çš„æ•°æ®è¡Œã€‚
è‡´å‘½è¿½é—®ï¼šå¦‚æžœæŸ¥è¯¢æ¡ä»¶æ²¡æœ‰ç”¨åˆ°ç´¢å¼•å‘¢ï¼Ÿ
ç­”ï¼šä¼šå‡çº§ä¸ºè¡¨é”ï¼å› ä¸ºå¼•æ“Žæ— æ³•é€šè¿‡ç´¢å¼•å¿«é€Ÿå®šä½åˆ°è¡Œï¼Œä¸ºäº†å®‰å…¨ï¼Œå®ƒä¼šç›´æŽ¥é”ä½æ•´ä¸ªè¡¨ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå¿…é¡»ä¼˜åŒ–SQLã€å»ºç«‹ç´¢å¼•çš„é‡è¦åŽŸå› ä¹‹ä¸€ã€‚



Qï¼šä»€ä¹ˆæ˜¯é—´éš™é”ï¼ˆGap Lockï¼‰å’Œä¸´é”®é”ï¼ˆNext-Key Lockï¼‰ï¼Ÿ

é—´éš™é” (Gap Lock)ï¼šé”ä½ç´¢å¼•è®°å½•ä¹‹é—´çš„é—´éš™ï¼Œé˜²æ­¢å…¶ä»–äº‹åŠ¡åœ¨è¿™ä¸ªé—´éš™ä¸­æ’å…¥æ–°æ•°æ®ã€‚ä¾‹å¦‚ï¼Œidå€¼æœ‰ 1, 5, 10ï¼Œé‚£ä¹ˆé—´éš™é”å¯ä»¥é”ä½ (1,5), (5,10), (10, +âˆž) è¿™äº›åŒºé—´ã€‚
ä¸´é”®é” (Next-Key Lock)ï¼šè¡Œé” + é—´éš™é”ã€‚å®ƒé”ä½ä¸€ä¸ªç´¢å¼•è®°å½•å’Œå®ƒä¹‹å‰çš„é—´éš™ã€‚ä¾‹å¦‚ï¼Œä¸´é”®é”å¯èƒ½é”ä½ (1,5] è¿™ä¸ªå·¦å¼€å³é—­çš„åŒºé—´ã€‚å®ƒæ˜¯RRéš”ç¦»çº§åˆ«ä¸‹é˜²æ­¢å¹»è¯»çš„å…³é”®æœºåˆ¶ã€‚

Qï¼šä»€ä¹ˆæ˜¯æ­»é”ï¼Ÿå¦‚ä½•æŽ’æŸ¥å’Œé¿å…ï¼Ÿ

å®šä¹‰ï¼šä¸¤ä¸ªæˆ–å¤šä¸ªäº‹åŠ¡ç›¸äº’ç­‰å¾…å¯¹æ–¹é‡Šæ”¾é”ï¼Œå¯¼è‡´å®ƒä»¬éƒ½æ— æ³•ç»§ç»­æ‰§è¡Œã€‚
MySQLå¦‚ä½•å¤„ç†ï¼šInnoDBæœ‰æ­»é”æ£€æµ‹æœºåˆ¶ï¼Œä¸€æ—¦æ£€æµ‹åˆ°æ­»é”ï¼Œä¼šç«‹å³å›žæ»šå…¶ä¸­ä¸€ä¸ªæˆæœ¬æœ€å°çš„äº‹åŠ¡ï¼Œè®©å¦ä¸€ä¸ªäº‹åŠ¡å¾—ä»¥ç»§ç»­ã€‚
å¦‚ä½•æŽ’æŸ¥ï¼šä½¿ç”¨å‘½ä»¤ SHOW ENGINE INNODB STATUS;ï¼ŒæŸ¥çœ‹ LATEST DETECTED DEADLOCK éƒ¨åˆ†ï¼Œåˆ†æžæ­»é”æ—¥å¿—ã€‚
å¦‚ä½•é¿å…ï¼š
ä¿æŒäº‹åŠ¡çŸ­å°ï¼Œå°½å¿«æäº¤ã€‚
å¤šä¸ªäº‹åŠ¡ä»¥ç›¸åŒçš„é¡ºåºè®¿é—®èµ„æºï¼ˆä¾‹å¦‚ï¼Œæ€»æ˜¯å…ˆæ›´æ–°è¡¨Aå†æ›´æ–°è¡¨Bï¼‰ã€‚
ä¸ºé«˜é¢‘æ“ä½œå»ºç«‹åˆé€‚çš„ç´¢å¼•ï¼Œå‡å°‘é”çš„ç«žäº‰èŒƒå›´ã€‚




3. ç´¢å¼•ï¼ˆIndexingï¼‰åè¯ä¸Žå®šä¹‰
ç´¢å¼•ï¼šä¸€ç§å¸®åŠ©MySQLé«˜æ•ˆèŽ·å–æ•°æ®çš„æŽ’å¥½åºçš„æ•°æ®ç»“æž„ã€‚
B+Treeï¼šMySQL InnoDBå¼•æ“Žç´¢å¼•çš„é»˜è®¤æ•°æ®ç»“æž„ã€‚ç›¸æ¯”B-Treeï¼Œæ‰€æœ‰æ•°æ®éƒ½å­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ï¼Œä¸”å¶å­èŠ‚ç‚¹é—´æœ‰æŒ‡é’ˆç›¸è¿žï¼Œæ›´é€‚åˆèŒƒå›´æŸ¥è¯¢å’ŒæŽ’åºã€‚
èšç°‡ç´¢å¼• (Clustered Index)ï¼šè¡¨æ•°æ®æœ¬èº«æŒ‰ä¸»é”®é¡ºåºå­˜å‚¨åœ¨B+Treeçš„å¶å­èŠ‚ç‚¹ä¸­ã€‚ä¸€å¼ è¡¨åªæœ‰ä¸€ä¸ªèšç°‡ç´¢å¼•ã€‚
éžèšç°‡ç´¢å¼• (Secondary Index)ï¼šåˆç§°è¾…åŠ©ç´¢å¼•ã€‚å…¶å¶å­èŠ‚ç‚¹å­˜å‚¨çš„æ˜¯ä¸»é”®å€¼ï¼Œè€Œä¸æ˜¯è¡Œæ•°æ®æœ¬èº«ã€‚æŸ¥è¯¢æ—¶éœ€è¦å›žè¡¨ã€‚

é¢è¯•æ·±å…¥è¿½é—®ä¸Žè§£ç­”Qï¼šä¸ºä»€ä¹ˆæŽ¨èä½¿ç”¨è‡ªå¢žä¸»é”®ï¼Ÿ

æ€§èƒ½ï¼šè‡ªå¢žä¸»é”®æ˜¯é¡ºåºå†™å…¥çš„ï¼Œèƒ½å¾ˆå¥½åœ°å¡«å……B+Treeçš„é¡µï¼Œå‡å°‘é¡µåˆ†è£‚å’Œç¢Žç‰‡ã€‚
ç©ºé—´ï¼šä¸»é”®é•¿åº¦è¶Šå°ï¼Œéžèšç°‡ç´¢å¼•çš„å¶å­èŠ‚ç‚¹å­˜å‚¨çš„ä¸»é”®å€¼ä¹Ÿå°±è¶Šå°ï¼Œå ç”¨çš„ç©ºé—´å°±è¶Šå°ã€‚

Qï¼šä»€ä¹ˆæ˜¯â€œå›žè¡¨â€å’Œâ€œè¦†ç›–ç´¢å¼•â€ï¼Ÿ

å›žè¡¨ï¼šé€šè¿‡éžèšç°‡ç´¢å¼•æŸ¥è¯¢æ—¶ï¼Œå…ˆåœ¨ç´¢å¼•æ ‘ä¸­æ‰¾åˆ°ä¸»é”®å€¼ï¼Œå†æ ¹æ®ä¸»é”®å€¼å›žåˆ°èšç°‡ç´¢å¼•æ ‘ä¸­æŸ¥æ‰¾å®Œæ•´è¡Œæ•°æ®çš„è¿‡ç¨‹ã€‚
è¦†ç›–ç´¢å¼•ï¼šå¦‚æžœç´¢å¼•å­—æ®µå·²ç»åŒ…å«äº†è¦æŸ¥è¯¢çš„æ‰€æœ‰å­—æ®µï¼ˆä¾‹å¦‚ï¼Œåœ¨(name, age)ç´¢å¼•ä¸ŠæŸ¥SELECT name, age FROM userï¼‰ï¼Œåˆ™å¼•æ“Žå¯ä»¥ç›´æŽ¥åœ¨ç´¢å¼•é¡µä¸­æ‹¿åˆ°æ•°æ®ï¼Œé¿å…å›žè¡¨ï¼Œæžå¤§æå‡æ€§èƒ½ã€‚

Qï¼šä»€ä¹ˆæƒ…å†µä¸‹ç´¢å¼•ä¼šå¤±æ•ˆï¼Ÿ

å¯¹ç´¢å¼•åˆ—è¿›è¡Œè®¡ç®—ã€å‡½æ•°æˆ–ç±»åž‹è½¬æ¢ï¼šWHERE YEAR(create_time) = 2023ï¼ŒWHERE amount * 2 &gt; 100ã€‚
Likeä»¥é€šé…ç¬¦å¼€å¤´ï¼šWHERE name LIKE &#39;%ä¸‰ä¸°&#39;ã€‚
è¿åæœ€å·¦å‰ç¼€åŽŸåˆ™ï¼šå¯¹äºŽè”åˆç´¢å¼•(a, b, c)ï¼ŒæŸ¥è¯¢æ¡ä»¶æ²¡æœ‰aï¼Œå¦‚WHERE b = 1 AND c = 2ã€‚
ä½¿ç”¨ORè¿žæŽ¥ï¼šå¦‚æžœORå‰åŽçš„æ¡ä»¶å¹¶éžéƒ½æœ‰ç´¢å¼•ï¼Œç´¢å¼•ä¼šå¤±æ•ˆã€‚
ç´¢å¼•åˆ—ä½¿ç”¨ != æˆ– NOT INï¼šå¯èƒ½ï¼ˆä¸æ˜¯ä¸€å®šï¼‰å¯¼è‡´å¤±æ•ˆã€‚


4. MVCC (å¤šç‰ˆæœ¬å¹¶å‘æŽ§åˆ¶)åè¯ä¸Žå®šä¹‰
MVCCï¼šé€šè¿‡ä¿å­˜æ•°æ®åœ¨æŸä¸ªæ—¶é—´ç‚¹çš„å¿«ç…§æ¥å®žçŽ°å¹¶å‘æŽ§åˆ¶ã€‚è¯»æ“ä½œä¸ä¼šé˜»å¡žå†™æ“ä½œï¼Œå†™æ“ä½œä¹Ÿä¸ä¼šé˜»å¡žè¯»æ“ä½œã€‚
ReadViewï¼šäº‹åŠ¡åœ¨æ‰§è¡Œå¿«ç…§è¯»æ—¶äº§ç”Ÿçš„ä¸€è‡´æ€§è¯»è§†å›¾ã€‚å®ƒå†³å®šäº†å½“å‰äº‹åŠ¡èƒ½çœ‹åˆ°å“ªä¸ªç‰ˆæœ¬çš„æ•°æ®ã€‚
Undo Logé“¾ï¼šä¸€è¡Œæ•°æ®å¯èƒ½æœ‰å¤šä¸ªç‰ˆæœ¬ï¼ˆç”±DB_ROLL_PTRå›žæ»šæŒ‡é’ˆä¸²è”ï¼‰ï¼Œæ¯ä¸ªç‰ˆæœ¬ä¿å­˜åœ¨Undo Logä¸­ã€‚

é¢è¯•æ·±å…¥è¿½é—®ä¸Žè§£ç­”Qï¼šMVCCåœ¨RCå’ŒRRéš”ç¦»çº§åˆ«ä¸‹æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ

æ ¸å¿ƒï¼šåœ¨äºŽReadViewçš„ç”Ÿæˆæ—¶æœºä¸åŒã€‚
Read Committed (RC)ï¼šæ¯æ¬¡æ‰§è¡Œå¿«ç…§è¯»æ—¶éƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„ReadViewã€‚å› æ­¤ï¼Œå®ƒèƒ½è¯»åˆ°å…¶ä»–äº‹åŠ¡æœ€æ–°å·²æäº¤çš„æ•°æ®ã€‚
Repeatable Read (RR)ï¼šåªåœ¨ç¬¬ä¸€æ¬¡æ‰§è¡Œå¿«ç…§è¯»æ—¶ç”Ÿæˆä¸€ä¸ªReadViewï¼ŒåŽç»­æ‰€æœ‰è¯»æ“ä½œéƒ½å¤ç”¨è¿™ä¸ªè§†å›¾ã€‚å› æ­¤ï¼Œå®ƒçœ‹ä¸åˆ°å…¶ä»–äº‹åŠ¡ä¹‹åŽæäº¤çš„æ•°æ®ï¼Œå®žçŽ°äº†å¯é‡å¤è¯»ã€‚

Qï¼šMVCCèƒ½è§£å†³å¹»è¯»å—ï¼Ÿ

å¯¹äºŽå¿«ç…§è¯»ï¼šèƒ½ã€‚å› ä¸ºRRçº§åˆ«ä¸‹ReadViewä¸å˜ï¼Œå³ä½¿å…¶ä»–äº‹åŠ¡æ’å…¥äº†æ–°æ•°æ®ï¼Œå½“å‰äº‹åŠ¡ä¹Ÿçœ‹ä¸åˆ°ï¼Œå› æ­¤ä¸ä¼šå‘ç”Ÿå¹»è¯»ã€‚
å¯¹äºŽå½“å‰è¯»ï¼šä¸èƒ½ã€‚å½“å‰è¯»è¯»å–çš„æ˜¯æœ€æ–°æ•°æ®ï¼Œéœ€è¦é Next-Key Lockæ¥é˜²æ­¢å¹»è¯»ã€‚


5. EXPLAIN æ‰§è¡Œè®¡åˆ’ä¸ŽSQLä¼˜åŒ–æ ¸å¿ƒï¼š EXPLAIN æ˜¯ä½ çš„SQLæ€§èƒ½è¯Šæ–­å™¨ï¼Œä½ å¿…é¡»èƒ½çœ‹æ‡‚å®ƒçš„è¾“å‡ºã€‚
å…³é”®å­—æ®µè§£è¯»ï¼š
typeï¼šè®¿é—®ç±»åž‹ï¼Œä»Žå¥½åˆ°åï¼šsystem &gt; const &gt; eq_ref &gt; ref &gt; range &gt; index &gt; ALLã€‚
è‡³å°‘è¦ä¼˜åŒ–åˆ°rangeçº§åˆ«ï¼Œæœ€å¥½è¾¾åˆ°refã€‚
indexï¼šå…¨ç´¢å¼•æ‰«æã€‚
ALLï¼šå…¨è¡¨æ‰«æï¼Œå¿…é¡»ä¼˜åŒ–ã€‚


keyï¼šå®žé™…ä½¿ç”¨çš„ç´¢å¼•ã€‚å¦‚æžœä¸ºNULLï¼Œè¯´æ˜Žæ²¡ç”¨åˆ°ç´¢å¼•ã€‚
rowsï¼šé¢„ä¼°éœ€è¦æ‰«æçš„è¡Œæ•°ã€‚å€¼è¶Šå°è¶Šå¥½ã€‚
Extraï¼šé¢å¤–ä¿¡æ¯ï¼Œéžå¸¸é‡è¦ï¼
Using filesortï¼šMySQLæ— æ³•åˆ©ç”¨ç´¢å¼•å®ŒæˆæŽ’åºï¼Œéœ€è¦é¢å¤–çš„æŽ’åºæ“ä½œã€‚éœ€è¦ä¼˜åŒ–ã€‚
Using temporaryï¼šä½¿ç”¨äº†ä¸´æ—¶è¡¨æ¥å¤„ç†æŸ¥è¯¢ï¼ˆå¸¸è§äºŽGROUP BYã€ORDER BYï¼‰ã€‚å¿…é¡»ä¼˜åŒ–ã€‚
Using indexï¼šä½¿ç”¨äº†è¦†ç›–ç´¢å¼•ï¼Œæ€§èƒ½æžä½³ã€‚



ä¼˜åŒ–å®žæˆ˜æ€è·¯ï¼š
ç”¨EXPLAINåˆ†æžï¼šæ‰¾åˆ°æ€§èƒ½ç“¶é¢ˆï¼ˆå…¨è¡¨æ‰«æï¼Ÿæ–‡ä»¶æŽ’åºï¼Ÿï¼‰ã€‚
æ£€æŸ¥ç´¢å¼•ï¼š
æŸ¥è¯¢æ¡ä»¶åˆ—æ˜¯å¦æœ‰ç´¢å¼•ï¼Ÿ
æ˜¯å¦è¿åäº†æœ€å·¦å‰ç¼€åŽŸåˆ™ï¼Ÿ
æ˜¯å¦å¯ä»¥è€ƒè™‘ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼Ÿ


ä¼˜åŒ–SQLå†™æ³•ï¼š
é¿å…ä½¿ç”¨SELECT *ï¼Œåªå–éœ€è¦çš„å­—æ®µã€‚
å°†å¤æ‚çš„æŸ¥è¯¢æ‹†åˆ†æˆå¤šä¸ªç®€å•æŸ¥è¯¢ï¼ˆMySQLå¯¹ç®€å•æŸ¥è¯¢æ”¯æŒæ›´å¥½ï¼‰ã€‚
ä¼˜åŒ–JOINï¼Œç¡®ä¿ONæ¡ä»¶çš„åˆ—æœ‰ç´¢å¼•ã€‚


** redesign è¡¨ç»“æž„**ï¼šå¦‚æžœå¿…è¦ï¼Œè€ƒè™‘åˆ†è¡¨ã€‚

redis1. Redis çº¿ç¨‹æ¨¡åž‹ (æ ¸å¿ƒä¸­çš„æ ¸å¿ƒ)åè¯ä¸Žå®šä¹‰
æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ï¼šRedisåŸºäºŽReactoræ¨¡å¼å¼€å‘çš„ç½‘ç»œäº‹ä»¶å¤„ç†å™¨ã€‚å®ƒæ˜¯ä¸€ä¸ªå•çº¿ç¨‹çš„ã€é«˜æ€§èƒ½çš„äº‹ä»¶å¾ªçŽ¯ï¼Œè´Ÿè´£å¤„ç†æ‰€æœ‰å®¢æˆ·ç«¯è¿žæŽ¥ã€å‘½ä»¤è¯·æ±‚å’Œå“åº”ã€‚
I&#x2F;Oå¤šè·¯å¤ç”¨ï¼šæ–‡ä»¶äº‹ä»¶å¤„ç†å™¨çš„æ ¸å¿ƒã€‚é€šè¿‡epollã€kqueueã€selectç­‰ç³»ç»Ÿè°ƒç”¨ï¼Œä¸€ä¸ªçº¿ç¨‹å¯ä»¥ç›‘å¬å’Œç®¡ç†æˆåƒä¸Šä¸‡ä¸ªç½‘ç»œè¿žæŽ¥ socket çš„å°±ç»ªçŠ¶æ€ï¼ˆå¯è¯»ã€å¯å†™ï¼‰ã€‚

é¢è¯•æ·±å…¥è¿½é—®ä¸Žè§£ç­”Qï¼šä¸ºä»€ä¹ˆRedisé€‰æ‹©å•çº¿ç¨‹æ¨¡åž‹ï¼Ÿè¿˜èƒ½è¿™ä¹ˆå¿«ï¼Ÿ

ç­”æ¡ˆï¼šå¿«çš„åŽŸå› å¹¶éžå› ä¸ºå•çº¿ç¨‹ï¼Œè€Œæ˜¯å› ä¸ºï¼š
çº¯å†…å­˜æ“ä½œï¼šæ•°æ®åœ¨å†…å­˜ä¸­ï¼Œè¯»å†™é€Ÿåº¦æžå¿«ã€‚
I&#x2F;Oå¤šè·¯å¤ç”¨ï¼šå•çº¿ç¨‹å¯ä»¥é«˜æ•ˆå¤„ç†å¤§é‡å¹¶å‘è¿žæŽ¥ï¼Œé¿å…äº†å¤šçº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œé”ç«žäº‰å¼€é”€ã€‚
é«˜æ•ˆçš„æ•°æ®ç»“æž„ï¼šå¦‚è·³è·ƒè¡¨ã€å“ˆå¸Œè¡¨ç­‰ï¼Œä¸ºä¸åŒåœºæ™¯åšäº†ä¼˜åŒ–ã€‚


ä¸ºä»€ä¹ˆç”¨å•çº¿ç¨‹ï¼Ÿï¼šé¿å…äº†å¤šçº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œç«žäº‰é”çš„æŸè€—ï¼Œä½¿å¾—æ¨¡åž‹éžå¸¸ç®€å•ã€å¯é¢„æµ‹ï¼Œä¸å­˜åœ¨å¹¶å‘è¯»å†™å¸¦æ¥çš„æ•°æ®ä¸€è‡´æ€§é—®é¢˜ã€‚

Qï¼šRedis 6.0ä¹‹åŽçš„å¤šçº¿ç¨‹æ˜¯æ€Žä¹ˆå›žäº‹ï¼Ÿ

ç­”æ¡ˆï¼šRedis 6.0å¼•å…¥çš„å¤šçº¿ç¨‹ä»…é™äºŽç½‘ç»œI&#x2F;Oå’Œå¤„ç†åè®®è§£æžï¼Œå‘½ä»¤çš„æ‰§è¡Œä¾ç„¶æ˜¯å•çº¿ç¨‹çš„ã€‚
å·¥ä½œåŽŸç†ï¼š
ä¸»çº¿ç¨‹ï¼ˆå•çº¿ç¨‹ï¼‰é€šè¿‡I&#x2F;Oå¤šè·¯å¤ç”¨æŽ¥æ”¶æ‰€æœ‰è¿žæŽ¥ï¼Œå¹¶å°†å°±ç»ªçš„Socketæ”¾å…¥ä¸€ä¸ªé˜Ÿåˆ—ã€‚
ä¸€ç»„I&#x2F;Oçº¿ç¨‹ï¼ˆå¯é…ç½®æ•°é‡ï¼‰å¹¶è¡Œåœ°ä»Žé˜Ÿåˆ—ä¸­èŽ·å–Socketï¼Œè¿›è¡Œè¯»å†™ç½‘ç»œæ•°æ®å’Œè§£æžå‘½ä»¤ï¼ˆread()å’Œparseï¼‰ã€‚
ä¸»çº¿ç¨‹ä¸²è¡Œåœ°æ‰§è¡Œæ‰€æœ‰è§£æžå¥½çš„å‘½ä»¤ã€‚
ä¸»çº¿ç¨‹å°†å‘½ä»¤ç»“æžœå†™å…¥ç¼“å†²åŒºã€‚
I&#x2F;Oçº¿ç¨‹å†æ¬¡å¹¶è¡Œåœ°å°†ç¼“å†²åŒºä¸­çš„ç»“æžœå†™å›žç½‘ç»œï¼ˆsend()ï¼‰å‘é€ç»™å®¢æˆ·ç«¯ã€‚


ç»“è®ºï¼šå¤šçº¿ç¨‹I&#x2F;Oåªæ˜¯ä¸ºäº†ç¼“è§£ç½‘ç»œè¯»å†™è¿™ä¸ªç“¶é¢ˆï¼Œæ ¸å¿ƒçš„å‘½ä»¤å¤„ç†é€»è¾‘ä»ç„¶æ˜¯å•çº¿ç¨‹çš„ï¼Œæ‰€ä»¥ä¸å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚


2. æ ¸å¿ƒæ•°æ®ç»“æž„ä¸Žä½¿ç”¨åœºæ™¯é¢è¯•å®˜ä¸ä¼šåªé—®ä½ 5ç§åŸºæœ¬ç±»åž‹ï¼Œä¼šé—®åº•å±‚å’Œåœºæ™¯ã€‚
| æ•°æ®ç±»åž‹ | åº•å±‚å®žçŽ°ï¼ˆå¯èƒ½ä¸æ­¢ä¸€ç§ï¼‰ | å…¸åž‹ä½¿ç”¨åœºæ™¯ || ï¼šâ€” | ï¼šâ€” | :â€” || String | SDS (Simple Dynamic String) | ç¼“å­˜ã€è®¡æ•°å™¨ã€åˆ†å¸ƒå¼é” (SETNX)ã€Session || List | åŽ‹ç¼©åˆ—è¡¨ (ziplist) &#x2F; åŒå‘é“¾è¡¨ (linkedlist) | æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆLPUSH+BRPOPï¼‰ã€æœ€æ–°åˆ—è¡¨ã€æŽ’è¡Œæ¦œ || Hash | åŽ‹ç¼©åˆ—è¡¨ (ziplist) &#x2F; å“ˆå¸Œè¡¨ (hashtable) | ç¼“å­˜å¯¹è±¡ï¼ˆç”¨æˆ·ä¿¡æ¯ã€å•†å“ä¿¡æ¯ï¼‰ã€å­˜å‚¨ç»“æž„åŒ–æ•°æ® || Set | æ•´æ•°é›†åˆ (intset) &#x2F; å“ˆå¸Œè¡¨ (hashtable) | å…±åŒå…³æ³¨ï¼ˆäº¤é›†ï¼‰ã€æŠ½å¥–ï¼ˆéšæœºå…ƒç´ ï¼‰ã€æ ‡ç­¾ç³»ç»Ÿ || ZSet | åŽ‹ç¼©åˆ—è¡¨ (ziplist) &#x2F; è·³è·ƒè¡¨ (skiplist) + å“ˆå¸Œè¡¨ | æŽ’è¡Œæ¦œã€å¸¦æƒé‡çš„æ¶ˆæ¯é˜Ÿåˆ—ã€å»¶è¿Ÿä»»åŠ¡ || HyperLogLog | - | å¤§æ•°æ®é‡çš„åŸºæ•°ç»Ÿè®¡ï¼ˆUVç»Ÿè®¡ï¼‰ï¼Œæœ‰è¯¯å·® || Bitmap | - | äºŒå€¼çŠ¶æ€ç»Ÿè®¡ï¼ˆç­¾åˆ°æ‰“å¡ã€ç”¨æˆ·æ˜¯å¦åœ¨çº¿ï¼‰ || GEO | åŸºäºŽZSetå®žçŽ° | åœ°ç†ä½ç½®ä¿¡æ¯ã€é™„è¿‘çš„äºº |
è¿½é—®ï¼šZSetä¸ºä»€ä¹ˆç”¨è·³è·ƒè¡¨è€Œä¸ç”¨çº¢é»‘æ ‘ï¼Ÿ

èŒƒå›´æŸ¥è¯¢æ•ˆçŽ‡ï¼šè·³è·ƒè¡¨åœ¨èŒƒå›´æŸ¥è¯¢ï¼ˆZRANGEï¼‰ä¸Šæ•ˆçŽ‡æžé«˜ï¼Œåªéœ€éåŽ†æœ€åº•å±‚çš„é“¾è¡¨ã€‚è€Œçº¢é»‘æ ‘è¿›è¡Œä¸­åºéåŽ†ç›¸å¯¹å¤æ‚ã€‚
å®žçŽ°å’Œç»´æŠ¤ç®€å•ï¼šè·³è·ƒè¡¨çš„å®žçŽ°å’Œè°ƒè¯•æ¯”çº¢é»‘æ ‘ç®€å•å¾—å¤šã€‚
å¹¶å‘å‹å¥½ï¼šè™½ç„¶Redisæ˜¯å•çº¿ç¨‹ç”¨ä¸åˆ°ï¼Œä½†è·³è·ƒè¡¨åœ¨å¹¶å‘çŽ¯å¢ƒä¸‹æ›´å®¹æ˜“æ‰©å±•ã€‚


3. ç¼“å­˜é—®é¢˜è§£å†³æ–¹æ¡ˆ (å¿…è€ƒ)ç¼“å­˜é›ªå´©
é—®é¢˜ï¼šå¤§é‡ç¼“å­˜æ•°æ®åœ¨åŒä¸€æ—¶é—´è¿‡æœŸæˆ–Rediså®žä¾‹å®•æœºï¼Œå¯¼è‡´æ‰€æœ‰è¯·æ±‚çž¬é—´æ‰“åˆ°æ•°æ®åº“ï¼Œé€ æˆæ•°æ®åº“åŽ‹åŠ›è¿‡å¤§ç”šè‡³å®•æœºã€‚
è§£å†³æ–¹æ¡ˆï¼š
è¿‡æœŸæ—¶é—´éšæœºï¼šç»™ç¼“å­˜æ•°æ®çš„TTLåŠ ä¸Šä¸€ä¸ªéšæœºå€¼ï¼Œé¿å…åŒæ—¶è¿‡æœŸã€‚
é›†ç¾¤é«˜å¯ç”¨ï¼šæ­å»ºRedisé›†ç¾¤ï¼ˆå“¨å…µæˆ–Clusteræ¨¡å¼ï¼‰ï¼Œå®žçŽ°æ•…éšœè‡ªåŠ¨è½¬ç§»ï¼Œé¿å…æ•´ä½“å®•æœºã€‚
æœåŠ¡é™çº§ä¸Žç†”æ–­ï¼šä½¿ç”¨Hystrixæˆ–Sentinelï¼Œå½“æ•°æ®åº“åŽ‹åŠ›è¿‡å¤§æ—¶ï¼Œå¯¹éžæ ¸å¿ƒä¸šåŠ¡è¿›è¡Œé™çº§ï¼Œç”šè‡³ç›´æŽ¥è¿”å›žé¢„å®šä¹‰ä¿¡æ¯ï¼ˆç†”æ–­ï¼‰ã€‚
ç¼“å­˜æ°¸ä¸è¿‡æœŸï¼šåŽå°å®šæ—¶ä»»åŠ¡ä¸»åŠ¨æ›´æ–°ç¼“å­˜ã€‚



ç¼“å­˜ç©¿é€
é—®é¢˜ï¼šæŸ¥è¯¢ä¸€ä¸ªæ•°æ®åº“ä¸­è‚¯å®šä¸å­˜åœ¨çš„æ•°æ®ï¼ˆå¦‚idä¸ºè´Ÿæ•°çš„å•†å“ï¼‰ã€‚å¯¼è‡´æ¯æ¬¡è¯·æ±‚éƒ½æ— æ³•å‘½ä¸­ç¼“å­˜ï¼Œç›´æŽ¥ç©¿é€åˆ°æ•°æ®åº“ã€‚
è§£å†³æ–¹æ¡ˆï¼š
ç¼“å­˜ç©ºå¯¹è±¡ï¼šå³ä½¿ä»Žæ•°æ®åº“æ²¡æŸ¥åˆ°ï¼Œä¹Ÿå°†è¿™ä¸ªnullæˆ–ç©ºå€¼ç¼“å­˜èµ·æ¥ï¼Œå¹¶è®¾ç½®ä¸€ä¸ªè¾ƒçŸ­çš„è¿‡æœŸæ—¶é—´ã€‚ç¼ºç‚¹ï¼šå¯èƒ½ç¼“å­˜å¤§é‡æ— ç”¨çš„keyã€‚
å¸ƒéš†è¿‡æ»¤å™¨ (Bloom Filter)ï¼šæœ€ä¼˜è§£ã€‚å°†æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„keyå“ˆå¸Œåˆ°ä¸€ä¸ªå·¨å¤§çš„bitmapä¸­ã€‚è¯·æ±‚æ¥æ—¶ï¼Œå…ˆç»è¿‡å¸ƒéš†è¿‡æ»¤å™¨ï¼š
å¦‚æžœåˆ¤æ–­ä¸å­˜åœ¨ï¼Œåˆ™ç›´æŽ¥è¿”å›žã€‚
å¦‚æžœåˆ¤æ–­å­˜åœ¨ï¼Œåˆ™ç»§ç»­åŽç»­çš„ç¼“å­˜ã€æ•°æ®åº“æµç¨‹ã€‚
ä¼˜ç‚¹ï¼šç©ºé—´æ•ˆçŽ‡æžé«˜ã€‚
ç¼ºç‚¹ï¼šæœ‰è¯¯åˆ¤çŽ‡ï¼ˆå¯èƒ½å­˜åœ¨åˆ¤æ–­ä¸ºå­˜åœ¨ï¼Œä½†å®žé™…ä¸å­˜åœ¨ï¼Œä½†è¿™ä¸ªé—®é¢˜å½±å“ä¸å¤§ï¼‰ï¼Œä¸”æ•°æ®åˆ é™¤å›°éš¾ã€‚





ç¼“å­˜å‡»ç©¿
é—®é¢˜ï¼šä¸€ä¸ªçƒ­ç‚¹keyåœ¨è¿‡æœŸçž¬é—´ï¼Œå¤§é‡å¹¶å‘è¯·æ±‚è¿™ä¸ªkeyï¼Œå…¨éƒ¨ç©¿é€åˆ°æ•°æ®åº“ï¼Œåƒä¸€ä¸ªâ€œå­å¼¹â€å‡»ç©¿äº†ç¼“å­˜ã€‚
è§£å†³æ–¹æ¡ˆï¼š
äº’æ–¥é” (Mutex Lock)ï¼šç¬¬ä¸€ä¸ªè¯·æ±‚å‘çŽ°ç¼“å­˜å¤±æ•ˆåŽï¼ŒåŽ»æŸ¥è¯¢æ•°æ®åº“å‰ï¼Œå…ˆä½¿ç”¨SETNXæˆ–Redissonç­‰å·¥å…·èŽ·å–ä¸€ä¸ªåˆ†å¸ƒå¼é”ã€‚å…¶ä»–è¯·æ±‚èŽ·å–é”å¤±è´¥åˆ™ç­‰å¾…æˆ–è¿”å›žé»˜è®¤å€¼ï¼Œå¾…ç¬¬ä¸€ä¸ªè¯·æ±‚é‡å»ºç¼“å­˜åŽï¼ŒåŽç»­è¯·æ±‚å†ä»Žç¼“å­˜è¯»å–ã€‚
é€»è¾‘è¿‡æœŸ&#x2F;æ°¸ä¸è¿‡æœŸï¼šç¼“å­˜å€¼ä¸è®¾ç½®TTLï¼Œè€Œæ˜¯åœ¨valueä¸­å°è£…ä¸€ä¸ªé€»è¾‘è¿‡æœŸæ—¶é—´ã€‚ä¸šåŠ¡çº¿ç¨‹å‘çŽ°é€»è¾‘æ—¶é—´è¿‡æœŸåŽï¼ŒèŽ·å–äº’æ–¥é”ï¼Œç„¶åŽå¯åŠ¨ä¸€ä¸ªæ–°çº¿ç¨‹åŽ»å¼‚æ­¥æ›´æ–°ç¼“å­˜ï¼Œè‡ªå·±å…ˆè¿”å›žæ—§çš„ç¼“å­˜æ•°æ®ã€‚



åŒå†™ä¸€è‡´æ€§
é—®é¢˜ï¼šå¦‚ä½•ä¿è¯ç¼“å­˜ä¸­çš„æ•°æ®ä¸Žæ•°æ®åº“ä¸­çš„æ•°æ®ä¸€è‡´ï¼Ÿ
è§£å†³æ–¹æ¡ˆï¼šæ²¡æœ‰é“¶å¼¹ï¼Œæ ¹æ®ä¸šåŠ¡å¯¹ä¸€è‡´æ€§çš„è¦æ±‚é€‰æ‹©ç­–ç•¥ã€‚
æœ€ç»ˆä¸€è‡´æ€§ï¼ˆå¸¸ç”¨ï¼‰ï¼š
å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜ï¼šè¿™æ˜¯æœ€æŽ¨èçš„æ¨¡å¼ã€‚å³ä½¿ç¬¬äºŒæ­¥åˆ é™¤ç¼“å­˜å¤±è´¥ï¼Œä¹Ÿåªä¼šé€ æˆä¸€æ¬¡æ—§æ•°æ®è„è¯»ï¼Œä¸‹æ¬¡è¯»å–æ—¶å°±ä¼šæ›´æ–°ã€‚å¯ä»¥é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—é‡è¯•æœºåˆ¶æ¥ä¿è¯åˆ é™¤æˆåŠŸã€‚
å»¶è¿ŸåŒåˆ ï¼šå…ˆåˆ ç¼“å­˜ -&gt; å†æ›´æ–°æ•°æ®åº“ -&gt; å»¶è¿Ÿå‡ ç™¾æ¯«ç§’å†åˆ ä¸€æ¬¡ç¼“å­˜ã€‚ç›®çš„æ˜¯ä¸ºäº†æ¸…é™¤åœ¨â€œæ›´æ–°æ•°æ®åº“â€æœŸé—´å…¶ä»–è¯·æ±‚å¯èƒ½å†™å…¥çš„æ—§ç¼“å­˜ã€‚


å¼ºä¸€è‡´æ€§ï¼šå‡ ä¹Žæ— æ³•å®žçŽ°ï¼Œä¸”æ€§èƒ½ä»£ä»·æžå¤§ã€‚å¯ä»¥é€šè¿‡Redissonçš„è¯»å†™é”æˆ–Canelç›‘å¬æ•°æ®åº“binlogæ¥å¼‚æ­¥æ·˜æ±°ç¼“å­˜ï¼Œä½†å»¶è¿Ÿä¸å¯é¿å…ã€‚




4. æŒä¹…åŒ–ç­–ç•¥| | RDB (Redis Database) | AOF (Append Only File) || ï¼šâ€” | :â€” | :â€” || åŽŸç† | å®šæ—¶forkå­è¿›ç¨‹ï¼Œç”Ÿæˆå†…å­˜å¿«ç…§ | è®°å½•æ¯ä¸€æ¬¡å†™æ“ä½œå‘½ä»¤åˆ°æ—¥å¿—æ–‡ä»¶ || ä¼˜ç‚¹ | æ–‡ä»¶å°ï¼Œæ¢å¤é€Ÿåº¦å¿«ï¼Œé€‚åˆå†·å¤‡ | æ•°æ®å®‰å…¨æ€§é«˜ï¼Œæœ€å¤šä¸¢å¤±1ç§’æ•°æ® || ç¼ºç‚¹ | å¯èƒ½ä¸¢å¤±ä¸Šæ¬¡å¿«ç…§åŽçš„æ•°æ® | æ–‡ä»¶å¤§ï¼Œæ¢å¤é€Ÿåº¦æ…¢ï¼Œå†™å…¥æ€§èƒ½æœ‰å½±å“ || é…ç½® | save 900 1 (900ç§’å†…1æ¬¡ä¿®æ”¹åˆ™è§¦å‘) | appendfsync always/everysec/no || æœ€ä½³å®žè·µ | æ··åˆæŒä¹…åŒ– (AOF + RDB)ï¼šaof-use-rdb-preamble yesã€‚é‡å†™åŽçš„AOFæ–‡ä»¶å‰åŠéƒ¨åˆ†æ˜¯RDBæ ¼å¼çš„å¿«ç…§ï¼ŒåŽåŠéƒ¨åˆ†æ˜¯å¢žé‡çš„AOFæ—¥å¿—ã€‚å…¼é¡¾äº†é€Ÿåº¦å’Œæ•°æ®å®‰å…¨æ€§ã€‚ |

5. åˆ†å¸ƒå¼é” &amp; åˆ†ç‰‡é›†ç¾¤Qï¼šå¦‚ä½•ç”¨Rediså®žçŽ°ä¸€ä¸ªå¯é çš„åˆ†å¸ƒå¼é”ï¼Ÿ

åŠ é”ï¼šSET lock_key random_value NX PX 30000

NXï¼šä»…å½“keyä¸å­˜åœ¨æ—¶æ‰èƒ½è®¾ç½®æˆåŠŸã€‚
PXï¼šè®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œé˜²æ­¢å®¢æˆ·ç«¯å®•æœºå¯¼è‡´é”æ— æ³•é‡Šæ”¾ã€‚
random_valueï¼ˆå”¯ä¸€å€¼ï¼‰ï¼šé˜²æ­¢è¯¯åˆ ã€‚åªèƒ½ç”±åŠ é”çš„å®¢æˆ·ç«¯æ¥è§£é”ã€‚


è§£é”ï¼šä½¿ç”¨Luaè„šæœ¬ä¿è¯åŽŸå­æ€§ã€‚
lua
if redis.call(&quot;get&quot;, KEYS[1]) == ARGV[1] then    return redis.call(&quot;del&quot;, KEYS[1])else    return 0end

è¿½é—®ï¼šRedLockç®—æ³•äº†è§£å—ï¼Ÿç”¨äºŽåœ¨å¤šä¸ªç‹¬ç«‹çš„Redisä¸»èŠ‚ç‚¹ä¸Šå®žçŽ°æ›´é«˜å¯é çš„åˆ†å¸ƒå¼é”ã€‚æµç¨‹æ˜¯å‘è¶…è¿‡åŠæ•°çš„èŠ‚ç‚¹ç”³è¯·é”ï¼Œå…¨éƒ¨æˆåŠŸæ‰ç®—åŠ é”æˆåŠŸã€‚äº‰è®®è¾ƒå¤§ï¼Œä¸€èˆ¬ä¸æŽ¨èä½¿ç”¨ï¼Œä¼˜å…ˆè€ƒè™‘ä½¿ç”¨ZooKeeperæˆ–etcdå®žçŽ°åˆ†å¸ƒå¼é”ã€‚
Qï¼šä½ æ­å»ºçš„Redisåˆ†ç‰‡é›†ç¾¤ï¼ˆClusterï¼‰æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ

æ•°æ®åˆ†ç‰‡ï¼šé‡‡ç”¨å“ˆå¸Œæ§½ï¼ˆSlotï¼‰ï¼Œå…±16384ä¸ªæ§½ã€‚æ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£ä¸€éƒ¨åˆ†æ§½ã€‚keyé€šè¿‡CRC16(key) % 16384è®¡ç®—å±žäºŽå“ªä¸ªæ§½ã€‚
è¯·æ±‚è·¯ç”±ï¼š
å®¢æˆ·ç«¯ç›´è¿žä»»æ„èŠ‚ç‚¹ï¼Œå¦‚æžœkeyä¸åœ¨è¯¥èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹è¿”å›žMOVEDé”™è¯¯å’Œæ­£ç¡®èŠ‚ç‚¹åœ°å€ï¼Œå®¢æˆ·ç«¯é‡å®šå‘è®¿é—®ã€‚
ä½¿ç”¨æ™ºèƒ½å®¢æˆ·ç«¯ï¼ˆå¦‚Lettuceï¼‰æˆ–ä»£ç†ä¸­é—´ä»¶ï¼ˆå¦‚Codisï¼‰å¯ä»¥ç¼“å­˜æ§½ä½æ˜ å°„ï¼Œç›´æŽ¥è·¯ç”±åˆ°æ­£ç¡®èŠ‚ç‚¹ã€‚


æ‰©å®¹ä¸Žé‡æ–°åˆ†ç‰‡ï¼š
ä½¿ç”¨redis-cli --cluster add-nodeæ·»åŠ æ–°èŠ‚ç‚¹ã€‚
ä½¿ç”¨redis-cli --cluster reshardå‘½ä»¤ï¼Œå°†ä¸€éƒ¨åˆ†å“ˆå¸Œæ§½ä»ŽçŽ°æœ‰èŠ‚ç‚¹åœ¨çº¿è¿ç§»åˆ°æ–°èŠ‚ç‚¹ã€‚è¿ç§»è¿‡ç¨‹ä¸­ï¼Œå®¢æˆ·ç«¯è¯·æ±‚æ— éœ€åœæœºã€‚



Qï¼šé›†ç¾¤çš„é«˜å¯ç”¨å¦‚ä½•ä¿è¯ï¼ŸRedis Clusteræœ¬èº«é€šè¿‡ä¸»ä»Žå¤åˆ¶å®žçŽ°é«˜å¯ç”¨ã€‚æ¯ä¸ªä¸»èŠ‚ç‚¹éƒ½æœ‰1ä¸ªæˆ–å¤šä¸ªä»ŽèŠ‚ç‚¹ã€‚å½“ä¸»èŠ‚ç‚¹å®•æœºï¼Œå…¶ä»ŽèŠ‚ç‚¹ä¼šé€šè¿‡é€‰ä¸¾æ™‹å‡ä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ï¼Œç»§ç»­æä¾›æœåŠ¡ã€‚
å¹¶å‘ç¼–ç¨‹1. Java å†…å­˜æ¨¡åž‹ (JMM) - ç†è®ºåŸºç¡€è¿™æ˜¯ç†è§£æ‰€æœ‰å¹¶å‘é—®é¢˜çš„åŸºçŸ³ã€‚

æ ¸å¿ƒé—®é¢˜ï¼šåœ¨å¤šçº¿ç¨‹çŽ¯å¢ƒä¸‹ï¼Œçº¿ç¨‹ä¹‹é—´å¦‚ä½•â€œçœ‹åˆ°â€å…±äº«å˜é‡çš„å€¼ï¼Ÿä¸ºä»€ä¹ˆæœ‰æ—¶çº¿ç¨‹Aä¿®æ”¹äº†å˜é‡ï¼Œçº¿ç¨‹Bå´çœ‹ä¸åˆ°ï¼Ÿ
JMMå®šä¹‰ï¼šJMMæ˜¯ä¸€ç§è§„èŒƒï¼Œè§„å®šäº†çº¿ç¨‹å¦‚ä½•ä¸Žä¸»å†…å­˜ï¼ˆå…±äº«å†…å­˜ï¼‰å’Œå·¥ä½œå†…å­˜ï¼ˆçº¿ç¨‹ç§æœ‰ï¼Œå¯ç±»æ¯”CPUç¼“å­˜ï¼‰äº¤äº’ï¼Œä»¥åŠä½•æ—¶å°†å·¥ä½œå†…å­˜ä¸­çš„å€¼åˆ·æ–°åˆ°ä¸»å†…å­˜ã€‚
ä¸‰å¤§ç‰¹æ€§ï¼š
åŽŸå­æ€§ï¼šåŸºæœ¬æ•°æ®ç±»åž‹çš„è®¿é—®è¯»å†™æ˜¯åŽŸå­æ€§çš„ï¼ˆlongå’ŒdoubleéžåŽŸå­æ€§ï¼Œä½†å•†ç”¨è™šæ‹Ÿæœºéƒ½å®žçŽ°äº†åŽŸå­æ€§ï¼‰ã€‚synchronizedå’ŒLockå¯ä»¥ä¿è¯æ›´å¤§èŒƒå›´çš„åŽŸå­æ€§ã€‚
å¯è§æ€§ï¼šä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†å…±äº«å˜é‡ï¼Œå…¶ä»–çº¿ç¨‹èƒ½ç«‹å³çœ‹åˆ°ä¿®æ”¹åŽçš„å€¼ã€‚
æœ‰åºæ€§ï¼šç¨‹åºæ‰§è¡Œçš„é¡ºåºä¸ä¸€å®šå°±æ˜¯ä»£ç ç¼–å†™çš„é¡ºåºã€‚ä¸ºäº†æé«˜æ€§èƒ½ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¼šåšæŒ‡ä»¤é‡æŽ’åºã€‚å•çº¿ç¨‹ä¸‹æ²¡é—®é¢˜ï¼Œä½†å¤šçº¿ç¨‹ä¸‹å¯èƒ½å¯¼è‡´è¯¡å¼‚é—®é¢˜ã€‚



é¢è¯•è¿½é—®ï¼šä»€ä¹ˆæ˜¯happens-beforeåŽŸåˆ™ï¼Ÿå®ƒæ˜¯JMMä¸­å®šä¹‰çš„ä¸¤ä¸ªæ“ä½œä¹‹é—´çš„ååºå…³ç³»ï¼Œç”¨æ¥åˆ¤æ–­æ•°æ®æ˜¯å¦å­˜åœ¨ç«žäº‰ã€çº¿ç¨‹æ˜¯å¦å®‰å…¨ã€‚å¦‚æžœæ“ä½œA happens-before æ“ä½œBï¼Œé‚£ä¹ˆAçš„ç»“æžœå¯¹Bå¯è§ã€‚å¸¸è§çš„happens-beforeè§„åˆ™åŒ…æ‹¬ï¼š

ç¨‹åºæ¬¡åºè§„åˆ™ï¼šä¸€ä¸ªçº¿ç¨‹å†…ï¼Œå‰é¢çš„æ“ä½œhappens-beforeäºŽåŽé¢çš„æ“ä½œã€‚
ç›‘è§†å™¨é”è§„åˆ™ï¼šå¯¹ä¸€ä¸ªé”çš„è§£é”happens-beforeäºŽéšåŽå¯¹è¿™ä¸ªé”çš„åŠ é”ã€‚
volatileå˜é‡è§„åˆ™ï¼šå¯¹ä¸€ä¸ªvolatileåŸŸçš„å†™happens-beforeäºŽä»»æ„åŽç»­å¯¹è¿™ä¸ªvolatileåŸŸçš„è¯»ã€‚
ä¼ é€’æ€§ï¼šå¦‚æžœA hb B, B hb Cï¼Œé‚£ä¹ˆA hb Cã€‚


2. synchronized å…³é”®å­—åŽŸç†
ä½œç”¨ï¼šæä¾›äº†ä¸€ç§ç‹¬å çš„åŠ é”æ–¹å¼ï¼Œä¿è¯äº†åŽŸå­æ€§ã€å¯è§æ€§å’Œæœ‰åºæ€§ã€‚
å®žçŽ°ï¼šJVMåŸºäºŽMonitorï¼ˆç®¡ç¨‹ï¼‰ å®žçŽ°ã€‚æ¯ä¸ªJavaå¯¹è±¡éƒ½å¯ä»¥å…³è”ä¸€ä¸ªMonitorã€‚
ä»£ç åŒæ­¥å—ç¼–è¯‘åŽï¼Œä¼šç”Ÿæˆmonitorenterå’ŒmonitorexitæŒ‡ä»¤ã€‚
åŒæ­¥æ–¹æ³•ä¼šè¢«æ ‡è®°ACC_SYNCHRONIZEDè®¿é—®æ ‡å¿—ã€‚



é”å‡çº§è¿‡ç¨‹ (éžå¸¸é‡è¦ï¼)ä¸ºäº†æé«˜æ€§èƒ½ï¼Œsynchronizedçš„é”çŠ¶æ€ä¼šéšç€ç«žäº‰æƒ…å†µå‡çº§ï¼Œæ–¹å‘ä¸å¯é€†ï¼š

æ— é” (New)ï¼šæ–°åˆ›å»ºçš„å¯¹è±¡ã€‚
åå‘é” (Biased Locking)ï¼šé€‚ç”¨äºŽåªæœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®åŒæ­¥å—ã€‚çº¿ç¨‹ç¬¬ä¸€æ¬¡èŽ·å¾—é”æ—¶ï¼Œä¼šåœ¨å¯¹è±¡å¤´å’Œæ ˆå¸§ä¸­è®°å½•åå‘çš„çº¿ç¨‹IDã€‚ä»¥åŽè¯¥çº¿ç¨‹è¿›å…¥å’Œé€€å‡ºåŒæ­¥å—æ—¶ï¼Œä¸éœ€è¦è¿›è¡ŒCASåŠ é”å’Œè§£é”ï¼Œæ€§èƒ½æžé«˜ã€‚
è½»é‡çº§é” (Lightweight Lock)ï¼šé€‚ç”¨äºŽçº¿ç¨‹äº¤æ›¿æ‰§è¡Œï¼Œç«žäº‰ä¸æ¿€çƒˆã€‚å½“æœ‰å¦ä¸€ä¸ªçº¿ç¨‹æ¥ç«žäº‰é”æ—¶ï¼Œåå‘é”ä¼šå‡çº§ä¸ºè½»é‡çº§é”ã€‚è¯¥çº¿ç¨‹ä¼šåœ¨è‡ªå·±çš„æ ˆå¸§ä¸­åˆ›å»ºé”è®°å½•ï¼ˆLock Recordï¼‰ï¼Œé€šè¿‡CASæ“ä½œå°è¯•å°†å¯¹è±¡å¤´çš„Mark Wordæ›¿æ¢ä¸ºæŒ‡å‘é”è®°å½•çš„æŒ‡é’ˆã€‚å¦‚æžœæˆåŠŸï¼Œå½“å‰çº¿ç¨‹èŽ·å¾—é”ï¼›å¦‚æžœå¤±è´¥ï¼Œè¡¨ç¤ºæœ‰å…¶ä»–çº¿ç¨‹ç«žäº‰ï¼Œä¼šè‡ªæ—‹å°è¯•èŽ·å–é”ã€‚
é‡é‡çº§é” (Heavyweight Lock)ï¼šé€‚ç”¨äºŽç«žäº‰æ¿€çƒˆã€‚å¦‚æžœè‡ªæ—‹å¤±è´¥ï¼ˆæˆ–è‡ªæ—‹è¶…è¿‡ä¸€å®šæ¬¡æ•°ï¼‰ï¼Œé”ä¼šå‡çº§ä¸ºé‡é‡çº§é”ã€‚æ­¤æ—¶ï¼Œå…¶ä»–å°è¯•èŽ·å–é”çš„çº¿ç¨‹éƒ½ä¼šè¿›å…¥é˜»å¡žçŠ¶æ€ï¼ˆBLOCKEDï¼‰ï¼Œç­‰å¾…æ“ä½œç³»ç»Ÿçš„è°ƒåº¦ï¼Œéœ€è¦è¿›è¡Œç”¨æˆ·æ€åˆ°å†…æ ¸æ€çš„åˆ‡æ¢ï¼Œå¼€é”€å·¨å¤§ã€‚

é¢è¯•è¿½é—®ï¼šä¸ºä»€ä¹ˆå¼•å…¥é”å‡çº§ï¼Ÿä¸ºäº†é¿å…åœ¨æ— ç«žäº‰æˆ–ä½Žç«žäº‰æƒ…å†µä¸‹ï¼Œç›´æŽ¥ä½¿ç”¨é‡é‡çº§é”å¸¦æ¥çš„æ€§èƒ½å¼€é”€ï¼ˆç”¨æˆ·æ€åˆ°å†…æ ¸æ€çš„åˆ‡æ¢ï¼‰ã€‚é€šè¿‡åå‘é”å’Œè½»é‡çº§é”è¿™ä¸¤ç§ä¹è§‚ç­–ç•¥æ¥ä¼˜åŒ–æ€§èƒ½ã€‚

3. ReentrantLock (å¯é‡å…¥é”)ä¸Žsynchronizedå¯¹æ¯”| ç‰¹æ€§ | synchronized (éšå¼é”) | ReentrantLock (æ˜¾å¼é”) || ï¼šâ€” | :â€” | :â€” || å®žçŽ° | JVMå±‚é¢ï¼Œå…³é”®å­— | JDKå±‚é¢ï¼ŒAPI || é”èŽ·å– | è‡ªåŠ¨åŠ é”ä¸Žé‡Šæ”¾ | å¿…é¡»æ‰‹åŠ¨lock()å’Œunlock()ï¼Œé€šå¸¸åœ¨finallyä¸­é‡Šæ”¾ || çµæ´»æ€§ | è¾ƒå·® | å¾ˆå¼ºï¼Œå¯å°è¯•éžé˜»å¡žèŽ·å–(tryLock)ã€å¯ä¸­æ–­(lockInterruptibly)ã€è¶…æ—¶èŽ·å– || å…¬å¹³æ€§ | éžå…¬å¹³ | å¯é€‰å…¬å¹³æˆ–éžå…¬å¹³ï¼ˆæž„é€ æ–¹æ³•ä¼ å…¥trueï¼‰ || ** Condition ** | åªèƒ½æœ‰ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ— | å¯ä»¥ç»‘å®šå¤šä¸ªConditionï¼Œå®žçŽ°æ›´ç²¾ç»†çš„çº¿ç¨‹ç­‰å¾…&#x2F;å”¤é†’ |
æ ¸å¿ƒåŽŸç†ï¼šAQS (AbstractQueuedSynchronizer)è¿™æ˜¯JUCå¹¶å‘åŒ…çš„çµé­‚ï¼Œå¿…é¡»ç†è§£ã€‚

æ˜¯ä»€ä¹ˆï¼šä¸€ä¸ªç”¨äºŽæž„å»ºé”å’ŒåŒæ­¥å™¨çš„æ¡†æž¶ã€‚ReentrantLockã€Semaphoreã€CountDownLatchç­‰éƒ½æ˜¯åŸºäºŽAQSæž„å»ºçš„ã€‚
æ ¸å¿ƒæ€æƒ³ï¼š
å®ƒç»´æŠ¤äº†ä¸€ä¸ªvolatile int stateï¼ˆä»£è¡¨å…±äº«èµ„æºçŠ¶æ€ï¼‰å’Œä¸€ä¸ªFIFOçº¿ç¨‹ç­‰å¾…é˜Ÿåˆ—ï¼ˆCLHå˜ä½“ï¼‰ã€‚
stateï¼šå¯¹äºŽReentrantLockï¼Œstate=0è¡¨ç¤ºé”ç©ºé—²ï¼Œstate&gt;0è¡¨ç¤ºé”è¢«å ç”¨ï¼Œä¸”æ•°å€¼è¡¨ç¤ºé‡å…¥æ¬¡æ•°ã€‚
ç­‰å¾…é˜Ÿåˆ—ï¼šèŽ·å–èµ„æºå¤±è´¥çš„çº¿ç¨‹ä¼šè¢«å°è£…æˆNodeèŠ‚ç‚¹å…¥é˜Ÿã€‚


å·¥ä½œæµç¨‹ (ä»¥éžå…¬å¹³é”ä¸ºä¾‹)ï¼š
çº¿ç¨‹Aè°ƒç”¨lock()ï¼Œå°è¯•ç”¨CASå°†stateä»Ž0æ”¹ä¸º1ï¼ŒæˆåŠŸåˆ™èŽ·å–é”ï¼Œå¹¶è®¾ç½®ç‹¬å çº¿ç¨‹ä¸ºAã€‚
çº¿ç¨‹Bä¹Ÿæ¥å°è¯•CASï¼Œå¤±è´¥ã€‚åˆ™è°ƒç”¨AQSçš„acquireæ–¹æ³•ã€‚
acquireä¼šå†æ¬¡å°è¯•èŽ·å–ï¼ˆtryAcquireï¼‰ï¼Œå¤±è´¥åŽï¼Œå°†çº¿ç¨‹BåŒ…è£…æˆNodeèŠ‚ç‚¹ï¼ŒCASåœ°åŠ å…¥ç­‰å¾…é˜Ÿåˆ—å°¾éƒ¨ï¼Œç„¶åŽçº¿ç¨‹Bä¼š** parkï¼ˆé˜»å¡žï¼‰**ã€‚
çº¿ç¨‹Aæ‰§è¡Œå®Œunlock()ï¼Œå°†stateå‡1ã€‚ç„¶åŽåŽ»å”¤é†’ï¼ˆunparkï¼‰é˜Ÿåˆ—ä¸­çš„å¤´èŠ‚ç‚¹çš„åŽç»§èŠ‚ç‚¹ï¼ˆçº¿ç¨‹Bï¼‰ã€‚
çº¿ç¨‹Bè¢«å”¤é†’ï¼Œå†æ¬¡å°è¯•èŽ·å–é”ï¼ˆCASä¿®æ”¹stateï¼‰ã€‚



é¢è¯•è¿½é—®ï¼šå…¬å¹³é”å’Œéžå…¬å¹³é”çš„å®žçŽ°åŒºåˆ«ï¼Ÿ

éžå…¬å¹³é”ï¼šçº¿ç¨‹èŽ·å–é”æ—¶ï¼Œç›´æŽ¥å…ˆå°è¯•CASæŠ¢é”ï¼Œä¸ç®¡é˜Ÿåˆ—é‡Œæœ‰æ²¡æœ‰çº¿ç¨‹åœ¨ç­‰ã€‚æŠ¢å¤±è´¥äº†æ‰å…¥é˜Ÿã€‚ReentrantLocké»˜è®¤æ˜¯éžå…¬å¹³çš„ï¼Œåžåé‡é«˜ï¼Œä½†å¯èƒ½é€ æˆâ€œé¥¥é¥¿â€ã€‚
å…¬å¹³é”ï¼šçº¿ç¨‹èŽ·å–é”æ—¶ï¼Œå…ˆæ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼ˆæˆ–æœ‰æ¯”è‡ªå·±æ›´æ—©çš„çº¿ç¨‹åœ¨ç­‰ï¼‰ï¼Œå¦‚æžœæ˜¯ï¼Œåˆ™ç›´æŽ¥ä¹–ä¹–å…¥é˜Ÿï¼›å¦‚æžœä¸æ˜¯ï¼Œæ‰å°è¯•CASæŠ¢é”ã€‚


4. volatile å…³é”®å­—
ä½œç”¨ï¼š
ä¿è¯å¯è§æ€§ï¼šå¯¹ä¸€ä¸ªvolatileå˜é‡çš„å†™ï¼Œä¼šç«‹åˆ»åˆ·æ–°åˆ°ä¸»å†…å­˜ï¼›å¯¹ä¸€ä¸ªvolatileå˜é‡çš„è¯»ï¼Œä¼šä»Žä¸»å†…å­˜è¯»å–æœ€æ–°å€¼ã€‚
ç¦æ­¢æŒ‡ä»¤é‡æŽ’åºï¼šé€šè¿‡æ’å…¥å†…å­˜å±éšœæ¥å®žçŽ°ã€‚


åŽŸç†ï¼šåœ¨æ±‡ç¼–å±‚é¢ï¼Œä¿®æ”¹volatileå˜é‡ä¼šå¤šæ‰§è¡Œä¸€ä¸ªlock addl $0x0, (%esp)æ“ä½œã€‚è¿™ä¸ªæ“ä½œç›¸å½“äºŽä¸€ä¸ªå†…å­˜å±éšœï¼Œå¹¶ä¼šè§¦å‘ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼ˆå¦‚MESIï¼‰ï¼Œä½¿å¾—å…¶ä»–CPUçš„ç¼“å­˜è¡Œå¤±æ•ˆï¼Œä»Žè€Œå¿…é¡»ä»Žä¸»å†…å­˜é‡æ–°è¯»å–æ•°æ®ã€‚
æ³¨æ„ï¼švolatileä¸ä¿è¯åŽŸå­æ€§ï¼count++è¿™ç§å¤åˆæ“ä½œå³ä½¿åŠ äº†volatileä¹Ÿä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚


5. ThreadLocal
æ˜¯ä»€ä¹ˆï¼šæä¾›çº¿ç¨‹å±€éƒ¨å˜é‡ã€‚æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªè¯¥å˜é‡çš„ç‹¬ç«‹å‰¯æœ¬ï¼Œå®žçŽ°äº†çº¿ç¨‹éš”ç¦»ã€‚
åŽŸç†ï¼š
æ¯ä¸ªThreadå¯¹è±¡å†…éƒ¨éƒ½æœ‰ä¸€ä¸ªThreadLocalMapç±»åž‹çš„å˜é‡threadLocalsã€‚
ThreadLocalMapçš„keyæ˜¯å¼±å¼•ç”¨çš„ThreadLocalå¯¹è±¡ï¼Œvalueæ˜¯å­˜å‚¨çš„å€¼ã€‚
å½“ä½ è°ƒç”¨threadLocal.set(value)æ—¶ï¼Œå®žé™…ä¸Šæ˜¯ä»¥å½“å‰ThreadLocalå®žä¾‹ä¸ºkeyï¼Œvalueä¸ºå€¼ï¼Œå­˜å…¥äº†å½“å‰çº¿ç¨‹çš„ThreadLocalMapä¸­ã€‚


å†…å­˜æ³„æ¼é—®é¢˜ (å¿…é—®ï¼)ï¼š
æˆå› ï¼šç”±äºŽThreadLocalMapçš„keyæ˜¯å¼±å¼•ç”¨ï¼Œå½“ThreadLocalå®žä¾‹æ²¡æœ‰å¼ºå¼•ç”¨æŒ‡å‘æ—¶ï¼ˆæ¯”å¦‚ç½®ä¸ºnullï¼‰ï¼Œåœ¨ä¸‹æ¬¡GCæ—¶ï¼Œkeyä¼šè¢«å›žæ”¶ï¼Œä½†valueæ˜¯å¼ºå¼•ç”¨ï¼Œè¿˜ä¼šå­˜åœ¨ã€‚è¿™å°±å¯¼è‡´äº†ä¸€æ¡key=nullè€Œvalueæœ‰å€¼çš„æ— æ•ˆEntryï¼Œå¦‚æžœçº¿ç¨‹è¿Ÿè¿Ÿä¸ç»“æŸï¼ˆä¾‹å¦‚çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ï¼‰ï¼Œå°±ä¼šé€ æˆå†…å­˜æ³„æ¼ã€‚
è§£å†³æ–¹æ¡ˆï¼šæ¯æ¬¡ä½¿ç”¨å®ŒThreadLocalåŽï¼Œå¿…é¡»è°ƒç”¨remove()æ–¹æ³•ï¼Œæ‰‹åŠ¨æ¸…é™¤Entryã€‚




6. çº¿ç¨‹æ±  (ThreadPoolExecutor)æ ¸å¿ƒå‚æ•° (7ä¸ª)
corePoolSizeï¼šæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå³ä½¿ç©ºé—²ä¹Ÿä¼šä¿ç•™çš„çº¿ç¨‹æ•°é‡ã€‚
maximumPoolSizeï¼šæœ€å¤§çº¿ç¨‹æ•°ã€‚
keepAliveTimeï¼šéžæ ¸å¿ƒçº¿ç¨‹ç©ºé—²æ—¶çš„å­˜æ´»æ—¶é—´ã€‚
unitï¼šå­˜æ´»æ—¶é—´çš„å•ä½ã€‚
workQueueï¼šç”¨äºŽä¿å­˜ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡çš„é˜»å¡žé˜Ÿåˆ—ï¼ˆå¦‚ArrayBlockingQueue, LinkedBlockingQueue, SynchronousQueueï¼‰ã€‚
threadFactoryï¼šç”¨äºŽåˆ›å»ºæ–°çº¿ç¨‹çš„å·¥åŽ‚ã€‚
handlerï¼šé¥±å’Œç­–ç•¥ã€‚å½“é˜Ÿåˆ—å’Œçº¿ç¨‹æ± éƒ½æ»¡äº†æ—¶çš„å¤„ç†ç­–ç•¥ï¼ˆAbortPolicyæŠ›å‡ºå¼‚å¸¸ã€CallerRunsPolicyç”¨è°ƒç”¨è€…çº¿ç¨‹æ‰§è¡Œã€DiscardPolicyç›´æŽ¥ä¸¢å¼ƒã€DiscardOldestPolicyä¸¢å¼ƒé˜Ÿåˆ—ä¸­æœ€è€çš„ä»»åŠ¡ï¼‰ã€‚

å·¥ä½œæµç¨‹ (éžå¸¸é‡è¦ï¼)
æäº¤ä¸€ä¸ªä»»åŠ¡ã€‚
å¦‚æžœå½“å‰çº¿ç¨‹æ•° &lt; corePoolSizeï¼Œåˆ›å»ºæ–°æ ¸å¿ƒçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ã€‚
å¦‚æžœå·²è¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œåˆ™å°†ä»»åŠ¡æ”¾å…¥workQueueç­‰å¾…ã€‚
å¦‚æžœé˜Ÿåˆ—å·²æ»¡ï¼Œä¸”å½“å‰çº¿ç¨‹æ•° &lt; maximumPoolSizeï¼Œåˆ›å»ºæ–°éžæ ¸å¿ƒçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ã€‚
å¦‚æžœé˜Ÿåˆ—å·²æ»¡ä¸”çº¿ç¨‹æ•°å·²è¾¾æœ€å¤§å€¼ï¼Œåˆ™è§¦å‘é¥±å’Œç­–ç•¥handlerã€‚
å½“çº¿ç¨‹ç©ºé—²æ—¶é—´è¶…è¿‡keepAliveTimeï¼Œä¸”æ˜¯éžæ ¸å¿ƒçº¿ç¨‹ï¼Œè¯¥çº¿ç¨‹ä¼šè¢«å›žæ”¶ã€‚æ ¸å¿ƒçº¿ç¨‹é»˜è®¤ä¸å›žæ”¶ï¼ˆå¯é€šè¿‡allowCoreThreadTimeOut(true)è®¾ç½®å›žæ”¶ï¼‰ã€‚

é¢è¯•è¿½é—®ï¼šå¦‚ä½•é…ç½®çº¿ç¨‹æ± å‚æ•°ï¼Ÿæ²¡æœ‰å›ºå®šå…¬å¼ï¼Œéœ€è¦æ ¹æ®ä»»åŠ¡ç±»åž‹åŽ‹æµ‹ã€‚

CPUå¯†é›†åž‹ï¼šçº¿ç¨‹æ•° â‰ˆ CPUæ ¸æ•° + 1ï¼ˆé¿å…è¿‡å¤šçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼‰
IOå¯†é›†åž‹ï¼šçº¿ç¨‹æ•°å¯ä»¥è®¾ç½®å¾—å¤šä¸€äº›ï¼Œå¦‚ â‰ˆ CPUæ ¸æ•° * 2 ï¼ˆæˆ–æ›´é«˜ï¼‰ï¼Œå› ä¸ºçº¿ç¨‹å¤§éƒ¨åˆ†æ—¶é—´åœ¨é˜»å¡žç­‰å¾…IOã€‚


7. JUC å¹¶å‘å·¥å…·åŒ…å…¶ä»–ç»„ä»¶
CountDownLatchï¼šå€’è®¡æ—¶å™¨ã€‚ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ç­‰å¾…å…¶ä»–çº¿ç¨‹å®Œæˆæ“ä½œã€‚await()ç­‰å¾…ï¼ŒcountDown()è®¡æ•°å‡ä¸€ã€‚
CyclicBarrierï¼šå¾ªçŽ¯æ …æ ã€‚ä¸€ç»„çº¿ç¨‹ç›¸äº’ç­‰å¾…ï¼Œåˆ°è¾¾ä¸€ä¸ªå…¬å…±å±éšœç‚¹åŽå†ç»§ç»­æ‰§è¡Œã€‚å¯é‡ç”¨ã€‚
Semaphoreï¼šä¿¡å·é‡ã€‚æŽ§åˆ¶åŒæ—¶è®¿é—®ç‰¹å®šèµ„æºçš„çº¿ç¨‹æ•°é‡ã€‚acquire()èŽ·å–è®¸å¯ï¼Œrelease()é‡Šæ”¾ã€‚

æ¡†æž¶1. IOC (æŽ§åˆ¶åè½¬) ä¸Ž DI (ä¾èµ–æ³¨å…¥)æ ¸å¿ƒæ¦‚å¿µ
IoC (Inversion of Control)ï¼šæ˜¯ä¸€ç§è®¾è®¡æ€æƒ³ï¼Œå°†åŽŸæœ¬ç”±ç¨‹åºä¸»åŠ¨åˆ›å»ºå’Œç®¡ç†å¯¹è±¡ï¼ˆnew Object()ï¼‰çš„æŽ§åˆ¶æƒï¼Œåè½¬ç»™å¤–éƒ¨å®¹å™¨ï¼ˆSpring Frameworkï¼‰æ¥ç®¡ç†ã€‚
DI (Dependency Injection)ï¼šæ˜¯å®žçŽ°IoCçš„ä¸€ç§æ–¹å¼ã€‚ç”±å®¹å™¨åœ¨è¿è¡ŒæœŸåŠ¨æ€åœ°å°†æŸç§ä¾èµ–å…³ç³»æ³¨å…¥åˆ°å¯¹è±¡ä¹‹ä¸­ï¼ˆé€šè¿‡æž„é€ å‡½æ•°ã€Setteræ–¹æ³•ç­‰æ–¹å¼ï¼‰ã€‚

ä¸€å¥è¯æ€»ç»“ï¼šIoCæ˜¯ç›®çš„ï¼ŒDIæ˜¯æ‰‹æ®µã€‚
é¢è¯•è¿½é—®Qï¼šIoCå®¹å™¨åšäº†ä»€ä¹ˆï¼Ÿå®ƒçš„å¥½å¤„æ˜¯ä»€ä¹ˆï¼Ÿ

åšäº†ä»€ä¹ˆï¼šè´Ÿè´£å¯¹è±¡çš„åˆ›å»ºã€ç»„è£…ï¼ˆæ³¨å…¥ä¾èµ–ï¼‰ã€é…ç½®ã€å’Œç®¡ç†å…¶æ•´ä¸ªç”Ÿå‘½å‘¨æœŸã€‚
å¥½å¤„ï¼š
è§£è€¦ï¼šå¯¹è±¡ä¹‹é—´çš„ä¾èµ–å…³ç³»ç”±å®¹å™¨ç»´æŠ¤ï¼Œé™ä½Žäº†ä»£ç çš„è€¦åˆåº¦ã€‚
èµ„æºé›†ä¸­ç®¡ç†ï¼šç»Ÿä¸€ç®¡ç†å¤§é‡å¯¹è±¡çš„åˆ›å»ºå’Œé”€æ¯ï¼Œæ˜“äºŽé…ç½®å’Œç»´æŠ¤ã€‚
æ˜“äºŽæµ‹è¯•ï¼šå¯ä»¥é€šè¿‡å®¹å™¨æ³¨å…¥ä¸€ä¸ªæ¨¡æ‹Ÿå¯¹è±¡ï¼ˆMockï¼‰æ¥è¿›è¡Œå•å…ƒæµ‹è¯•ã€‚



Qï¼šæœ‰å“ªäº›ä¾èµ–æ³¨å…¥çš„æ–¹å¼ï¼Ÿ

æž„é€ å™¨æ³¨å…¥ï¼šSpringå®˜æ–¹æŽ¨èçš„æ–¹å¼ã€‚ä¿è¯ä¾èµ–ä¸å¯å˜ã€å®Œå…¨åˆå§‹åŒ–çš„çŠ¶æ€ã€‚èƒ½é¿å…å¾ªçŽ¯ä¾èµ–é—®é¢˜ã€‚
java
@Servicepublic class UserService &#123;    private final OrderService orderService;    // æž„é€ å™¨æ³¨å…¥    public UserService(OrderService orderService) &#123;        this.orderService = orderService;    &#125;&#125;



Setteræ–¹æ³•æ³¨å…¥ï¼šå¯é€‰ä¾èµ–ï¼Œå…è®¸å¯¹è±¡åœ¨åˆ›å»ºåŽé‡æ–°é…ç½®ã€‚
java
public class UserService &#123;    private OrderService orderService;    // Setteræ³¨å…¥    @Autowired    public void setOrderService(OrderService orderService) &#123;        this.orderService = orderService;    &#125;&#125;



å­—æ®µæ³¨å…¥ï¼ˆä¸æŽ¨èï¼‰ï¼šä½¿ç”¨@Autowiredç›´æŽ¥æ ‡æ³¨åœ¨å­—æ®µä¸Šã€‚ä»£ç ç®€æ´ï¼Œä½†ç¼ºç‚¹å¾ˆå¤šï¼šä¸åˆ©äºŽæµ‹è¯•ï¼ˆå¿…é¡»é€šè¿‡åå°„æ³¨å…¥ï¼‰ã€éšè—äº†ä¾èµ–å…³ç³»ã€å®¹æ˜“å¯¼è‡´NPEï¼ˆå› ä¸ºå­—æ®µå¯èƒ½ä¸ºnullï¼‰ã€‚
java
public class UserService &#123;    @Autowired // ä¸æŽ¨è    private OrderService orderService;&#125;


2. Bean çš„ç”Ÿå‘½å‘¨æœŸ (éžå¸¸éžå¸¸é‡è¦)ä¸€ä¸ªBeanä»Žåˆ›å»ºåˆ°é”€æ¯çš„å®Œæ•´è¿‡ç¨‹ã€‚ä½ éœ€è¦èƒ½è¯´å‡ºå…³é”®æ­¥éª¤å’Œæ‰©å±•ç‚¹ã€‚
ç®€åŒ–ç‰ˆæ ¸å¿ƒæµç¨‹ï¼š

å®žä¾‹åŒ– (Instantiate)ï¼šé€šè¿‡åå°„è°ƒç”¨æž„é€ æ–¹æ³•åˆ›å»ºBeançš„å®žä¾‹ã€‚
å±žæ€§èµ‹å€¼ (Populate)ï¼šä¸ºBeançš„å±žæ€§æ³¨å…¥å€¼ï¼ˆä¾èµ–æ³¨å…¥å‘ç”Ÿåœ¨è¿™é‡Œï¼‰ã€‚
åˆå§‹åŒ– (Initialize)ï¼š
å¦‚æžœBeanå®žçŽ°äº†BeanNameAwareã€BeanFactoryAwareç­‰æŽ¥å£ï¼Œä¼šè°ƒç”¨ç›¸åº”çš„å›žè°ƒæ–¹æ³•ã€‚
æ‰§è¡Œæ‰€æœ‰BeanPostProcessorçš„**postProcessBeforeInitialization**æ–¹æ³•ã€‚
å¦‚æžœBeanæŒ‡å®šäº†init-methodæˆ–å®žçŽ°äº†InitializingBeanæŽ¥å£ï¼Œè°ƒç”¨åˆå§‹åŒ–æ–¹æ³•ã€‚
æ‰§è¡Œæ‰€æœ‰BeanPostProcessorçš„**postProcessAfterInitialization**æ–¹æ³•ï¼ˆAOPä»£ç†å¯¹è±¡çš„ç”Ÿæˆå°±åœ¨è¿™ä¸€æ­¥ï¼ï¼‰ã€‚


ä½¿ç”¨ (Ready)ï¼šBeanå·²ç»å®Œå…¨åˆå§‹åŒ–ï¼Œå­˜æ”¾åœ¨IoCå®¹å™¨ä¸­ï¼Œå¯ä¾›åº”ç”¨ç¨‹åºä½¿ç”¨ã€‚
é”€æ¯ (Destroy)ï¼šå®¹å™¨å…³é—­æ—¶ï¼Œå¦‚æžœBeanæŒ‡å®šäº†destroy-methodæˆ–å®žçŽ°äº†DisposableBeanæŽ¥å£ï¼Œä¼šè°ƒç”¨é”€æ¯æ–¹æ³•ã€‚

é¢è¯•è¿½é—®ï¼šè¯·è¯¦ç»†è¯´ä¸€ä¸‹BeanPostProcessorçš„ä½œç”¨ï¼Ÿ

ä½œç”¨ï¼šå®ƒæ˜¯Springæä¾›çš„ä¸€ä¸ªå¼ºå¤§çš„æ‰©å±•ç‚¹ï¼Œå…è®¸å¼€å‘è€…åœ¨Beanåˆå§‹åŒ–å‰åŽâ€œæ’æ‰‹â€ï¼Œè¿›è¡Œè‡ªå®šä¹‰é€»è¾‘ã€‚
postProcessBeforeInitializationï¼šåœ¨åˆå§‹åŒ–æ–¹æ³•ï¼ˆå¦‚@PostConstructï¼‰è°ƒç”¨ä¹‹å‰æ‰§è¡Œã€‚
postProcessAfterInitializationï¼šåœ¨åˆå§‹åŒ–æ–¹æ³•è°ƒç”¨ä¹‹åŽæ‰§è¡Œã€‚Spring AOPå°±æ˜¯é€šè¿‡AbstractAutoProxyCreatorï¼ˆå®ƒæ˜¯ä¸€ä¸ªBeanPostProcessorï¼‰åœ¨è¿™ä¸€æ­¥åˆ›å»ºä»£ç†å¯¹è±¡çš„ã€‚

è¿½é—®ï¼š@PostConstructã€InitializingBeanã€init-methodçš„æ‰§è¡Œé¡ºåºï¼Ÿ

@PostConstruct æ³¨è§£æ ‡æ³¨çš„æ–¹æ³•
InitializingBean æŽ¥å£çš„ afterPropertiesSet() æ–¹æ³•
è‡ªå®šä¹‰çš„ init-method æ–¹æ³•


3. å¾ªçŽ¯ä¾èµ– (Circular Dependency)é—®é¢˜åœºæ™¯æ¯”å¦‚ï¼šAService ä¾èµ– BServiceï¼ŒåŒæ—¶ BService åˆä¾èµ– AServiceã€‚
Springçš„è§£å†³æ–¹æ¡ˆ (ä¸‰çº§ç¼“å­˜)Springé€šè¿‡ä¸‰çº§ç¼“å­˜æ¥è§£å†³å•ä¾‹Beançš„Setteræ³¨å…¥&#x2F;å­—æ®µæ³¨å…¥çš„å¾ªçŽ¯ä¾èµ–ã€‚

ç¬¬ä¸€çº§ç¼“å­˜ (singletonObjects)ï¼šå­˜æ”¾å·²ç»å®Œå…¨åˆå§‹åŒ–å¥½çš„Beanã€‚
ç¬¬äºŒçº§ç¼“å­˜ (earlySingletonObjects)ï¼šå­˜æ”¾æå‰æš´éœ²çš„åŽŸå§‹Beanï¼ˆå°šæœªå¡«å……å±žæ€§ï¼‰ï¼Œç”¨äºŽè§£å†³å¾ªçŽ¯ä¾èµ–ã€‚
ç¬¬ä¸‰çº§ç¼“å­˜ (singletonFactories)ï¼šå­˜æ”¾ObjectFactoryï¼Œç”¨äºŽç”ŸæˆåŽŸå§‹Beançš„æ—©æœŸå¼•ç”¨ï¼ˆå¯èƒ½è¢«AOPä»£ç†ï¼‰ã€‚

è§£å†³æµç¨‹ï¼ˆä»¥Aã€Bå¾ªçŽ¯ä¾èµ–ä¸ºä¾‹ï¼‰ï¼š

å¼€å§‹åˆ›å»ºAï¼Œå®žä¾‹åŒ–Aï¼ˆåªæ˜¯è°ƒç”¨æž„é€ æ–¹æ³•ï¼‰ï¼Œå¾—åˆ°ä¸€ä¸ªåŽŸå§‹å¯¹è±¡ã€‚æ­¤æ—¶ï¼Œå°†Aå¯¹åº”çš„ObjectFactoryæ”¾å…¥ç¬¬ä¸‰çº§ç¼“å­˜ã€‚
ä¸ºAè¿›è¡Œå±žæ€§èµ‹å€¼ï¼Œå‘çŽ°éœ€è¦æ³¨å…¥Bã€‚äºŽæ˜¯åŽ»åˆ›å»ºBã€‚
å¼€å§‹åˆ›å»ºBï¼Œå®žä¾‹åŒ–Bï¼Œå°†Bçš„ObjectFactoryæ”¾å…¥ç¬¬ä¸‰çº§ç¼“å­˜ã€‚
ä¸ºBè¿›è¡Œå±žæ€§èµ‹å€¼ï¼Œå‘çŽ°éœ€è¦æ³¨å…¥Aã€‚äºŽæ˜¯å°è¯•ä»Žç¼“å­˜ä¸­èŽ·å–Aï¼š
ä»Žç¬¬ä¸€çº§ç¼“å­˜singletonObjectsèŽ·å–A -&gt; æ²¡æœ‰ã€‚
ä»Žç¬¬äºŒçº§ç¼“å­˜earlySingletonObjectsèŽ·å–A -&gt; æ²¡æœ‰ã€‚
ä»Žç¬¬ä¸‰çº§ç¼“å­˜singletonFactoriesä¸­èŽ·å–Açš„ObjectFactoryï¼Œå¹¶è°ƒç”¨getObject()æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•å¯èƒ½ä¼šæå‰è¿›è¡ŒAOPï¼ˆå¦‚æžœAéœ€è¦è¢«ä»£ç†ï¼‰ï¼Œç„¶åŽå¾—åˆ°ä¸€ä¸ªAçš„æ—©æœŸå¼•ç”¨ï¼ˆå¯èƒ½æ˜¯ä»£ç†å¯¹è±¡ï¼‰ï¼Œå¹¶å°†è¿™ä¸ªæ—©æœŸå¼•ç”¨æ”¾å…¥ç¬¬äºŒçº§ç¼“å­˜ï¼ŒåŒæ—¶ä»Žç¬¬ä¸‰çº§ç¼“å­˜ç§»é™¤Açš„ObjectFactoryã€‚


BæˆåŠŸèŽ·å–åˆ°Açš„æ—©æœŸå¼•ç”¨ï¼Œå®Œæˆå±žæ€§èµ‹å€¼å’Œåˆå§‹åŒ–ï¼Œæˆä¸ºä¸€ä¸ªå®Œæ•´çš„Beanï¼Œæ”¾å…¥ç¬¬ä¸€çº§ç¼“å­˜ã€‚
AæŽ¥ç€æ³¨å…¥Bï¼Œå®Œæˆå±žæ€§èµ‹å€¼å’Œåˆå§‹åŒ–ï¼Œä¹Ÿæˆä¸ºä¸€ä¸ªå®Œæ•´çš„Beanï¼Œæ”¾å…¥ç¬¬ä¸€çº§ç¼“å­˜ã€‚

é¢è¯•è¿½é—®ï¼šä¸ºä»€ä¹ˆæž„é€ å™¨æ³¨å…¥çš„å¾ªçŽ¯ä¾èµ–æ— æ³•è§£å†³ï¼Ÿå› ä¸ºæž„é€ å™¨æ³¨å…¥å‘ç”Ÿåœ¨å®žä¾‹åŒ–è¿™ä¸€æ­¥ã€‚åœ¨å®žä¾‹åŒ–Aæ—¶ï¼Œå°±éœ€è¦å…ˆå¾—åˆ°Bï¼›è€Œå®žä¾‹åŒ–Bæ—¶ï¼Œåˆéœ€è¦å…ˆå¾—åˆ°Aã€‚åŒæ–¹éƒ½å¡åœ¨ç¬¬ä¸€æ­¥ï¼Œæ— æ³•å®Œæˆå®žä¾‹åŒ–ï¼Œæ›´æ— æ³•æå‰æš´éœ²å¼•ç”¨ï¼Œå› æ­¤ä¸‰çº§ç¼“å­˜æœºåˆ¶å¤±æ•ˆï¼ŒSpringä¼šç›´æŽ¥æŠ›å‡ºBeanCurrentlyInCreationExceptionå¼‚å¸¸ã€‚

4. AOP (é¢å‘åˆ‡é¢ç¼–ç¨‹)æ ¸å¿ƒæ¦‚å¿µ
ä½œç”¨ï¼šå°†é‚£äº›ä¸Žæ ¸å¿ƒä¸šåŠ¡é€»è¾‘æ— å…³ä½†åˆéå¸ƒåœ¨ä»£ç ä¸­çš„åŠŸèƒ½ï¼ˆå¦‚æ—¥å¿—ã€äº‹åŠ¡ã€å®‰å…¨ç­‰ï¼‰åˆ†ç¦»å‡ºæ¥ï¼Œä½œä¸ºâ€œæ¨ªåˆ‡å…³æ³¨ç‚¹â€ï¼Œé›†ä¸­ç®¡ç†ã€‚
é‡è¦æœ¯è¯­ï¼š
åˆ‡é¢ (Aspect)ï¼šå°è£…æ¨ªåˆ‡å…³æ³¨ç‚¹çš„æ¨¡å—ï¼ˆä¸€ä¸ª@Aspectæ³¨è§£çš„ç±»ï¼‰ã€‚
è¿žæŽ¥ç‚¹ (Joinpoint)ï¼šç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­å¯ä»¥æ’å…¥åˆ‡é¢çš„ç‚¹ï¼ˆå¦‚æ–¹æ³•è°ƒç”¨ã€å¼‚å¸¸æŠ›å‡ºï¼‰ã€‚
é€šçŸ¥ (Advice)ï¼šåˆ‡é¢åœ¨ç‰¹å®šè¿žæŽ¥ç‚¹æ‰§è¡Œçš„åŠ¨ä½œï¼ˆ@Before, @After, @Around, @AfterReturning, @AfterThrowingï¼‰ã€‚
åˆ‡ç‚¹ (Pointcut)ï¼šåŒ¹é…è¿žæŽ¥ç‚¹çš„è¡¨è¾¾å¼ï¼Œå®šä¹‰äº†é€šçŸ¥ä½•æ—¶è¢«æ‰§è¡Œï¼ˆ@Pointcutï¼‰ã€‚
ç»‡å…¥ (Weaving)ï¼šå°†åˆ‡é¢åº”ç”¨åˆ°ç›®æ ‡å¯¹è±¡å¹¶åˆ›å»ºä»£ç†å¯¹è±¡çš„è¿‡ç¨‹ã€‚



å®žçŽ°åŽŸç†ï¼šåŠ¨æ€ä»£ç†Spring AOPé»˜è®¤ä½¿ç”¨åŠ¨æ€ä»£ç†ï¼Œæ ¹æ®æ¡ä»¶é€‰æ‹©ï¼š

JDKåŠ¨æ€ä»£ç† (é»˜è®¤)ï¼šè¦æ±‚ç›®æ ‡ç±»å¿…é¡»å®žçŽ°è‡³å°‘ä¸€ä¸ªæŽ¥å£ã€‚ä»£ç†å¯¹è±¡ä¼šå®žçŽ°ç›¸åŒçš„æŽ¥å£ã€‚
CGLIBåŠ¨æ€ä»£ç†ï¼šé€šè¿‡ç»§æ‰¿ç›®æ ‡ç±»æ¥ç”Ÿæˆå­ç±»ä½œä¸ºä»£ç†ã€‚ä¸éœ€è¦å®žçŽ°æŽ¥å£ã€‚å¯ä»¥é€šè¿‡@EnableAspectJAutoProxy(proxyTargetClass = true)å¼ºåˆ¶ä½¿ç”¨ã€‚

é¢è¯•è¿½é—®ï¼š@Aroundå’Œ@Afterçš„åŒºåˆ«ï¼Ÿ

@Aroundï¼šæœ€å¼ºå¤§çš„é€šçŸ¥ã€‚å®ƒåŒ…å›´äº†è¿žæŽ¥ç‚¹ï¼Œå¯ä»¥æŽ§åˆ¶ç›®æ ‡æ–¹æ³•æ˜¯å¦æ‰§è¡Œã€ä½•æ—¶æ‰§è¡Œã€æ‰§è¡Œå¤šå°‘æ¬¡ï¼Œå¹¶å¯ä»¥ä¿®æ”¹è¿”å›žå€¼ã€‚å®ƒéœ€è¦æ˜¾å¼è°ƒç”¨ProceedingJoinPoint.proceed()æ¥æ‰§è¡Œç›®æ ‡æ–¹æ³•ã€‚
@Afterï¼šæœ€ç»ˆé€šçŸ¥ã€‚æ— è®ºç›®æ ‡æ–¹æ³•æ˜¯æ­£å¸¸è¿”å›žè¿˜æ˜¯æŠ›å‡ºå¼‚å¸¸ï¼Œå®ƒéƒ½ä¼šæ‰§è¡Œï¼ˆç±»ä¼¼äºŽfinallyå—ï¼‰ã€‚


5. Spring Boot è‡ªåŠ¨é…ç½®åŽŸç† (Magic)è¿™æ˜¯Spring Bootçš„æ ¸å¿ƒé­…åŠ›æ‰€åœ¨ã€‚
æ ¸å¿ƒæ³¨è§£ï¼š@SpringBootApplicationå®ƒæ˜¯ä¸€ä¸ªå¤åˆæ³¨è§£ï¼Œä¸»è¦ç”±ä¸‰ä¸ªæ³¨è§£ç»„æˆï¼š

@SpringBootConfigurationï¼šè¡¨æ˜Žè¿™æ˜¯ä¸€ä¸ªé…ç½®ç±»ã€‚
@ComponentScanï¼šå¼€å¯ç»„ä»¶æ‰«æã€‚
@EnableAutoConfiguration (å…³é”®)ï¼šå¯ç”¨è‡ªåŠ¨é…ç½®ã€‚

@EnableAutoConfiguration çš„å·¥ä½œåŽŸç†ï¼š

å®ƒå¯¼å…¥äº†AutoConfigurationImportSelectorç±»ã€‚
è¿™ä¸ªç±»ä¼šè°ƒç”¨SpringFactoriesLoader.loadFactoryNames()æ–¹æ³•ï¼Œä»Žæ‰€æœ‰jaråŒ…çš„META-INF/spring.factoriesæ–‡ä»¶ä¸­è¯»å–EnableAutoConfigurationé”®å¯¹åº”çš„å…¨é™å®šç±»ååˆ—è¡¨ï¼ˆè¿™äº›å°±æ˜¯è‡ªåŠ¨é…ç½®ç±»ï¼‰ã€‚
è¿™äº›è‡ªåŠ¨é…ç½®ç±»ï¼ˆå¦‚DataSourceAutoConfigurationï¼‰ä½¿ç”¨@Configurationæ³¨è§£ï¼Œå¹¶åˆ©ç”¨@ConditionalOnClass, @ConditionalOnProperty, @ConditionalOnMissingBeanç­‰æ¡ä»¶æ³¨è§£è¿›è¡Œåˆ¤æ–­ã€‚
æ¡ä»¶æ³¨è§£çš„é€»è¾‘æ˜¯ï¼š â€œå¦‚æžœç±»è·¯å¾„ä¸‹æœ‰æŸä¸ªç±»â€ã€â€œå¦‚æžœé…ç½®äº†æŸä¸ªå±žæ€§â€ã€â€œå¦‚æžœå®¹å™¨ä¸­æ²¡æœ‰æŸä¸ªBeanâ€ï¼Œæ‰åˆ›å»ºé…ç½®ä¸­å®šä¹‰çš„Beanã€‚
è¿™æ ·å°±å®žçŽ°äº†ï¼šåªè¦ä½ å¼•å…¥äº†spring-boot-starter-webï¼ŒTomcatå’ŒSpring MVCæ‰€éœ€çš„Beanå°±ä¼šè‡ªåŠ¨é…ç½®å¥½ï¼›åªè¦ä½ å¼•å…¥äº†spring-boot-starter-jdbcå¹¶é…ç½®äº†æ•°æ®æºï¼ŒDataSourceå’ŒJdbcTemplateå°±ä¼šè‡ªåŠ¨é…ç½®å¥½ã€‚

é¢è¯•è¿½é—®ï¼šå¦‚ä½•è‡ªå®šä¹‰ä¸€ä¸ªStarterï¼Ÿ

åˆ›å»ºä¸€ä¸ªé¡¹ç›®ï¼ŒåŒ…å«è‡ªåŠ¨é…ç½®æ¨¡å—your-starter-autoconfigureå’Œå¯é€‰ä¾èµ–æ¨¡å—your-starterã€‚
åœ¨your-starter-autoconfigureä¸­åˆ›å»ºï¼š
ä¸€ä¸ªYourServicePropertiesç±»ï¼Œç»‘å®š@ConfigurationPropertiesã€‚
ä¸€ä¸ªYourServiceAutoConfigurationç±»ï¼Œä½¿ç”¨@Configurationå’Œ@EnableConfigurationProperties(YourServiceProperties.class)ï¼Œå¹¶ç”¨æ¡ä»¶æ³¨è§£æŽ§åˆ¶Beançš„åˆ›å»ºã€‚


åœ¨resources/META-INF/ä¸‹åˆ›å»ºspring.factoriesæ–‡ä»¶ï¼Œæ·»åŠ org.springframework.boot.autoconfigure.EnableAutoConfiguration=com.you.YourServiceAutoConfigurationã€‚
å°†your-starter-autoconfigureæ‰“åŒ…ï¼Œå¹¶åœ¨your-starterä¸­ä¾èµ–å®ƒã€‚

æ¶ˆæ¯é˜Ÿåˆ—ä¸€ã€æ¶ˆæ¯é˜Ÿåˆ—æ ¸å¿ƒæ¨¡åž‹ä¸Žä»·å€¼æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMQï¼‰æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å®žçŽ°å¼‚æ­¥é€šä¿¡ã€è§£è€¦æœåŠ¡ã€å‰Šå³°å¡«è°·çš„æ ¸å¿ƒç»„ä»¶ï¼Œæ ¸å¿ƒæ¨¡åž‹æ˜¯å‘å¸ƒ - è®¢é˜…æ¨¡å¼ï¼š

ç”Ÿäº§è€…ï¼ˆProducerï¼‰ï¼šå‘é€æ¶ˆæ¯çš„æœåŠ¡ï¼›
æ¶ˆè´¹è€…ï¼ˆConsumerï¼‰ï¼šæŽ¥æ”¶å¹¶å¤„ç†æ¶ˆæ¯çš„æœåŠ¡ï¼›
** broker**ï¼šä¸­é—´ä»¶æœåŠ¡å™¨ï¼Œå­˜å‚¨æ¶ˆæ¯å¹¶è½¬å‘ç»™æ¶ˆè´¹è€…ï¼›
ä¸»é¢˜ï¼ˆTopicï¼‰ï¼šæ¶ˆæ¯çš„åˆ†ç±»æ ‡è¯†ï¼Œç”Ÿäº§è€…å‘ Topic å‘é€æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…ä»Ž Topic è®¢é˜…æ¶ˆæ¯ã€‚

æ ¸å¿ƒä»·å€¼ï¼š

è§£è€¦ï¼šæœåŠ¡é—´é€šè¿‡ MQ é€šä¿¡ï¼Œæ— éœ€ç›´æŽ¥ä¾èµ–ï¼›
å¼‚æ­¥ï¼šéžæ ¸å¿ƒæµç¨‹å¼‚æ­¥å¤„ç†ï¼ˆå¦‚ä¸‹å•åŽå¼‚æ­¥å‘é€é€šçŸ¥ï¼‰ï¼Œæå‡ä¸»æµç¨‹å“åº”é€Ÿåº¦ï¼›
å‰Šå³°ï¼šé«˜å¹¶å‘åœºæ™¯ä¸‹ï¼ˆå¦‚ç§’æ€ï¼‰ï¼ŒMQ ç¼“å†²è¯·æ±‚ï¼Œé¿å…ä¸‹æ¸¸æœåŠ¡è¢«åŽ‹åž®ï¼›
å¯é é€šä¿¡ï¼šé€šè¿‡æŒä¹…åŒ–ã€é‡è¯•æœºåˆ¶ç¡®ä¿æ¶ˆæ¯ä¸ä¸¢å¤±ã€‚

äºŒã€Kafka æ·±åº¦è§£æžKafka æ˜¯é«˜åžåã€ä½Žå»¶è¿Ÿçš„åˆ†å¸ƒå¼æ¶ˆæ¯ç³»ç»Ÿï¼Œé€‚åˆå¤§æ•°æ®åœºæ™¯ï¼ˆå¦‚æ—¥å¿—æ”¶é›†ã€å®žæ—¶è®¡ç®—ï¼‰ã€‚
1. æ ¸å¿ƒæž¶æž„ç»„ä»¶ï¼ˆç¤ºæ„å›¾ï¼šå±•ç¤ºç”Ÿäº§è€…ã€broker é›†ç¾¤ã€æ¶ˆè´¹è€…ç»„ä¸Ž ZooKeeper çš„å…³ç³»ï¼‰

Producerï¼ˆç”Ÿäº§è€…ï¼‰ï¼šå‘é€æ¶ˆæ¯åˆ° Topicï¼Œæ”¯æŒåŒæ­¥ &#x2F; å¼‚æ­¥å‘é€ï¼Œé€šè¿‡åˆ†åŒºç­–ç•¥ï¼ˆé»˜è®¤æŒ‰ key å“ˆå¸Œï¼‰å°†æ¶ˆæ¯åˆ†é…åˆ°å…·ä½“åˆ†åŒºã€‚
Consumerï¼ˆæ¶ˆè´¹è€…ï¼‰ï¼šä»Ž Topic è®¢é˜…æ¶ˆæ¯ï¼Œä»¥æ¶ˆè´¹è€…ç»„ï¼ˆConsumer Groupï¼‰ ä¸ºå•ä½å·¥ä½œï¼š
åŒä¸€ç»„å†…çš„æ¶ˆè´¹è€…åˆ†å·¥æ¶ˆè´¹ä¸åŒåˆ†åŒºï¼ˆä¸€ä¸ªåˆ†åŒºä»…è¢«ç»„å†…ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ï¼‰ï¼›
ä¸åŒç»„å¯ç‹¬ç«‹æ¶ˆè´¹åŒä¸€ Topicï¼ˆå¹¿æ’­æ¨¡å¼ï¼‰ã€‚


Brokerï¼ˆ broker èŠ‚ç‚¹ï¼‰ï¼šå­˜å‚¨æ¶ˆæ¯çš„æœåŠ¡å™¨ï¼Œå¤šä¸ª broker ç»„æˆé›†ç¾¤ã€‚æ¯ä¸ª broker è´Ÿè´£å¤šä¸ª Topic çš„åˆ†åŒºå­˜å‚¨ã€‚
Topic ä¸Ž Partitionï¼ˆåˆ†åŒºï¼‰ï¼š
Topic æ˜¯æ¶ˆæ¯çš„é€»è¾‘åˆ†ç±»ï¼Œç‰©ç†ä¸Šè¢«åˆ’åˆ†ä¸ºå¤šä¸ªåˆ†åŒºï¼ˆPartitionï¼‰ï¼Œåˆ†åŒºæ˜¯ Kafka å¹¶è¡Œå¤„ç†çš„æœ€å°å•ä½ï¼›
æ¯ä¸ªåˆ†åŒºæ˜¯æœ‰åºçš„ã€ä¸å¯å˜çš„æ¶ˆæ¯æ—¥å¿—ï¼ˆæŒ‰æ—¶é—´é¡ºåºè¿½åŠ ï¼‰ï¼Œæ¶ˆæ¯è¢«åˆ†é…å…¨å±€å”¯ä¸€çš„ offsetï¼ˆåç§»é‡ï¼‰æ ‡è¯†ä½ç½®ã€‚


Replicaï¼ˆå‰¯æœ¬ï¼‰ï¼šæ¯ä¸ªåˆ†åŒºæœ‰å¤šä¸ªå‰¯æœ¬ï¼ˆ1 ä¸ª leader + N ä¸ª followerï¼‰ï¼Œå®žçŽ°é«˜å¯ç”¨ï¼š
leader å‰¯æœ¬ï¼šå¤„ç†è¯»å†™è¯·æ±‚ï¼›
follower å‰¯æœ¬ï¼šåŒæ­¥ leader æ•°æ®ï¼Œleader æ•…éšœæ—¶é€šè¿‡é€‰ä¸¾æˆä¸ºæ–° leaderã€‚
ISRï¼ˆIn-Sync Replicasï¼‰ï¼šä¸Ž leader ä¿æŒåŒæ­¥çš„å‰¯æœ¬é›†åˆï¼ˆå»¶è¿Ÿä¸è¶…è¿‡é˜ˆå€¼ï¼‰ï¼Œåªæœ‰ ISR å†…çš„å‰¯æœ¬å¯å‚ä¸Ž leader é€‰ä¸¾ã€‚


ZooKeeperï¼ˆKafka 2.8 å‰ï¼‰ï¼šç®¡ç†é›†ç¾¤å…ƒæ•°æ®ï¼ˆå¦‚ broker èŠ‚ç‚¹åˆ—è¡¨ã€åˆ†åŒº - å‰¯æœ¬æ˜ å°„ã€æ¶ˆè´¹è€…ç»„ offsetï¼‰ï¼Œåè°ƒ leader é€‰ä¸¾ã€‚æ³¨ï¼šKafka 2.8+ æ”¯æŒ KRaft æ¨¡å¼ï¼ˆåŽ» ZooKeeper åŒ–ï¼‰ï¼Œç”¨å†…ç½®å…ƒæ•°æ®æŽ§åˆ¶å™¨æ›¿ä»£ ZooKeeperã€‚

2. æ¶ˆæ¯å¯é åŽŸç†ï¼ˆç”Ÿäº§ - å­˜å‚¨ - æ¶ˆè´¹å…¨é“¾è·¯ï¼‰ï¼ˆ1ï¼‰ç”Ÿäº§ç«¯å¯é æ€§ï¼šç¡®ä¿æ¶ˆæ¯æˆåŠŸå‘é€åˆ° broker
acks å‚æ•°æŽ§åˆ¶ç¡®è®¤çº§åˆ«
ï¼š

acks=0ï¼šç”Ÿäº§è€…å‘é€åŽä¸ç­‰å¾…ç¡®è®¤ï¼ˆå¯èƒ½ä¸¢å¤±ï¼Œåžåæœ€é«˜ï¼‰ï¼›
acks=1ï¼šä»…ç­‰å¾… leader å†™å…¥æˆåŠŸç¡®è®¤ï¼ˆleader æ•…éšœå¯èƒ½ä¸¢å¤±ï¼‰ï¼›
acks=allï¼ˆæˆ– -1ï¼‰ï¼šç­‰å¾… leader å’Œæ‰€æœ‰ ISR ä¸­çš„ follower å†™å…¥æˆåŠŸç¡®è®¤ï¼ˆæœ€å¯é ï¼Œåžåæœ€ä½Žï¼‰ã€‚


é‡è¯•æœºåˆ¶ï¼šé…ç½® retriesï¼ˆé‡è¯•æ¬¡æ•°ï¼‰å’Œ retry.backoff.msï¼ˆé‡è¯•é—´éš”ï¼‰ï¼Œåº”å¯¹ç½‘ç»œæŠ–åŠ¨ç­‰ä¸´æ—¶æ•…éšœã€‚


ï¼ˆ2ï¼‰å­˜å‚¨ç«¯å¯é æ€§ï¼šç¡®ä¿æ¶ˆæ¯æŒä¹…åŒ–ä¸ä¸¢å¤±
åˆ†åŒºå‰¯æœ¬æœºåˆ¶ï¼šé€šè¿‡å¤šå‰¯æœ¬ï¼ˆå¦‚ 3 å‰¯æœ¬ï¼‰ï¼Œå³ä½¿å•ä¸ª broker æ•…éšœï¼Œæ•°æ®ä»å¯ä»Žå…¶ä»–å‰¯æœ¬æ¢å¤ï¼›
æ—¥å¿—æŒä¹…åŒ–ï¼šæ¶ˆæ¯å†™å…¥åˆ†åŒºåŽï¼Œå…ˆå­˜äºŽé¡µç¼“å­˜ï¼ˆPageCacheï¼‰ï¼Œå†é€šè¿‡åˆ·ç›˜ç­–ç•¥å†™å…¥ç£ç›˜ï¼ˆlog.flush.interval.messages æŽ§åˆ¶æ¶ˆæ¯æ•°è§¦å‘åˆ·ç›˜ï¼Œlog.flush.interval.ms æŽ§åˆ¶æ—¶é—´è§¦å‘ï¼‰ï¼›
ISR åŠ¨æ€ç»´æŠ¤ï¼šfollower è‹¥è½åŽ leader è¶…è¿‡é˜ˆå€¼ï¼ˆreplica.lag.time.max.msï¼Œé»˜è®¤ 30sï¼‰ï¼Œä¼šè¢«ç§»å‡º ISRï¼Œç¡®ä¿ä»…åŒæ­¥çŠ¶æ€è‰¯å¥½çš„å‰¯æœ¬å‚ä¸Žç¡®è®¤ã€‚

ï¼ˆ3ï¼‰æ¶ˆè´¹ç«¯å¯é æ€§ï¼šç¡®ä¿æ¶ˆæ¯è¢«æ­£ç¡®å¤„ç†
offset æäº¤æœºåˆ¶
ï¼šæ¶ˆè´¹è€…å¤„ç†å®Œæ¶ˆæ¯åŽï¼Œæ‰‹åŠ¨æäº¤ offsetï¼ˆè®°å½•å·²æ¶ˆè´¹åˆ°çš„ä½ç½®ï¼‰ï¼š

è‡ªåŠ¨æäº¤ï¼ˆenable.auto.commit=trueï¼‰ï¼šæŒ‰é—´éš”è‡ªåŠ¨æäº¤ï¼Œå¯èƒ½é‡å¤æ¶ˆè´¹ï¼ˆå¤„ç†ä¸­æœªæäº¤ï¼Œæ¶ˆè´¹è€…é‡å¯ï¼‰ï¼›
æ‰‹åŠ¨æäº¤ï¼šcommitSync()ï¼ˆåŒæ­¥é˜»å¡žï¼‰æˆ– commitAsync()ï¼ˆå¼‚æ­¥éžé˜»å¡žï¼‰ï¼Œç¡®ä¿å¤„ç†æˆåŠŸåŽå†æäº¤ï¼Œé¿å…æ¶ˆæ¯ä¸¢å¤±ã€‚


æ¶ˆè´¹è€…ç»„é‡å¹³è¡¡ï¼ˆRebalanceï¼‰ï¼šå½“æ¶ˆè´¹è€…ç»„å†…æˆå‘˜å˜åŒ–ï¼ˆæ–°å¢ž &#x2F; ä¸‹çº¿ï¼‰æˆ–åˆ†åŒºæ•°é‡å˜åŒ–æ—¶ï¼Œé‡æ–°åˆ†é…åˆ†åŒºä¸Žæ¶ˆè´¹è€…çš„æ˜ å°„ï¼Œéœ€é€šè¿‡ group.id æ ‡è¯†ç»„ï¼Œsession.timeout.ms æ£€æµ‹æ¶ˆè´¹è€…å­˜æ´»ã€‚


3. å…¸åž‹é—®é¢˜ä¸Žè§£å†³æ–¹æ¡ˆ
æ¶ˆæ¯é‡å¤æ¶ˆè´¹ï¼šå› ç½‘ç»œå»¶è¿Ÿå¯¼è‡´ offset æäº¤å¤±è´¥ï¼Œæ¶ˆè´¹è€…é‡å¯åŽé‡å¤æ‹‰å–ã€‚è§£å†³ï¼šæ¶ˆè´¹é€»è¾‘è®¾è®¡ä¸ºå¹‚ç­‰æ€§ï¼ˆå¦‚åŸºäºŽæ¶ˆæ¯ ID åŽ»é‡ï¼‰ã€‚
é¡ºåºæ¶ˆæ¯ï¼šKafka ä»…ä¿è¯åˆ†åŒºå†…æ¶ˆæ¯æœ‰åºï¼ˆæŒ‰ offset é€’å¢žï¼‰ï¼Œå…¨å±€æ— åºã€‚è‹¥éœ€å…¨å±€æœ‰åºï¼Œéœ€å°† Topic è®¾ä¸º 1 ä¸ªåˆ†åŒºï¼ˆç‰ºç‰²å¹¶è¡Œæ€§ï¼‰ã€‚

ä¸‰ã€RocketMQ æ·±åº¦è§£æžRocketMQ æ˜¯é˜¿é‡Œå¼€æºçš„æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œä¾§é‡é‡‘èžçº§å¯é æ€§ã€ä½Žå»¶è¿Ÿå’Œä¸°å¯Œçš„æ¶ˆæ¯ç±»åž‹ï¼ˆå¦‚äº‹åŠ¡æ¶ˆæ¯ã€å®šæ—¶æ¶ˆæ¯ï¼‰ï¼Œé€‚åˆä¸šåŠ¡ç³»ç»Ÿï¼ˆå¦‚ç”µå•†äº¤æ˜“ï¼‰ã€‚
1. æ ¸å¿ƒæž¶æž„ç»„ä»¶ï¼ˆç¤ºæ„å›¾ï¼šå±•ç¤ºç”Ÿäº§è€…ã€æ¶ˆè´¹è€…ã€broker é›†ç¾¤ã€NameServer çš„å…³ç³»ï¼‰

Producerï¼ˆç”Ÿäº§è€…ï¼‰ï¼šå‘é€æ¶ˆæ¯åˆ° Topicï¼Œæ”¯æŒåŒæ­¥ã€å¼‚æ­¥ã€å•å‘å‘é€ï¼Œæä¾›äº‹åŠ¡æ¶ˆæ¯ã€å®šæ—¶æ¶ˆæ¯ç­‰é«˜çº§ç‰¹æ€§ã€‚
Consumerï¼ˆæ¶ˆè´¹è€…ï¼‰ï¼šä»Ž Topic æ¶ˆè´¹æ¶ˆæ¯ï¼Œåˆ†ä¸¤ç§æ¨¡å¼ï¼š
é›†ç¾¤æ¶ˆè´¹ï¼ˆClusteringï¼‰ï¼šåŒç»„æ¶ˆè´¹è€…åˆ†æ‘Šæ¶ˆè´¹ï¼ˆç±»ä¼¼ Kafka çš„æ¶ˆè´¹è€…ç»„ï¼‰ï¼›
å¹¿æ’­æ¶ˆè´¹ï¼ˆBroadcastingï¼‰ï¼šåŒç»„æ¯ä¸ªæ¶ˆè´¹è€…éƒ½æ”¶åˆ°å…¨é‡æ¶ˆæ¯ã€‚


Brokerï¼ˆ broker èŠ‚ç‚¹ï¼‰ï¼šå­˜å‚¨æ¶ˆæ¯å¹¶å¤„ç†è¯»å†™è¯·æ±‚ï¼Œåˆ†Masterï¼ˆå¯è¯»å†™ï¼‰å’ŒSlaveï¼ˆåªè¯»ï¼ŒåŒæ­¥ Master æ•°æ®ï¼‰ï¼Œæ”¯æŒå¤š Master å¤š Slave æž¶æž„ã€‚
Topic ä¸Ž Queueï¼ˆé˜Ÿåˆ—ï¼‰ï¼š
Topic æ˜¯æ¶ˆæ¯é€»è¾‘åˆ†ç±»ï¼Œç‰©ç†ä¸Šåˆ’åˆ†ä¸ºå¤šä¸ªé˜Ÿåˆ—ï¼ˆQueueï¼‰ï¼ˆç±»ä¼¼ Kafka çš„ Partitionï¼‰ï¼›
æ¯ä¸ª Queue æ˜¯æœ‰åºçš„æ¶ˆæ¯åˆ—è¡¨ï¼Œæ¶ˆæ¯æŒ‰å‘é€é¡ºåºå­˜å‚¨ï¼Œæ”¯æŒé¡ºåºæ¶ˆè´¹ã€‚


NameServerï¼šè½»é‡çº§è·¯ç”±æ³¨å†Œä¸­å¿ƒï¼Œå­˜å‚¨ Topic ä¸Ž broker çš„æ˜ å°„å…³ç³»ï¼ˆæ— çŠ¶æ€ï¼Œå¯é›†ç¾¤éƒ¨ç½²ï¼ŒèŠ‚ç‚¹é—´ä¸é€šä¿¡ï¼‰ï¼š
ç”Ÿäº§è€… &#x2F; æ¶ˆè´¹è€…å¯åŠ¨æ—¶ä»Ž NameServer èŽ·å– Topic çš„è·¯ç”±ä¿¡æ¯ï¼ˆQueue åˆ†å¸ƒåœ¨å“ªäº› brokerï¼‰ï¼›
broker å®šæœŸå‘ NameServer å‘é€å¿ƒè·³ï¼Œç»´æŒå­˜æ´»çŠ¶æ€ã€‚


CommitLog ä¸Ž ConsumeQueueï¼š
CommitLogï¼šå…¨å±€ç»Ÿä¸€çš„æ¶ˆæ¯å­˜å‚¨æ–‡ä»¶ï¼ˆæ‰€æœ‰ Topic çš„æ¶ˆæ¯æ··åˆå­˜å‚¨ï¼‰ï¼ŒæŒ‰é¡ºåºè¿½åŠ å†™å…¥ï¼›
ConsumeQueueï¼šæ¯ä¸ª Queue å¯¹åº”ä¸€ä¸ª ConsumeQueueï¼ˆç´¢å¼•æ–‡ä»¶ï¼‰ï¼Œè®°å½•æ¶ˆæ¯åœ¨ CommitLog ä¸­çš„åç§»é‡ã€å¤§å°å’Œ Tag å“ˆå¸Œå€¼ï¼ŒåŠ é€Ÿæ¶ˆæ¯æ£€ç´¢ã€‚



2. æ¶ˆæ¯å¯é åŽŸç†ï¼ˆç”Ÿäº§ - å­˜å‚¨ - æ¶ˆè´¹å…¨é“¾è·¯ï¼‰ï¼ˆ1ï¼‰ç”Ÿäº§ç«¯å¯é æ€§ï¼šç¡®ä¿æ¶ˆæ¯æˆåŠŸæŠ•é€’
å‘é€ç¡®è®¤æœºåˆ¶
ï¼š

åŒæ­¥å‘é€ï¼šç­‰å¾… broker è¿”å›žç¡®è®¤ï¼ˆSEND_OKï¼‰ï¼Œå¤±è´¥åˆ™é‡è¯•ï¼ˆretryTimesWhenSendFailedï¼‰ï¼›
å¼‚æ­¥å‘é€ï¼šé€šè¿‡å›žè°ƒå‡½æ•°å¤„ç†å‘é€ç»“æžœï¼Œå¤±è´¥æ—¶è§¦å‘é‡è¯•ã€‚


äº‹åŠ¡æ¶ˆæ¯ï¼šæ”¯æŒåˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆ2PC æ€æƒ³ï¼‰ï¼Œé€šè¿‡ â€œåŠæ¶ˆæ¯ + ç¡®è®¤ &#x2F; å›žæ»šâ€ æœºåˆ¶ç¡®ä¿äº‹åŠ¡ä¸€è‡´æ€§ã€‚


ï¼ˆ2ï¼‰å­˜å‚¨ç«¯å¯é æ€§ï¼šç¡®ä¿æ¶ˆæ¯æŒä¹…åŒ–
åˆ·ç›˜ç­–ç•¥
ï¼šæ¶ˆæ¯å†™å…¥ CommitLog æ—¶ï¼Œå¯é…ç½®ï¼š

åŒæ­¥åˆ·ç›˜ï¼ˆSYNC_FLUSHï¼‰ï¼šæ¶ˆæ¯å†™å…¥ç£ç›˜åŽæ‰è¿”å›žç¡®è®¤ï¼ˆå¯é æ€§é«˜ï¼Œæ€§èƒ½ä½Žï¼‰ï¼›
å¼‚æ­¥åˆ·ç›˜ï¼ˆASYNC_FLUSHï¼‰ï¼šæ¶ˆæ¯å†™å…¥é¡µç¼“å­˜åŽå³è¿”å›žï¼ŒåŽå°çº¿ç¨‹å¼‚æ­¥åˆ·ç›˜ï¼ˆæ€§èƒ½é«˜ï¼Œå¯èƒ½ä¸¢å¤±æœªåˆ·ç›˜æ•°æ®ï¼‰ã€‚


ä¸»ä»Žå¤åˆ¶ç­–ç•¥
ï¼šMaster ä¸Ž Slave çš„æ•°æ®åŒæ­¥ï¼š

åŒæ­¥å¤åˆ¶ï¼šMaster ç­‰å¾… Slave å¤åˆ¶å®ŒæˆåŽæ‰è¿”å›žç¡®è®¤ï¼ˆæ— å•ç‚¹ä¸¢å¤±é£Žé™©ï¼‰ï¼›
å¼‚æ­¥å¤åˆ¶ï¼šMaster æ— éœ€ç­‰å¾… Slaveï¼Œç›´æŽ¥è¿”å›žï¼ˆæ€§èƒ½é«˜ï¼ŒSlave æœªåŒæ­¥æ—¶ Master æ•…éšœä¼šä¸¢å¤±æ•°æ®ï¼‰ã€‚



ï¼ˆ3ï¼‰æ¶ˆè´¹ç«¯å¯é æ€§ï¼šç¡®ä¿æ¶ˆæ¯è¢«æ­£ç¡®å¤„ç†
æ¶ˆè´¹ç¡®è®¤ï¼ˆAckï¼‰
ï¼š

æ¶ˆè´¹è€…å¤„ç†å®Œæ¶ˆæ¯åŽï¼Œéœ€å‘é€ Ack ç»™ brokerï¼ˆé»˜è®¤è‡ªåŠ¨ Ackï¼Œå¯é…ç½®æ‰‹åŠ¨ Ackï¼‰ï¼›
æœª Ack çš„æ¶ˆæ¯ä¼šè¢«æ”¾å…¥é‡è¯•é˜Ÿåˆ—ï¼ˆæœ€å¤šé‡è¯• 16 æ¬¡ï¼Œé—´éš”é€’å¢žï¼‰ï¼Œé¿å…æ¶ˆæ¯ä¸¢å¤±ã€‚


æ¶ˆè´¹ä½ç‚¹ç®¡ç†ï¼šbroker å­˜å‚¨æ¶ˆè´¹è€…ç»„çš„æ¶ˆè´¹ä½ç‚¹ï¼ˆæ¶ˆè´¹åˆ°å“ªä¸ª Queue çš„å“ªä¸ªä½ç½®ï¼‰ï¼Œæ¶ˆè´¹è€…é‡å¯åŽå¯ä»Žä½ç‚¹ç»§ç»­æ¶ˆè´¹ã€‚


3. å…¸åž‹é—®é¢˜ä¸Žè§£å†³æ–¹æ¡ˆ
äº‹åŠ¡æ¶ˆæ¯å®žçŽ°
ï¼šè§£å†³åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆå¦‚ â€œä¸‹å• + æ‰£åº“å­˜â€ï¼‰ï¼Œæµç¨‹ï¼š

ç”Ÿäº§è€…å‘é€ â€œåŠæ¶ˆæ¯â€ï¼ˆæš‚ä¸èƒ½è¢«æ¶ˆè´¹ï¼‰ï¼›
æ‰§è¡Œæœ¬åœ°äº‹åŠ¡ï¼›
å‘é€ â€œç¡®è®¤â€ï¼ˆåŠæ¶ˆæ¯å˜ä¸ºå¯æ¶ˆè´¹ï¼‰æˆ– â€œå›žæ»šâ€ï¼ˆåŠæ¶ˆæ¯è¢«åˆ é™¤ï¼‰ï¼›
è‹¥è¶…æ—¶æœªç¡®è®¤ï¼Œbroker é€šè¿‡ â€œå›žæŸ¥â€ ç”Ÿäº§è€…ç¡®è®¤äº‹åŠ¡çŠ¶æ€ã€‚


é¡ºåºæ¶ˆæ¯ï¼šæ”¯æŒå…¨å±€é¡ºåºï¼ˆTopic ä»… 1 ä¸ª Queueï¼‰å’Œåˆ†åŒºé¡ºåºï¼ˆæŒ‰ä¸šåŠ¡ key è·¯ç”±åˆ°å›ºå®š Queueï¼‰ï¼Œç¡®ä¿åŒä¸€ key çš„æ¶ˆæ¯æœ‰åºæ¶ˆè´¹ã€‚


å››ã€Kafka vs RocketMQ æ ¸å¿ƒå·®å¼‚


ç»´åº¦
Kafka
RocketMQ



å®šä½
é«˜åžåå¤§æ•°æ®åœºæ™¯ï¼ˆæ—¥å¿—ã€æµå¤„ç†ï¼‰
ä¸šåŠ¡ç³»ç»Ÿï¼ˆäº¤æ˜“ã€é€šçŸ¥ï¼‰ï¼Œä¾§é‡å¯é æ€§


å…ƒæ•°æ®ç®¡ç†
ä¾èµ– ZooKeeperï¼ˆæˆ– KRaftï¼‰
è½»é‡çº§ NameServerï¼ˆæ— çŠ¶æ€ï¼‰


æ¶ˆæ¯å­˜å‚¨
åˆ†åŒºæ—¥å¿—æ–‡ä»¶ï¼ˆæŒ‰ Topic - åˆ†åŒºéš”ç¦»ï¼‰
å…¨å±€ CommitLog + ç´¢å¼• ConsumeQueue


é«˜çº§ç‰¹æ€§
åŸºç¡€æ¶ˆæ¯ã€æµå¤„ç†é›†æˆï¼ˆKafka Streamsï¼‰
äº‹åŠ¡æ¶ˆæ¯ã€å®šæ—¶æ¶ˆæ¯ã€é‡è¯•é˜Ÿåˆ—ç­‰


åžåé‡
æžé«˜ï¼ˆå•æœºåä¸‡çº§ &#x2F; ç§’ï¼‰
é«˜ï¼ˆå•æœºä¸‡çº§ &#x2F; ç§’ï¼Œæ»¡è¶³ä¸šåŠ¡åœºæ™¯ï¼‰


å»¶è¿Ÿ
æ¯«ç§’çº§
æ¯«ç§’çº§ï¼ˆç•¥é«˜äºŽ Kafkaï¼‰


æ€»ç»“Kafka å’Œ RocketMQ å‡åŸºäºŽå‘å¸ƒ - è®¢é˜…æ¨¡å¼ï¼Œé€šè¿‡åˆ†åŒº &#x2F; é˜Ÿåˆ—å®žçŽ°å¹¶è¡Œå¤„ç†ï¼Œé€šè¿‡å‰¯æœ¬æœºåˆ¶ä¿è¯å¯é æ€§ã€‚Kafka ä»¥é«˜åžåè§é•¿ï¼Œé€‚åˆå¤§æ•°æ®åœºæ™¯ï¼›RocketMQ ä»¥ä¸°å¯Œç‰¹æ€§å’Œé‡‘èžçº§å¯é æ€§ä¸ºä¼˜åŠ¿ï¼Œé€‚åˆä¸šåŠ¡ç³»ç»Ÿã€‚ç†è§£ä¸¤è€…çš„æž¶æž„è®¾è®¡ï¼ˆå¦‚åˆ†åŒº &#x2F; é˜Ÿåˆ—ã€å…ƒæ•°æ®ç®¡ç†ï¼‰å’Œå¯é æ€§ä¿éšœæœºåˆ¶ï¼ˆç”Ÿäº§ç¡®è®¤ã€å­˜å‚¨æŒä¹…åŒ–ã€æ¶ˆè´¹ç¡®è®¤ï¼‰ï¼Œæ˜¯æ­£ç¡®é€‰åž‹å’Œè§£å†³é—®é¢˜çš„æ ¸å¿ƒã€‚
å¾®æœåŠ¡ä¸€ã€å¾®æœåŠ¡æ ¸å¿ƒè®¤çŸ¥ä¸Žå¼€å‘æµç¨‹å¾®æœåŠ¡æ˜¯å°†å•ä½“åº”ç”¨æ‹†åˆ†ä¸ºç‹¬ç«‹éƒ¨ç½²ã€èŒè´£å•ä¸€ã€é€šä¿¡è½»é‡çš„å°åž‹æœåŠ¡é›†ç¾¤ï¼Œæ¯ä¸ªæœåŠ¡èšç„¦ç‰¹å®šä¸šåŠ¡åŸŸï¼Œé€šè¿‡ HTTP&#x2F;RPC ç­‰åè®®åä½œã€‚å…¶æ ¸å¿ƒç›®æ ‡æ˜¯è§£å†³å•ä½“åº”ç”¨ â€œè¿­ä»£æ…¢ã€æ‰©å±•æ€§å·®ã€æ•…éšœå½±å“èŒƒå›´å¤§â€ çš„é—®é¢˜ã€‚
1. å¾®æœåŠ¡å¼€å‘å…¨æµç¨‹


é˜¶æ®µ
æ ¸å¿ƒä»»åŠ¡
å…³é”®åŽŸåˆ™ &#x2F; å·¥å…·



éœ€æ±‚åˆ†æžä¸ŽæœåŠ¡æ‹†åˆ†
å°†ä¸šåŠ¡æ‹†åˆ†ä¸ºç‹¬ç«‹æœåŠ¡ï¼ˆå¦‚ç”µå•†æ‹†åˆ†ä¸ºç”¨æˆ·ã€è®¢å•ã€å•†å“ã€æ”¯ä»˜æœåŠ¡ï¼‰
æŒ‰ä¸šåŠ¡åŸŸæ‹†åˆ†ã€å•ä¸€èŒè´£ã€é«˜å†…èšä½Žè€¦åˆï¼ˆDDD é¢†åŸŸé©±åŠ¨è®¾è®¡å¯è¾…åŠ©ï¼‰


æŠ€æœ¯é€‰åž‹
ç¡®å®šæ³¨å†Œä¸­å¿ƒã€é…ç½®ä¸­å¿ƒã€æœåŠ¡è°ƒç”¨ã€æµé‡æŽ§åˆ¶ã€ç½‘å…³ç­‰ç»„ä»¶
ä¸»æµæ ˆï¼šSpring Cloud Alibabaï¼ˆNacos&#x2F;Feign&#x2F;Sentinelï¼‰æˆ– Spring Cloud Netflix


æœåŠ¡å¼€å‘
å•ä¸ªæœåŠ¡æŒ‰ â€œåˆ†å±‚æž¶æž„â€ å®žçŽ°ï¼ˆControllerâ†’Serviceâ†’DAOï¼‰ï¼Œæš´éœ² API æŽ¥å£
ç»Ÿä¸€æŽ¥å£è§„èŒƒï¼ˆå¦‚ RESTfulï¼‰ã€å®šä¹‰æœåŠ¡å¥‘çº¦ï¼ˆOpenAPI&#x2F;Swaggerï¼‰


æœåŠ¡æ²»ç†
è§£å†³æœåŠ¡æ³¨å†Œå‘çŽ°ã€é…ç½®åŒæ­¥ã€è°ƒç”¨ç†”æ–­ã€æµé‡æŽ§åˆ¶ã€ç›‘æŽ§å‘Šè­¦ç­‰é—®é¢˜
Nacosï¼ˆæ³¨å†Œ &#x2F; é…ç½®ï¼‰ã€Sentinelï¼ˆæµé‡ï¼‰ã€Prometheus+Grafanaï¼ˆç›‘æŽ§ï¼‰


éƒ¨ç½²è¿ç»´
æœåŠ¡å®¹å™¨åŒ–ï¼ˆDockerï¼‰ã€ç¼–æŽ’ï¼ˆK8sï¼‰ã€æŒç»­é›†æˆ &#x2F; éƒ¨ç½²ï¼ˆCI&#x2F;CDï¼‰
å®¹å™¨åŒ–éƒ¨ç½²ã€ç°åº¦å‘å¸ƒã€æ»šåŠ¨æ›´æ–°


2. æœåŠ¡æ‹†åˆ†å…³é”®åŽŸåˆ™
é¿å… â€œè¿‡ç»†æ‹†åˆ†â€ï¼šæ‹†åˆ†è¿‡ç»†ä¼šå¯¼è‡´æœåŠ¡é—´è°ƒç”¨é¢‘ç¹ï¼ˆâ€œåˆ†å¸ƒå¼äº‹åŠ¡åœ°ç‹±â€ï¼‰ï¼Œé€šå¸¸æŒ‰ â€œä¸šåŠ¡èƒ½åŠ›â€ æ‹†åˆ†ï¼ˆå¦‚ â€œå•†å“ç®¡ç†â€ è€Œéž â€œå•†å“æŸ¥è¯¢â€â€œå•†å“ä¿®æ”¹â€ ä¸¤ä¸ªæœåŠ¡ï¼‰ï¼›
æ•°æ®è‡ªæ²»ï¼šæ¯ä¸ªæœåŠ¡æ‹¥æœ‰ç‹¬ç«‹æ•°æ®åº“ï¼ˆé¿å…è·¨æœåŠ¡è¯»å†™åº“ï¼‰ï¼Œè·¨æœåŠ¡æ•°æ®äº¤äº’é€šè¿‡ API è€Œéžç›´æŽ¥æ“ä½œ DBï¼›
æŽ¥å£ç¨³å®šï¼šæœåŠ¡å¯¹å¤– API ä¸€æ—¦å‘å¸ƒï¼Œé¿å…é¢‘ç¹å˜æ›´ï¼ˆå¦‚éœ€å˜æ›´ï¼Œå…¼å®¹æ—§ç‰ˆæœ¬æˆ–ç‰ˆæœ¬åŒ– APIï¼‰ã€‚

äºŒã€æ ¸å¿ƒæŠ€æœ¯æ ˆè¯¦è§£ï¼ˆSpring Cloud Alibaba ä½“ç³»ï¼‰1. Nacosï¼šæ³¨å†Œä¸­å¿ƒ + é…ç½®ä¸­å¿ƒï¼ˆåŒæ ¸å¿ƒè§’è‰²ï¼‰Nacosï¼ˆDynamic Naming and Configuration Serviceï¼‰æ˜¯å¾®æœåŠ¡çš„ â€œåœ°å€ç°¿â€ å’Œ â€œé…ç½®ä¸­å¿ƒâ€ï¼Œæ›¿ä»£ä¼ ç»Ÿçš„ Eurekaï¼ˆæ³¨å†Œï¼‰+ Configï¼ˆé…ç½®ï¼‰ï¼Œæ”¯æŒé«˜å¯ç”¨ã€åŠ¨æ€æ›´æ–°ã€‚
ï¼ˆ1ï¼‰æ ¸å¿ƒä½œç”¨ï¼šæœåŠ¡æ³¨å†Œä¸Žå‘çŽ°è§£å†³ â€œæœåŠ¡é—´å¦‚ä½•æ‰¾åˆ°å½¼æ­¤â€ çš„é—®é¢˜ï¼ˆå¦‚è®¢å•æœåŠ¡éœ€è°ƒç”¨å•†å“æœåŠ¡ï¼Œéœ€çŸ¥é“å•†å“æœåŠ¡çš„ IP:Portï¼‰ã€‚
å·¥ä½œæµç¨‹ï¼š

æœåŠ¡æ³¨å†Œï¼šæœåŠ¡å¯åŠ¨æ—¶ï¼Œé€šè¿‡ Nacos å®¢æˆ·ç«¯å°†è‡ªèº«ä¿¡æ¯ï¼ˆæœåŠ¡åã€IPã€Portã€å¥åº·çŠ¶æ€ï¼‰æ³¨å†Œåˆ° Nacos Serverï¼›
å¿ƒè·³ç»­çº¦ï¼šæœåŠ¡æ¯ 5 ç§’å‘é€å¿ƒè·³åˆ° Nacosï¼ŒNacos è¶…è¿‡ 15 ç§’æœªæ”¶åˆ°å¿ƒè·³åˆ™æ ‡è®° â€œä¸å¥åº·â€ï¼Œ30 ç§’æœªæ”¶åˆ°åˆ™ç§»é™¤æœåŠ¡ï¼›
æœåŠ¡å‘çŽ°ï¼šæ¶ˆè´¹è€…é€šè¿‡æœåŠ¡åå‘ Nacos æŸ¥è¯¢å¯ç”¨å®žä¾‹åˆ—è¡¨ï¼ŒNacos è¿”å›žå¥åº·å®žä¾‹ï¼ˆé»˜è®¤é‡‡ç”¨ â€œåŠ æƒéšæœºâ€ è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼‰ã€‚

ä½¿ç”¨å®žè·µï¼š

ä¾èµ–å¼•å…¥ï¼ˆSpring Boot é¡¹ç›®ï¼‰ï¼š
xml
&lt;dependency&gt;    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;&lt;/dependency&gt;

é…ç½®
application.yml

ï¼š
yaml
spring:  cloud:    nacos:      discovery:        server-addr: 192.168.1.100:8848  # Nacos Serveråœ°å€  application:    name: order-service  # æœåŠ¡åï¼ˆæ ¸å¿ƒæ ‡è¯†ï¼Œæ¶ˆè´¹è€…é€šè¿‡æ­¤åè°ƒç”¨ï¼‰

ï¼ˆ2ï¼‰æ ¸å¿ƒä½œç”¨ï¼šé…ç½®ä¸­å¿ƒè§£å†³ â€œå¤šçŽ¯å¢ƒã€å¤šæœåŠ¡é…ç½®é›†ä¸­ç®¡ç†ä¸ŽåŠ¨æ€æ›´æ–°â€ çš„é—®é¢˜ï¼ˆå¦‚å¼€å‘ &#x2F; æµ‹è¯• &#x2F; ç”Ÿäº§çŽ¯å¢ƒçš„æ•°æ®åº“é…ç½®ï¼Œæ— éœ€é‡å¯æœåŠ¡å³å¯ç”Ÿæ•ˆï¼‰ã€‚
å·¥ä½œæµç¨‹ï¼š

é…ç½®å‘å¸ƒï¼šåœ¨ Nacos æŽ§åˆ¶å°åˆ›å»ºé…ç½®ï¼ˆå¦‚order-service-dev.ymlï¼‰ï¼Œå…³è”æœåŠ¡åå’ŒçŽ¯å¢ƒï¼›
é…ç½®æ‹‰å–ï¼šæœåŠ¡å¯åŠ¨æ—¶ï¼ŒNacos å®¢æˆ·ç«¯æ ¹æ® â€œæœåŠ¡å + çŽ¯å¢ƒâ€ æ‹‰å–é…ç½®ï¼Œè¦†ç›–æœ¬åœ°é…ç½®ï¼›
åŠ¨æ€æ›´æ–°ï¼šé…ç½®å˜æ›´æ—¶ï¼ŒNacos é€šè¿‡ HTTP é•¿è½®è¯¢é€šçŸ¥å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯è‡ªåŠ¨åˆ·æ–°é…ç½®ï¼ˆæ— éœ€é‡å¯ï¼‰ã€‚

ä½¿ç”¨å®žè·µï¼š

ä¾èµ–å¼•å…¥ï¼š
xml
&lt;dependency&gt;    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-config&lt;/artifactId&gt;&lt;/dependency&gt;

é…ç½®
bootstrap.yml

ï¼ˆä¼˜å…ˆäºŽ
application.yml

åŠ è½½ï¼‰ï¼š
yaml
spring:  cloud:    nacos:      config:        server-addr: 192.168.1.100:8848        file-extension: yml  # é…ç½®æ–‡ä»¶æ ¼å¼        group: DEFAULT_GROUP  # é…ç½®åˆ†ç»„ï¼ˆé»˜è®¤å³å¯ï¼‰  application:    name: order-service  profiles:    active: dev  # çŽ¯å¢ƒï¼ˆå¯¹åº”é…ç½®åï¼šorder-service-dev.ymlï¼‰

åŠ¨æ€åˆ·æ–°é…ç½®ï¼šåœ¨éœ€è¦åˆ·æ–°çš„ç±»ä¸ŠåŠ 
@RefreshScope

ï¼š
java
@RestController@RefreshScope  // é…ç½®å˜æ›´æ—¶è‡ªåŠ¨åˆ·æ–°public class OrderController &#123;    @Value(&quot;$&#123;order.timeout:3000&#125;&quot;)  // ä»ŽNacosèŽ·å–é…ç½®ï¼Œé»˜è®¤3000    private Integer timeout;&#125;

ï¼ˆ3ï¼‰Nacos é«˜å¯ç”¨éƒ¨ç½²ç”Ÿäº§çŽ¯å¢ƒéœ€éƒ¨ç½² Nacos é›†ç¾¤ï¼ˆè‡³å°‘ 3 èŠ‚ç‚¹ï¼‰ï¼Œé€šè¿‡ MySQL å…±äº«å…ƒæ•°æ®ï¼ˆé¿å…å•æœºæ•…éšœï¼‰ï¼Œå¹¶é…ç½®è´Ÿè½½å‡è¡¡å™¨ï¼ˆå¦‚ Nginxï¼‰ä»£ç† Nacos Server åœ°å€ã€‚
2. Feignï¼šå£°æ˜Žå¼æœåŠ¡è°ƒç”¨å·¥å…·Feign æ˜¯åŸºäºŽNetflix Feignå°è£…çš„ HTTP å®¢æˆ·ç«¯ï¼Œé€šè¿‡æ³¨è§£å®šä¹‰æŽ¥å£å³å¯å®žçŽ°æœåŠ¡é—´è°ƒç”¨ï¼Œæ— éœ€æ‰‹åŠ¨ç¼–å†™RestTemplate+URL çš„ç¹çä»£ç ï¼Œä¸”é»˜è®¤é›†æˆ Ribbonï¼ˆè´Ÿè½½å‡è¡¡ï¼‰å’Œ Sentinelï¼ˆç†”æ–­é™çº§ï¼‰ã€‚
ï¼ˆ1ï¼‰æ ¸å¿ƒåŽŸç†ï¼šåŠ¨æ€ä»£ç†
æ‰«æ@FeignClientæ³¨è§£çš„æŽ¥å£ï¼Œç”ŸæˆåŠ¨æ€ä»£ç†å®žçŽ°ç±»ï¼›
ä»£ç†ç±»å°†æŽ¥å£æ–¹æ³•è½¬æ¢ä¸º HTTP è¯·æ±‚ï¼ˆè§£æž@GetMapping&#x2F;@PostMappingç­‰æ³¨è§£ï¼‰ï¼›
é€šè¿‡ Ribbon ä»Ž Nacos èŽ·å–æœåŠ¡å®žä¾‹åˆ—è¡¨ï¼Œé€‰æ‹©ä¸€ä¸ªå®žä¾‹å‘èµ·è¯·æ±‚ï¼›
æŽ¥æ”¶å“åº”ï¼Œè½¬æ¢ä¸º Java å¯¹è±¡è¿”å›žç»™è°ƒç”¨è€…ã€‚

ï¼ˆ2ï¼‰ä½¿ç”¨å®žè·µ
ä¾èµ–å¼•å…¥ï¼š
xml
&lt;dependency&gt;    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;    &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;&lt;/dependency&gt;&lt;dependency&gt;  &lt;!-- é›†æˆSentinelç†”æ–­ --&gt;    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;    &lt;artifactId&gt;spring-cloud-starter-alibaba-sentinel&lt;/artifactId&gt;&lt;/dependency&gt;

å¯åŠ¨ç±»åŠ 
@EnableFeignClients

ï¼š
java
@SpringBootApplication@EnableFeignClients  // å¼€å¯Feignæ‰«æpublic class OrderServiceApplication &#123;    public static void main(String[] args) &#123;        SpringApplication.run(OrderServiceApplication.class, args);    &#125;&#125;

å®šä¹‰ Feign æŽ¥å£ï¼ˆè°ƒç”¨å•†å“æœåŠ¡ï¼‰ï¼š
java
@FeignClient(    value = &quot;product-service&quot;,  // ç›®æ ‡æœåŠ¡åï¼ˆNacosä¸­æ³¨å†Œçš„åç§°ï¼‰    fallback = ProductFeignFallback.class  // ç†”æ–­é™çº§å›žè°ƒç±»)public interface ProductFeignClient &#123;    // å¯¹åº”å•†å“æœåŠ¡çš„æŽ¥å£ï¼šGET /product/&#123;id&#125;    @GetMapping(&quot;/product/&#123;id&#125;&quot;)    ProductDTO getById(@PathVariable(&quot;id&quot;) Long id);&#125;// ç†”æ–­é™çº§å®žçŽ°ç±»@Componentpublic class ProductFeignFallback implements ProductFeignClient &#123;    @Override    public ProductDTO getById(Long id) &#123;        // æœåŠ¡ä¸å¯ç”¨æ—¶è¿”å›žé»˜è®¤å€¼æˆ–æç¤º        return new ProductDTO(id, &quot;æœåŠ¡æš‚ä¸å¯ç”¨&quot;, 0.0);    &#125;&#125;

æœåŠ¡ä¸­è°ƒç”¨ï¼š
java
@Servicepublic class OrderService &#123;    @Autowired    private ProductFeignClient productFeignClient;    public OrderDTO createOrder(Long productId) &#123;        // è°ƒç”¨å•†å“æœåŠ¡èŽ·å–å•†å“ä¿¡æ¯ï¼ˆFeignè‡ªåŠ¨å¤„ç†æœåŠ¡å‘çŽ°å’Œè´Ÿè½½å‡è¡¡ï¼‰        ProductDTO product = productFeignClient.getById(productId);        // ä¸šåŠ¡é€»è¾‘...        return new OrderDTO(1L, productId, product.getName());    &#125;&#125;

ï¼ˆ3ï¼‰å…³é”®ç‰¹æ€§ä¸Žé—®é¢˜
è´Ÿè½½å‡è¡¡ï¼šé»˜è®¤é›†æˆ Ribbonï¼Œæ”¯æŒ â€œè½®è¯¢â€â€œåŠ æƒéšæœºâ€ ç­‰ç­–ç•¥ï¼ˆå¯é€šè¿‡ribbon.NFLoadBalancerRuleClassNameé…ç½®ï¼‰ï¼›

è¶…æ—¶é…ç½®
ï¼šé¿å…æœåŠ¡è°ƒç”¨å¡ä½ï¼Œéœ€é…ç½®è¶…æ—¶æ—¶é—´ï¼š
yaml
feign:  client:    config:      default:  # å…¨å±€é…ç½®ï¼ˆä¹Ÿå¯æŒ‡å®šæœåŠ¡åå¦‚product-serviceï¼‰        connect-timeout: 5000  # è¿žæŽ¥è¶…æ—¶        read-timeout: 3000     # è¯»å–è¶…æ—¶

ä¸Ž RestTemplate çš„åŒºåˆ«ï¼šFeign æ˜¯ â€œå£°æ˜Žå¼â€ï¼ˆæŽ¥å£ + æ³¨è§£ï¼‰ï¼Œä»£ç æ›´ç®€æ´ï¼›RestTemplate æ˜¯ â€œå‘½ä»¤å¼â€ï¼ˆéœ€æ‰‹åŠ¨æ‹¼æŽ¥ URL å’Œå‚æ•°ï¼‰ï¼Œçµæ´»æ€§æ›´é«˜ã€‚


3. Sentinelï¼šæµé‡æŽ§åˆ¶ä¸ŽæœåŠ¡å®¹é”™å·¥å…·Sentinelï¼ˆå“¨å…µï¼‰æ˜¯é˜¿é‡Œå¼€æºçš„æµé‡æ²»ç†ç»„ä»¶ï¼Œè§£å†³å¾®æœåŠ¡ä¸­çš„ â€œæµé‡çªå¢žåŽ‹åž®æœåŠ¡â€â€œæœåŠ¡æ•…éšœçº§è”æ‰©æ•£ï¼ˆé›ªå´©ï¼‰â€ ç­‰é—®é¢˜ï¼Œæ ¸å¿ƒåŠŸèƒ½ï¼šé™æµã€ç†”æ–­ã€é™çº§ã€‚
ï¼ˆ1ï¼‰æ ¸å¿ƒæ¦‚å¿µ
èµ„æºï¼šéœ€è¦ä¿æŠ¤çš„å¯¹è±¡ï¼ˆå¦‚ Feign è°ƒç”¨ã€Controller æ–¹æ³•ï¼Œé€šè¿‡@SentinelResourceæ ‡è®°ï¼‰ï¼›
è§„åˆ™ï¼šé™æµ &#x2F; ç†”æ–­ &#x2F; é™çº§çš„é…ç½®ï¼ˆå¦‚ â€œæ¯ç§’æœ€å¤š 100 ä¸ªè¯·æ±‚â€â€œå¼‚å¸¸æ¯”ä¾‹è¶…è¿‡ 50% åˆ™ç†”æ–­â€ï¼‰ï¼›
æ’æ§½é“¾ï¼ˆSlot Chainï¼‰ï¼šSentinel çš„æ ¸å¿ƒéª¨æž¶ï¼Œä¾æ¬¡æ‰§è¡Œ â€œèŠ‚ç‚¹é€‰æ‹©â†’è§„åˆ™æ ¡éªŒâ†’ç»Ÿè®¡â€ ç­‰é€»è¾‘ï¼ˆå¦‚é™æµ Slotã€ç†”æ–­ Slotï¼‰ã€‚

ï¼ˆ2ï¼‰ä¸‰å¤§æ ¸å¿ƒåŠŸèƒ½


åŠŸèƒ½
ä½œç”¨
å…¸åž‹åœºæ™¯



é™æµ
é™åˆ¶å•ä½æ—¶é—´å†…çš„è¯·æ±‚é‡ï¼Œé¿å…æœåŠ¡è¿‡è½½
ç§’æ€æ´»åŠ¨ã€æŽ¥å£å³°å€¼é˜²æŠ¤


ç†”æ–­
æœåŠ¡è°ƒç”¨å¼‚å¸¸ï¼ˆè¶…æ—¶ &#x2F; å¼‚å¸¸æ¯”ä¾‹é«˜ï¼‰æ—¶ï¼Œæš‚æ—¶åˆ‡æ–­è°ƒç”¨ï¼Œé¿å…æ•…éšœæ‰©æ•£
ä¸‹æ¸¸æœåŠ¡æ•…éšœï¼Œé˜²æ­¢ä¸Šæ¸¸æœåŠ¡è¢«æ‹–åž®


é™çº§
ç†”æ–­æˆ–é™æµè§¦å‘åŽï¼Œè¿”å›žé»˜è®¤å€¼ &#x2F; ç¼“å­˜æ•°æ®ï¼Œé¿å…è¿”å›žé”™è¯¯ç»™ç”¨æˆ·
å•†å“è¯¦æƒ…æŽ¥å£é™çº§ï¼Œè¿”å›žç¼“å­˜æ•°æ®


ï¼ˆ3ï¼‰ä½¿ç”¨å®žè·µï¼ˆç»“åˆ Spring Cloudï¼‰
ä¾èµ–å¼•å…¥ï¼ˆåŒ Feign éƒ¨åˆ†çš„sentinelä¾èµ–ï¼‰ï¼›

é…ç½® Sentinel Dashboardï¼ˆå¯è§†åŒ–æŽ§åˆ¶å°ï¼Œç”¨äºŽé…ç½®è§„åˆ™å’Œç›‘æŽ§ï¼‰ï¼š
yaml
spring:  cloud:    sentinel:      transport:        dashboard: 192.168.1.100:8080  # SentinelæŽ§åˆ¶å°åœ°å€        port: 8719  # å®¢æˆ·ç«¯ä¸ŽæŽ§åˆ¶å°é€šä¿¡ç«¯å£

æ ‡è®°èµ„æºå¹¶é…ç½®è§„åˆ™ï¼š
java
@RestControllerpublic class OrderController &#123;    // æ ‡è®°èµ„æºï¼šorder-createï¼Œé…ç½®é™æµè§„åˆ™    @SentinelResource(        value = &quot;order-create&quot;,  // èµ„æºå        blockHandler = &quot;blockHandler&quot;,  // é™æµ/ç†”æ–­è§¦å‘çš„å›žè°ƒ        fallback = &quot;fallback&quot;  // ä¸šåŠ¡å¼‚å¸¸è§¦å‘çš„é™çº§    )    @PostMapping(&quot;/order&quot;)    public ResultDTO createOrder(@RequestBody OrderVO orderVO) &#123;        // ä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚è°ƒç”¨å•†å“æœåŠ¡æ‰£åº“å­˜ï¼‰        return ResultDTO.success(&quot;è®¢å•åˆ›å»ºæˆåŠŸ&quot;);    &#125;    // é™æµ/ç†”æ–­å›žè°ƒï¼ˆå‚æ•°å’Œè¿”å›žå€¼éœ€ä¸ŽåŽŸæ–¹æ³•ä¸€è‡´ï¼Œé¢å¤–åŠ BlockExceptionå‚æ•°ï¼‰    public ResultDTO blockHandler(OrderVO orderVO, BlockException e) &#123;        return ResultDTO.fail(&quot;è¯·æ±‚è¿‡äºŽé¢‘ç¹ï¼Œè¯·ç¨åŽå†è¯•&quot;);    &#125;    // ä¸šåŠ¡å¼‚å¸¸å›žè°ƒ    public ResultDTO fallback(OrderVO orderVO, Throwable e) &#123;        return ResultDTO.fail(&quot;ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·ç¨åŽå†è¯•&quot;);    &#125;&#125;

åœ¨ Sentinel æŽ§åˆ¶å°é…ç½®é™æµè§„åˆ™ï¼š

è®¿é—®http://192.168.1.100:8080ï¼ˆé»˜è®¤è´¦å·å¯†ç  sentinel&#x2F;sentinelï¼‰ï¼›

æ‰¾åˆ°
order-service

æœåŠ¡ï¼Œç‚¹å‡» â€œæµæŽ§è§„åˆ™â€â†’â€œæ–°å¢žâ€ï¼Œé…ç½®ï¼š

èµ„æºåï¼šorder-createï¼›
é™æµç±»åž‹ï¼šQPSï¼ˆæ¯ç§’è¯·æ±‚æ•°ï¼‰ï¼›
é˜ˆå€¼ï¼š10ï¼ˆæ¯ç§’æœ€å¤š 10 ä¸ªè¯·æ±‚ï¼‰ã€‚





ï¼ˆ4ï¼‰å…³é”®è§„åˆ™è¯¦è§£
é™æµç®—æ³•ï¼š
å›ºå®šçª—å£ï¼šç®€å•ä½†å¯èƒ½å‡ºçŽ° â€œä¸´ç•Œé—®é¢˜â€ï¼ˆå¦‚ 1 ç§’æ‹†ä¸ºä¸¤ä¸ª 500ms çª—å£ï¼Œæ¯ä¸ªçª—å£é˜ˆå€¼ 100ï¼Œå®žé™… 1 ç§’å¯èƒ½ 200 è¯·æ±‚ï¼‰ï¼›
æ»‘åŠ¨çª—å£ï¼šå°† 1 ç§’æ‹†åˆ†ä¸ºå¤šä¸ªå°çª—å£ï¼ˆå¦‚ 10 ä¸ª 100ms çª—å£ï¼‰ï¼Œæ»‘åŠ¨ç»Ÿè®¡è¯·æ±‚æ•°ï¼Œè§£å†³ä¸´ç•Œé—®é¢˜ï¼ˆSentinel é»˜è®¤ï¼‰ï¼›
ä»¤ç‰Œæ¡¶ï¼šåŒ€é€Ÿç”Ÿæˆä»¤ç‰Œï¼Œè¯·æ±‚éœ€èŽ·å–ä»¤ç‰Œæ‰å…è®¸é€šè¿‡ï¼ˆé€‚åˆå¹³æ»‘æµé‡ï¼‰ï¼›
æ¼æ¡¶ï¼šè¯·æ±‚åŒ€é€Ÿæµå‡ºï¼Œåº”å¯¹çªå‘æµé‡ï¼ˆç±»ä¼¼ â€œæ³„æ´ªâ€ï¼‰ã€‚


ç†”æ–­è§„åˆ™ï¼šæ”¯æŒä¸‰ç§ç†”æ–­ç­–ç•¥ï¼š
æ…¢è°ƒç”¨æ¯”ä¾‹ï¼šæ…¢è°ƒç”¨ï¼ˆè¶…è¿‡é˜ˆå€¼ï¼‰å æ¯”è¶…è¿‡è®¾å®šå€¼ï¼Œè§¦å‘ç†”æ–­ï¼›
å¼‚å¸¸æ¯”ä¾‹ï¼šå¼‚å¸¸è¯·æ±‚å æ¯”è¶…è¿‡è®¾å®šå€¼ï¼Œè§¦å‘ç†”æ–­ï¼›
å¼‚å¸¸æ•°ï¼šå•ä½æ—¶é—´å†…å¼‚å¸¸æ•°è¶…è¿‡è®¾å®šå€¼ï¼Œè§¦å‘ç†”æ–­ã€‚



ä¸‰ã€å¾®æœåŠ¡æ ¸å¿ƒæ²»ç†åœºæ™¯ä¸Žè§£å†³æ–¹æ¡ˆ


åœºæ™¯
æŠ€æœ¯ç»„åˆ
è§£å†³æ–¹æ¡ˆ



æœåŠ¡é—´è°ƒç”¨
Nacos + Feign
Feign å£°æ˜Žå¼è°ƒç”¨ï¼ŒNacos æä¾›æœåŠ¡å‘çŽ°ï¼ŒRibbon è´Ÿè½½å‡è¡¡


é…ç½®é›†ä¸­ç®¡ç†
Nacos é…ç½®ä¸­å¿ƒ
å¤šçŽ¯å¢ƒé…ç½®é›†ä¸­å­˜å‚¨ï¼ŒåŠ¨æ€åˆ·æ–°ï¼ˆ@RefreshScopeï¼‰


æµé‡å³°å€¼é˜²æŠ¤
Sentinel é™æµ
åŸºäºŽ QPS é…ç½®é™æµè§„åˆ™ï¼Œé¿å…æœåŠ¡è¿‡è½½


æœåŠ¡æ•…éšœéš”ç¦»
Sentinel ç†”æ–­
ä¸‹æ¸¸æœåŠ¡æ•…éšœæ—¶ç†”æ–­ï¼Œé˜²æ­¢çº§è”é›ªå´©


æŽ¥å£æ–‡æ¡£ç»Ÿä¸€ç®¡ç†
Feign + Knife4jï¼ˆSwagger å¢žå¼ºï¼‰
è‡ªåŠ¨ç”ŸæˆæŽ¥å£æ–‡æ¡£ï¼Œæ”¯æŒè°ƒè¯•


åˆ†å¸ƒå¼äº‹åŠ¡
Seataï¼ˆSpring Cloud Alibaba ç»„ä»¶ï¼‰
åŸºäºŽ TCC&#x2F;SAGA æ¨¡å¼ï¼Œè§£å†³è·¨æœåŠ¡äº‹åŠ¡ä¸€è‡´æ€§ï¼ˆå¦‚è®¢å• + æ”¯ä»˜ + åº“å­˜çš„äº‹åŠ¡ï¼‰


æ€»ç»“å¾®æœåŠ¡å¼€å‘çš„æ ¸å¿ƒæ˜¯ â€œæœåŠ¡æ²»ç†â€ï¼ŒNacos è§£å†³ â€œæ³¨å†Œä¸Žé…ç½®â€ çš„åŸºç¡€é—®é¢˜ï¼ŒFeign ç®€åŒ– â€œæœåŠ¡é—´è°ƒç”¨â€ï¼ŒSentinel ä¿éšœ â€œæµé‡ä¸Žå®¹é”™â€ï¼Œä¸‰è€…æž„æˆ Spring Cloud Alibaba ä½“ç³»çš„æ ¸å¿ƒéª¨æž¶ã€‚å®žé™…å¼€å‘ä¸­ï¼Œéœ€ç»“åˆä¸šåŠ¡åœºæ™¯åˆç†æ‹†åˆ†æœåŠ¡ã€é…ç½®ç»„ä»¶å‚æ•°ï¼ˆå¦‚ Feign è¶…æ—¶ã€Sentinel é˜ˆå€¼ï¼‰ï¼Œå¹¶é€šè¿‡ç›‘æŽ§å·¥å…·ï¼ˆå¦‚ Sentinel Dashboardã€Prometheusï¼‰å®žæ—¶æ„ŸçŸ¥æœåŠ¡çŠ¶æ€ï¼Œç¡®ä¿å¾®æœåŠ¡é›†ç¾¤ç¨³å®šè¿è¡Œã€‚
javaåŸºç¡€ä¸€ã€é¢å‘å¯¹è±¡æ€æƒ³ï¼ˆOOPï¼‰æ ¸å¿ƒåè¯è§£é‡Š
å°è£…ï¼šå°†å¯¹è±¡çš„å±žæ€§ï¼ˆæ•°æ®ï¼‰å’Œæ–¹æ³•ï¼ˆæ“ä½œï¼‰å°è£…åœ¨ç±»ä¸­ï¼Œé€šè¿‡è®¿é—®ä¿®é¥°ç¬¦ï¼ˆprivate&#x2F;protected&#x2F;public&#x2F; é»˜è®¤ï¼‰æŽ§åˆ¶å¤–éƒ¨è®¿é—®æƒé™ï¼Œä»…æš´éœ²å¿…è¦æŽ¥å£ï¼ˆå¦‚ getter&#x2F;setterï¼‰ï¼Œéšè—å†…éƒ¨å®žçŽ°ç»†èŠ‚ã€‚
ç»§æ‰¿ï¼šå­ç±»é€šè¿‡å…³é”®å­—ç»§æ‰¿çˆ¶ç±»ï¼Œå¤ç”¨çˆ¶ç±»çš„å±žæ€§å’Œæ–¹æ³•ï¼ŒåŒæ—¶å¯æ–°å¢žåŠŸèƒ½æˆ–é‡å†™çˆ¶ç±»æ–¹æ³•ï¼Œä½“çŽ° â€œis-aâ€ å…³ç³»ã€‚
å¤šæ€ï¼šåŒä¸€è¡Œä¸ºåœ¨ä¸åŒå¯¹è±¡ä¸Šè¡¨çŽ°å‡ºä¸åŒå®žçŽ°ï¼Œæ ¸å¿ƒæ˜¯ â€œçˆ¶ç±»å¼•ç”¨æŒ‡å‘å­ç±»å¯¹è±¡â€ï¼Œä¾èµ–ç»§æ‰¿ &#x2F; å®žçŽ°å…³ç³»ã€æ–¹æ³•é‡å†™ä¸¤å¤§å‰æã€‚
æŠ½è±¡ï¼šé€šè¿‡æŠ½è±¡ç±»æˆ–æŽ¥å£æå–äº‹ç‰©å…±æ€§è¡Œä¸ºï¼Œå¿½ç•¥å…·ä½“å®žçŽ°ï¼Œçº¦æŸå­ç±»å¿…é¡»å®žçŽ°æ ¸å¿ƒåŠŸèƒ½ï¼Œèšç„¦ â€œåšä»€ä¹ˆâ€ è€Œéž â€œæ€Žä¹ˆåšâ€ã€‚

æ ¸å¿ƒé—®ç­”
é—®ï¼šå°è£…çš„æ ¸å¿ƒä»·å€¼æ˜¯ä»€ä¹ˆï¼Ÿç­”ï¼šä¸€æ˜¯éšè—å®žçŽ°ç»†èŠ‚ï¼Œé¿å…å¤–éƒ¨è¯¯ä¿®æ”¹æ•°æ®ï¼ˆå¦‚å¯¹å¹´é¾„å±žæ€§åŠ åˆæ³•æ€§æ ¡éªŒï¼‰ï¼›äºŒæ˜¯é™ä½Žä»£ç è€¦åˆï¼Œå¤–éƒ¨ä»…é€šè¿‡æŽ¥å£äº¤äº’ï¼Œå†…éƒ¨é€»è¾‘ä¿®æ”¹ä¸å½±å“å¤–éƒ¨ä½¿ç”¨ã€‚
é—®ï¼šç»§æ‰¿æœ‰å“ªäº›é™åˆ¶ï¼Ÿå®žé™…å¼€å‘ä¸­å¦‚ä½•è§„é¿ç»§æ‰¿çš„å¼Šç«¯ï¼Ÿç­”ï¼šJava ä»…æ”¯æŒå•ç»§æ‰¿ï¼ˆä¸€ä¸ªç±»åªèƒ½æœ‰ä¸€ä¸ªç›´æŽ¥çˆ¶ç±»ï¼‰ï¼Œä¸”çˆ¶ç±»ä¿®æ”¹å¯èƒ½å¼•å‘å­ç±» â€œé›ªå´©å¼â€ å˜æ›´ï¼ˆå¼ºè€¦åˆï¼‰ã€‚è§„é¿æ–¹å¼ï¼šä¼˜å…ˆä½¿ç”¨ç»„åˆï¼ˆâ€œhas-aâ€ å…³ç³»ï¼Œå¦‚æ±½è½¦åŒ…å«å‘åŠ¨æœºå¯¹è±¡ï¼‰ï¼Œé€šè¿‡å¯¹è±¡å…³è”å®žçŽ°åŠŸèƒ½å¤ç”¨ï¼Œé™ä½Žè€¦åˆã€‚
é—®ï¼šå¤šæ€çš„å®žçŽ°æ¡ä»¶å’Œæ ¸å¿ƒä»·å€¼æ˜¯ä»€ä¹ˆï¼Ÿç­”ï¼šå®žçŽ°æ¡ä»¶æœ‰ä¸‰ï¼šä¸€æ˜¯å­˜åœ¨ç»§æ‰¿æˆ–æŽ¥å£å®žçŽ°å…³ç³»ï¼›äºŒæ˜¯å­ç±»é‡å†™çˆ¶ç±»æ–¹æ³•ï¼›ä¸‰æ˜¯çˆ¶ç±»å¼•ç”¨æŒ‡å‘å­ç±»å¯¹è±¡ã€‚æ ¸å¿ƒä»·å€¼æ˜¯é™ä½Žè€¦åˆï¼ˆä¾èµ–æŠ½è±¡è€Œéžå…·ä½“å®žçŽ°ï¼‰ï¼Œæå‡æ‰©å±•æ€§ï¼ˆæ–°å¢žå­ç±»æ— éœ€ä¿®æ”¹åŽŸæœ‰è°ƒç”¨é€»è¾‘ï¼‰ã€‚

è¿½é—®
è¿½é—® 1ï¼šå¤šæ€åœ¨æ¡†æž¶ä¸­çš„å…¸åž‹åº”ç”¨åœºæ™¯æœ‰å“ªäº›ï¼Ÿç­”ï¼šæ¯”å¦‚ Spring çš„ BeanPostProcessor æŽ¥å£ï¼Œä¸åŒå®žçŽ°ç±»å¯å¯¹ Bean åˆå§‹åŒ–åšä¸åŒå¢žå¼ºï¼Œæ¡†æž¶é€šè¿‡çˆ¶ç±»å¼•ç”¨è°ƒç”¨å…·ä½“å®žçŽ°ï¼›åˆå¦‚æ—¥å¿—æ¡†æž¶çš„ LoggerFactoryï¼Œè¿”å›ž Logger æŽ¥å£å³å¯åˆ‡æ¢ä¸åŒæ—¥å¿—å®žçŽ°ï¼Œè°ƒç”¨è€…æ— éœ€å…³å¿ƒåº•å±‚ã€‚
è¿½é—® 2ï¼šæŠ½è±¡ç±»å’ŒæŽ¥å£çš„æ ¸å¿ƒåŒºåˆ«æ˜¯ä»€ä¹ˆï¼ŸJDK8 åŽæŽ¥å£æœ‰å“ªäº›å˜åŒ–ï¼Ÿç­”ï¼šæŠ½è±¡ç±»å¯å«æ™®é€šæ–¹æ³•å’ŒæŠ½è±¡æ–¹æ³•ï¼Œæ”¯æŒä»»æ„å±žæ€§ï¼Œå­ç±»é€šè¿‡ extends å•ç»§æ‰¿ï¼›æŽ¥å£æ—©æœŸä»…å«æŠ½è±¡æ–¹æ³•å’Œå¸¸é‡ï¼ŒJDK8 åŽæ–°å¢žé»˜è®¤æ–¹æ³•ï¼ˆdefaultï¼‰å’Œé™æ€æ–¹æ³•ï¼Œç±»é€šè¿‡ implements å¤šå®žçŽ°ã€‚æ ¸å¿ƒåŒºåˆ«æ˜¯æŠ½è±¡ç±»ä¾§é‡ â€œéƒ¨åˆ†å®žçŽ°â€ï¼ŒæŽ¥å£ä¾§é‡ â€œè¡Œä¸ºè§„èŒƒâ€ã€‚

äºŒã€å¸¸ç”¨é›†åˆåŠåº•å±‚æ•°æ®ç»“æž„æ ¸å¿ƒåè¯è§£é‡Š
ArrayListï¼šåŸºäºŽåŠ¨æ€æ•°ç»„å®žçŽ°çš„ List é›†åˆï¼Œåˆå§‹å®¹é‡ 10ï¼Œæ‰©å®¹æ—¶ä¸ºåŽŸå®¹é‡çš„ 1.5 å€ï¼Œæ”¯æŒéšæœºè®¿é—®ã€‚
LinkedListï¼šåŸºäºŽåŒå‘é“¾è¡¨å®žçŽ°çš„ List é›†åˆï¼Œæ¯ä¸ªèŠ‚ç‚¹åŒ…å« prevï¼ˆå‰é©±ï¼‰å’Œ nextï¼ˆåŽç»§ï¼‰æŒ‡é’ˆï¼Œæ’å…¥åˆ é™¤é¦–å°¾å…ƒç´ æ•ˆçŽ‡é«˜ã€‚
HashMapï¼šåŸºäºŽ â€œæ•°ç»„ + é“¾è¡¨ + çº¢é»‘æ ‘â€ å®žçŽ°çš„ Map é›†åˆï¼Œé€šè¿‡å“ˆå¸Œå‡½æ•°å®šä½å…ƒç´ ï¼Œé“¾è¡¨é•¿åº¦è¶…è¿‡ 8 ä¸”æ•°ç»„å®¹é‡â‰¥64 æ—¶è½¬ä¸ºçº¢é»‘æ ‘ã€‚
ConcurrentHashMapï¼šçº¿ç¨‹å®‰å…¨çš„ Map é›†åˆï¼ŒJDK8 åŽé€šè¿‡ â€œCAS+ synchronizedâ€ ä¿è¯å®‰å…¨ï¼Œé”ç²’åº¦ä¸ºå“ˆå¸Œæ¡¶ï¼ˆé“¾è¡¨ &#x2F; çº¢é»‘æ ‘çš„å¤´èŠ‚ç‚¹ï¼‰ã€‚
HashSetï¼šåŸºäºŽ HashMap å®žçŽ°çš„ Set é›†åˆï¼Œå°†å…ƒç´ ä½œä¸º HashMap çš„ key å­˜å‚¨ï¼Œä¾èµ– hashCode () å’Œ equals () ä¿è¯å…ƒç´ ä¸å¯é‡å¤ã€‚

æ ¸å¿ƒé—®ç­”
é—®ï¼šHashMap çš„åº•å±‚ç»“æž„æ¼”å˜ï¼ˆJDK7 vs JDK8ï¼‰åŠæ‰©å®¹æœºåˆ¶æ˜¯ä»€ä¹ˆï¼Ÿç­”ï¼šJDK7 åº•å±‚æ˜¯ â€œæ•°ç»„ + é“¾è¡¨â€ï¼ŒJDK8 æ–°å¢žçº¢é»‘æ ‘ä¼˜åŒ–ï¼ˆè§£å†³é•¿é“¾è¡¨æŸ¥è¯¢æ…¢é—®é¢˜ï¼‰ã€‚æ‰©å®¹æœºåˆ¶ï¼šå½“å…ƒç´ æ•°è¶…è¿‡ â€œå®¹é‡ Ã— è´Ÿè½½å› å­ï¼ˆé»˜è®¤ 0.75ï¼‰â€ æ—¶ï¼Œå®¹é‡ç¿»å€ï¼ˆä¿è¯ä¸º 2 çš„å¹‚æ¬¡ï¼Œæ–¹ä¾¿è®¡ç®—ç´¢å¼•ï¼‰ï¼Œé‡æ–°è®¡ç®—å…ƒç´ å“ˆå¸Œå€¼å¹¶è¿ç§»ã€‚
é—®ï¼šArrayList å’Œ LinkedList çš„æ ¸å¿ƒåŒºåˆ«åŠé€‚ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿç­”ï¼šä»Žç»“æž„çœ‹ï¼ŒArrayList æ˜¯åŠ¨æ€æ•°ç»„ï¼ŒLinkedList æ˜¯åŒå‘é“¾è¡¨ï¼›ä»Žæ€§èƒ½çœ‹ï¼ŒArrayList éšæœºè®¿é—®å¿«ï¼ˆO (1)ï¼‰ã€æ’å…¥åˆ é™¤ä¸­é—´æ…¢ï¼ˆO (n)ï¼‰ï¼ŒLinkedList æ’å…¥åˆ é™¤é¦–å°¾å¿«ï¼ˆO (1)ï¼‰ã€éšæœºè®¿é—®æ…¢ï¼ˆO (n)ï¼‰ã€‚é€‚ç”¨åœºæ™¯ï¼šé¢‘ç¹æŸ¥è¯¢ç”¨ ArrayListï¼Œé¢‘ç¹å¢žåˆ é¦–å°¾ç”¨ LinkedListã€‚
é—®ï¼šHashSet å¦‚ä½•ä¿è¯å…ƒç´ ä¸å¯é‡å¤ï¼Ÿä¸ºä»€ä¹ˆè¦åŒæ—¶é‡å†™ hashCode () å’Œ equals ()ï¼Ÿç­”ï¼šHashSet æœ¬è´¨æ˜¯ HashMap çš„ key é›†åˆï¼ˆvalue å›ºå®šä¸ºå¸¸é‡ï¼‰ï¼Œæ·»åŠ å…ƒç´ æ—¶å…ˆé€šè¿‡ hashCode () è®¡ç®—å“ˆå¸Œå€¼å®šä½æ•°ç»„ä½ç½®ï¼Œå†é€šè¿‡ equals () æ¯”è¾ƒè¯¥ä½ç½®çš„å…ƒç´ æ˜¯å¦ç›¸åŒï¼Œä¸¤è€…éƒ½ç›¸åŒåˆ™åˆ¤å®šä¸ºé‡å¤å…ƒç´ ï¼Œæ‹’ç»æ·»åŠ ã€‚è‹¥ä»…é‡å†™ equals ()ï¼Œå¯èƒ½å›  hashCode () ä¸åŒå¯¼è‡´ç›¸åŒå…ƒç´ å­˜å…¥ä¸åŒä½ç½®ï¼›ä»…é‡å†™ hashCode ()ï¼Œå¯èƒ½å›  equals () ä¸åŒå¯¼è‡´é‡å¤å…ƒç´ å­˜å…¥åŒä¸€ä½ç½®ï¼Œå‡æ— æ³•ä¿è¯åŽ»é‡ã€‚

è¿½é—®
è¿½é—® 1ï¼šHashMap ä¸ºä»€ä¹ˆä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼ŸJDK8 çš„ ConcurrentHashMap å¦‚ä½•è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Ÿç­”ï¼šHashMap çº¿ç¨‹ä¸å®‰å…¨ä½“çŽ°åœ¨ä¸¤æ–¹é¢ï¼šå¤šçº¿ç¨‹æ‰©å®¹æ—¶ JDK7 çš„å¤´æ’æ³•å¯èƒ½å¯¼è‡´é“¾è¡¨æˆçŽ¯ï¼ˆJDK8 å°¾æ’æ³•è§£å†³ï¼‰ï¼›å¤šçº¿ç¨‹ put æ—¶å¯èƒ½è¦†ç›–å½¼æ­¤ç»“æžœã€‚ConcurrentHashMap JDK8 åŽæ‘’å¼ƒåˆ†æ®µé”ï¼Œæ”¹ç”¨ â€œCAS+ synchronizedâ€ï¼šå†™æ“ä½œé”å®šå“ˆå¸Œæ¡¶å¤´èŠ‚ç‚¹ï¼Œä¸åŒæ¡¶å¯å¹¶å‘ï¼›è¯»æ“ä½œæ— é”ï¼Œä¾èµ– volatile ä¿è¯èŠ‚ç‚¹å€¼å¯è§æ€§ã€‚
è¿½é—® 2ï¼šTreeSet å’Œ LinkedHashSet çš„æŽ’åºæœºåˆ¶æœ‰ä½•ä¸åŒï¼Ÿç­”ï¼šTreeSet åŸºäºŽçº¢é»‘æ ‘å®žçŽ°ï¼Œé€šè¿‡å…ƒç´ çš„ Comparable æŽ¥å£æˆ–å¤–éƒ¨ Comparator å®žçŽ°è‡ªç„¶æŽ’åºæˆ–è‡ªå®šä¹‰æŽ’åºï¼ŒæŽ’åºä¸Žæ’å…¥é¡ºåºæ— å…³ï¼›LinkedHashSet åŸºäºŽ LinkedHashMap å®žçŽ°ï¼Œé€šè¿‡åŒå‘é“¾è¡¨ç»´æŠ¤å…ƒç´ çš„æ’å…¥é¡ºåºï¼ŒåŒæ—¶ä¿è¯åŽ»é‡ï¼ŒæŽ’åºä¸Žæ’å…¥é¡ºåºä¸€è‡´ã€‚

ä¸‰ã€Lambda è¡¨è¾¾å¼ä¸Ž Stream æµæ ¸å¿ƒåè¯è§£é‡Š
Lambda è¡¨è¾¾å¼ï¼šJava8 å¼•å…¥çš„å‡½æ•°å¼ç¼–ç¨‹è¯­æ³•ï¼Œç”¨äºŽç®€åŒ–åŒ¿åå†…éƒ¨ç±»ï¼Œæ ¼å¼ä¸º â€œ(å‚æ•°åˆ—è¡¨) -&gt; æ–¹æ³•ä½“â€ï¼Œä»…èƒ½ç”¨äºŽå‡½æ•°å¼æŽ¥å£ï¼ˆå«ä¸€ä¸ªæŠ½è±¡æ–¹æ³•çš„æŽ¥å£ï¼‰ã€‚
å‡½æ•°å¼æŽ¥å£ï¼šä»…åŒ…å«ä¸€ä¸ªæŠ½è±¡æ–¹æ³•çš„æŽ¥å£ï¼Œå¯é€šè¿‡ @FunctionalInterface æ³¨è§£æ ¡éªŒï¼Œå¦‚ Runnableã€Consumerã€Comparator ç­‰ã€‚
Stream æµï¼šJava8 ç”¨äºŽå¤„ç†é›†åˆçš„ â€œæµæ°´çº¿å¼â€ å·¥å…·ï¼Œå°†é›†åˆè½¬æ¢ä¸ºå…ƒç´ åºåˆ—ï¼Œæ”¯æŒä¸­é—´æ“ä½œï¼ˆæƒ°æ€§æ‰§è¡Œï¼‰å’Œç»ˆæ­¢æ“ä½œï¼ˆè§¦å‘æ‰§è¡Œï¼‰ï¼Œå®žçŽ°é«˜æ•ˆçš„é›†åˆå¤„ç†ã€‚
ä¸­é—´æ“ä½œï¼šStream æµçš„éžç»ˆæ­¢æ“ä½œï¼Œè¿”å›žæ–°çš„ Streamï¼Œä¸ç«‹å³æ‰§è¡Œï¼Œå¦‚ filterï¼ˆç­›é€‰ï¼‰ã€mapï¼ˆè½¬æ¢ï¼‰ã€sortedï¼ˆæŽ’åºï¼‰ã€‚
ç»ˆæ­¢æ“ä½œï¼šè§¦å‘ Stream æµå®žé™…å¤„ç†çš„æ“ä½œï¼Œè¿”å›žéž Stream ç»“æžœï¼Œå¦‚ collectï¼ˆæ”¶é›†ï¼‰ã€forEachï¼ˆéåŽ†ï¼‰ã€countï¼ˆè®¡æ•°ï¼‰ã€‚

æ ¸å¿ƒé—®ç­”
é—®ï¼šLambda è¡¨è¾¾å¼çš„ä½¿ç”¨å‰ææ˜¯ä»€ä¹ˆï¼Ÿç›¸æ¯”åŒ¿åå†…éƒ¨ç±»æœ‰å“ªäº›ä¼˜åŠ¿ï¼Ÿç­”ï¼šä½¿ç”¨å‰ææ˜¯å¿…é¡»å…³è”å‡½æ•°å¼æŽ¥å£ï¼ˆä»…å«ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼‰ã€‚ä¼˜åŠ¿åœ¨äºŽï¼šä»£ç æ›´ç®€æ´ï¼ŒçœåŽ»åŒ¿åå†…éƒ¨ç±»çš„ç±»åã€æ–¹æ³•åç­‰å†—ä½™ç»“æž„ï¼›è¯­ä¹‰æ›´æ¸…æ™°ï¼Œç›´æŽ¥èšç„¦æ ¸å¿ƒé€»è¾‘ï¼›æ”¯æŒæ–¹æ³•å¼•ç”¨ï¼Œè¿›ä¸€æ­¥ç®€åŒ–ä»£ç ã€‚
é—®ï¼šStream æµçš„ â€œæƒ°æ€§æ±‚å€¼â€ æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿä¸ºä»€ä¹ˆè¦è®¾è®¡æˆæƒ°æ€§æ±‚å€¼ï¼Ÿç­”ï¼šæƒ°æ€§æ±‚å€¼æŒ‡ä»…è°ƒç”¨ç»ˆæ­¢æ“ä½œæ—¶ï¼Œä¸­é—´æ“ä½œæ‰ä¼šå®žé™…æ‰§è¡Œï¼Œè‹¥æ²¡æœ‰ç»ˆæ­¢æ“ä½œï¼Œä¸­é—´æ“ä½œä¸ä¼šè§¦å‘ä»»ä½•è®¡ç®—ã€‚è®¾è®¡ç›®çš„æ˜¯ä¼˜åŒ–æ€§èƒ½ï¼šå¯åˆå¹¶å¤šä¸ªä¸­é—´æ“ä½œä¸€æ¬¡æ€§å¤„ç†ï¼ˆå‡å°‘éåŽ†æ¬¡æ•°ï¼‰ï¼Œé¿å…æ— æ•ˆè®¡ç®—ï¼ˆå¦‚æå‰è¿‡æ»¤æŽ‰å¤§éƒ¨åˆ†å…ƒç´ åŽå†è½¬æ¢ï¼‰ã€‚
é—®ï¼šStream æµçš„å¹¶è¡Œæµï¼ˆparallelStreamï¼‰åŽŸç†æ˜¯ä»€ä¹ˆï¼Ÿä½¿ç”¨æ—¶éœ€æ³¨æ„ä»€ä¹ˆï¼Ÿç­”ï¼šå¹¶è¡ŒæµåŸºäºŽ Fork&#x2F;Join æ¡†æž¶å®žçŽ°ï¼Œå°†æ•°æ®æ‹†åˆ†ä¸ºå¤šä¸ªå­ä»»åŠ¡ï¼Œç”±å¤šä¸ªçº¿ç¨‹å¹¶è¡Œå¤„ç†åŽåˆå¹¶ç»“æžœï¼Œé€‚åˆ CPU å¯†é›†åž‹ä»»åŠ¡ã€‚æ³¨æ„äº‹é¡¹ï¼šé¿å…å¤„ç†éžçº¿ç¨‹å®‰å…¨çš„é›†åˆï¼ˆå¦‚ ArrayListï¼‰ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®é”™ä¹±ï¼›é¿å…åœ¨å¹¶è¡Œæµä¸­ä¿®æ”¹å…±äº«å˜é‡ï¼Œéœ€é¢å¤–åŠ é”åè€Œé™ä½Žæ€§èƒ½ã€‚

è¿½é—®
è¿½é—® 1ï¼šä½¿ç”¨ Stream æµæ—¶å¸¸è§çš„ â€œå‘â€ æœ‰å“ªäº›ï¼Ÿå¦‚ä½•è§„é¿ï¼Ÿç­”ï¼šä¸€æ˜¯é‡å¤æ¶ˆè´¹ï¼ŒStream æµåªèƒ½è¢«æ¶ˆè´¹ä¸€æ¬¡ï¼ˆç»ˆæ­¢æ“ä½œåŽå…³é—­ï¼‰ï¼Œé‡å¤è°ƒç”¨ä¼šæŠ›å¼‚å¸¸ï¼Œè§„é¿éœ€é‡æ–°åˆ›å»º Streamï¼›äºŒæ˜¯çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå¹¶è¡Œæµæ“ä½œéžçº¿ç¨‹å®‰å…¨é›†åˆä¼šå‡ºé—®é¢˜ï¼Œè§„é¿éœ€ä½¿ç”¨çº¿ç¨‹å®‰å…¨é›†åˆæˆ–åœ¨å¤„ç†æ—¶åŠ é”ï¼›ä¸‰æ˜¯å¿½ç•¥æƒ°æ€§æ±‚å€¼ï¼Œå¿˜è®°åŠ ç»ˆæ­¢æ“ä½œå¯¼è‡´ä¸­é—´æ“ä½œæ— æ•ˆï¼Œè§„é¿éœ€ç¡®ä¿æ¯ä¸ª Stream æµéƒ½æœ‰æ˜Žç¡®çš„ç»ˆæ­¢æ“ä½œã€‚
è¿½é—® 2ï¼šæ–¹æ³•å¼•ç”¨æ˜¯ä»€ä¹ˆï¼Ÿæœ‰å“ªäº›å¸¸è§ç±»åž‹ï¼Ÿç­”ï¼šæ–¹æ³•å¼•ç”¨æ˜¯ Lambda è¡¨è¾¾å¼çš„ç®€åŒ–å½¢å¼ï¼Œå½“ Lambda ä½“ä»…è°ƒç”¨ä¸€ä¸ªçŽ°æœ‰æ–¹æ³•æ—¶ï¼Œå¯é€šè¿‡ â€œç±»åï¼šï¼šæ–¹æ³•åâ€ æˆ– â€œå¯¹è±¡ï¼šï¼šæ–¹æ³•åâ€ æ›¿ä»£ã€‚å¸¸è§ç±»åž‹æœ‰ï¼šå®žä¾‹æ–¹æ³•å¼•ç”¨ï¼ˆå¦‚ user::getNameï¼‰ã€é™æ€æ–¹æ³•å¼•ç”¨ï¼ˆå¦‚ Math::maxï¼‰ã€æž„é€ æ–¹æ³•å¼•ç”¨ï¼ˆå¦‚ User::newï¼‰ã€‚

å››ã€å¤šçº¿ç¨‹åŠå¹¶å‘å®¹å™¨æ ¸å¿ƒåè¯è§£é‡Š
çº¿ç¨‹ï¼šè¿›ç¨‹å†…çš„æœ€å°æ‰§è¡Œå•å…ƒï¼Œä¸€ä¸ªè¿›ç¨‹å¯åŒ…å«å¤šä¸ªçº¿ç¨‹ï¼Œå…±äº«è¿›ç¨‹èµ„æºï¼Œå®žçŽ°å¹¶å‘æ‰§è¡Œã€‚
çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸï¼šçº¿ç¨‹ä»Žåˆ›å»ºåˆ°é”€æ¯çš„çŠ¶æ€å˜åŒ–ï¼ŒåŒ…å« NEWï¼ˆæ–°å»ºï¼‰ã€RUNNABLEï¼ˆå°±ç»ª &#x2F; è¿è¡Œï¼‰ã€BLOCKEDï¼ˆé˜»å¡žï¼‰ã€WAITINGï¼ˆæ— è¶…æ—¶ç­‰å¾…ï¼‰ã€TIMED_WAITINGï¼ˆè¶…æ—¶ç­‰å¾…ï¼‰ã€TERMINATEDï¼ˆç»ˆæ­¢ï¼‰6 ç§çŠ¶æ€ã€‚
Callableï¼šå¸¦è¿”å›žå€¼çš„çº¿ç¨‹ä»»åŠ¡æŽ¥å£ï¼Œå®šä¹‰äº† call () æ–¹æ³•ï¼Œå¯æŠ›å‡ºå—æ£€å¼‚å¸¸ï¼Œéœ€ç»“åˆ FutureTask èŽ·å–æ‰§è¡Œç»“æžœã€‚
ConcurrentHashMapï¼šçº¿ç¨‹å®‰å…¨çš„ HashMap å®žçŽ°ï¼ŒJDK8 åŽé€šè¿‡ â€œCAS+ synchronizedâ€ ä¿è¯å¹¶å‘å®‰å…¨ï¼Œé”ç²’åº¦ç»†ï¼Œæ€§èƒ½ä¼˜äºŽ Hashtableã€‚
CopyOnWriteArrayListï¼šåŸºäºŽ â€œå†™æ—¶å¤åˆ¶â€ æœºåˆ¶çš„çº¿ç¨‹å®‰å…¨ Listï¼Œè¯»æ“ä½œæ— é”ï¼Œå†™æ“ä½œå¤åˆ¶åŽŸæ•°ç»„ä¿®æ”¹åŽæ›¿æ¢ï¼Œé€‚åˆè¯»å¤šå†™å°‘åœºæ™¯ã€‚
BlockingQueueï¼šæ”¯æŒé˜»å¡žæ“ä½œçš„é˜Ÿåˆ—ï¼Œæä¾› put ()ï¼ˆé˜Ÿåˆ—æ»¡æ—¶é˜»å¡žï¼‰å’Œ take ()ï¼ˆé˜Ÿåˆ—ç©ºæ—¶é˜»å¡žï¼‰æ–¹æ³•ï¼Œå¸¸ç”¨äºŽç”Ÿäº§è€… - æ¶ˆè´¹è€…æ¨¡åž‹ã€‚

æ ¸å¿ƒé—®ç­”
é—®ï¼šçº¿ç¨‹çš„ 6 ç§ç”Ÿå‘½å‘¨æœŸçŠ¶æ€åŠè½¬æ¢è§¦å‘åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿç­”ï¼šâ‘  NEWï¼šnew Thread () åŽæœªè°ƒç”¨ start ()ï¼›â‘¡ RUNNABLEï¼šè°ƒç”¨ start () åŽç­‰å¾… CPU è°ƒåº¦æˆ–æ­£åœ¨è¿è¡Œï¼›â‘¢ BLOCKEDï¼šèŽ·å– synchronized é”å¤±è´¥æ—¶è¿›å…¥ï¼›â‘£ WAITINGï¼šè°ƒç”¨ object.wait ()ã€thread.join () ç­‰æ— è¶…æ—¶æ–¹æ³•æ—¶è¿›å…¥ï¼Œéœ€è¢«å”¤é†’ï¼›â‘¤ TIMED_WAITINGï¼šè°ƒç”¨ Thread.sleep (long)ã€object.wait (long) ç­‰è¶…æ—¶æ–¹æ³•æ—¶è¿›å…¥ï¼Œè¶…æ—¶è‡ªåŠ¨å”¤é†’ï¼›â‘¥ TERMINATEDï¼šrun () æ‰§è¡Œå®Œæ¯•æˆ–å¼‚å¸¸ç»ˆæ­¢ã€‚
é—®ï¼šCopyOnWriteArrayList çš„ â€œå†™æ—¶å¤åˆ¶â€ æœºåˆ¶æ˜¯ä»€ä¹ˆï¼Ÿæœ‰å“ªäº›ä¼˜ç¼ºç‚¹ï¼Ÿç­”ï¼šå†™æ—¶å¤åˆ¶æŒ‡ï¼šè¯»æ“ä½œç›´æŽ¥è®¿é—®åŽŸæ•°ç»„ï¼ˆæ— é”ï¼Œæ•ˆçŽ‡é«˜ï¼‰ï¼›å†™æ“ä½œï¼ˆadd&#x2F;removeï¼‰å…ˆå¤åˆ¶ä¸€ä»½åŽŸæ•°ç»„ï¼Œåœ¨æ–°æ•°ç»„ä¸Šä¿®æ”¹ï¼Œä¿®æ”¹å®ŒæˆåŽç”¨ volatile å˜é‡æ›¿æ¢åŽŸæ•°ç»„å¼•ç”¨ã€‚ä¼˜ç‚¹æ˜¯è¯»æ“ä½œæ— é”ã€çº¿ç¨‹å®‰å…¨ï¼›ç¼ºç‚¹æ˜¯å†…å­˜å¼€é”€å¤§ï¼ˆå¤åˆ¶æ•°ç»„ï¼‰ã€å¼±ä¸€è‡´æ€§ï¼ˆå†™åŽè¯»å¯èƒ½çœ‹åˆ°æ—§æ•°æ®ï¼‰ã€‚
é—®ï¼šçº¿ç¨‹åˆ›å»ºçš„ä¸‰ç§æ–¹å¼åŠæ ¸å¿ƒåŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿç­”ï¼šä¸‰ç§æ–¹å¼åˆ†åˆ«æ˜¯ï¼šâ‘  ç»§æ‰¿ Thread ç±»ï¼šé‡å†™ run () æ–¹æ³•ï¼Œæ— è¿”å›žå€¼ï¼Œæ— æ³•æŠ›å—æ£€å¼‚å¸¸ï¼Œå—å•ç»§æ‰¿é™åˆ¶ï¼›â‘¡ å®žçŽ° Runnable æŽ¥å£ï¼šé‡å†™ run () æ–¹æ³•ï¼Œæ— è¿”å›žå€¼ï¼Œæ— æ³•æŠ›å—æ£€å¼‚å¸¸ï¼Œå¯é¿å…å•ç»§æ‰¿é™åˆ¶ï¼›â‘¢ å®žçŽ° Callable æŽ¥å£ï¼šé‡å†™ call () æ–¹æ³•ï¼Œæœ‰è¿”å›žå€¼ï¼Œå¯æŠ›å—æ£€å¼‚å¸¸ï¼Œéœ€ç»“åˆ FutureTask èŽ·å–ç»“æžœã€‚æ ¸å¿ƒåŒºåˆ«åœ¨äºŽæ˜¯å¦æœ‰è¿”å›žå€¼ã€æ˜¯å¦å—å•ç»§æ‰¿é™åˆ¶ã€æ˜¯å¦èƒ½æŠ›å—æ£€å¼‚å¸¸ã€‚

è¿½é—®
è¿½é—® 1ï¼šwait () å’Œ sleep () çš„æ ¸å¿ƒåŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿç­”ï¼šä»Žé”é‡Šæ”¾çœ‹ï¼Œwait () ä¼šé‡Šæ”¾æŒæœ‰çš„å¯¹è±¡é”ï¼Œsleep () ä¸ä¼šï¼›ä»Žè°ƒç”¨åœºæ™¯çœ‹ï¼Œwait () å¿…é¡»åœ¨ synchronized å—ä¸­è°ƒç”¨ï¼Œsleep () å¯åœ¨ä»»æ„åœºæ™¯è°ƒç”¨ï¼›ä»Žå”¤é†’æ–¹å¼çœ‹ï¼Œwait () éœ€é€šè¿‡ notify ()&#x2F;notifyAll () å”¤é†’ï¼Œsleep () è¶…æ—¶è‡ªåŠ¨å”¤é†’ï¼›ä»Žæ‰€å±žç±»çœ‹ï¼Œwait () æ˜¯ Object ç±»æ–¹æ³•ï¼ˆæ‰€æœ‰å¯¹è±¡éƒ½æœ‰ï¼‰ï¼Œsleep () æ˜¯ Thread ç±»æ–¹æ³•ã€‚

è¿½é—® 2ï¼šConcurrentHashMap åœ¨ JDK7 å’Œ JDK8 çš„å®žçŽ°æœ‰ä½•ä¸åŒï¼Ÿä¸ºä»€ä¹ˆ JDK8 æ€§èƒ½æ›´ä¼˜ï¼Ÿç­”ï¼šJDK7 é‡‡ç”¨ â€œåˆ†æ®µé”ï¼ˆSegmentï¼‰â€ï¼Œå°†æ•°ç»„åˆ†ä¸ºå¤šä¸ª Segmentï¼Œæ¯ä¸ª Segment æ˜¯ç‹¬ç«‹çš„ HashMapï¼Œé”ç²’åº¦ä¸º Segmentï¼›JDK8 æ‘’å¼ƒåˆ†æ®µé”ï¼Œæ”¹ç”¨ â€œæ•°ç»„ + é“¾è¡¨ + çº¢é»‘æ ‘â€ï¼Œé€šè¿‡ â€œCAS+ synchronizedâ€ é”å®šå“ˆå¸Œæ¡¶å¤´èŠ‚ç‚¹ï¼Œé”ç²’åº¦æ›´ç»†ï¼ˆä»…å•ä¸ªæ¡¶ï¼‰ã€‚JDK8 æ€§èƒ½æ›´ä¼˜æ˜¯å› ä¸ºé”ç²’åº¦ç»†åŒ–ï¼Œä¸åŒæ¡¶çš„æ“ä½œå¯å¹¶å‘æ‰§è¡Œï¼Œå‡å°‘é”ç«žäº‰ã€‚


]]></content>
      <categories>
        <category>Java</category>
        <category>ä¸ºäº†å®žä¹ è¯´æ˜¯</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>ä¸ºäº†å®žä¹ è¯´æ˜¯</tag>
      </tags>
  </entry>
</search>
